<!doctype html>
<html lang="ja" data-theme="light">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>ä¸å…·åˆãƒ»å¯¾ç­–ï¼ˆã‚¯ãƒ¬ãƒ¼ãƒ ãƒãƒ¼ã‚¿ãƒ«ï¼‰</title>

<style>
  :root{
    --bg1:#eef2ff; --bg2:#f8fafc;
    --panel:#fff; --ink:#0f172a; --muted:#64748b; --border:#e5e7eb;
    --accent:#2563eb; --accent-2:#22d3ee;
    --ok:#16a34a; --warn:#f59e0b; --bad:#ef4444;
    --radius-xl:22px; --radius:12px;
    --shadow-1:0 12px 30px rgba(15,23,42,.08); --shadow-2:0 30px 60px rgba(15,23,42,.10);
  }
  @media (prefers-color-scheme: dark){
    :root{
      --bg1:#0b1220; --bg2:#0b1220;
      --panel:#0f172a; --ink:#e5e7eb; --muted:#94a3b8; --border:#1f2937;
      --accent:#60a5fa; --shadow-1:none; --shadow-2:none;
    }
  }
  *{box-sizing:border-box}
  html,body{height:100%}
  body{
    margin:0; color:var(--ink);
    font-family:system-ui,-apple-system,Segoe UI,Roboto,"Noto Sans JP","Yu Gothic",sans-serif;
    background:
      radial-gradient(1100px 540px at -12% -12%, #c7d2fe33 0%, transparent 60%),
      radial-gradient(820px 460px at 112% -6%, #bae6fd33 0%, transparent 55%),
      linear-gradient(120deg,var(--bg1),var(--bg2));
    padding-bottom:56px;
    overflow-x:hidden; /* biar overlay tidak bikin scroll horizontal */
  }

  /* ===== Header / Top nav ===== */
  header{position:sticky;top:0;z-index:60;background:#ffffffcc;backdrop-filter:blur(12px);border-bottom:1px solid var(--border)}
  @media (prefers-color-scheme: dark){ header{background:#0f172acc} }
  .wrap{max-width:1200px;margin:0 auto;padding:12px 20px}
  .row{display:flex;align-items:center;justify-content:space-between;gap:12px}
  .brand{display:flex;align-items:center;gap:10px}
  .brand img{height:36px}

  .top-actions{display:flex;gap:8px;align-items:center;flex-wrap:wrap;margin-left:auto}
  .btn-top{
    height:34px;padding:0 12px;border:1px solid var(--border);border-radius:10px;background:var(--panel);
    color:var(--ink);display:inline-flex;align-items:center;gap:8px;cursor:pointer;text-decoration:none
  }
  .btn-top:hover{border-color:#c7d2fe}

  /* ===== Layout (main) ===== */
  main{max-width:1200px;margin:20px auto;padding:0 20px}
  .grid{display:grid;gap:16px;grid-template-columns:1fr 1fr}
  @media (max-width:960px){ .grid{grid-template-columns:1fr} }

  .card{background:var(--panel);border:1px solid var(--border);border-radius:var(--radius-xl);box-shadow:var(--shadow-2);padding:18px}
  .section-title{margin:0 0 10px 0}

  /* ===== Controls ===== */
  .pill{display:inline-flex;gap:8px;align-items:center;height:32px;padding:0 12px;border-radius:9999px;border:1px solid var(--border);background:var(--panel);color:var(--ink);cursor:pointer}
  .pill.active{border-color:#93c5fd;background:#f0f9ff}
  @media (prefers-color-scheme: dark){ .pill.active{background:#0b3b6f66} }
  .group{display:flex;gap:8px;flex-wrap:wrap}

  label{display:block;font-size:12px;font-weight:700;color:var(--muted);margin:6px 0 6px}
  input[type="text"],input[type="date"],input[type="email"],select,textarea{
    width:100%;padding:10px 12px;border:1px solid var(--border);border-radius:12px;background:var(--panel);color:var(--ink);outline:none
  }
  textarea{min-height:96px;resize:vertical}
  .hint{font-size:12px;color:var(--muted)}

  .actions{display:flex;gap:8px;flex-wrap:wrap}
  .btn{height:36px;padding:0 14px;border-radius:10px;border:1px solid var(--border);background:var(--panel);cursor:pointer}
  .btn.primary{background:var(--accent);color:#fff;border-color:#1e4fdc}
  .btn.ghost{background:#f1f5f9}
  @media (prefers-color-scheme: dark){ .btn.ghost{background:#0b1624} }

  /* ===== Tag/Status ===== */
  .tag{display:inline-flex;align-items:center;gap:6px;padding:2px 10px;border-radius:999px;background:#0ea5e91a;color:var(--ink);border:1px solid var(--border);font-size:12px}
  .status{font-size:12px;padding:4px 10px;border-radius:999px;border:1px solid var(--border);display:inline-block}
  .status.open{background:rgba(239,68,68,.1);color:#b91c1c}
  .status.prog{background:rgba(245,158,11,.1);color:#b45309}
  .status.done{background:rgba(34,197,94,.12);color:#15803d}

  /* ===== KPI ===== */
  .kpi{display:grid;grid-template-columns:repeat(4,minmax(0,1fr));gap:12px}
  @media (max-width:600px){ .kpi{grid-template-columns:repeat(2,minmax(0,1fr))} }
  .kpi .box{background:var(--panel);border:1px solid var(--border);border-radius:16px;padding:12px;box-shadow:var(--shadow-1)}
  .kpi .big{font-size:26px;font-weight:800}

  /* ===== List ===== */
  .list .item{background:var(--panel);border:1px solid var(--border);border-radius:14px;padding:10px 12px;box-shadow:var(--shadow-1)}
  .list .item + .item{margin-top:8px}
  .sub{color:var(--muted);font-size:12px}

  /* ===== Toast ===== */
  .toast{position:fixed;right:18px;bottom:18px;z-index:65;display:flex;flex-direction:column;gap:10px}
  .toast .t{background:var(--panel);border:1px solid var(--border);border-radius:12px;box-shadow:var(--shadow-1);padding:10px 12px;font-size:14px}
  .t.ok{border-color:#bbf7d0}
  .t.err{border-color:#fecaca}

  .footer{position:fixed;bottom:0;left:0;right:0;text-align:center;font-size:12px;color:var(--muted);background:#f1f5f9;padding:4px 0;z-index:21}
  @media (prefers-color-scheme: dark){ .footer{background:#0b1220} }

  /* ===== Edge-hover sidebar (desktop) ===== */
  .edge-hotspot{
    position:fixed; left:0; top:64px; width:12px; height:calc(100vh - 64px);
    z-index:70;
  }
  .hover-side{
    position:fixed; left:0; top:64px; height:calc(100vh - 64px);
    width:260px; padding:14px 12px; overflow:auto;
    background:var(--panel); border-right:1px solid var(--border); box-shadow:var(--shadow-1);
    transform:translateX(-100%); transition:transform .22s ease; z-index:71;
  }
  .hover-side.open{ transform:translateX(0) }
  .hover-side h3{ margin:4px 8px 10px; font-size:12px; letter-spacing:.08em; color:#6b7280; text-transform:uppercase }
  .navlist{ display:grid; gap:4px }
  .slink{ display:flex; align-items:center; gap:10px; padding:10px 12px; border-radius:12px; color:var(--ink); text-decoration:none }
  .slink:hover{ background:#f1f5ff }
  .ico{ width:22px; text-align:center }
  .admin-only{ display:none } /* akan muncul saat admin ON */

  /* ===== Drawer (mobile) ===== */
  .burger{display:none; align-items:center; justify-content:center; width:38px; height:38px;
          border:1px solid var(--border); border-radius:10px; background:#fff; cursor:pointer}
  .burger:active{transform:scale(.98)}
  .drawer{ position:fixed; inset:0; z-index:80; display:none }
  .drawer.open{ display:block }
  .drawer .backdrop{ position:absolute; inset:0; background:#0006 }
  .drawer .panel{ position:absolute; top:0; left:0; height:100%; width:min(86%,320px);
                  background:#fff; border-right:1px solid var(--border); box-shadow:var(--shadow-2); padding:14px 12px; overflow:auto;
                  transform:translateX(-100%); transition:transform .25s ease }
  .drawer.open .panel{ transform:translateX(0) }
  .drawer .close{ position:absolute; right:10px; top:10px; border:0; background:#f1f5f9; border:1px solid var(--border); border-radius:8px; padding:6px 10px; cursor:pointer }

  /* Hide top nav on small screens; use burger instead */
  @media (max-width:900px){
    nav.top-actions{ display:none }
    .burger{ display:inline-flex }
    .edge-hotspot, .hover-side{ display:none }
  }
</style>
</head>
<body>
<header>
  <div class="wrap row">
    <div class="brand">
      <button id="btnBurger" class="burger" aria-label="ãƒ¡ãƒ‹ãƒ¥ãƒ¼"><span>â˜°</span></button>
      <img src="tsh.png" alt="TSH">
      <strong>å“è³ªç®¡ç†ç”Ÿç”£æŠ€è¡“</strong>
    </div>
    <nav class="top-actions">
      <a class="btn-top" href="./index.html">ğŸ  ãƒ›ãƒ¼ãƒ </a>
      <a class="btn-top" href="./forms.html">ğŸ“„ å‡ºè·æ¤œæŸ»æˆç¸¾æ›¸</a>
      <a class="btn-top" href="./sagyoutejunsho.html">ğŸ“ ä½œæ¥­æ‰‹é †æ›¸</a>
      <a class="btn-top" href="./charts.html">ğŸ“ˆ ãƒãƒ£ãƒ¼ãƒˆ</a>
      <a class="btn-top" href="./quality.html">ğŸ” å“è³ªæƒ…å ±</a>
      <a class="btn-top" href="./claim.html"><strong>ğŸ§ª ä¸å…·åˆãƒ»å¯¾ç­–</strong></a>
      <button id="btnAdmin" class="btn-top" type="button" title="Admin login/logout">ç®¡ç†</button>
    </nav>
  </div>
</header>

<!-- ===== Hover Sidebar (desktop) ===== -->
<div id="edgeHotspot" class="edge-hotspot" aria-hidden="true"></div>
<aside id="hoverSide" class="hover-side" aria-label="Pages">
  <h3>Pages</h3>
  <div class="navlist">
    <a class="slink" href="./index.html"><span class="ico">ğŸ </span><strong>ãƒ›ãƒ¼ãƒ </strong></a>
    <a class="slink" href="./forms.html"><span class="ico">ğŸ“„</span><strong>å‡ºè·æ¤œæŸ»æˆç¸¾æ›¸</strong></a>
    <a class="slink" href="./sagyoutejunsho.html"><span class="ico">ğŸ“</span><strong>ä½œæ¥­æ‰‹é †æ›¸</strong></a>
    <a class="slink" href="./charts.html"><span class="ico">ğŸ“ˆ</span><strong>ãƒãƒ£ãƒ¼ãƒˆ</strong></a>
    <a class="slink" href="./quality.html"><span class="ico">ğŸ”</span><strong>å“è³ªæƒ…å ±</strong></a>
    <a class="slink" href="./claim.html"><span class="ico">ğŸ§ª</span><strong>ä¸å…·åˆãƒ»å¯¾ç­–</strong></a>
  </div>

  <div class="admin-only" style="margin-top:12px">
    <h3>Admin</h3>
    <div class="navlist">
      <a class="slink" href="./admin-numbering.html"><span class="ico">#</span><strong>Admin Numbering</strong></a>
      <a class="slink" href="./admin-prefix.html"><span class="ico">ğŸ”§</span><strong>Admin Prefix</strong></a>
      <a class="slink" href="./admin-serial-gas.html"><span class="ico">â›½</span><strong>Admin Serial Gas</strong></a>
      <a class="slink" href="./thanks.html"><span class="ico">âœ¨</span><strong>Thanks</strong></a>
    </div>
  </div>
</aside>

<!-- ===== Drawer (mobile) ===== -->
<div id="drawer" class="drawer" aria-hidden="true">
  <div class="backdrop" data-close></div>
  <aside class="panel">
    <button class="close" data-close>âœ•</button>
    <div class="side-card" style="box-shadow:none;border:0;padding-top:30px">
      <h3>Pages</h3>
      <div class="navlist">
        <a class="slink" href="./index.html"><span class="ico">ğŸ </span><strong>ãƒ›ãƒ¼ãƒ </strong></a>
        <a class="slink" href="./forms.html"><span class="ico">ğŸ“„</span><strong>å‡ºè·æ¤œæŸ»æˆç¸¾æ›¸</strong></a>
        <a class="slink" href="./sagyoutejunsho.html"><span class="ico">ğŸ“</span><strong>ä½œæ¥­æ‰‹é †æ›¸</strong></a>
        <a class="slink" href="./charts.html"><span class="ico">ğŸ“ˆ</span><strong>ãƒãƒ£ãƒ¼ãƒˆ</strong></a>
        <a class="slink" href="./quality.html"><span class="ico">ğŸ”</span><strong>å“è³ªæƒ…å ±</strong></a>
        <a class="slink" href="./claim.html"><span class="ico">ğŸ§ª</span><strong>ä¸å…·åˆãƒ»å¯¾ç­–</strong></a>
      </div>

      <div class="admin-only" style="margin-top:12px">
        <h3>Admin</h3>
        <div class="navlist">
          <a class="slink" href="./admin-numbering.html"><span class="ico">#</span><strong>Admin Numbering</strong></a>
          <a class="slink" href="./admin-prefix.html"><span class="ico">ğŸ”§</span><strong>Admin Prefix</strong></a>
          <a class="slink" href="./admin-serial-gas.html"><span class="ico">â›½</span><strong>Admin Serial Gas</strong></a>
          <a class="slink" href="./thanks.html"><span class="ico">âœ¨</span><strong>Thanks</strong></a>
        </div>
      </div>
    </div>
  </aside>
</div>

<main class="wrap">
  <div class="grid">
    <!-- ===== Form ===== -->
    <section class="card">
      <h2 class="section-title">å“è³ªãƒ•ã‚©ãƒ¼ãƒ </h2>

      <!-- Jenis -->
      <div class="group" role="tablist" aria-label="Jenis Form">
        <button type="button" class="pill active" data-tab="customer">å„å…ˆã‚¯ãƒ¬ãƒ¼ãƒ </button>
        <button type="button" class="pill" data-tab="internal">ç¤¾å†…ã‚¯ãƒ¬ãƒ¼ãƒ </button>
        <button type="button" class="pill" data-tab="design">è¨­è¨ˆå¤‰æ›´</button>
        <button type="button" class="pill" data-tab="kaizen">æ”¹å–„</button>
        <button type="button" class="pill" data-tab="supplier">å”åŠ›ä¼šç¤¾ã‚¯ãƒ¬ãƒ¼ãƒ </button>
      </div>

      <!-- Phase -->
      <div class="group" role="tablist" aria-label="Mode Form" style="margin-top:6px">
        <button type="button" class="pill active" data-mode="report">ğŸ“ ã‚¯ãƒ¬ãƒ¼ãƒ å ±å‘Š</button>
        <button type="button" class="pill" data-mode="handling">ğŸ›  ã‚¯ãƒ¬ãƒ¼ãƒ å¯¾å¿œ</button>
      </div>

      <form id="reportForm" class="grid" style="grid-template-columns:1fr 1fr" autocomplete="off">
        <input type="hidden" name="type" id="type" value="customer">
        <input type="hidden" name="phase" id="phase" value="report">

        <div><label>ã‚¿ã‚¤ãƒˆãƒ«</label><input name="title" type="text" required placeholder="ä¾‹ï¼šMU6300 Xè»¸ ï¾Œï¾Ÿï¾›ï¾ƒï½¸ï¾€ï½°å¹²æ¸‰"/></div>
        <div><label>æ—¥ä»˜</label><input name="date" type="date" required /></div>
        <div><label>å ±å‘Šè€…</label><input name="reporter" type="text" required /></div>
        <div><label>Email</label><input name="email" type="email" placeholder="name@example.com"/></div>
        <div><label>éƒ¨ç½²</label><input name="dept" type="text" placeholder="å“è³ªï¼ç”Ÿç”£æŠ€è¡“ ãªã©" /></div>
        <div><label>ã‚«ãƒ†ã‚´ãƒª</label><input name="category" type="text" placeholder="å¤–è¦³ï¼å¯¸æ³•ï¼å·¥ç¨‹â€¦"/></div>
        <div><label>å„ªå…ˆåº¦</label>
          <select name="priority">
            <option>ä½</option><option selected>ä¸­</option><option>é«˜</option>
          </select>
        </div>

        <div id="statusField">
          <label>çŠ¶æ³</label>
          <select name="status">
            <option selected>æœª</option><option>é€²è¡Œä¸­</option><option>å®Œäº†</option>
          </select>
        </div>

        <div>
          <label>å„å…ˆã‚¯ãƒ¬ãƒ¼ãƒ ?</label>
          <select name="isClaim"><option value="0">No</option><option value="1" selected>Yes</option></select>
        </div>

        <!-- å ±å‘Š -->
        <div class="phase-report" style="grid-column:1/-1">
          <label>ä¸å…·åˆå†…å®¹ï¼ˆå ±å‘Šï¼‰</label>
          <textarea name="problem" placeholder="ç¾è±¡ã€è¦æ ¼ã€åŸºæº–ã€ç™ºç”Ÿæ¡ä»¶ãªã©"></textarea>
        </div>

        <!-- å¯¾å¿œ -->
        <div class="grid phase-handling" style="grid-template-columns:1fr 1fr;grid-column:1/-1;display:none">
          <div><label>åŸå› ï¼ˆ5Whyï¼‰</label><textarea name="rootcause"></textarea></div>
          <div><label>å¿œæ€¥å‡¦ç½®ï¼ˆContainmentï¼‰</label><textarea name="containment"></textarea></div>
          <div><label>æ’ä¹…å¯¾ç­–ï¼ˆCorrectiveï¼‰</label><textarea name="corrective"></textarea></div>
          <div><label>äºˆé˜²å‡¦ç½®ï¼ˆPreventiveï¼‰</label><textarea name="preventive"></textarea></div>
          <div><label>PICï¼ˆå¯¾å¿œè€…ï¼‰</label><input name="pic" type="text" /></div>
          <div><label>Dueï¼ˆå®Œäº†äºˆå®šï¼‰</label><input name="due" type="date" /></div>
        </div>

        <div style="grid-column:1/-1">
          <label>æ·»ä»˜ï¼ˆå†™çœŸãƒ»PDF ç­‰ï¼‰</label>
          <input id="attachments" name="attachments" type="file" multiple />
          <div class="hint">åˆè¨ˆ 20MBï¼æœ€å¤§ 10 ãƒ•ã‚¡ã‚¤ãƒ«ã¾ã§ã€‚</div>
          <div id="attachInfo" class="hint"></div>
        </div>

        <div class="actions" style="grid-column:1/-1;margin-top:4px">
          <button type="submit" class="btn primary">ä¿å­˜</button>
          <button type="reset" class="btn">ãƒªã‚»ãƒƒãƒˆ</button>
          <button type="button" id="btnClearDraft" class="btn ghost" title="ä¸€æ™‚ä¿å­˜ã‚’å‰Šé™¤">ä¸€æ™‚ä¿å­˜ã‚¯ãƒªã‚¢</button>
          <span id="draftNote" class="hint" style="margin-left:auto"></span>
        </div>
      </form>
    </section>

    <!-- ===== Data & Summary ===== -->
    <section class="card">
      <h2 class="section-title">ãƒ‡ãƒ¼ã‚¿ & ã‚µãƒãƒªãƒ¼</h2>
      <div class="hint">ã€Œå„å…ˆã‚¯ãƒ¬ãƒ¼ãƒ ã€ï¼ isClaim: Yesã€‚ä»–ã¯ Noã€‚ãƒ•ã‚§ãƒ¼ã‚ºã”ã¨ã«åˆ¥é›†è¨ˆã—ã¾ã™ã€‚</div>

      <div class="kpi" style="margin:8px 0">
        <div class="box"><div class="sub">Total</div><div id="kpiTotal" class="big">0</div></div>
        <div class="box"><div class="sub">Open</div><div id="kpiOpen" class="big">0</div></div>
        <div class="box"><div class="sub">é€²è¡Œä¸­</div><div id="kpiProg" class="big">0</div></div>
        <div class="box"><div class="sub">ä»Šæœˆå®Œäº†</div><div id="kpiDone" class="big">0</div></div>
      </div>

      <div class="row" style="margin:6px 0">
        <input id="search" type="text" placeholder="æ¤œç´¢: ã‚¿ã‚¤ãƒˆãƒ«ãƒ»éƒ¨ç½²ãƒ»PICâ€¦">
        <button id="btnExport" class="btn" title="CSVã«ã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆ">Export CSV</button>
      </div>

      <div id="list" class="list" style="margin-top:8px"></div>

      <!-- Charts -->
      <h3 class="section-title" style="margin-top:14px">ğŸ“Š ç¨®åˆ¥åˆ¥ï¼ˆå ±å‘Šï¼‰</h3>
      <canvas id="chartByType" height="140" aria-label="ç¨®åˆ¥åˆ¥ï¼ˆå ±å‘Šï¼‰"></canvas>

      <h3 class="section-title" style="margin-top:14px">ğŸ“ˆ æœˆæ¬¡ãƒˆãƒ¬ãƒ³ãƒ‰ï¼ˆå ±å‘Š vs å¯¾å¿œãƒ»12ãƒ¶æœˆï¼‰</h3>
      <canvas id="chartMonthly" height="140" aria-label="æœˆæ¬¡ãƒˆãƒ¬ãƒ³ãƒ‰"></canvas>

      <h3 class="section-title" style="margin-top:14px">ğŸŸ¢ ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹æ§‹æˆï¼ˆå…¨ä»¶ï¼‰</h3>
      <canvas id="chartStatus" height="140" aria-label="ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹æ§‹æˆ"></canvas>
    </section>
  </div>
</main>

<div class="toast" id="toast"></div>
<div class="footer">Design by Wahyu</div>

<!-- Libs -->
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

<script>
/* ===== Drawer (mobile) ===== */
const drawer = document.getElementById('drawer');
document.getElementById('btnBurger')?.addEventListener('click', ()=>{
  drawer.classList.add('open'); drawer.setAttribute('aria-hidden','false');
});
drawer?.addEventListener('click', (e)=>{
  if(e.target.hasAttribute('data-close')){ drawer.classList.remove('open'); drawer.setAttribute('aria-hidden','true'); }
});

/* ===== Admin gate (UI only) ===== */
const ADMIN_CODE = "admin2025"; // ganti sesuai kebutuhan
function setAdmin(on){
  document.querySelectorAll('.admin-only').forEach(el=> el.style.display = on ? '' : 'none');
  localStorage.setItem('kensa_admin', on ? '1' : '0');
  const b=document.getElementById('btnAdmin'); if(b) b.textContent = on ? 'ç®¡ç†ï¼ˆONï¼‰' : 'ç®¡ç†';
}
function isAdmin(){ return localStorage.getItem('kensa_admin')==='1'; }
document.getElementById('btnAdmin')?.addEventListener('click', ()=>{
  if(isAdmin()){
    if(confirm('Adminã‚’OFFã«ã—ã¾ã™ã‹ï¼Ÿ')) setAdmin(false);
  }else{
    const c = prompt('Admin code:');
    if(c===ADMIN_CODE) setAdmin(true); else alert('ã‚³ãƒ¼ãƒ‰ãŒé•ã„ã¾ã™');
  }
});

/* ===== EDGE-HOVER sidebar (desktop) ===== */
const hot = document.getElementById('edgeHotspot');
const fly = document.getElementById('hoverSide');
let hideTimer = null;
const HIDE_DELAY = 280; // ms
function openFly(){ clearTimeout(hideTimer); fly.classList.add('open'); }
function scheduleClose(){ clearTimeout(hideTimer); hideTimer = setTimeout(()=>fly.classList.remove('open'), HIDE_DELAY); }
hot?.addEventListener('mouseenter', openFly);
hot?.addEventListener('mouseleave', scheduleClose);
fly?.addEventListener('mouseenter', ()=> clearTimeout(hideTimer));
fly?.addEventListener('mouseleave', scheduleClose);

/* ===== App Script endpoint (masih sama) ===== */
const Apps = { sheetUrl: 'https://script.google.com/macros/s/AKfycbxdZvt2CzA59f6AoUXOwmN_IxmTLu8GSFZgcdc1OfoHwrq71A5dLpt2T3X3m2Q5XhNHHQ/exec' };
const ConfigTypes = { customer:'å„å…ˆã‚¯ãƒ¬ãƒ¼ãƒ ', internal:'ç¤¾å†…ã‚¯ãƒ¬ãƒ¼ãƒ ', design:'è¨­è¨ˆå¤‰æ›´', kaizen:'æ”¹å–„', supplier:'å”åŠ›ä¼šç¤¾ã‚¯ãƒ¬ãƒ¼ãƒ ' };

/* ===== State / Utils ===== */
const $ = (s)=>document.querySelector(s);
const $$= (s)=>Array.from(document.querySelectorAll(s));
const state = { data:[] };
function uid(){return 'R'+Math.random().toString(36).slice(2,7).toUpperCase()+'-'+Date.now().toString(36).toUpperCase();}
function monthKey(dStr){ const d = dStr? new Date(dStr):null; if(!d||isNaN(d)) return null; return `${d.getFullYear()}-${String(d.getMonth()+1).padStart(2,'0')}`; }
function lastNMonthsLabels(n=12){ const a=[], now=new Date(); for(let i=n-1;i>=0;i--){const d=new Date(now.getFullYear(), now.getMonth()-i, 1); a.push(`${d.getFullYear()}-${String(d.getMonth()+1).padStart(2,'0')}`);} return a; }
function toast(msg,type='ok'){ const t=document.createElement('div'); t.className='t '+type; t.textContent=msg; $('#toast').appendChild(t); setTimeout(()=>t.remove(),3000); }

/* ===== Tabs (Jenis) ===== */
(function initJenis(){
  const host=document.querySelector('[aria-label="Jenis Form"]');
  host.addEventListener('click',e=>{
    const b=e.target.closest('[data-tab]'); if(!b) return;
    host.querySelectorAll('[data-tab]').forEach(x=>x.classList.remove('active'));
    b.classList.add('active');
    $('#type').value=b.dataset.tab;
    $('[name="isClaim"]').value = (b.dataset.tab==='customer') ? '1' : '0';
  });
})();

/* ===== Tabs (Phase) ===== */
(function initPhase(){
  const host=document.querySelector('[aria-label="Mode Form"]');
  const statusWrap = $('#statusField');
  const statusSel  = statusWrap.querySelector('select');

  function setPhase(mode){
    $('#phase').value = mode;
    $$('.phase-report').forEach(el=> el.style.display = (mode==='report') ? '' : 'none');
    $$('.phase-handling').forEach(el=> el.style.display = (mode==='handling') ? '' : 'none');
    const showStatus = (mode==='handling');
    statusWrap.style.display = showStatus ? '' : 'none';
    statusSel.disabled = !showStatus;
    if(!showStatus) statusSel.value='æœª';
  }

  host.addEventListener('click',e=>{
    const b=e.target.closest('[data-mode]'); if(!b) return;
    host.querySelectorAll('[data-mode]').forEach(x=>x.classList.remove('active'));
    b.classList.add('active');
    setPhase(b.dataset.mode);
  });

  setPhase('report');
})();

/* ===== Attachments validation (â‰¤20MB & â‰¤10 files) ===== */
(function initAttach(){
  const input = $('#attachments');
  const info  = $('#attachInfo');
  input.addEventListener('change', ()=>{
    const files=[...input.files];
    const total = files.reduce((n,f)=>n+f.size,0);
    info.textContent = `${files.length} file / ${(total/1024/1024).toFixed(1)} MB`;
    if(files.length>10 || total>20*1024*1024){
      toast('æ·»ä»˜ã¯æœ€å¤§10ä»¶ãƒ»åˆè¨ˆ20MBã¾ã§ã§ã™ã€‚', 'err');
      input.value = '';
      info.textContent = '';
    }
  });
})();

/* ===== Draft autosave ===== */
(function initDraft(){
  const KEY='claim_draft_v1';
  const form=$('#reportForm');
  const note=$('#draftNote');
  try{
    const saved=localStorage.getItem(KEY);
    if(saved){
      const obj=JSON.parse(saved);
      Object.entries(obj||{}).forEach(([k,v])=>{
        const el=form.querySelector(`[name="${k}"]`);
        if(el && el.type!=='file') el.value=v;
      });
      note.textContent='ä¸€æ™‚ä¿å­˜ã‚’å¾©å…ƒã—ã¾ã—ãŸ';
      toast('ä¸€æ™‚ä¿å­˜ã‚’å¾©å…ƒ', 'ok');
    }
  }catch(_){ localStorage.removeItem(KEY); }
  form.addEventListener('input', ()=>{
    const fd=new FormData(form);
    const obj=Object.fromEntries(fd.entries());
    delete obj.attachments;
    localStorage.setItem(KEY, JSON.stringify(obj));
    note.textContent='è‡ªå‹•ä¿å­˜ä¸­â€¦';
  });
  $('#btnClearDraft').addEventListener('click', ()=>{
    localStorage.removeItem(KEY);
    note.textContent='ä¸€æ™‚ä¿å­˜ã‚’å‰Šé™¤ã—ã¾ã—ãŸ';
    toast('ä¸€æ™‚ä¿å­˜ã‚¯ãƒªã‚¢', 'ok');
  });
  form.addEventListener('reset', ()=>{ setTimeout(()=>{ $('#attachInfo').textContent=''; }, 0); });
})();

/* ===== Send to Apps Script ===== */
async function fileToBase64(file){
  return new Promise((resolve,reject)=>{
    const fr=new FileReader();
    fr.onload=()=>{ const b64=String(fr.result).split(',')[1]; resolve({name:file.name,type:file.type,size:file.size,base64:b64}); };
    fr.onerror=reject; fr.readAsDataURL(file);
  });
}
async function sendToSheet(rec){
  const files = $('#attachments').files;
  const attachments = [];
  for(const f of files){ attachments.push(await fileToBase64(f)); }
  const payload = { ...rec, attachments };
  try{
    const res = await fetch(Apps.sheetUrl,{ method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify(payload) });
    if(!res.ok){
      await fetch(Apps.sheetUrl,{ method:'POST', mode:'no-cors', headers:{'Content-Type':'application/json'}, body: JSON.stringify(payload) });
    }
    toast('é€ä¿¡ã—ã¾ã—ãŸï¼ˆã‚ªãƒ³ãƒ©ã‚¤ãƒ³ï¼‰','ok');
  }catch(_){
    toast('ã‚ªãƒ•ãƒ©ã‚¤ãƒ³ä¿å­˜ï¼ˆæ¬¡å›ã‚ªãƒ³ãƒ©ã‚¤ãƒ³æ™‚ã«é€ä¿¡ã‚’è©¦è¡Œã—ã¦ãã ã•ã„ï¼‰','err');
  }
}

/* ===== Charts & List ===== */
let chartType=null, chartMonthly=null, chartStatus=null;

function render(){
  const q=$('#search').value.toLowerCase();
  const arr=state.data.filter(r=>!q || [r.title,r.dept,r.pic,r.reporter].some(v=>String(v||'').toLowerCase().includes(q)));

  // KPI
  $('#kpiTotal').textContent = arr.length;
  $('#kpiOpen').textContent  = arr.filter(x=>x.status==='æœª').length;
  $('#kpiProg').textContent  = arr.filter(x=>x.status==='é€²è¡Œä¸­').length;
  const ymNow=new Date().toISOString().slice(0,7);
  $('#kpiDone').textContent  = arr.filter(x=>x.status==='å®Œäº†' && String(x.date||'').startsWith(ymNow)).length;

  // List
  const list=$('#list'); list.innerHTML='';
  arr.sort((a,b)=> String(b.date||'').localeCompare(String(a.date||'')));
  arr.forEach(r=>{
    const div=document.createElement('div'); div.className='item';
    const status = r.status==='å®Œäº†'?'done':(r.status==='é€²è¡Œä¸­'?'prog':'open');
    div.innerHTML = `
      <div style="display:flex;align-items:center;gap:8px;flex-wrap:wrap">
        <strong>${r.title || '(ç„¡é¡Œ)'}</strong>
        <span class="tag">${ConfigTypes[r.type]||r.type}</span>
        ${r.isClaim?'<span class="tag">CLAIM</span>':''}
        ${r.status?`<span class="status ${status}">${r.status}</span>`:''}
      </div>
      <div class="sub">${r.date||''} ï½œ ${r.dept||''} ï½œ ${r.priority||''}${r.pic?` ï½œ PIC:${r.pic}`:''}</div>
    `;
    list.appendChild(div);
  });

  // Chart 1: By Type (report only)
  const labelsType=Object.values(ConfigTypes);
  const typeKeys=['customer','internal','design','kaizen','supplier'];
  const countsType=typeKeys.map(k=> arr.filter(x=>x.type===k && x.phase==='report').length);
  if(chartType) chartType.destroy();
  chartType=new Chart($('#chartByType'),{
    type:'bar',
    data:{labels:labelsType, datasets:[{label:'ä»¶æ•°ï¼ˆå ±å‘Šï¼‰', data:countsType}]},
    options:{responsive:true,plugins:{legend:{display:false}},animation:false}
  });

  // Chart 2: Monthly trend
  const months = lastNMonthsLabels(12);
  const countsReport  = months.map(m => arr.filter(x=> x.phase==='report'   && monthKey(x.date)===m).length);
  const countsHandling= months.map(m => arr.filter(x=> x.phase==='handling' && monthKey(x.date)===m).length);
  if(chartMonthly) chartMonthly.destroy();
  chartMonthly=new Chart($('#chartMonthly'),{
    type:'line',
    data:{labels:months, datasets:[
      {label:'å ±å‘Š', data:countsReport,   tension:.25, pointRadius:2},
      {label:'å¯¾å¿œ', data:countsHandling, tension:.25, pointRadius:2}
    ]},
    options:{responsive:true,maintainAspectRatio:false,scales:{y:{beginAtZero:true}},animation:false}
  });

  // Chart 3: Status pie
  const sOpen=arr.filter(x=>x.status==='æœª').length;
  const sProg=arr.filter(x=>x.status==='é€²è¡Œä¸­').length;
  const sDone=arr.filter(x=>x.status==='å®Œäº†').length;
  if(chartStatus) chartStatus.destroy();
  chartStatus=new Chart($('#chartStatus'),{
    type:'pie',
    data:{ labels:['æœª','é€²è¡Œä¸­','å®Œäº†'], datasets:[{ data:[sOpen,sProg,sDone] }] },
    options:{responsive:true,maintainAspectRatio:false,animation:false}
  });
}

/* ===== Export CSV (current view) ===== */
document.getElementById('btnExport').addEventListener('click', ()=>{
  const q=$('#search').value.toLowerCase();
  const arr=state.data.filter(r=>!q || [r.title,r.dept,r.pic,r.reporter].some(v=>String(v||'').toLowerCase().includes(q)));
  const headers=['id','createdAt','type','phase','title','date','reporter','email','dept','category','priority','status','isClaim','problem','rootcause','containment','corrective','preventive','pic','due'];
  const lines=[headers.join(',')];
  arr.forEach(r=>{
    const row=headers.map(h=>{
      const v=r[h]==null?'':String(r[h]).replace(/"/g,'""');
      return `"${v}"`;
    }).join(',');
    lines.push(row);
  });
  const blob=new Blob([lines.join('\n')],{type:'text/csv;charset=utf-8;'});
  const a=document.createElement('a'); a.href=URL.createObjectURL(blob); a.download='claims.csv'; a.click();
});

/* ===== Submit ===== */
document.getElementById('reportForm').addEventListener('submit', async e=>{
  e.preventDefault();
  const fd=new FormData(e.target);
  const rec=Object.fromEntries(fd.entries());

  if(rec.status==='Open') rec.status='æœª';
  if(rec.status==='In Progress') rec.status='é€²è¡Œä¸­';
  if(rec.status==='Done') rec.status='å®Œäº†';

  rec.isClaim = rec.isClaim==='1';
  rec.id=uid();
  rec.createdAt=new Date().toISOString();

  state.data.push(rec);
  render();

  await sendToSheet(rec);

  e.target.reset();
  document.querySelector('[data-tab="customer"]').click();
  document.querySelector('[data-mode="report"]').click();
  toast('ãƒ­ãƒ¼ã‚«ãƒ«ã«ä¿å­˜ã—ã¾ã—ãŸ','ok');
});

/* ===== Search live ===== */
document.getElementById('search').addEventListener('input', render);

/* ===== Init ===== */
window.addEventListener('DOMContentLoaded', ()=>{
  setAdmin(localStorage.getItem('kensa_admin')==='1'); // restore admin UI
  render();
});
</script>
</body>
</html>
