<!DOCTYPE html> 
<html lang="jp">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>ä¸å…·åˆãƒ»å¯¾ç­–</title>
  <style>
    :root{ --bg:#0b0f17; --card:#111827; --muted:#9ca3af; --text:#e5e7eb; --accent:#22d3ee; --ok:#22c55e; --warn:#f59e0b; --bad:#ef4444; --br:16px; }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{margin:0; font:14px/1.5 system-ui,-apple-system,Segoe UI,Roboto,Noto Sans,Helvetica,Arial,"Apple Color Emoji","Segoe UI Emoji"; background:linear-gradient(180deg,#0b0f17,#0b1320 60%,#0b0f17); color:var(--text)}
    header{position:sticky;top:0;z-index:5;background:rgba(11,15,23,.7);backdrop-filter: blur(8px);border-bottom:1px solid #1f2937}
    .wrap{max-width:1152px;margin:0 auto;padding:16px}
    h1{margin:0;font-size:20px;letter-spacing:.2px}
    .sub{color:var(--muted);font-size:12px}
    .grid{display:grid; gap:12px}
    .grid.cols-2{grid-template-columns: 1fr 1fr}
    .card{background:var(--card); border:1px solid #1f2937; border-radius:var(--br); padding:16px; box-shadow:0 10px 30px rgba(0,0,0,.25)}
    .section-title{font-weight:700;letter-spacing:.3px;margin:0 0 8px}
    label{display:block; font-size:12px; color:var(--muted); margin:8px 0 6px}
    input[type="text"],input[type="date"],input[type="email"],select,textarea{
      width:100%; padding:10px 12px; border-radius:10px; border:1px solid #283244; background:#0f172a; color:#fff; outline:none;
    }
    textarea{min-height:96px; resize:vertical}
    .row{display:flex; gap:8px; flex-wrap:wrap}
    .actions{display:flex; gap:8px; flex-wrap:wrap}
    button{border:0; padding:10px 14px; border-radius:10px; cursor:pointer; color:#07131a; font-weight:700}
    .btn{background:var(--accent)}
    .btn-outline{background:transparent; color:#e5e7eb; border:1px solid #334155}
    .pill{padding:6px 10px; border-radius:20px; border:1px solid #334155; color:#9ca3af}
    .tag{display:inline-block; padding:4px 8px; border-radius:999px; background:#0b1422; border:1px solid #243041; font-size:12px; color:#cbd5e1}
    .kpi{display:grid; grid-template-columns: repeat(4, minmax(0,1fr)); gap:12px}
    .kpi .card{display:grid; gap:6px}
    .kpi .big{font-size:28px; font-weight:800}
    .status{font-size:12px; padding:4px 8px; border-radius:999px; display:inline-block}
    .status.open{background:rgba(239,68,68,.15); color:#fecaca; border:1px solid rgba(239,68,68,.35)}
    .status.progress{background:rgba(245,158,11,.15); color:#fde68a; border:1px solid rgba(245,158,11,.35)}
    .status.done{background:rgba(34,197,94,.15); color:#bbf7d0; border:1px solid rgba(34,197,94,.35)}
    @media (max-width:900px){ .grid.cols-2{grid-template-columns:1fr} }
    .row[role="tablist"] [data-tab], .row[role="tablist"] [data-mode]{ cursor:pointer }
  </style>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
</head>
<body>
  <header>
    <div class="wrap row">
      <div>
        <h1>Portal Laporan <span class="tag">ä¸å…·åˆ</span> & <span class="tag">å¯¾ç­–</span></h1>
        <div class="sub">ã‚¯ãƒ¬ãƒ¼ãƒ å ±å‘Šã¨å¯¾å¿œï¼ˆphaseï¼‰ã‚’åˆ†é›¢ã—ã€Apps Script Type A ã«é€ä¿¡ã—ã¾ã™</div>
      </div>
      <div class="row" role="group" aria-label="Utility">
        <a class="btn-outline" href="./index.html" title="ãƒ›ãƒ¼ãƒ ">â† ãƒ›ãƒ¼ãƒ </a>
      </div>
    </div>
  </header>

  <main class="wrap grid cols-2" style="margin-top:12px">
    <!-- Form -->
    <section class="card">
      <h2 class="section-title">å“è³ªãƒ•ã‚©ãƒ¼ãƒ </h2>

      <!-- Jenis -->
      <div class="row" role="tablist" aria-label="Jenis Form">
        <button type="button" class="btn pill" data-tab="customer">å„å…ˆã‚¯ãƒ¬ãƒ¼ãƒ </button>
        <button type="button" class="btn-outline pill" data-tab="internal">ç¤¾å†…ã‚¯ãƒ¬ãƒ¼ãƒ </button>
        <button type="button" class="btn-outline pill" data-tab="design">è¨­è¨ˆå¤‰æ›´</button>
        <button type="button" class="btn-outline pill" data-tab="kaizen">æ”¹å–„</button>
        <button type="button" class="btn-outline pill" data-tab="supplier">å”åŠ›ä¼šç¤¾ã‚¯ãƒ¬ãƒ¼ãƒ </button>
      </div>

      <!-- Phase -->
      <div class="row" role="tablist" aria-label="Mode Form" style="margin-top:6px">
        <button type="button" class="btn pill" data-mode="report">ğŸ“ ã‚¯ãƒ¬ãƒ¼ãƒ å ±å‘Š</button>
        <button type="button" class="btn-outline pill" data-mode="handling">ğŸ›  ã‚¯ãƒ¬ãƒ¼ãƒ å¯¾å¿œ</button>
      </div>

      <form id="reportForm" class="grid cols-2" autocomplete="off">
        <input type="hidden" name="type" id="type" value="customer" />
        <input type="hidden" name="phase" id="phase" value="report" />

        <div><label>ã‚¿ã‚¤ãƒˆãƒ«</label><input type="text" name="title" required /></div>
        <div><label>æ—¥ä»˜</label><input type="date" name="date" required /></div>
        <div><label>å ±å‘Šè€…</label><input type="text" name="reporter" required /></div>
        <div><label>Email</label><input type="email" name="email" /></div>
        <div><label>éƒ¨ç½²</label><input type="text" name="dept" /></div>
        <div><label>ã‚«ãƒ†ã‚´ãƒª</label><input type="text" name="category" /></div>
        <div><label>å„ªå…ˆåº¦</label>
          <select name="priority"><option>ä½</option><option selected>ä¸­</option><option>é«˜</option></select>
        </div>

        <!-- çŠ¶æ³: tampil hanya di å¯¾å¿œ -->
        <div id="statusField"><label>çŠ¶æ³</label>
          <select name="status"><option selected>æœª</option><option>é€²è¡Œä¸­</option><option>å®Œäº†</option></select>
        </div>

        <div><label>å„å…ˆã‚¯ãƒ¬ãƒ¼ãƒ ?</label>
          <select name="isClaim"><option value="0">No</option><option value="1">Yes</option></select>
        </div>

        <!-- Laporan -->
        <div class="phase-report" style="grid-column:1/-1">
          <label>ä¸å…·åˆå†…å®¹ï¼ˆå ±å‘Šï¼‰</label>
          <textarea name="problem" placeholder="ç¾è±¡ã€è¦æ ¼ã€åŸºæº–ã€ç™ºç”Ÿæ¡ä»¶ãªã©"></textarea>
        </div>

        <!-- Penanganan -->
        <div class="grid cols-2 phase-handling" style="grid-column:1/-1; display:none">
          <div><label>åŸå› ï¼ˆ5Whyï¼‰</label><textarea name="rootcause"></textarea></div>
          <div><label>å¿œæ€¥å‡¦ç½®ï¼ˆContainmentï¼‰</label><textarea name="containment"></textarea></div>
          <div><label>æ’ä¹…å¯¾ç­–ï¼ˆCorrectiveï¼‰</label><textarea name="corrective"></textarea></div>
          <div><label>äºˆé˜²å‡¦ç½®ï¼ˆPreventiveï¼‰</label><textarea name="preventive"></textarea></div>
          <div><label>PICï¼ˆå¯¾å¿œè€…ï¼‰</label><input type="text" name="pic" /></div>
          <div><label>Dueï¼ˆå®Œäº†äºˆå®šï¼‰</label><input type="date" name="due" /></div>
        </div>

        <div style="grid-column:1/-1">
          <label>æ·»ä»˜ï¼ˆå†™çœŸãƒ»PDF ç­‰ï¼‰</label>
          <input type="file" name="attachments" id="attachments" multiple />
          <div class="hint">æ·»ä»˜ã‚µã‚¤ã‚º20MBä»¥ä¸‹ã€‚</div>
        </div>

        <div class="actions" style="grid-column:1/-1; margin-top:8px">
          <button type="submit" class="btn">ä¿å­˜</button>
          <button type="reset" class="btn-outline">ãƒªã‚»ãƒƒãƒˆ</button>
        </div>
      </form>
    </section>

    <!-- Data -->
    <section class="card">
      <h2 class="section-title">ãƒ‡ãƒ¼ã‚¿ & ã‚µãƒãƒªãƒ¼</h2>
      <div class="hint">ã€Œå„å…ˆã‚¯ãƒ¬ãƒ¼ãƒ ã€ã‚’é¸ã¶ã¨ isClaim=Yesã€ä»–ã¯ Noã€‚ãƒ•ã‚§ãƒ¼ã‚ºã«å¿œã˜ã¦åˆ¥ã‚¿ãƒ–ã¸ä¿å­˜ã—ã¾ã™ã€‚</div>

      <div class="kpi" style="margin-bottom:6px">
        <div class="card"><div class="muted">Total</div><div id="kpiTotal" class="big">0</div></div>
        <div class="card"><div class="muted">Open</div><div id="kpiOpen" class="big">0</div></div>
        <div class="card"><div class="muted">é€²è¡Œä¸­</div><div id="kpiProg" class="big">0</div></div>
        <div class="card"><div class="muted">ä»Šæœˆå®Œäº†</div><div id="kpiDone" class="big">0</div></div>
      </div>

      <div class="row">
        <input id="search" type="text" placeholder="æ¤œç´¢: ã‚¿ã‚¤ãƒˆãƒ«ãƒ»éƒ¨ç½²ãƒ»PICâ€¦" />
      </div>

      <div id="list" style="margin-top:8px"></div>

      <!-- Charts -->
      <h3 class="section-title" style="margin-top:14px">ğŸ“Š ç¨®åˆ¥åˆ¥ï¼ˆå ±å‘Šï¼‰</h3>
      <canvas id="chartByType" height="140"></canvas>

      <h3 class="section-title" style="margin-top:14px">ğŸ“ˆ æœˆæ¬¡ãƒˆãƒ¬ãƒ³ãƒ‰ï¼ˆå ±å‘Š vs å¯¾å¿œãƒ»12ãƒ¶æœˆï¼‰</h3>
      <canvas id="chartMonthly" height="140"></canvas>

      <h3 class="section-title" style="margin-top:14px">ğŸŸ¢ ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹æ§‹æˆï¼ˆå…¨ä»¶ï¼‰</h3>
      <canvas id="chartStatus" height="140"></canvas>
    </section>
  </main>

  <footer>Â© <span id="year"></span> To-Hatsu</footer>

  <script>
  // ===== Config Type A =====
  const Apps = {
    sheetUrl: 'https://script.google.com/macros/s/AKfycbxdZvt2CzA59f6AoUXOwmN_IxmTLu8GSFZgcdc1OfoHwrq71A5dLpt2T3X3m2Q5XhNHHQ/exec'
  };
  const ConfigTypes = { customer:'å„å…ˆã‚¯ãƒ¬ãƒ¼ãƒ ', internal:'ç¤¾å†…ã‚¯ãƒ¬ãƒ¼ãƒ ', design:'è¨­è¨ˆå¤‰æ›´', kaizen:'æ”¹å–„', supplier:'å”åŠ›ä¼šç¤¾ã‚¯ãƒ¬ãƒ¼ãƒ ' };

  // ===== State =====
  const state={data:[]}; const $=s=>document.querySelector(s); const $$=s=>Array.from(document.querySelectorAll(s));
  function uid(){return 'R'+Math.random().toString(36).slice(2,7).toUpperCase()+'-'+Date.now().toString(36).toUpperCase();}

  // ==== Tabs (Jenis) ====
  (function initJenis(){
    const host=document.querySelector('div[role="tablist"][aria-label="Jenis Form"]');
    host.addEventListener('click',e=>{
      const b=e.target.closest('[data-tab]'); if(!b) return;
      host.querySelectorAll('[data-tab]').forEach(x=>{x.classList.add('btn-outline');x.classList.remove('btn')});
      b.classList.remove('btn-outline'); b.classList.add('btn');
      const t=b.dataset.tab; $('#type').value=t;
      const claimSel=$('[name="isClaim"]'); if(claimSel) claimSel.value=(t==='customer')?'1':'0';
    });
  })();

  // ==== Tabs (Phase) ====
  (function initPhase(){
    const host=document.querySelector('div[role="tablist"][aria-label="Mode Form"]');
    const statusWrap = document.getElementById('statusField');
    const statusSel  = statusWrap.querySelector('select');

    function setPhase(mode){
      $('#phase').value = mode;
      $$('.phase-report').forEach(el=>el.style.display=(mode==='report')?'':'none');
      $$('.phase-handling').forEach(el=>el.style.display=(mode==='handling')?'':'none');

      // çŠ¶æ³: sembunyikan & disable di å ±å‘Š, tampil & enable di å¯¾å¿œ
      const showStatus = (mode==='handling');
      statusWrap.style.display = showStatus ? '' : 'none';
      statusSel.disabled = !showStatus;
      if(!showStatus){ statusSel.value = 'æœª'; } // reset default ketika disembunyikan
    }

    host.addEventListener('click',e=>{
      const b=e.target.closest('[data-mode]'); if(!b) return;
      host.querySelectorAll('[data-mode]').forEach(x=>{x.classList.add('btn-outline');x.classList.remove('btn')});
      b.classList.remove('btn-outline'); b.classList.add('btn');
      setPhase(b.dataset.mode);
    });

    // set default
    setPhase('report');
  })();

  // ==== Send to Apps Script Type A ====
  async function fileToBase64(file){
    return new Promise((resolve,reject)=>{
      const fr=new FileReader();
      fr.onload=()=>{ const b64=String(fr.result).split(',')[1]; resolve({name:file.name,type:file.type,size:file.size,base64:b64}); };
      fr.onerror=reject; fr.readAsDataURL(file);
    });
  }
  async function sendToSheet(rec){
    const files = $('#attachments').files;
    const attachments = [];
    for(const f of files){ attachments.push(await fileToBase64(f)); }
    const payload = { ...rec, attachments };
    try{
      const res = await fetch(Apps.sheetUrl,{ method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify(payload) });
      if(!res.ok){ await fetch(Apps.sheetUrl,{ method:'POST', mode:'no-cors', headers:{'Content-Type':'application/json'}, body: JSON.stringify(payload) }); }
    }catch(_){ /* ignore for offline */ }
  }

  // ==== Helpers for charts ====
  function monthKey(dStr){
    const d = dStr ? new Date(dStr) : null;
    if(!d || isNaN(d)) return null;
    return `${d.getFullYear()}-${String(d.getMonth()+1).padStart(2,'0')}`; // YYYY-MM
  }
  function lastNMonthsLabels(n=12){
    const a=[]; const now=new Date();
    for(let i=n-1;i>=0;i--){
      const d=new Date(now.getFullYear(), now.getMonth()-i, 1);
      a.push(`${d.getFullYear()}-${String(d.getMonth()+1).padStart(2,'0')}`);
    }
    return a;
  }

  // ==== Render (list & charts) ====
  let chartType=null, chartMonthly=null, chartStatus=null;
  function render(){
    const q=$('#search').value.toLowerCase();
    const arr=state.data.filter(r=>!q || [r.title,r.dept,r.pic,r.reporter].some(v=>String(v||'').toLowerCase().includes(q)));

    // KPI
    $('#kpiTotal').textContent = arr.length;
    $('#kpiOpen').textContent  = arr.filter(x=>x.status==='æœª').length;
    $('#kpiProg').textContent  = arr.filter(x=>x.status==='é€²è¡Œä¸­').length;
    const ymNow=new Date().toISOString().slice(0,7);
    $('#kpiDone').textContent  = arr.filter(x=>x.status==='å®Œäº†' && String(x.date||'').startsWith(ymNow)).length;

    // List
    const list=$('#list'); list.innerHTML='';
    arr.sort((a,b)=> String(b.date||'').localeCompare(String(a.date||'')));
    arr.forEach(r=>{
      const div=document.createElement('div');
      div.className='card'; div.style.padding='10px';
      div.innerHTML = `<strong>${r.title}</strong> <span class="tag">${ConfigTypes[r.type]||r.type}</span> ${r.isClaim?'<span class="tag">CLAIM</span>':''}
      <div class="muted">${r.date||''} ï½œ ${r.dept||''} ï½œ ${r.priority||''}${r.status?` ï½œ ${r.status}`:''}</div>`;
      list.appendChild(div);
    });

    // --- Chart 1: By Type (report only)
    const labelsType=Object.values(ConfigTypes);
    const countsType=['customer','internal','design','kaizen','supplier'].map(k=> arr.filter(x=>x.type===k && x.phase==='report').length);
    if(chartType) chartType.destroy();
    chartType=new Chart($('#chartByType'),{
      type:'bar',
      data:{labels:labelsType, datasets:[{label:'ä»¶æ•°ï¼ˆå ±å‘Šï¼‰', data:countsType}]},
      options:{plugins:{legend:{display:false}}}
    });

    // --- Chart 2: Monthly trend (last 12 months, report vs handling)
    const labelsMonth = lastNMonthsLabels(12);
    const countsReport  = labelsMonth.map(m => arr.filter(x=> x.phase==='report'   && monthKey(x.date)===m).length);
    const countsHandling= labelsMonth.map(m => arr.filter(x=> x.phase==='handling' && monthKey(x.date)===m).length);
    if(chartMonthly) chartMonthly.destroy();
    chartMonthly=new Chart($('#chartMonthly'),{
      type:'line',
      data:{labels:labelsMonth, datasets:[
        {label:'å ±å‘Š',   data:countsReport,   fill:false, tension:.2},
        {label:'å¯¾å¿œ',   data:countsHandling, fill:false, tension:.2}
      ]},
      options:{scales:{ y:{ beginAtZero:true } }}
    });

    // --- Chart 3: Status pie (all phases)
    const sOpen   = arr.filter(x=>x.status==='æœª').length;
    const sProg   = arr.filter(x=>x.status==='é€²è¡Œä¸­').length;
    const sDone   = arr.filter(x=>x.status==='å®Œäº†').length;
    if(chartStatus) chartStatus.destroy();
    chartStatus=new Chart($('#chartStatus'),{
      type:'pie',
      data:{ labels:['æœª','é€²è¡Œä¸­','å®Œäº†'], datasets:[{ data:[sOpen,sProg,sDone] }] },
      options:{}
    });
  }

  // ==== Form submit ====
  $('#reportForm').addEventListener('submit', async e=>{
    e.preventDefault();
    const fd=new FormData(e.target);
    const rec=Object.fromEntries(fd.entries());
    // normalisasi JP status jika ada nilai EN
    if(rec.status==='Open') rec.status='æœª';
    if(rec.status==='In Progress') rec.status='é€²è¡Œä¸­';
    if(rec.status==='Done') rec.status='å®Œäº†';
    rec.isClaim = rec.isClaim==='1';
    rec.id=uid(); rec.createdAt=new Date().toISOString();

    state.data.push(rec);
    render();

    await sendToSheet(rec);

    e.target.reset();
    document.querySelector('[data-tab="customer"]').click();
    document.querySelector('[data-mode="report"]').click();
  });

  // ==== Init ====
  document.getElementById('year').textContent=new Date().getFullYear();
  document.getElementById('search').addEventListener('input', render);
  document.querySelector('[data-tab="customer"]').click();
  document.querySelector('[data-mode="report"]').click();
  render(); // render awal
  </script>
</body>
</html>
