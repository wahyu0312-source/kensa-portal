<!doctype html>
<html lang="ja" data-theme="light">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>ã‚¯ãƒ¬ãƒ¼ãƒ å¯è¦–åŒ–ï¼ˆå¹´æœˆãƒ»ã‚¯ãƒ¬ãƒ¼ãƒ ç¨®é¡ãƒ»æ©Ÿç¨®åãƒ»éƒ¨ç½²ï¼‰</title>
  <!-- Tailwind (CDN) -->
  <script src="https://cdn.tailwindcss.com"></script>
  <!-- Chart.js -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>
  <!-- Chart.js DataLabels plugin -->
  <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-datalabels@2.2.0"></script>
  <!-- Papa Parse for CSV -->
  <script src="https://cdn.jsdelivr.net/npm/papaparse@5.4.1/papaparse.min.js"></script>
  <style>
    .sticky-header { position: sticky; top: 0; z-index: 20; }
    .chart-box { height: 360px; }
  </style>
</head>
<body class="bg-slate-50 text-slate-800">
  <header class="sticky-header bg-white/80 backdrop-blur border-b border-slate-200">
    <div class="max-w-6xl mx-auto px-4 py-3 flex flex-wrap items-center gap-3">
      <a href="index.html" class="inline-flex items-center gap-2 px-3 py-1.5 rounded-lg border text-sm hover:bg-slate-50">
        <span>ğŸ </span><span>Home</span>
      </a>
      <h1 class="text-xl font-semibold ml-2">ã‚¯ãƒ¬ãƒ¼ãƒ å¯è¦–åŒ–</h1>
      <span class="text-sm text-slate-500">ï¼ˆå¹´æœˆãƒ»ã‚¯ãƒ¬ãƒ¼ãƒ ç¨®é¡ãƒ»æ©Ÿç¨®åãƒ»éƒ¨ç½²ï¼‰</span>
      <div class="ml-auto text-xs text-slate-500" id="lastLoaded"></div>
    </div>
  </header>

  <main class="max-w-6xl mx-auto px-4 py-6 space-y-6">
    <!-- ãƒ•ã‚£ãƒ«ã‚¿ -->
    <section class="bg-white rounded-2xl shadow p-4">
      <h2 class="text-lg font-semibold mb-3">ãƒ•ã‚£ãƒ«ã‚¿</h2>
      <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-3">
        <div>
          <label class="block text-sm font-medium mb-1" for="fYM">å¹´æœˆ</label>
          <select id="fYM" class="w-full border rounded-xl px-3 py-2"></select>
        </div>
        <div>
          <label class="block text-sm font-medium mb-1" for="fType">ã‚¯ãƒ¬ãƒ¼ãƒ ç¨®é¡</label>
          <select id="fType" class="w-full border rounded-xl px-3 py-2"></select>
        </div>
        <div>
          <label class="block text-sm font-medium mb-1" for="fModel">æ©Ÿç¨®å</label>
          <select id="fModel" class="w-full border rounded-xl px-3 py-2"></select>
        </div>
        <div>
          <label class="block text-sm font-medium mb-1" for="fDept">éƒ¨ç½²</label>
          <select id="fDept" class="w-full border rounded-xl px-3 py-2"></select>
        </div>
      </div>
      <div class="mt-3 flex gap-2">
        <button id="clearFilters" class="px-3 py-2 rounded-xl bg-slate-200 hover:bg-slate-300">ãƒ•ã‚£ãƒ«ã‚¿å…¨è§£é™¤</button>
      </div>
    </section>

    <!-- Charts (bar) -->
    <section class="grid grid-cols-1 lg:grid-cols-2 gap-6">
      <div class="bg-white rounded-2xl shadow p-4 flex flex-col">
        <div class="flex items-center">
          <h3 class="text-base font-semibold">ä»¶æ•°ï¼ˆå¹´æœˆï¼‰</h3>
          <button data-chart="ym" class="ml-auto text-xs px-2 py-1 rounded-lg border exportBtn">PNGä¿å­˜</button>
        </div>
        <div class="chart-box"><canvas id="chartYM"></canvas></div>
      </div>
      <div class="bg-white rounded-2xl shadow p-4 flex flex-col">
        <div class="flex items-center">
          <h3 class="text-base font-semibold">ä»¶æ•°ï¼ˆã‚¯ãƒ¬ãƒ¼ãƒ ç¨®é¡ï¼‰</h3>
          <button data-chart="type" class="ml-auto text-xs px-2 py-1 rounded-lg border exportBtn">PNGä¿å­˜</button>
        </div>
        <div class="chart-box"><canvas id="chartType"></canvas></div>
      </div>
      <div class="bg-white rounded-2xl shadow p-4 flex flex-col">
        <div class="flex items-center">
          <h3 class="text-base font-semibold">ä»¶æ•°ï¼ˆæ©Ÿç¨®åï¼‰</h3>
          <button data-chart="model" class="ml-auto text-xs px-2 py-1 rounded-lg border exportBtn">PNGä¿å­˜</button>
        </div>
        <div class="chart-box"><canvas id="chartModel"></canvas></div>
      </div>
      <div class="bg-white rounded-2xl shadow p-4 flex flex-col">
        <div class="flex items-center">
          <h3 class="text-base font-semibold">ä»¶æ•°ï¼ˆéƒ¨ç½²ï¼‰</h3>
          <button data-chart="dept" class="ml-auto text-xs px-2 py-1 rounded-lg border exportBtn">PNGä¿å­˜</button>
        </div>
        <div class="chart-box"><canvas id="chartDept"></canvas></div>
      </div>
    </section>

    <!-- Charts (Pareto & Pie) -->
    <section class="grid grid-cols-1 lg:grid-cols-2 gap-6">
      <div class="bg-white rounded-2xl shadow p-4 flex flex-col">
        <div class="flex items-center">
          <h3 class="text-base font-semibold">ãƒ‘ãƒ¬ãƒ¼ãƒˆï¼ˆã‚¯ãƒ¬ãƒ¼ãƒ ç¨®é¡ï¼‰</h3>
          <button data-chart="paretoType" class="ml-auto text-xs px-2 py-1 rounded-lg border exportBtn">PNGä¿å­˜</button>
        </div>
        <div class="chart-box"><canvas id="chartParetoType"></canvas></div>
      </div>
      <div class="bg-white rounded-2xl shadow p-4 flex flex-col">
        <div class="flex items-center">
          <h3 class="text-base font-semibold">å††ã‚°ãƒ©ãƒ•ï¼ˆéƒ¨ç½²ï¼‰</h3>
          <button data-chart="pieDept" class="ml-auto text-xs px-2 py-1 rounded-lg border exportBtn">PNGä¿å­˜</button>
        </div>
        <div class="chart-box"><canvas id="chartPieDept"></canvas></div>
      </div>
    </section>

    <!-- ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ï¼ˆä»»æ„ï¼‰ -->
    <section class="bg-white rounded-2xl shadow p-4">
      <details>
        <summary class="cursor-pointer select-none font-medium">ãƒ‡ãƒ¼ã‚¿æ•°è¡Œãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼</summary>
        <div class="overflow-x-auto mt-3">
          <table id="previewTable" class="min-w-full text-sm border">
            <thead class="bg-slate-100" id="previewHead"></thead>
            <tbody id="previewBody"></tbody>
          </table>
        </div>
      </details>
    </section>
  </main>

  <template id="optionTpl"><option></option></template>

  <script>
    // ======= CSV URL & CORS fallbacks =======
    const DIRECT_CSV = "https://docs.google.com/spreadsheets/d/e/2PACX-1vQGwY4tjwfHVYZMuJpqSVo9uqHexcD2bmHdCiIg85oo036PLkxe4YXhHCpJbFi1mT1VgyjfNYLHOtNb/pub?gid=1070847733&single=true&output=csv";
    function buildProxyUrls(url){
      const noProto = url.replace(/^https?:\/\//, "");
      return [ url, `https://r.jina.ai/http://${noProto}`, `https://cors.isomorphic-git.org/${url}` ];
    }
    async function fetchTextWithFallback(url){
      const tries = buildProxyUrls(url);
      let lastErr;
      for (const u of tries){
        try{
          const res = await fetch(u, { mode: "cors" });
          if(!res.ok) throw new Error(`HTTP ${res.status}`);
          const text = await res.text();
          if(text) return { url: u, text };
        }catch(e){ lastErr = e; }
      }
      throw lastErr || new Error("Fetch failed");
    }

    // ======= Utils =======
    const $  = (sel) => document.querySelector(sel);
    const $$ = (sel) => Array.from(document.querySelectorAll(sel));

    const requiredKeys = {
      ym: ["å¹´æœˆ","yearmonth","year-month","å¹´æœˆæ—¥","ym"],
      type: ["ã‚¯ãƒ¬ãƒ¼ãƒ ç¨®é¡","ã‚¯ãƒ¬ãƒ¼ãƒ ç¨®åˆ¥","ã‚¯ãƒ¬ãƒ¼ãƒ ","ç¨®åˆ¥","claimtype"],
      model: ["æ©Ÿç¨®å","æ©Ÿç¨®","å‹å¼","model"],
      dept: ["éƒ¨ç½²","éƒ¨é–€","éƒ¨èª²","éƒ¨ç½²å","department"],
    };
    function normalizeHeader(h){ return String(h||"").trim().toLowerCase().replace(/[\s_\-/]/g,""); }
    function autoMapHeaders(headers){
      const norm = headers.map(h=>({raw:h,n:normalizeHeader(h)}));
      const pick = (cands)=>{ for(const c of cands){ const f = norm.find(x=>x.n.includes(normalizeHeader(c))); if(f) return f.raw; } return headers[0]||""; };
      return { ym:pick(requiredKeys.ym), type:pick(requiredKeys.type), model:pick(requiredKeys.model), dept:pick(requiredKeys.dept) };
    }

    // === Normalize any date-like value â†’ YYYY-MM ===
    function normalizeYM(v){
      if(v==null) return "";
      const s = String(v).trim();
      if(!s) return "";
      const m1 = s.match(/^(\d{4})[-\/.](\d{1,2})(?:[-\/.]\d{1,2})?$/);
      if(m1){ const y=m1[1]; const m=m1[2].padStart(2,"0"); return `${y}-${m}`; }
      const m2 = s.match(/(\d{4})\s*å¹´\s*(\d{1,2})\s*æœˆ?/);
      if(m2){ const y=m2[1]; const m=m2[2].padStart(2,"0"); return `${y}-${m}`; }
      const m3 = s.match(/^(\d{4})(\d{2})(\d{0,2})?$/);
      if(m3){ const y=m3[1]; const m=m3[2]; return `${y}-${m}`; }
      const m4 = s.match(/^(\d{4})[-\/.](\d{1,2})$/);
      if(m4){ const y=m4[1]; const m=m4[2].padStart(2,"0"); return `${y}-${m}`; }
      const d = new Date(s);
      if(!Number.isNaN(d.getTime())){ const y=d.getFullYear(); const m=String(d.getMonth()+1).padStart(2,"0"); return `${y}-${m}`; }
      return s;
    }

    function countsBy(arr, keyFn){
      const map = new Map();
      for(const a of arr){ const k = keyFn(a); if(!k) continue; map.set(k,(map.get(k)||0)+1); }
      return Array.from(map.entries()).sort((a,b)=>a[0]>b[0]?1:-1);
    }
    function uniqueValues(arr, key){
      const s=new Set(); arr.forEach(r=>{ const v=(r[key]??"").toString().trim(); if(v) s.add(v); });
      return Array.from(s).sort();
    }
    function fillSelect(sel, values, {withAll=true,labelAll="(ã™ã¹ã¦)"}={}){
      sel.innerHTML=""; if(withAll){ const o=document.createElement("option"); o.value=""; o.textContent=labelAll; sel.appendChild(o); }
      for(const v of values){ const o=document.createElement("option"); o.value=v; o.textContent=v; sel.appendChild(o); }
    }
    function downloadImageFromChart(chart, filename){ const a=document.createElement("a"); a.href=chart.toBase64Image(); a.download=filename; a.click(); }

    // --- Colors: special mapping for éƒ¨ç½² ---
    const deptColorMap = {
      "ã‚³ãƒ³ãƒ™ãƒ¤ãƒ¼":   "#3b82f6", // blue-500
      "ã‚·ãƒ£ãƒˆãƒ«ã‚¬ãƒ¼ãƒ‰": "#f50b59"  // pink
    };
    const fallbackPalette = ["#6366F1","#10B981","#EF4444","#8B5CF6","#06B6D4","#84CC16","#F97316","#14B8A6","#A855F7","#22C55E","#EAB308","#F43F5E"];
    function hexToRgba(hex, alpha=0.6){
      const m = hex.replace("#",""); const r=parseInt(m.substring(0,2),16), g=parseInt(m.substring(2,4),16), b=parseInt(m.substring(4,6),16);
      return `rgba(${r},${g},${b},${alpha})`;
    }
    function colorForDept(label, alphaBg=true, idx=0){
      const base = deptColorMap[label] || fallbackPalette[idx % fallbackPalette.length];
      return alphaBg ? hexToRgba(base,0.55) : base;
    }

    // ======= State =======
    let rawRows=[], headers=[], mapping={ym:"",type:"",model:"",dept:""};
    let chartYM, chartType, chartModel, chartDept, chartParetoType, chartPieDept;

    // ======= Helpers =======
    // wrap JP text into multi-line (for long ã‚¯ãƒ¬ãƒ¼ãƒ ç¨®é¡ labels)
    function wrapJP(text, max = 6) {
      const s = String(text ?? "");
      const lines = [];
      for (let i = 0; i < s.length; i += max) lines.push(s.slice(i, i + max));
      return lines;
    }

    // ======= Rendering =======
    function renderPreview(rows, max=10){
      const head=$("#previewHead"), body=$("#previewBody"); head.innerHTML=""; body.innerHTML="";
      if(!rows.length) return;
      const tr=document.createElement("tr");
      headers.forEach(h=>{ const th=document.createElement("th"); th.className="px-2 py-1 border text-left font-medium"; th.textContent=h; tr.appendChild(th); });
      head.appendChild(tr);
      rows.slice(0,max).forEach(r=>{ const trb=document.createElement("tr"); headers.forEach(h=>{ const td=document.createElement("td"); td.className="px-2 py-1 border"; td.textContent=r[h]??""; trb.appendChild(td); }); body.appendChild(trb); });
    }

    function currentFilters(){ return { ym:$("#fYM").value, type:$("#fType").value, model:$("#fModel").value, dept:$("#fDept").value }; }

    function applyFilters(rows){
      const f=currentFilters();
      return rows.filter(r=>{
        if(f.ym && normalizeYM(r[mapping.ym])!==f.ym) return false;
        if(f.type && r[mapping.type]!==f.type) return false;
        if(f.model && r[mapping.model]!==f.model) return false;
        if(f.dept && r[mapping.dept]!==f.dept) return false;
        return true;
      });
    }

    function refreshFilters(){
      const rows=rawRows;
      const ymValues = Array.from(new Set(rows.map(r=>normalizeYM(r[mapping.ym])).filter(Boolean))).sort();
      const typeValues = uniqueValues(rows, mapping.type);
      const modelValues = uniqueValues(rows, mapping.model);
      const deptValues = uniqueValues(rows, mapping.dept);
      fillSelect($("#fYM"), ymValues);
      fillSelect($("#fType"), typeValues);
      fillSelect($("#fModel"), modelValues);
      fillSelect($("#fDept"), deptValues);
    }

    function destroyCharts(){
      [chartYM, chartType, chartModel, chartDept, chartParetoType, chartPieDept].forEach(ch=>{ if(ch) ch.destroy(); });
      chartYM=chartType=chartModel=chartDept=chartParetoType=chartPieDept=undefined;
    }

    function buildCharts(){
      const rows = applyFilters(rawRows);

      // å¹´æœˆ
      const ymCounts = countsBy(rows, r=>normalizeYM(r[mapping.ym]));
      const ymLabels = ymCounts.map(([k])=>k);
      const ymData   = ymCounts.map(([,v])=>v);

      // æ©Ÿç¨®
      const modelCounts = countsBy(rows, r=>(r[mapping.model]||"").toString().trim());
      const modelLabels = modelCounts.map(([k])=>k || "ï¼ˆæœªè¨­å®šï¼‰");
      const modelData   = modelCounts.map(([,v])=>v);

      // éƒ¨ç½²
      const deptCounts = countsBy(rows, r=>(r[mapping.dept]||"").toString().trim());
      const deptLabels = deptCounts.map(([k])=>k || "ï¼ˆæœªè¨­å®šï¼‰");
      const deptData   = deptCounts.map(([,v])=>v);
      const deptBG = deptLabels.map((l,i)=>colorForDept(l,true,i));
      const deptBD = deptLabels.map((l,i)=>colorForDept(l,false,i));

      // ---- ã‚¯ãƒ¬ãƒ¼ãƒ ç¨®é¡ (horizontal + wrapped labels) ----
      const typeCounts = countsBy(rows, r => (r[mapping.type] || "").toString().trim());
      const typeLabels = typeCounts.map(([k]) => k || "ï¼ˆæœªè¨­å®šï¼‰");
      const typeData   = typeCounts.map(([, v]) => v);
      const typeLabelsWrapped = typeLabels.map(l => wrapJP(l, 6));

      // Re-render
      destroyCharts();
      const commonOptions = (isHorizontal=false)=>({
        responsive:true, maintainAspectRatio:false, animation:false, indexAxis:isHorizontal?'y':'x',
        scales:{ x:{ ticks:{ maxRotation:0, autoSkip:true } }, y:{ beginAtZero:true, ticks:{ precision:0 } } },
        plugins:{ legend:{ display:false }, datalabels:{ anchor:'end', align:isHorizontal?'right':'top', offset:4, formatter:v=>v, font:{ weight:'600' } } }
      });

      try{ Chart.register(ChartDataLabels); }catch(_){}

      chartYM = new Chart($("#chartYM"), { type:"bar", data:{ labels:ymLabels, datasets:[{ label:"ä»¶æ•°", data:ymData }] }, options:commonOptions(false) });

      chartType = new Chart($("#chartType"), {
        type:"bar",
        data:{ labels:typeLabelsWrapped, datasets:[{ label:"ä»¶æ•°", data:typeData }] },
        options:{
          responsive:true, maintainAspectRatio:false, animation:false, indexAxis:'y',
          scales:{ y:{ beginAtZero:true, ticks:{ autoSkip:false } }, x:{ beginAtZero:true, ticks:{ precision:0 } } },
          plugins:{
            legend:{ display:false },
            tooltip:{ callbacks:{ title:(items)=> typeLabels[items[0].dataIndex] || "" } },
            datalabels:{ anchor:'end', align:'right', offset:4, formatter:v=>v, font:{ weight:'600' } }
          }
        }
      });

      const modelHorizontal = modelLabels.length > 6;
      chartModel = new Chart($("#chartModel"), { type:"bar", data:{ labels:modelLabels, datasets:[{ label:"ä»¶æ•°", data:modelData }] }, options:commonOptions(modelHorizontal) });

      const deptHorizontal = deptLabels.length > 6;
      chartDept = new Chart($("#chartDept"), {
        type:"bar",
        data:{ labels:deptLabels, datasets:[{ label:"ä»¶æ•°", data:deptData, backgroundColor:deptBG, borderColor:deptBD, borderWidth:1 }] },
        options:commonOptions(deptHorizontal)
      });

      // ---- Pareto (ç¨®é¡) ----
      const totalType = typeData.reduce((a,b)=>a+b,0) || 1;
      const pairs = typeLabels.map((l,i)=>[l, typeData[i]]).sort((a,b)=>b[1]-a[1]);
      const pLabels = pairs.map(p=>p[0]);
      const pBars   = pairs.map(p=>p[1]);
      let cum=0; const pCumPct = pBars.map(v => (cum+=v, +(cum/totalType*100).toFixed(1)));
      chartParetoType = new Chart($("#chartParetoType"), {
        data: {
          labels: pLabels,
          datasets: [
            { type:"bar",  label:"ä»¶æ•°", data:pBars, yAxisID:"y", datalabels:{ align:'end', anchor:'end' } },
            { type:"line", label:"ç´¯ç©%", data:pCumPct, yAxisID:"y1", tension:0.3, pointRadius:3, datalabels:{ align:'top', formatter:v=>v+'%' } }
          ]
        },
        options: {
          responsive:true, maintainAspectRatio:false, animation:false,
          scales: { y: { beginAtZero:true, ticks:{ precision:0 } },
                   y1:{ position:"right", beginAtZero:true, min:0, max:100, ticks:{ callback:v=>v+'%' }, grid:{ drawOnChartArea:false } } },
          plugins:{ legend:{ display:true } }
        }
      });

      // ---- Pie (éƒ¨ç½²) ----
      const pieBG = deptLabels.map((l,i)=>colorForDept(l,true,i));
      const pieBD = deptLabels.map((l,i)=>colorForDept(l,false,i));
      chartPieDept = new Chart($("#chartPieDept"), {
        type:"pie",
        data:{ labels:deptLabels, datasets:[{ data:deptData, backgroundColor:pieBG, borderColor:pieBD, borderWidth:1 }] },
        options:{
          responsive:true, maintainAspectRatio:false,
          plugins:{
            legend:{ position:"right" },
            datalabels:{ formatter:(v,ctx)=>{ const sum=ctx.dataset.data.reduce((a,b)=>a+b,0)||1; const pct=(v/sum*100).toFixed(0); return pct+'%'; } }
          }
        }
      });
    }

    function applyMappingAndRender(){ refreshFilters(); buildCharts(); }

    // ======= Load CSV =======
    async function loadCSV(url){
      $("#lastLoaded").textContent = "èª­ã¿è¾¼ã¿ä¸­â€¦";
      try{
        const { url:used, text } = await fetchTextWithFallback(url);
        const parsed = Papa.parse(text, { header:true, skipEmptyLines:true });
        rawRows = parsed.data;
        headers = parsed.meta.fields || Object.keys(rawRows[0]||{});
        renderPreview(rawRows);
        mapping = autoMapHeaders(headers);
        applyMappingAndRender();
        $("#lastLoaded").textContent = `æœ€çµ‚èª­è¾¼: ${new Date().toLocaleString()}ï¼ˆ${used.includes("r.jina.ai")?"proxy":"direct"}ï¼‰`;
      }catch(e){
        console.error(e);
        $("#lastLoaded").textContent = "èª­ã¿è¾¼ã¿å¤±æ•—: " + (e?.message || e);
      }
    }

    // Events
    $$("#fYM, #fType, #fModel, #fDept").forEach(sel=>sel.addEventListener("change", buildCharts));
    $("#clearFilters").addEventListener("click", ()=>{ $$("#fYM, #fType, #fModel, #fDept").forEach(s=>s.value=""); buildCharts(); });
    $$(".exportBtn").forEach(btn=>btn.addEventListener("click", ()=>{
      const map = { ym:chartYM, type:chartType, model:chartModel, dept:chartDept, paretoType:chartParetoType, pieDept:chartPieDept };
      const inst = map[btn.dataset.chart];
      if(inst) downloadImageFromChart(inst, `chart-${btn.dataset.chart}.png`);
    }));

    // åˆæœŸèª­ã¿è¾¼ã¿
    window.addEventListener("DOMContentLoaded", ()=> loadCSV(DIRECT_CSV));
  </script>
</body>
</html>
