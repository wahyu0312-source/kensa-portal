<!doctype html>
<html lang="ja" data-theme="light">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>品質情報</title>

<style>
  :root{
    --bg:#f6f7fb; --panel:#fff; --ink:#0f172a; --muted:#64748b; --border:#e5e7eb; --ring:#c7d2fe;
    --accent:#2563eb; --radius-xl:22px; --radius:12px;
    --shadow-1:0 12px 30px rgba(15,23,42,.08); --shadow-2:0 30px 60px rgba(15,23,42,.10);
  }
  [data-theme="dark"]{
    --bg:#0b1220; --panel:#0f172a; --ink:#e5e7eb; --muted:#94a3b8; --border:#1f2937; --ring:#243b55;
    --accent:#60a5fa; --shadow-1:none; --shadow-2:none;
  }
  *{box-sizing:border-box}
  html,body{height:100%}
  body{
    margin:0; color:var(--ink);
    font-family:system-ui,-apple-system,Segoe UI,Roboto,"Noto Sans JP","Yu Gothic",sans-serif;
    background:
      radial-gradient(1100px 540px at -12% -12%, #c7d2fe33 0%, transparent 60%),
      radial-gradient(820px 460px at 112% -6%, #bae6fd33 0%, transparent 55%),
      linear-gradient(120deg,#f8fafc,var(--bg));
    overflow-x: hidden;
  }

  .app{
    display:grid;
    grid-template-rows:64px 1fr;
    grid-template-areas:
      "header"
      "main";
    min-height:100vh;
  }
  header{
    grid-area:header; position:sticky; top:0; z-index:60;
    backdrop-filter: blur(12px);
    background: color-mix(in srgb, var(--panel) 85%, transparent);
    border-bottom:1px solid var(--border);
  }
  .header-wrap{
    height:64px; max-width:1400px; margin:0 auto;
    display:flex; align-items:center; justify-content:space-between; gap:12px; padding:0 20px;
  }
  .brand{display:flex; align-items:center; gap:10px}
  .brand img{height:36px}
  .brand .ttl{font-weight:800}

  .top-actions{display:flex; gap:8px; align-items:center; flex-wrap:wrap}
  .btn{
    height:34px; padding:0 12px; border:1px solid var(--border); border-radius:10px; background:var(--panel);
    color:var(--ink); display:inline-flex; align-items:center; gap:8px; cursor:pointer; text-decoration:none;
  }
  .btn:hover{ border-color:var(--ring) }

  /* Hover Sidebar (desktop) */
  .edge-hotspot{
    position:fixed; left:0; top:64px; width:12px; height:calc(100vh - 64px); z-index:70;
  }
  .hover-side{
    position:fixed; left:0; top:64px; height:calc(100vh - 64px);
    width:260px; padding:14px 12px; overflow:auto;
    background:var(--panel); border-right:1px solid var(--border); box-shadow:var(--shadow-1);
    transform:translateX(-100%); transition:transform .22s ease; z-index:71;
  }
  .hover-side.open{ transform:translateX(0) }
  .hover-side h3{ margin:4px 8px 10px; font-size:12px; letter-spacing:.08em; color:#6b7280; text-transform:uppercase }
  .navlist{ display:grid; gap:4px }
  .slink{ display:flex; align-items:center; gap:10px; padding:10px 12px; border-radius:12px; color:var(--ink); text-decoration:none }
  .slink:hover{ background:#f1f5ff }
  [data-theme="dark"] .slink:hover{ background:#132033 }
  .admin-only{ display:none } /* default hidden */

  /* Drawer (mobile) */
  .burger{display:none; align-items:center; justify-content:center; width:38px; height:38px;
          border:1px solid var(--border); border-radius:10px; background:#fff; cursor:pointer}
  .burger:active{transform:scale(.98)}
  .drawer{ position:fixed; inset:0; z-index:80; display:none }
  .drawer.open{ display:block }
  .drawer .backdrop{ position:absolute; inset:0; background:#0006 }
  .drawer .panel{ position:absolute; top:0; left:0; height:100%; width:min(86%,320px);
                  background:#fff; border-right:1px solid var(--border); box-shadow:var(--shadow-2); padding:14px 12px; overflow:auto;
                  transform:translateX(-100%); transition:transform .25s ease }
  .drawer.open .panel{ transform:translateX(0) }
  .drawer .close{ position:absolute; right:10px; top:10px; border:0; background:#f1f5f9; border:1px solid var(--border); border-radius:8px; padding:6px 10px; cursor:pointer }

  main{ grid-area:main; max-width:1400px; margin:0 auto; padding:22px 20px 64px; overflow-x: clip; }
  .card{ background:var(--panel); border:1px solid var(--border); border-radius:var(--radius-xl); box-shadow:var(--shadow-2); padding:18px }
  .card + .card{ margin-top:16px }
  .h1{ font-size:22px; margin:0 }
  .small{ font-size:12px; color:var(--muted) }

  .grid{ display:grid; gap:12px; grid-template-columns:repeat(4,minmax(0,1fr)) }
  @media (max-width:1000px){ .grid{ grid-template-columns:repeat(2,minmax(0,1fr)) } }
  @media (max-width:620px){ .grid{ grid-template-columns:1fr } }

  .field label{ display:block; font-size:12px; font-weight:700; color:var(--muted); margin:0 0 6px }
  .select{ width:100%; height:38px; padding:0 12px; border:1px solid var(--border); border-radius:12px; background:var(--panel) }
  .btn-ghost{ background:#f1f5f9 }
  [data-theme="dark"] .btn-ghost{ background:#0b1624 }

  .chart-grid{ display:grid; gap:16px; grid-template-columns:1fr 1fr }
  .chart-box{ background:var(--panel); border:1px solid var(--border); border-radius:16px; padding:12px; min-height:360px; display:flex; flex-direction:column }
  .chart-head{ display:flex; align-items:center; gap:8px; margin-bottom:6px }
  .chart-head .sp{ margin-left:auto }
  .export{ height:28px; padding:0 10px; border:1px solid var(--border); border-radius:8px; background:var(--panel); cursor:pointer; font-size:12px }
  .chart-canvas{ flex:1; min-height:300px; display:block; width:100% !important; height:320px !important; }
  @media (max-width:900px){ .chart-grid{ grid-template-columns:1fr } }

  table{ width:100%; border-collapse:collapse; }
  th,td{ border:1px solid var(--border); padding:8px 10px; text-align:left; font-size:13px }
  thead th{ background:#f8fafc }
  [data-theme="dark"] thead th{ background:#0b1624 }

  @media (max-width:900px){
    .burger{ display:inline-flex }
    .edge-hotspot, .hover-side{ display:none }
  }
</style>
</head>

<body>
<div class="app">
  <!-- HEADER -->
  <header>
    <div class="header-wrap">
      <button id="btnBurger" class="burger" aria-label="メニュー"><span>☰</span></button>
      <div class="brand">
        <img src="tsh.png" alt="TSH"><strong class="ttl">品質管理生産技術</strong>
      </div>
      <nav class="top-actions">
        <a class="btn" href="./index.html">🏠 ホーム</a>
        <a class="btn" href="./forms.html">📄 出荷検査成績書</a>
        <a class="btn" href="./sagyoutejunsho.html">📝 作業手順書</a>
        <a class="btn" href="./charts.html">📈 チャート</a>
        <a class="btn" href="./quality.html" aria-current="page">🔎 品質情報</a>
        <button id="btnAdmin" class="btn" type="button" title="Admin login/logout">管理</button>
        <span id="lastLoaded" class="small" style="margin-left:8px"></span>
      </nav>
    </div>
  </header>

  <!-- MAIN -->
  <main>
    <section class="card">
      <div style="display:flex;align-items:end;gap:12px;justify-content:space-between;margin-bottom:12px">
        <h1 class="h1">品質情報</h1>
        <span class="small">（年月・クレーム種類・機種名・部署）</span>
      </div>

      <div class="grid">
        <div class="field">
          <label for="fYM">年月</label>
          <select id="fYM" class="select"></select>
        </div>
        <div class="field">
          <label for="fType">クレーム種類</label>
          <select id="fType" class="select"></select>
        </div>
        <div class="field">
          <label for="fModel">機種名</label>
          <select id="fModel" class="select"></select>
        </div>
        <div class="field">
          <label for="fDept">部署</label>
          <select id="fDept" class="select"></select>
        </div>
      </div>
      <div style="margin-top:10px;display:flex;gap:8px;flex-wrap:wrap">
        <button id="clearFilters" class="btn btn-ghost">フィルタ全解除</button>
      </div>
    </section>

    <section class="chart-grid" style="margin-top:16px">
      <div class="chart-box">
        <div class="chart-head"><strong>件数（年月）</strong><span class="sp"></span><button data-chart="ym" class="export">PNG保存</button></div>
        <canvas id="chartYM" class="chart-canvas"></canvas>
      </div>
      <div class="chart-box">
        <div class="chart-head"><strong>件数（クレーム種類）</strong><span class="sp"></span><button data-chart="type" class="export">PNG保存</button></div>
        <canvas id="chartType" class="chart-canvas"></canvas>
      </div>
      <div class="chart-box">
        <div class="chart-head"><strong>件数（機種名）</strong><span class="sp"></span><button data-chart="model" class="export">PNG保存</button></div>
        <canvas id="chartModel" class="chart-canvas"></canvas>
      </div>
      <div class="chart-box">
        <div class="chart-head"><strong>件数（部署）</strong><span class="sp"></span><button data-chart="dept" class="export">PNG保存</button></div>
        <canvas id="chartDept" class="chart-canvas"></canvas>
      </div>
    </section>

    <section class="chart-grid" style="margin-top:16px">
      <div class="chart-box">
        <div class="chart-head"><strong>パレート（クレーム種類）</strong><span class="sp"></span><button data-chart="paretoType" class="export">PNG保存</button></div>
        <canvas id="chartParetoType" class="chart-canvas"></canvas>
      </div>
      <div class="chart-box">
        <div class="chart-head"><strong>円グラフ（部署）</strong><span class="sp"></span><button data-chart="pieDept" class="export">PNG保存</button></div>
        <canvas id="chartPieDept" class="chart-canvas"></canvas>
      </div>
    </section>

    <section class="card" style="margin-top:16px">
      <details>
        <summary>データ数行プレビュー</summary>
        <div style="overflow:auto;margin-top:10px">
          <table>
            <thead id="previewHead"></thead>
            <tbody id="previewBody"></tbody>
          </table>
        </div>
      </details>
    </section>
  </main>
</div>

<!-- Hover Sidebar (desktop) -->
<div id="edgeHotspot" class="edge-hotspot" aria-hidden="true"></div>
<aside id="hoverSide" class="hover-side" aria-label="Pages">
  <h3>Pages</h3>
  <div class="navlist">
    <a class="slink" href="./index.html"><span class="ico">🏠</span><strong>ホーム</strong></a>
    <a class="slink" href="./forms.html"><span class="ico">📄</span><strong>出荷検査成績書</strong></a>
    <a class="slink" href="./sagyoutejunsho.html"><span class="ico">📝</span><strong>作業手順書</strong></a>
    <a class="slink" href="./charts.html"><span class="ico">📈</span><strong>チャート</strong></a>
    <a class="slink" href="./quality.html"><span class="ico">🔎</span><strong>品質情報</strong></a>
    <a class="slink admin-only" href="./claim.html"><span class="ico">🧪</span><strong>Trial Page</strong></a>
  </div>

  <div class="admin-only" style="margin-top:12px">
    <h3>Admin</h3>
    <div class="navlist">
      <a class="slink" href="./admin-numbering.html"><span class="ico">#</span><strong>Admin Numbering</strong></a>
      <a class="slink" href="./admin-prefix.html"><span class="ico">🔧</span><strong>Admin Prefix</strong></a>
      <a class="slink" href="./admin-serial-gas.html"><span class="ico">⛽</span><strong>Admin Serial Gas</strong></a>
      <a class="slink" href="./thanks.html"><span class="ico">✨</span><strong>Thanks</strong></a>
    </div>
  </div>
</aside>

<!-- Drawer (mobile) -->
<div id="drawer" class="drawer" aria-hidden="true">
  <div class="backdrop" data-close></div>
  <aside class="panel">
    <button class="close" data-close>✕</button>
    <div class="side-card" style="box-shadow:none;border:0;padding-top:30px">
      <h3>Pages</h3>
      <div class="navlist">
        <a class="slink" href="./index.html"><span class="ico">🏠</span><strong>ホーム</strong></a>
        <a class="slink" href="./forms.html"><span class="ico">📄</span><strong>出荷検査成績書</strong></a>
        <a class="slink" href="./sagyoutejunsho.html"><span class="ico">📝</span><strong>作業手順書</strong></a>
        <a class="slink" href="./charts.html"><span class="ico">📈</span><strong>チャート</strong></a>
        <a class="slink" href="./quality.html"><span class="ico">🔎</span><strong>品質情報</strong></a>
        <a class="slink admin-only" href="./claim.html"><span class="ico">🧪</span><strong>Trial Page</strong></a>
      </div>

      <div class="admin-only" style="margin-top:12px">
        <h3>Admin</h3>
        <div class="navlist">
          <a class="slink" href="./admin-numbering.html"><span class="ico">#</span><strong>Admin Numbering</strong></a>
          <a class="slink" href="./admin-prefix.html"><span class="ico">🔧</span><strong>Admin Prefix</strong></a>
          <a class="slink" href="./admin-serial-gas.html"><span class="ico">⛽</span><strong>Admin Serial Gas</strong></a>
          <a class="slink" href="./thanks.html"><span class="ico">✨</span><strong>Thanks</strong></a>
        </div>
      </div>
    </div>
  </aside>
</div>

<!-- Libs -->
<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-datalabels@2.2.0"></script>
<script src="https://cdn.jsdelivr.net/npm/papaparse@5.4.1/papaparse.min.js"></script>

<script>
/* ========= Drawer (mobile) ========= */
const drawer = document.getElementById('drawer');
document.getElementById('btnBurger')?.addEventListener('click', ()=>{
  drawer.classList.add('open'); drawer.setAttribute('aria-hidden','false');
});
drawer?.addEventListener('click', (e)=>{
  if(e.target.hasAttribute('data-close')){ drawer.classList.remove('open'); drawer.setAttribute('aria-hidden','true'); }
});

/* ========= Admin gate (UI only) ========= */
const ADMIN_CODE = "admin2025";
function setAdmin(on){
  document.querySelectorAll('.admin-only').forEach(el=> el.style.display = on ? '' : 'none');
  localStorage.setItem('kensa_admin', on ? '1' : '0');
  const b=document.getElementById('btnAdmin'); if(b) b.textContent = on ? '管理（ON）' : '管理';
}
function isAdmin(){ return localStorage.getItem('kensa_admin')==='1'; }
document.getElementById('btnAdmin')?.addEventListener('click', ()=>{
  if(isAdmin()){
    if(confirm('AdminをOFFにしますか？')) setAdmin(false);
  }else{
    const c = prompt('Admin code:');
    if(c===ADMIN_CODE) setAdmin(true); else alert('コードが違います');
  }
});

/* ========= EDGE-HOVER sidebar (desktop) ========= */
const hot = document.getElementById('edgeHotspot');
const fly = document.getElementById('hoverSide');
let hideTimer = null;
const HIDE_DELAY = 280;
function openFly(){ clearTimeout(hideTimer); fly.classList.add('open'); }
function scheduleClose(){ clearTimeout(hideTimer); hideTimer = setTimeout(()=>fly.classList.remove('open'), HIDE_DELAY); }
hot?.addEventListener('mouseenter', openFly);
hot?.addEventListener('mouseleave', scheduleClose);
fly?.addEventListener('mouseenter', ()=> clearTimeout(hideTimer));
fly?.addEventListener('mouseleave', scheduleClose);

/* ===== CSV URL + fallbacks ===== */
const DIRECT_CSV = "https://docs.google.com/spreadsheets/d/e/2PACX-1vQGwY4tjwfHVYZMuJpqSVo9uqHexcD2bmHdCiIg85oo036PLkxe4YXhHCpJbFi1mT1VgyjfNYLHOtNb/pub?gid=1070847733&single=true&output=csv";
function buildProxyUrls(url){
  const noProto = url.replace(/^https?:\/\//, "");
  return [ url, `https://r.jina.ai/http/${noProto}`, `https://cors.isomorphic-git.org/${url}` ];
}
async function fetchTextWithFallback(url){
  const tries = buildProxyUrls(url);
  let lastErr;
  for(const u of tries){
    try{
      const res = await fetch(u, {mode:"cors"});
      if(!res.ok) throw new Error(`HTTP ${res.status}`);
      const text = await res.text();
      if(text) return { url:u, text };
    }catch(e){ lastErr = e; }
  }
  throw lastErr || new Error("Fetch failed");
}

/* ===== Utils ===== */
const $  = (s)=>document.querySelector(s);
const $$ = (s)=>Array.from(document.querySelectorAll(s));
const requiredKeys = {
  ym: ["年月","yearmonth","year-month","年月日","ym"],
  type: ["クレーム種類","クレーム種別","クレーム","種別","claimtype"],
  model: ["機種名","機種","型式","model"],
  dept: ["部署","部門","部課","部署名","department"],
};
function normalizeHeader(h){ return String(h||"").trim().toLowerCase().replace(/[\s_\-/]/g,""); }
function autoMapHeaders(headers){
  const norm = headers.map(h=>({raw:h,n:normalizeHeader(h)}));
  const pick = (cands)=>{ for(const c of cands){ const f = norm.find(x=>x.n.includes(normalizeHeader(c))); if(f) return f.raw; } return headers[0]||""; };
  return { ym:pick(requiredKeys.ym), type:pick(requiredKeys.type), model:pick(requiredKeys.model), dept:pick(requiredKeys.dept) };
}
function normalizeYM(v){
  if(v==null) return "";
  const s=String(v).trim(); if(!s) return "";
  const m1=s.match(/^(\d{4})[-\/.](\d{1,2})(?:[-\/.]\d{1,2})?$/); if(m1) return `${m1[1]}-${m1[2].padStart(2,"0")}`;
  const m2=s.match(/(\d{4})\s*年\s*(\d{1,2})/); if(m2) return `${m2[1]}-${m2[2].padStart(2,"0")}`;
  const m3=s.match(/^(\d{4})(\d{2})(\d{0,2})?$/); if(m3) return `${m3[1]}-${m3[2]}`;
  const m4=s.match(/^(\d{4})[-\/.](\d{1,2})$/);   if(m4) return `${m4[1]}-${m4[2].padStart(2,"0")}`;
  const d=new Date(s); if(!Number.isNaN(d.getTime())) return `${d.getFullYear()}-${String(d.getMonth()+1).padStart(2,"0")}`;
  return s;
}

/* countsBy: bisa keepEmpty */
function countsBy(arr, keyFn, { keepEmpty=false } = {}){
  const map=new Map();
  for(const a of arr){
    const k = keyFn(a);
    if (!keepEmpty && !k) continue;
    const key = (k ?? "").toString();
    map.set(key,(map.get(key)||0)+1);
  }
  return Array.from(map.entries()).sort((a,b)=>a[0]>b[0]?1:-1);
}
function uniqueValues(arr, key){
  const s=new Set(); arr.forEach(r=>{ const v=(r[key]??"").toString().trim(); if(v) s.add(v); });
  return Array.from(s).sort();
}
function downloadImageFromChart(chart, filename){ const a=document.createElement("a"); a.href=chart.toBase64Image(); a.download=filename; a.click(); }

/* Palette */
const deptColorMap = { "コンベヤー":"#3b82f6", "シャトルガード":"#f50b59" };
const palette = ["#6366F1","#10B981","#EF4444","#8B5CF6","#06B6D4","#84CC16","#F97316","#14B8A6","#A855F7","#22C55E","#EAB308","#F43F5E"];
const hexToRgba=(hex,a=0.55)=>{const h=hex.replace("#","");const r=parseInt(h.slice(0,2),16),g=parseInt(h.slice(2,4),16),b=parseInt(h.slice(4,6),16);return`rgba(${r},${g},${b},${a})`};
function colorForDept(label,i){ const base = deptColorMap[label] || palette[i%palette.length]; return {bg:hexToRgba(base,0.55), bd:base }; }

/* Chart defaults */
Chart.register(ChartDataLabels);
Chart.defaults.animation = false;
Chart.defaults.transitions = {
  active: { animation: { duration: 0 } },
  resize: { animation: { duration: 0 } }
};
Chart.defaults.responsive = true;
Chart.defaults.maintainAspectRatio = false;

/* ===== State ===== */
let rawRows=[], headers=[], mapping={ym:"",type:"",model:"",dept:""};
let chartYM, chartType, chartModel, chartDept, chartParetoType, chartPieDept;

/* ===== Preview ===== */
function renderPreview(rows, max=10){
  const head=$("#previewHead"), body=$("#previewBody"); head.innerHTML=""; body.innerHTML="";
  if(!rows.length) return;
  const tr=document.createElement("tr");
  headers.forEach(h=>{ const th=document.createElement("th"); th.textContent=h; tr.appendChild(th); });
  head.appendChild(tr);
  rows.slice(0,max).forEach(r=>{ const trb=document.createElement("tr"); headers.forEach(h=>{ const td=document.createElement("td"); td.textContent=r[h]??""; trb.appendChild(td); }); body.appendChild(trb); });
}

/* ===== Filters ===== */
function currentFilters(){ return { ym:$("#fYM").value, type:$("#fType").value, model:$("#fModel").value, dept:$("#fDept").value }; }
function applyFilters(rows){
  const f=currentFilters();
  return rows.filter(r=>{
    if(f.ym && normalizeYM(r[mapping.ym])!==f.ym) return false;
    if(f.type && r[mapping.type]!==f.type) return false;
    if(f.model && r[mapping.model]!==f.model) return false;
    if(f.dept && r[mapping.dept]!==f.dept) return false;
    return true;
  });
}
function refreshFilters(){
  const rows=rawRows;
  const ymValues = Array.from(new Set(rows.map(r=>normalizeYM(r[mapping.ym])).filter(Boolean))).sort();
  const typeValues = uniqueValues(rows, mapping.type);
  const modelValues = uniqueValues(rows, mapping.model);
  const deptValues = uniqueValues(rows, mapping.dept);

  const fill=(sel,values,labelAll="(すべて)")=>{
    sel.innerHTML=""; const o=document.createElement("option"); o.value=""; o.textContent=labelAll; sel.appendChild(o);
    values.forEach(v=>{ const op=document.createElement("option"); op.value=v; op.textContent=v; sel.appendChild(op); });
  };
  fill($("#fYM"), ymValues);
  fill($("#fType"), typeValues);
  fill($("#fModel"), modelValues);
  fill($("#fDept"), deptValues);
}
function destroyCharts(){ [chartYM, chartType, chartModel, chartDept, chartParetoType, chartPieDept].forEach(ch=>{ if(ch) ch.destroy?.(); }); }

/* ===== Empty State ===== */
function drawEmpty(canvas, msg="データなし"){
  const rect = canvas.getBoundingClientRect();
  const ctx = canvas.getContext('2d');
  canvas.width = rect.width;  // ensure proper text centering
  canvas.height = rect.height;
  ctx.clearRect(0,0,canvas.width,canvas.height);
  ctx.font = '14px system-ui';
  ctx.textAlign = 'center';
  ctx.fillStyle = '#94a3b8';
  ctx.fillText(msg, canvas.width/2, canvas.height/2);
}

/* ===== Charts ===== */
function wrapJP(text,max=6){ const s=String(text??""); const out=[]; for(let i=0;i<s.length;i+=max) out.push(s.slice(i,i+max)); return out; }
function barOpts(horiz=false){
  return {
    responsive:true, maintainAspectRatio:false, resizeDelay:200,
    animation:false, indexAxis:horiz?'y':'x',
    scales:{ x:{ ticks:{ maxRotation:0, autoSkip:true } }, y:{ beginAtZero:true, ticks:{ precision:0 } } },
    plugins:{ legend:{ display:false }, datalabels:{ anchor:'end', align:horiz?'right':'top', offset:4, formatter:v=>v, font:{ weight:'600' }, clamp:true, clip:false } }
  };
}

function buildCharts(){
  const rows = applyFilters(rawRows);

  // 年月
  const ymCounts = countsBy(rows, r=>normalizeYM(r[mapping.ym]), { keepEmpty:false });
  const ymLabels = ymCounts.map(([k])=>k);
  const ymData   = ymCounts.map(([,v])=>v);

  // 機種（kosong dihitung）
  const modelCounts = countsBy(rows, r=>(r[mapping.model]??"").toString().trim(), { keepEmpty:true });
  const modelLabels = modelCounts.map(([k])=>k || "（未設定）");
  const modelData   = modelCounts.map(([,v])=>v);

  // 部署（kosong dihitung）
  const deptCounts = countsBy(rows, r=>(r[mapping.dept]??"").toString().trim(), { keepEmpty:true });
  const deptLabels = deptCounts.map(([k])=>k || "（未設定）");
  const deptData   = deptCounts.map(([,v])=>v);
  const deptColors = deptLabels.map((l,i)=>colorForDept(l,i));

  // 種類（kosong dihitung）
  const typeCounts = countsBy(rows, r=>(r[mapping.type]??"").toString().trim(), { keepEmpty:true });
  const typeLabels = typeCounts.map(([k])=>k || "（未設定）");
  const typeData   = typeCounts.map(([,v])=>v);
  const typeLabelsWrapped = typeLabels.map(l=>wrapJP(l, 6));

  destroyCharts();

  // Render or empty
  if(ymLabels.length===0) drawEmpty($("#chartYM")); else
    chartYM = new Chart($("#chartYM"), { type:"bar", data:{ labels:ymLabels, datasets:[{ label:"件数", data:ymData }] }, options:barOpts(false) });

  if(typeLabels.length===0) drawEmpty($("#chartType")); else
    chartType = new Chart($("#chartType"), {
      type:"bar",
      data:{ labels:typeLabelsWrapped, datasets:[{ label:"件数", data:typeData }] },
      options:{
        responsive:true, maintainAspectRatio:false, resizeDelay:200,
        animation:false, indexAxis:'y',
        scales:{ y:{ beginAtZero:true, ticks:{ autoSkip:false } }, x:{ beginAtZero:true, ticks:{ precision:0 } } },
        plugins:{
          legend:{ display:false },
          tooltip:{ callbacks:{ title:(items)=> typeLabels[items[0].dataIndex] || "" } },
          datalabels:{ anchor:'end', align:'right', offset:4, formatter:v=>v, font:{ weight:'600' }, clamp:true, clip:false }
        }
      }
    });

  const modelHoriz = modelLabels.length>6;
  if(modelLabels.length===0) drawEmpty($("#chartModel")); else
    chartModel = new Chart($("#chartModel"), { type:"bar", data:{ labels:modelLabels, datasets:[{ label:"件数", data:modelData }] }, options:barOpts(modelHoriz) });

  const deptHoriz = deptLabels.length>6;
  if(deptLabels.length===0) drawEmpty($("#chartDept")); else
    chartDept = new Chart($("#chartDept"), {
      type:"bar",
      data:{ labels:deptLabels, datasets:[{ label:"件数", data:deptData, backgroundColor:deptColors.map(c=>c.bg), borderColor:deptColors.map(c=>c.bd), borderWidth:1 }] },
      options:barOpts(deptHoriz)
    });

  // Pareto (種類)
  if(typeLabels.length===0){
    drawEmpty($("#chartParetoType"));
  }else{
    const totalType = typeData.reduce((a,b)=>a+b,0) || 1;
    const pairs = typeLabels.map((l,i)=>[l, typeData[i]]).sort((a,b)=>b[1]-a[1]);
    const pLabels = pairs.map(p=>p[0]); const pBars=pairs.map(p=>p[1]);
    let cum=0; const pCumPct = pBars.map(v => (cum+=v, +(cum/totalType*100).toFixed(1)));
    chartParetoType = new Chart($("#chartParetoType"), {
      data:{
        labels:pLabels,
        datasets:[
          { type:"bar", label:"件数", data:pBars, yAxisID:"y", datalabels:{ align:'end', anchor:'end', clamp:true, clip:false } },
          { type:"line", label:"累積%", data:pCumPct, yAxisID:"y1", tension:0.3, pointRadius:3, datalabels:{ align:'top', formatter:v=>v+'%' } }
        ]
      },
      options:{
        responsive:true, maintainAspectRatio:false, resizeDelay:200, animation:false,
        scales:{ y:{ beginAtZero:true, ticks:{ precision:0 } }, y1:{ position:"right", beginAtZero:true, min:0, max:100, ticks:{ callback:v=>v+'%' }, grid:{ drawOnChartArea:false } } },
        plugins:{ legend:{ display:true } }
      }
    });
  }

  // Pie (部署)
  if(deptLabels.length===0){
    drawEmpty($("#chartPieDept"));
  }else{
    chartPieDept = new Chart($("#chartPieDept"), {
      type:"pie",
      data:{ labels:deptLabels, datasets:[{ data:deptData, backgroundColor:deptColors.map(c=>c.bg), borderColor:deptColors.map(c=>c.bd), borderWidth:1 }] },
      options:{
        responsive:true, maintainAspectRatio:false, animation:false, resizeDelay:200,
        plugins:{
          legend:{ position:"right" },
          datalabels:{ formatter:(v,ctx)=>{ const sum=ctx.dataset.data.reduce((a,b)=>a+b,0)||1; return Math.round(v/sum*100)+'%'; } }
        }
      }
    });
  }
}

/* ===== Load CSV ===== */
async function loadCSV(url){
  document.getElementById("lastLoaded").textContent = "読み込み中…";
  try{
    const { url:used, text } = await fetchTextWithFallback(url);
    const parsed = Papa.parse(text, { header:true, skipEmptyLines:true });
    rawRows = parsed.data;
    headers = parsed.meta.fields || Object.keys(rawRows[0]||{});
    renderPreview(rawRows);
    mapping = autoMapHeaders(headers);
    refreshFilters();
    buildCharts();
    document.getElementById("lastLoaded").textContent = `最終読込: ${new Date().toLocaleString()}（${used.includes("r.jina.ai")?"proxy":"direct"}）`;
  }catch(e){
    console.error(e);
    document.getElementById("lastLoaded").textContent = "読み込み失敗: " + (e?.message || e);
    // draw empties to avoid blank canvases
    ["#chartYM","#chartType","#chartModel","#chartDept","#chartParetoType","#chartPieDept"].forEach(sel=>drawEmpty(document.querySelector(sel), "読み込み失敗"));
  }
}

/* ===== Events ===== */
["#fYM","#fType","#fModel","#fDept"].forEach(sel=>{
  document.querySelector(sel).addEventListener("change", buildCharts);
});
document.getElementById("clearFilters").addEventListener("click", ()=>{
  ["#fYM","#fType","#fModel","#fDept"].forEach(s=>document.querySelector(s).value="");
  buildCharts();
});
document.querySelectorAll(".export").forEach(btn=>btn.addEventListener("click", ()=>{
  const map = { ym:chartYM, type:chartType, model:chartModel, dept:chartDept, paretoType:chartParetoType, pieDept:chartPieDept };
  const inst = map[btn.dataset.chart];
  if(inst) downloadImageFromChart(inst, `chart-${btn.dataset.chart}.png`);
  else alert("このグラフは現在データがありません。");
}));

/* ===== Init ===== */
window.addEventListener("DOMContentLoaded", ()=>{
  setAdmin(localStorage.getItem('kensa_admin')==='1');
  loadCSV(DIRECT_CSV);
});
</script>
</body>
</html>
