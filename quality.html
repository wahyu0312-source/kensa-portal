<!doctype html>
<html lang="ja" data-theme="light">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>品質情報（グラフ）</title>
<style>
  :root{--bg1:#eef2ff;--bg2:#f8fafc;--card:#fff;--ink:#0f172a;--muted:#64748b;--border:#e5e7eb;--accent:#2563eb;--shadow:0 30px 60px rgba(15,23,42,.08);--radius:20px;--grid:#e5e7eb}
  [data-theme="dark"]{--bg1:#0b1220;--bg2:#0b1220;--card:#0f172a;--ink:#e5e7eb;--muted:#94a3b8;--border:#1f2937;--accent:#60a5fa;--shadow:none;--grid:#223044}
  *{box-sizing:border-box} html,body{height:100%}
  body{margin:0;color:var(--ink);font-family:system-ui,-apple-system,Segoe UI,Roboto,"Noto Sans JP","Yu Gothic",sans-serif;
       background:
        radial-gradient(1200px 600px at -10% -10%, #c7d2fe33 0%, transparent 60%),
        radial-gradient(900px 500px at 110% 0%, #bae6fd33 0%, transparent 55%),
        linear-gradient(120deg,var(--bg1),var(--bg2))}
  header{position:sticky;top:0;z-index:10;background:#ffffffcc;backdrop-filter:blur(10px);border-bottom:1px solid var(--border)}
  [data-theme="dark"] header{background:#0f172acc}
  .wrap{max-width:1200px;margin:0 auto;padding:12px 20px}
  .row{display:flex;justify-content:space-between;align-items:center;gap:16px}
  nav a{margin-left:18px;color:var(--accent);font-weight:700;text-decoration:none}
  nav a:hover{text-decoration:underline}
  .controls{display:flex;gap:8px;align-items:center}
  .btn{padding:8px 12px;border:1px solid var(--border);border-radius:10px;background:var(--card);color:var(--ink);cursor:pointer}
  .btn[disabled]{opacity:.6;cursor:not-allowed}
  .small{font-size:12px;color:var(--muted)}
  main{max-width:1200px;margin:26px auto;padding:0 20px}
  .card{background:var(--card);border:1px solid var(--border);border-radius:20px;box-shadow:0 30px 60px rgba(15,23,42,.08);padding:18px}
  .filterbar{display:flex;gap:8px;align-items:center;flex-wrap:wrap}
  .chart-grid{display:grid;grid-template-columns:1fr 1fr;gap:16px}
  .chart-box{background:var(--card);border:1px solid var(--border);border-radius:16px;padding:12px;min-height:380px;display:flex;align-items:center;justify-content:center}
  .chart-box.wide{grid-column:1/-1}
  .chart-box canvas{width:100%!important;height:330px!important}
  @media (max-width:900px){.chart-grid{grid-template-columns:1fr}}
  .banner{max-width:1200px;margin:0 auto 10px;padding:8px 12px;border:1px solid #f0ad4e;background:#fffbe6;color:#6b4f00;border-radius:10px;font-size:13px}
  .chip{display:inline-block;font-size:12px;background:#e2e8f0;border:1px solid #cbd5e1;border-radius:999px;padding:2px 8px;margin-left:8px}
  .footer{margin:18px 0 8px;text-align:center;font-size:12px;color:var(--muted)}
</style>
</head>
<body>
<header>
  <div class="wrap row">
    <div style="display:flex;align-items:center;gap:10px">
      <img src="tsh.png" alt="TSH" style="height:36px">
      <strong>品質情報</strong>
      <span id="stat" class="chip" style="display:none"></span>
    </div>
    <nav><a href="./index.html">ホーム</a></nav>
    <div class="controls">
      <button id="btnRefresh" class="btn" type="button">Refresh now</button>
      <label class="small" style="display:flex;align-items:center;gap:6px"><input id="chkDark" type="checkbox"> Dark</label>
    </div>
  </div>
</header>

<main>
  <div id="err" class="banner" style="display:none"></div>

  <section class="card" style="margin-bottom:16px">
    <div class="filterbar">
      <label class="small">Top 件数:</label>
      <select id="selTop" class="btn"><option>5</option><option selected>10</option><option>15</option><option>30</option></select>

      <label class="small">年:</label>
      <select id="selYear" class="btn" disabled>
        <option value="ALL" selected>N/A</option>
      </select>

      <label class="small">月:</label>
      <select id="selMonth" class="btn"><option value="ALL" selected>All</option></select>

      <label class="small">クレーム種類:</label>
      <select id="selType" class="btn"><option value="ALL" selected>All</option></select>

      <label class="small">顧客:</label>
      <select id="selCust" class="btn" disabled><option value="">(Pivotに顧客列なし)</option></select>

      <label class="small">向き:</label>
      <select id="selOrient" class="btn"><option value="h">Horizontal</option><option value="v" selected>Vertical</option></select>
    </div>
    <div class="small" id="chartNote">Pivot から集計：月/部署/種類 単位=件。Totals 行は自動的に除外。</div>
  </section>

  <section class="card">
    <div class="chart-grid">
      <div class="chart-box"><canvas id="chartDept"></canvas></div>
      <div class="chart-box"><canvas id="chartType"></canvas></div>
      <div class="chart-box wide"><canvas id="chartMonth"></canvas></div>
    </div>
  </section>

  <div class="footer">Design by Wahyu</div>
</main>

<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-datalabels@2"></script>
<script>
Chart.register(ChartDataLabels);

/* ====== SETUP: isi sesuai file Anda ====== */
const DOC_ID   = "1lfykozvCdpMJ7-3VhlOCtd4zavaRZ4X_I5eu2"; // <— dari URL editor Sheets Anda
const GID      = "865157145";                                 // <— tab Pivot
const GVIZ_CSV = `https://docs.google.com/spreadsheets/d/${DOC_ID}/gviz/tq?tqx=out:csv&gid=${GID}`;

// link 2PACX yang Anda kirim (tetap dipakai sebagai fallback)
const CSV_DIRECT =
 "https://docs.google.com/spreadsheets/d/e/2PACX-1vQGwY4tjwfHVYZMuJpqSVo9uqHexcD2bmHdCiIg85oo036PLkxe4YXhHCpJbFi1mT1VgyjfNYLHOtNb/pub?gid=865157145&single=true&output=csv";
const CSV_PROXY_RJINA = "https://r.jina.ai/" + CSV_DIRECT;
const CSV_PROXY_ISO   = "https://cors.isomorphic-git.org/" + CSV_DIRECT;
const CSV_URLS = [GVIZ_CSV, CSV_DIRECT, CSV_PROXY_RJINA, CSV_PROXY_ISO];

/* ====== Util ====== */
const S = s => String(s ?? '').trim();
const intTick = v => Number.isInteger(v) ? v : '';
function showErr(msg){ const b=document.getElementById('err'); b.textContent=msg; b.style.display='block'; }
function hideErr(){ const b=document.getElementById('err'); b.style.display='none'; b.textContent=''; }
function stat(msg){ const el=document.getElementById('stat'); el.textContent=msg; el.style.display='inline-block'; }

/* CSV parser yang tahan kutip/koma/CRLF */
function parseCSV(t){
  const rows=[], re=/\s*("(?:[^"]|"")*"|[^,]*)\s*(,|\n|$)/g;
  let m, row=[]; t=t.replace(/\r\n?/g,"\n");
  for(let i=0;i<t.length;){
    re.lastIndex=i; m=re.exec(t); if(!m) break;
    let cell=m[1]; if(cell.startsWith('"')) cell=cell.slice(1,-1).replace(/""/g,'"');
    row.push(cell); i=re.lastIndex;
    if(m[2]==="\n"||m[2]===""){ rows.push(row); row=[]; }
  }
  return rows.filter(r=>r.length && r.some(c=>S(c)!==""));
}

/* Fetch CSV dengan fallback berurutan */
async function fetchAnyCSV(){
  for(const u of CSV_URLS){
    try{
      const res=await fetch(u + (u.includes('?')?'&':'?') + '_ts=' + Date.now(), {cache:'no-store'});
      if(!res.ok) continue;
      const txt=await res.text();
      const arr=parseCSV(txt);
      if(arr.length>=2){
        const mode = (u===GVIZ_CSV)?'gviz-csv':(u===CSV_DIRECT?'csv':'csv-proxy');
        return {mode, rows:arr};
      }
    }catch(e){}
  }
  throw new Error('CSV fetch failed on all endpoints');
}

/* Deteksi struktur Pivot: cari baris header yang punya "Month/年月" dan "部署" */
function detectPivot(rows){
  for(let r=0;r<rows.length;r++){
    const row = rows[r].map(S);
    const iMonth = row.findIndex(x=>/(年月|month)/i.test(x));
    const iDept  = row.findIndex(x=>/(部署|部門|課|department)/i.test(x));
    if(iMonth>=0 && iDept>=0){
      // Kolom kategori = header selain Month/部署 yang bukan Total/Sum/Grand
      const header = rows[r].map(S);
      const catIdx=[], catNames=[];
      for(let c=0;c<header.length;c++){
        if(c===iMonth || c===iDept) continue;
        const h=S(header[c]);
        if(!h) continue;
        if(/(total|合計|grand|sum)/i.test(h)) continue;
        catIdx.push(c); catNames.push(h);
      }
      if(catIdx.length>0){
        return {headerRow:r, colMonth:iMonth, colDept:iDept, catCols:catIdx, cats:catNames};
      }
    }
  }
  return null;
}

/* Parse nilai integer aman */
function num(v){ const s=S(v).replace(/,/g,''); const n=parseFloat(s); return isNaN(n)?0:n; }

/* State & palet */
let pivot=null, dataRows=[], months=[], departments=[], types=[];
let charts={dept:null,type:null,month:null};
const isDark=()=> document.documentElement.getAttribute('data-theme')==='dark';
const PALETTE_LIGHT=['#93c5fd','#a5b4fc','#fda4af','#fdba74','#86efac','#67e8f9','#f5d0fe','#c4b5fd','#fecaca','#fde68a','#bbf7d0','#bae6fd'];
const PALETTE_DARK=['#60a5fa','#818cf8','#fca5a5','#fbbf24','#4ade80','#22d3ee','#f0abfc','#a78bfa','#f87171','#fde047','#86efac','#93c5fd'];
const hexToRgba=(hex,a=0.8)=>{const h=hex.replace('#','');const b=parseInt(h,16);return`rgba(${(b>>16)&255},${(b>>8)&255},${b&255},${a})`};
function softPalette(n,a=0.8){ const base=isDark()?PALETTE_DARK:PALETTE_LIGHT; return Array.from({length:n},(_,i)=>hexToRgba(base[i%base.length],a)); }
function applyChartDefaults(){
  const st=getComputedStyle(document.documentElement);
  Chart.defaults.color=st.getPropertyValue('--ink').trim()||'#0f172a';
  Chart.defaults.borderColor=st.getPropertyValue('--grid').trim()||'#e5e7eb';
  Chart.defaults.font.family='system-ui,-apple-system,Segoe UI,Roboto,"Noto Sans JP","Yu Gothic",sans-serif';
}

/* Siapkan struktur dari CSV Pivot */
function prepareFromPivot(rows, meta){
  const h = meta.headerRow;
  dataRows = rows.slice(h+1); // data mulai setelah header
  // Ambil daftar bulan & departemen (abaikan 'Total' row)
  const monthSet=new Set(), deptSet=new Set();
  for(const r of dataRows){
    const m=S(r[meta.colMonth]), d=S(r[meta.colDept]);
    if(!m || /total/i.test(m)) continue;
    if(!d || /total/i.test(d)) continue;
    monthSet.add(m); deptSet.add(d);
  }
  months=[...monthSet]; departments=[...deptSet]; types=[...meta.cats];

  // Isi filter bulan dan jenis
  const selMonth=document.getElementById('selMonth');
  selMonth.innerHTML = `<option value="ALL">All</option>` + months.map(x=>`<option value="${x}">${x}</option>`).join('');
  const selType=document.getElementById('selType');
  selType.innerHTML = `<option value="ALL">All</option>` + types.map(x=>`<option value="${x}">${x}</option>`).join('');
}

/* Aggregate sesuai filter */
function aggregate(meta, {monthPick, typePick, topN}){
  const mDept=new Map(), mType=new Map(), mMonth=new Map();
  for(const r of dataRows){
    const mo=S(r[meta.colMonth]), dp=S(r[meta.colDept]);
    if(!mo || /total/i.test(mo)) continue;
    if(!dp || /total/i.test(dp)) continue;

    const cats=meta.catCols, names=meta.cats;
    // total per baris sesuai typePick
    let rowTotal=0;
    for(let i=0;i<cats.length;i++){
      const col=cats[i], name=names[i];
      const v=num(r[col]);
      if(typePick==='ALL' || typePick===name){ rowTotal += v; mType.set(name,(mType.get(name)||0)+ (typePick==='ALL'?v: (typePick===name?v:0))); }
      else { // tetap akumulasi jenis lain ke mType saat typePick==='ALL' saja
        mType.set(name,(mType.get(name)||0)+0);
      }
    }

    // filter bulan untuk Dept dan Month chart
    if(monthPick==='ALL' || mo===monthPick){
      mDept.set(dp,(mDept.get(dp)||0)+rowTotal);
    }
    // selalu akumulasi per bulan (untuk chart bulan), boleh tetap hormati typePick
    mMonth.set(mo,(mMonth.get(mo)||0)+rowTotal);
  }

  // Jika typePick !== ALL, rapikan mType (hanya tampil satu jenis)
  if(typePick!=='ALL'){
    const only=new Map();
    for(const name of types){
      only.set(name, name===typePick ? (mType.get(name)||0) : 0);
    }
    return {byDept:mDept, byType:only, byMonth:mMonth};
  }
  return {byDept:mDept, byType:mType, byMonth:mMonth};
}

/* Render charts */
function render(){
  applyChartDefaults();
  const topN=+document.getElementById('selTop').value||10;
  const monthPick=document.getElementById('selMonth').value;
  const typePick=document.getElementById('selType').value;
  const orient=document.getElementById('selOrient').value==='h'?'y':'x';

  const agg = aggregate(pivot, {monthPick, typePick, topN});

  const themeInk = getComputedStyle(document.documentElement).getPropertyValue('--ink').trim()||'#0f172a';

  // Dept
  {
    const entries=[...agg.byDept.entries()].sort((a,b)=>b[1]-a[1]);
    const labels=entries.slice(0,topN).map(e=>e[0]);
    const data=entries.slice(0,topN).map(e=>e[1]);
    const colors=softPalette(data.length, isDark()?0.7:0.8);
    const maxV=Math.max(1,...data);
    const ctx=document.getElementById('chartDept').getContext('2d');
    charts.dept && charts.dept.destroy();
    charts.dept=new Chart(ctx,{type:'bar',
      data:{labels,datasets:[{label:'件数',data,backgroundColor:colors,borderColor:colors,borderWidth:1,maxBarThickness:28,categoryPercentage:.7,barPercentage:.9}]},
      options:{indexAxis:orient,maintainAspectRatio:false,plugins:{legend:{display:false},title:{display:true,text:`部署別（件数）｜${monthPick==='ALL'?'全月':monthPick}｜種類:${typePick==='ALL'?'全て':typePick}`},datalabels:{anchor:'end',align:orient==='y'?'right':'top',formatter:v=>v,color:themeInk}},
        scales:orient==='y'?{x:{beginAtZero:true,suggestedMax:maxV*1.15,ticks:{callback:intTick}},y:{grid:{display:false}}}
                           :{y:{beginAtZero:true,suggestedMax:maxV*1.15,ticks:{callback:intTick}},x:{grid:{display:false}}}}
    });
  }

  // Type
  {
    const entries=[...agg.byType.entries()].sort((a,b)=>b[1]-a[1]);
    const labels=entries.map(e=>e[0]);
    const data=entries.map(e=>e[1]);
    const colors=softPalette(data.length, isDark()?0.7:0.8);
    const maxV=Math.max(1,...data);
    const ctx=document.getElementById('chartType').getContext('2d');
    charts.type && charts.type.destroy();
    charts.type=new Chart(ctx,{type:'bar',
      data:{labels,datasets:[{label:'件数',data,backgroundColor:colors,borderColor:colors,borderWidth:1,maxBarThickness:28,categoryPercentage:.7,barPercentage:.9}]},
      options:{indexAxis:orient,maintainAspectRatio:false,plugins:{legend:{display:false},title:{display:true,text:`種類別（件数）｜${monthPick==='ALL'?'全月':monthPick}`},datalabels:{anchor:'end',align:orient==='y'?'right':'top',formatter:v=>v,color:themeInk}},
        scales:orient==='y'?{x:{beginAtZero:true,suggestedMax:maxV*1.15,ticks:{callback:intTick}},y:{grid:{display:false}}}
                           :{y:{beginAtZero:true,suggestedMax:maxV*1.15,ticks:{callback:intTick}},x:{grid:{display:false}}}}
    });
  }

  // Month
  {
    const order = months; // urut sesuai kemunculan
    const data = order.map(m=> agg.byMonth.get(m)||0);
    const colors=softPalette(data.length, isDark()?0.7:0.8);
    const maxV=Math.max(1,...data);
    const ctx=document.getElementById('chartMonth').getContext('2d');
    charts.month && charts.month.destroy();
    charts.month=new Chart(ctx,{type:'bar',
      data:{labels:order,datasets:[{label:'件数',data,backgroundColor:colors,borderColor:colors,borderWidth:1,maxBarThickness:36,categoryPercentage:.8,barPercentage:.9}]},
      options:{indexAxis:orient,maintainAspectRatio:false,plugins:{legend:{display:false},title:{display:true,text:`月別（件数）｜種類:${typePick==='ALL'?'全て':typePick}`},datalabels:{anchor:'end',align:orient==='y'?'right':'top',formatter:v=>v,color:themeInk}},
        scales:orient==='y'?{x:{beginAtZero:true,suggestedMax:maxV*1.15,ticks:{callback:intTick}},y:{grid:{display:false}}}
                           :{y:{beginAtZero:true,suggestedMax:maxV*1.15,ticks:{callback:intTick}},x:{grid:{display:false}}}}
    });
  }
}

/* Load all */
async function load(){
  hideErr(); stat('Loading…');
  try{
    const any = await fetchAnyCSV();   // {mode, rows}
    const meta = detectPivot(any.rows);
    if(!meta) throw new Error('Pivot header not found (need 月/Month & 部署).');

    pivot = meta;
    prepareFromPivot(any.rows, meta);

    stat(`Data: OK (${any.mode}) | months:${months.length} dept:${departments.length} types:${types.length}`);
    render();
  }catch(e){
    console.error(e);
    showErr('読み込みに失敗しました。CSV公開/ネットワーク/ピボットの列名（「年月 - Month」「部署」）をご確認ください。');
    stat('No data');
  }
}

/* Events */
document.getElementById('btnRefresh').addEventListener('click', load);
['selTop','selMonth','selType','selOrient'].forEach(id=>document.getElementById(id).addEventListener('change', render));
document.getElementById('chkDark').addEventListener('change',e=>{
  document.documentElement.setAttribute('data-theme', e.target.checked?'dark':'light'); render();
});
window.addEventListener('DOMContentLoaded', load);
</script>
</body>
</html>
