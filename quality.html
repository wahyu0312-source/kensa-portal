<!doctype html>
<html lang="ja" data-theme="light">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>クレーム可視化（年月・クレーム種類・機種名・部署）</title>
  <!-- Tailwind (CDN) -->
  <script src="https://cdn.tailwindcss.com"></script>
  <!-- Chart.js -->
  $1
  <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-datalabels@2.2.0"></script>
  <!-- Papa Parse for CSV -->
  <script src="https://cdn.jsdelivr.net/npm/papaparse@5.4.1/papaparse.min.js"></script>
  <style>
    .sticky-header { position: sticky; top: 0; z-index: 20; }
    .chart-box { height: 360px; }
  </style>
</head>
<body class="bg-slate-50 text-slate-800">
  <header class="sticky-header bg-white/80 backdrop-blur border-b border-slate-200">
    <div class="max-w-6xl mx-auto px-4 py-3 flex flex-wrap items-center gap-3">
      <h1 class="text-xl font-semibold">クレーム可視化</h1>
      <span class="text-sm text-slate-500">（年月・クレーム種類・機種名・部署）</span>
      <div class="ml-auto flex items-center gap-3 text-xs text-slate-500"><span id="rowCount"></span><span id="lastLoaded"></span></div>
    </div>
  </header>

  <main class="max-w-6xl mx-auto px-4 py-6 space-y-6">
    <!-- フィルタ -->
    <section class="bg-white rounded-2xl shadow p-4">
      <h2 class="text-lg font-semibold mb-3">フィルタ</h2>
      <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-3">
        <div>
          <label class="block text-sm font-medium mb-1" for="fYM">年月</label>
          <select id="fYM" class="w-full border rounded-xl px-3 py-2"></select>
        </div>
        <div>
          <label class="block text-sm font-medium mb-1" for="fType">クレーム種類</label>
          <select id="fType" class="w-full border rounded-xl px-3 py-2"></select>
        </div>
        <div>
          <label class="block text-sm font-medium mb-1" for="fModel">機種名</label>
          <select id="fModel" class="w-full border rounded-xl px-3 py-2"></select>
        </div>
        <div>
          <label class="block text-sm font-medium mb-1" for="fDept">部署</label>
          <select id="fDept" class="w-full border rounded-xl px-3 py-2"></select>
        </div>
      </div>
      <div class="mt-3 flex gap-2">
        <button id="clearFilters" class="px-3 py-2 rounded-xl bg-slate-200 hover:bg-slate-300">フィルタ全解除</button>
      </div>
    </section>

    <!-- Charts -->
    <section class="grid grid-cols-1 lg:grid-cols-2 gap-6">
      <div class="bg-white rounded-2xl shadow p-4 flex flex-col">
        <div class="flex items-center">
          <h3 class="text-base font-semibold">件数（年月）</h3>
          <button data-chart="ym" class="ml-auto text-xs px-2 py-1 rounded-lg border exportBtn">PNG保存</button>
        </div>
        <div class="chart-box"><canvas id="chartYM"></canvas></div>
      </div>
      <div class="bg-white rounded-2xl shadow p-4 flex flex-col">
        <div class="flex items-center">
          <h3 class="text-base font-semibold">件数（クレーム種類）</h3>
          <button data-chart="type" class="ml-auto text-xs px-2 py-1 rounded-lg border exportBtn">PNG保存</button>
        </div>
        <div class="chart-box"><canvas id="chartType"></canvas></div>
      </div>
      <div class="bg-white rounded-2xl shadow p-4 flex flex-col">
        <div class="flex items-center">
          <h3 class="text-base font-semibold">件数（機種名）</h3>
          <button data-chart="model" class="ml-auto text-xs px-2 py-1 rounded-lg border exportBtn">PNG保存</button>
        </div>
        <div class="chart-box"><canvas id="chartModel"></canvas></div>
      </div>
      <div class="bg-white rounded-2xl shadow p-4 flex flex-col">
        <div class="flex items-center">
          <h3 class="text-base font-semibold">件数（部署）</h3>
          <button data-chart="dept" class="ml-auto text-xs px-2 py-1 rounded-lg border exportBtn">PNG保存</button>
        </div>
        <div class="chart-box"><canvas id="chartDept"></canvas></div>
      </div>
    </section>

    <!-- プレビュー -->
    <section class="bg-white rounded-2xl shadow p-4">
      <details>
        <summary class="cursor-pointer select-none font-medium">データ数行プレビュー</summary>
        <div class="overflow-x-auto mt-3">
          <table id="previewTable" class="min-w-full text-sm border">
            <thead class="bg-slate-100" id="previewHead"></thead>
            <tbody id="previewBody"></tbody>
          </table>
        </div>
      </details>
    </section>
  </main>

  <template id="optionTpl"><option></option></template>

  <script>
    // Chart.js DataLabels plugin register
    if (window.ChartDataLabels) { Chart.register(ChartDataLabels); }

    // ======= Utility =======
    const $ = (sel) => document.querySelector(sel);
    const $$ = (sel) => Array.from(document.querySelectorAll(sel));

    const requiredKeys = {
      ym: ["年月", "yearmonth", "year-month", "年月日", "ym"],
      type: ["クレーム種類", "クレーム種別", "クレーム", "種別", "claimtype"],
      model: ["機種名", "機種", "型式", "model"],
      dept: ["部署", "部門", "部課", "部署名", "department"]
    };

    function normalizeHeader(h) {
      if (!h) return "";
      return String(h).trim().toLowerCase().replace(/[\s_\-/]/g, "");
    }

    function autoMapHeaders(headers) {
      const norm = headers.map(h => ({ raw: h, n: normalizeHeader(h) }));
      const pickFirst = (cands) => {
        for (const c of cands) {
          const n = normalizeHeader(c);
          const f = norm.find(x => x.n.includes(n));
          if (f) return f.raw;
        }
        return headers[0] || "";
      };
      return { ym: pickFirst(requiredKeys.ym), type: pickFirst(requiredKeys.type), model: pickFirst(requiredKeys.model), dept: pickFirst(requiredKeys.dept) };
    }

    function normalizeYM(v) {
      if (v == null) return "";
      let s = String(v).trim();
      if (!s) return "";
      // 例: 2024-05, 2024/5, 2024年5月, 202405, 2024-05-31 → YYYY-MM
      const ymdMatch = s.match(/^(\d{4})[-\/.](\d{1,2})(?:[-\/.]\d{1,2})?$/);
      if (ymdMatch) {
        const y = ymdMatch[1];
        const m = ymdMatch[2].padStart(2, '0');
        return `${y}-${m}`;
      }
      const jpMatch = s.match(/(\d{4})\s*年\s*(\d{1,2})\s*月?/);
      if (jpMatch) {
        const y = jpMatch[1];
        const m = jpMatch[2].padStart(2, '0');
        return `${y}-${m}`;
      }
      const yyyymm = s.match(/^(\d{4})(\d{2})(\d{0,2})?$/);
      if (yyyymm) {
        const y = yyyymm[1];
        const m = yyyymm[2];
        return `${y}-${m}`;
      }
      const ym = s.match(/^(\d{4})[-\/.](\d{1,2})$/);
      if (ym) {
        const y = ym[1];
        const m = ym[2].padStart(2, '0');
        return `${y}-${m}`;
      }
      return s;
    }

    function countsBy(arr, keyFn) {
      const map = new Map();
      for (const a of arr) {
        const k = keyFn(a);
        if (!k) continue;
        map.set(k, (map.get(k) || 0) + 1);
      }
      return Array.from(map.entries()).sort((a,b) => a[0] > b[0] ? 1 : -1);
    }

    function uniqueValues(arr, key) {
      const s = new Set();
      arr.forEach(r => {
        const v = (r[key] ?? "").toString().trim();
        if (v) s.add(v);
      });
      return Array.from(s).sort();
    }

    function fillSelect(sel, values, { withAll=true, labelAll='(すべて)' }={}) {
      sel.innerHTML = '';
      if (withAll) {
        const opt = document.createElement('option');
        opt.value = '';
        opt.textContent = labelAll;
        sel.appendChild(opt);
      }
      for (const v of values) {
        const opt = document.createElement('option');
        opt.value = v;
        opt.textContent = v;
        sel.appendChild(opt);
      }
    }

    function downloadImageFromChart(chart, filename) {
      const a = document.createElement('a');
      a.href = chart.toBase64Image();
      a.download = filename;
      a.click();
    }

    // ======= State =======
    let rawRows = [];
    let headers = [];
    let mapping = { ym: '', type: '', model: '', dept: '' };

    let chartYM, chartType, chartModel, chartDept;

    // ======= Rendering =======
    function renderPreview(rows, max = 10) {
      const head = $('#previewHead');
      const body = $('#previewBody');
      head.innerHTML = '';
      body.innerHTML = '';
      if (!rows.length) return;
      const tr = document.createElement('tr');
      headers.forEach(h => {
        const th = document.createElement('th');
        th.className = 'px-2 py-1 border text-left font-medium';
        th.textContent = h;
        tr.appendChild(th);
      });
      head.appendChild(tr);

      rows.slice(0, max).forEach(r => {
        const trb = document.createElement('tr');
        headers.forEach(h => {
          const td = document.createElement('td');
          td.className = 'px-2 py-1 border';
          td.textContent = (h === mapping.ym) ? normalizeYM(r[h]) : (r[h] ?? '');
          trb.appendChild(td);
        });
        body.appendChild(trb);
      });
    }

    function currentFilters() {
      return {
        ym: $('#fYM').value,
        type: $('#fType').value,
        model: $('#fModel').value,
        dept: $('#fDept').value,
      };
    }

    function applyFilters(rows) {
      const f = currentFilters();
      return rows.filter(r => {
        if (f.ym && normalizeYM(r[mapping.ym]) !== f.ym) return false;
        if (f.type && r[mapping.type] !== f.type) return false;
        if (f.model && r[mapping.model] !== f.model) return false;
        if (f.dept && r[mapping.dept] !== f.dept) return false;
        return true;
      });
    }

    function refreshFilters() {
      const rows = rawRows;
      const ymValues = Array.from(new Set(rows.map(r => normalizeYM(r[mapping.ym])).filter(Boolean))).sort();
      const typeValues = uniqueValues(rows, mapping.type);
      const modelValues = uniqueValues(rows, mapping.model);
      const deptValues = uniqueValues(rows, mapping.dept);

      fillSelect($('#fYM'), ymValues);
      fillSelect($('#fType'), typeValues);
      fillSelect($('#fModel'), modelValues);
      fillSelect($('#fDept'), deptValues);
    }

    function destroyCharts() {
      [chartYM, chartType, chartModel, chartDept].forEach(ch => {
        if (ch) ch.destroy();
      });
      chartYM = chartType = chartModel = chartDept = undefined;
    }

    function buildCharts() {
      const rows = applyFilters(rawRows);

      // 年月
      const ymCounts = countsBy(rows, r => normalizeYM(r[mapping.ym]));
      const ymLabels = ymCounts.map(([k]) => k);
      const ymData = ymCounts.map(([,v]) => v);

      // 種類
      const typeCounts = countsBy(rows, r => (r[mapping.type]||'').toString().trim());
      const typeLabels = typeCounts.map(([k]) => k || '（未設定）');
      const typeData = typeCounts.map(([,v]) => v);

      // 機種
      const modelCounts = countsBy(rows, r => (r[mapping.model]||'').toString().trim());
      const modelLabels = modelCounts.map(([k]) => k || '（未設定）');
      const modelData = modelCounts.map(([,v]) => v);

      // 部署
      const deptCounts = countsBy(rows, r => (r[mapping.dept]||'').toString().trim());
      const deptLabels = deptCounts.map(([k]) => k || '（未設定）');
      const deptData = deptCounts.map(([,v]) => v);

      // 再描画
      destroyCharts();

      chartYM = new Chart($('#chartYM'), {
        type: 'bar',
        data: { labels: ymLabels, datasets: [{ label: '件数', data: ymData }] },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          scales: {
            x: { ticks: { maxRotation: 0, autoSkip: true } },
            y: { beginAtZero: true, precision: 0 }
          },
          plugins: { legend: { display: false }, datalabels: { anchor: "end", align: "top", formatter: (v) => v, clamp: true, clip: false } }
        }
      });

      chartType = new Chart($('#chartType'), {
        type: 'bar',
        data: { labels: typeLabels, datasets: [{ label: '件数', data: typeData }] },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          indexAxis: typeLabels.length > 6 ? 'y' : 'x',
          scales: { y: { beginAtZero: true, precision: 0 } },
          plugins: { legend: { display: false }, datalabels: { anchor: "end", align: "top", formatter: (v) => v, clamp: true, clip: false } }
        }
      });

      chartModel = new Chart($('#chartModel'), {
        type: 'bar',
        data: { labels: modelLabels, datasets: [{ label: '件数', data: modelData }] },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          indexAxis: modelLabels.length > 6 ? 'y' : 'x',
          scales: { y: { beginAtZero: true, precision: 0 } },
          plugins: { legend: { display: false }, datalabels: { anchor: "end", align: "top", formatter: (v) => v, clamp: true, clip: false } }
        }
      });

      chartDept = new Chart($('#chartDept'), {
        type: 'bar',
        data: { labels: deptLabels, datasets: [{ label: '件数', data: deptData }] },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          indexAxis: deptLabels.length > 6 ? 'y' : 'x',
          scales: { y: { beginAtZero: true, precision: 0 } },
          plugins: { legend: { display: false }, datalabels: { anchor: "end", align: "top", formatter: (v) => v, clamp: true, clip: false } }
        }
      });
    }

    function applyMappingAndRender() {
      // フィルタの選択肢再構成 → グラフ再描画
      refreshFilters();
      buildCharts();
      $('#rowCount').textContent = `${rawRows.length.toLocaleString()} 件`;
    }

    // ======= Load CSV =======
    async function loadCSV(url) {
      try {
        const res = await fetch(url);
        if (!res.ok) throw new Error(`HTTP ${res.status}`);
        const text = await res.text();
        const parsed = Papa.parse(text, { header: true, skipEmptyLines: true });
        if (parsed.errors?.length) {
          console.warn('PapaParse errors', parsed.errors);
        }
        rawRows = parsed.data;
        headers = parsed.meta.fields || Object.keys(rawRows[0] || {});
        renderPreview(rawRows);

        // マッピング初期化
        mapping = autoMapHeaders(headers);

        applyMappingAndRender();
        $('#lastLoaded').textContent = new Date().toLocaleString();
      } catch (e) {
        console.error(e);
      }
    }

    // ======= Events =======
        });

    $$('#fYM, #fType, #fModel, #fDept').forEach(sel => sel.addEventListener('change', buildCharts));

    $('#clearFilters').addEventListener('click', () => {
      $$('#fYM, #fType, #fModel, #fDept').forEach(sel => sel.value = '');
      buildCharts();
    });

    // 初期読み込み（固定CSV）
    window.addEventListener('DOMContentLoaded', () => {
      loadCSV('https://docs.google.com/spreadsheets/d/e/2PACX-1vQGwY4tjwfHVYZMuJpqSVo9uqHexcD2bmHdCiIg85oo036PLkxe4YXhHCpJbFi1mT1VgyjfNYLHOtNb/pub?gid=1070847733&single=true&output=csv');
    });
  </script>
</body>
</html>
