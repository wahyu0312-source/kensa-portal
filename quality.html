<!doctype html>
<html lang="ja" data-theme="light">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <title>品質情報</title>

  <!-- Chart.js & PapaParse -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.3/dist/chart.umd.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/papaparse@5.4.1/papaparse.min.js"></script>

  <style>
    :root{
      --bg1:#eef2ff; --bg2:#f8fafc; --card:#fff; --ink:#0f172a; --muted:#64748b; --border:#e5e7eb;
      --accent:#2563eb; --shadow:0 30px 60px rgba(15,23,42,.08); --radius:22px
    }
    [data-theme="dark"]{
      --bg1:#0b1220; --bg2:#0b1220; --card:#0f172a; --ink:#e5e7eb; --muted:#94a3b8; --border:#1f2937; --accent:#60a5fa;
    }
    *{box-sizing:border-box}
    body{margin:0;color:var(--ink);background:linear-gradient(120deg,var(--bg1),var(--bg2));font-family:system-ui,-apple-system,Segoe UI,Roboto,"Noto Sans JP","Yu Gothic",sans-serif}
    header{position:sticky;top:0;background:#ffffffcc;backdrop-filter:blur(8px);border-bottom:1px solid var(--border);z-index:10}
    .container{max-width:1200px;margin:0 auto;padding:14px 18px}
    nav a{margin-right:14px;color:var(--ink);text-decoration:none;font-weight:600}
    nav a.active{color:var(--accent)}
    h1{font-size:22px;margin:12px 0 4px}
    .sub{color:var(--muted);font-size:13px;margin-bottom:18px}
    .card{background:var(--card);border:1px solid var(--border);border-radius:var(--radius);box-shadow:var(--shadow);padding:16px}
    .grid-2{display:grid;grid-template-columns:1fr;gap:16px}
    @media(min-width:1100px){.grid-2{grid-template-columns:1.2fr .8fr}}
    .controls{display:flex;flex-wrap:wrap;gap:10px;align-items:center;margin-bottom:12px}
    .controls label{font-size:12px;color:var(--muted)}
    .controls select,.controls input,.controls button{
      padding:8px 10px;border:1px solid var(--border);border-radius:12px;background:#fff;font-size:14px
    }
    .controls button{cursor:pointer}
    .checks{display:flex;gap:10px;flex-wrap:wrap}
    .badge{display:inline-block;padding:2px 8px;border-radius:999px;border:1px solid var(--border);font-size:12px;color:var(--muted)}
    .err{background:#fff1f2;border:1px solid #fecaca;color:#991b1b;padding:10px;border-radius:12px;margin-bottom:10px;display:none}
    .chart-wrap{position:relative;height:360px}
    .nodata{position:absolute;inset:0;display:flex;align-items:center;justify-content:center;color:#64748b;font-weight:600}
    table{width:100%;border-collapse:separate;border-spacing:0}
    thead th{background:#f8fafc;color:#475569;text-align:left;font-weight:700;padding:10px 12px;border-bottom:1px solid var(--border)}
    tbody td{padding:10px 12px;border-bottom:1px solid var(--border)}
    footer{color:#64748b;font-size:12px;margin:28px 0}
  </style>
</head>
<body>
  <header>
    <div class="container">
      <nav>
        <a href="./index.html">ホーム</a>
        <a href="./forms.html">出荷検査成績書</a>
        <a href="./sagyoutejunsho.html">出荷検査作業手順書</a>
        <a href="./charts.html">出荷検査（グラフ）</a>
        <a class="active" href="./quality.html">品質情報</a>
      </nav>
    </div>
  </header>

  <main class="container">
    <h1>品質情報 <span class="badge" id="dataRange"></span></h1>
    <div class="sub">CSV（公開）から自動読込。月（<b>月</b>）と部位（<b>シャトルガード/コンベヤー/ウィンベンド/スクリューカバー</b>）で絞り込み、カテゴリ（<b>発行実績</b>）でPareto表示。</div>

    <div id="err" class="err"></div>

    <div class="card">
      <div class="controls">
        <label>月：</label>
        <select id="monthSel"></select>

        <label>表示（トレンド）：</label>
        <select id="trendMode">
          <option value="line-v" selected>折れ線（縦）</option>
          <option value="bar-v">棒（縦）</option>
          <option value="bar-h">棒（横）</option>
        </select>

        <label>表示（Pareto）：</label>
        <select id="paretoOri">
          <option value="vertical" selected>縦</option>
          <option value="horizontal">横</option>
        </select>

        <button id="reloadBtn">再読み込み</button>
        <button id="exportBtn">CSV出力（絞り込み後）</button>
      </div>

      <div class="controls" style="margin-top:6px">
        <label>部位：</label>
        <div class="checks" id="partChecks"></div>
      </div>

      <div class="grid-2" style="margin-top:10px">
        <div>
          <h3 style="margin:0 0 8px">月次トレンド（1〜12月｜件数）</h3>
          <div class="chart-wrap"><canvas id="trendChart"></canvas><div id="trendEmpty" class="nodata" style="display:none">データなし</div></div>
        </div>
        <div>
          <h3 style="margin:0 0 8px">Pareto（発行実績｜選択月）</h3>
          <div class="chart-wrap"><canvas id="paretoChart"></canvas><div id="paretoEmpty" class="nodata" style="display:none">データなし</div></div>
        </div>
      </div>
    </div>

    <div class="card" style="margin-top:14px">
      <h3 style="margin:0 0 8px">Claims（明細）— 現在のフィルタ</h3>
      <table>
        <thead><tr><th>カテゴリ（発行実績）</th><th>件数</th><th>構成比</th></tr></thead>
        <tbody id="claimsBody"><tr><td colspan="3" style="color:#64748b">データなし</td></tr></tbody>
      </table>
    </div>

    <footer>Design by Wahyu · データは公開CSVから自動取得</footer>
  </main>

  <script>
    // ==== CONFIG (CSV baru) ====
    const CSV_URL = "https://docs.google.com/spreadsheets/d/e/2PACX-1vQonny5Rq7uIRcB2AagV1P1vlFSXzS8r88z4_FTPMSFj9aFeNNK_QLMQquHmZ2Fzo1VKJTRg_z6HNJG/pub?gid=864633681&single=true&output=csv";
    const PARTS = ["シャトルガード","コンベヤー","ウィンベンド","スクリューカバー"];
    const COL_CATEGORY = "発行実績"; // claim category
    const COL_MONTH = "月";         // 1..12

    // kolom "部位" tidak disebut namanya -> deteksi otomatis yang paling banyak memuat token PARTS
    function guessPartColumn(headers, rows){
      let best = {col:null, score:-1};
      headers.forEach(h=>{
        let s = 0;
        for(const r of rows){
          const v = String(r[h] ?? "");
          for(const p of PARTS){ if(v.includes(p)) { s++; break; } }
        }
        if(s > best.score) best = {col:h, score:s};
      });
      return best.col; // bisa null
    }

    // ==== utils ====
    const $ = id => document.getElementById(id);
    function setErr(msg){ const e=$("err"); if(!msg){e.style.display="none"; e.textContent="";} else {e.style.display="block"; e.textContent=msg;} }
    function uniq(arr){ return Array.from(new Set(arr)); }
    function toCSV(rows){
      if(!rows.length) return "";
      const headers = Object.keys(rows[0]);
      const esc = v => `"${String(v??"").replace(/"/g,'""')}"`;
      return [headers.join(","), ...rows.map(r=>headers.map(h=>esc(r[h])).join(","))].join("\n");
    }
    function showEmpty(id, show){ $(id).style.display = show ? "flex" : "none"; }

    // ==== state ====
    let RAW=[], HEADERS=[], PART_COL=null;
    let trendChart=null, paretoChart=null;

    // ==== load CSV ====
    async function loadCSV(){
      try{
        const res = await fetch(CSV_URL, {cache:"no-store"});
        if(!res.ok) throw new Error("HTTP "+res.status);
        const text = await res.text();
        const out = await new Promise(resolve=>{
          Papa.parse(text,{header:true,dynamicTyping:true,skipEmptyLines:true,complete: r=>resolve(r)});
        });
        return out;
      }catch(e){
        console.error(e);
        setErr("CSVの読み込みに失敗しました。公開設定/URLをご確認ください。");
        return {data:[], meta:{fields:[]}};
      }
    }

    // ==== filters UI ====
    function buildMonthSelect(rows){
      const months = uniq(rows.map(r=> Number(r[COL_MONTH]) ).filter(n=>Number.isFinite(n) && n>=1 && n<=12)).sort((a,b)=>a-b);
      const sel = $("monthSel");
      sel.innerHTML = months.map(m=>`<option value="${m}">${m}月</option>`).join("");
      // default -> 6月 kalau ada; kalau tidak, pakai terakhir
      const def = months.includes(6) ? 6 : (months[months.length-1]||"");
      sel.value = def;
      $("dataRange").textContent = months.length ? `${months[0]}〜${months[months.length-1]}月` : "";
    }

    function buildPartChecks(){
      const wrap = $("partChecks");
      wrap.innerHTML = PARTS.map(p=>{
        const id = "p_"+p;
        return `<label style="display:inline-flex;align-items:center;gap:6px">
          <input type="checkbox" id="${id}" data-part="${p}" checked>
          <span>${p}</span>
        </label>`;
      }).join("");
    }

    function selectedParts(){
      return Array.from($("partChecks").querySelectorAll("input[type=checkbox]"))
        .filter(cb=>cb.checked).map(cb=>cb.getAttribute("data-part"));
    }

    // ==== filter data ====
    function filterByUI(rows){
      const month = Number($("monthSel").value);
      const parts = selectedParts();
      return rows.filter(r=>{
        const m = Number(r[COL_MONTH]);
        const partStr = String(r[PART_COL] ?? "");
        const okMonth = Number.isFinite(m) && m===month;
        const okPart = parts.length ? parts.some(p => partStr.includes(p)) : true;
        return okMonth && okPart;
      });
    }

    // all-year trend for selected parts
    function buildTrend(rows){
      const parts = selectedParts();
      const byMonth = new Array(12).fill(0);
      rows.forEach(r=>{
        const partStr = String(r[PART_COL] ?? "");
        if(parts.length && !parts.some(p=>partStr.includes(p))) return;
        const m = Number(r[COL_MONTH]);
        if(Number.isFinite(m) && m>=1 && m<=12) byMonth[m-1] += 1;
      });
      const labels = Array.from({length:12}, (_,i)=>`${i+1}月`);
      return {labels, values: byMonth};
    }

    function buildPareto(rows){
      const by = new Map();
      for(const r of rows){
        const cat = String(r[COL_CATEGORY] ?? "").trim() || "（未分類）";
        by.set(cat, (by.get(cat)||0) + 1);
      }
      let arr = Array.from(by.entries()).sort((a,b)=>b[1]-a[1]);
      const total = arr.reduce((s,[,v])=>s+v,0);
      const labels = arr.map(([k])=>k);
      const values = arr.map(([,v])=>v);
      const cum=[]; let acc=0;
      for(const v of values){ acc+=v; cum.push(total? Math.round(acc/total*1000)/10 : 0); }
      return {labels, values, cum, total};
    }

    function destroyCharts(){ if(trendChart){trendChart.destroy();trendChart=null;} if(paretoChart){paretoChart.destroy();paretoChart=null;} }

    // ==== draw ====
    function drawAll(){
      destroyCharts();
      if(!RAW.length || !PART_COL){
        setErr("必要な列（発行実績 / 月 / 部位）が見つかりません。ヘッダー名をご確認ください。");
        showEmpty("trendEmpty", true); showEmpty("paretoEmpty", true);
        $("claimsBody").innerHTML = `<tr><td colspan="3" style="color:#64748b">データなし</td></tr>`;
        return;
      }
      setErr("");

      // Trend (1..12)
      const t = buildTrend(RAW);
      const mode = $("trendMode").value;
      const trendType = mode.startsWith("line") ? "line" : "bar";
      const indexAxis = mode==="bar-h" ? "y" : "x";
      showEmpty("trendEmpty", t.values.every(v=>v===0));

      trendChart = new Chart($("trendChart").getContext("2d"), {
        type: trendType,
        data: { labels: t.labels, datasets: [{ label:"件数", data: t.values, tension:.3, borderWidth:2, pointRadius:3, fill:false }] },
        options: {
          responsive:true, maintainAspectRatio:false,
          plugins:{ legend:{display:true}, tooltip:{mode:"index", intersect:false} },
          indexAxis: trendType==="bar" ? indexAxis : undefined,
          scales: trendType==="bar" && indexAxis==="y" ? {
            y:{ beginAtZero:true, ticks:{ autoSkip:false } },
            x:{ beginAtZero:true, ticks:{ precision:0 } }
          } : { y:{ beginAtZero:true, ticks:{ precision:0 } } }
        }
      });

      // Pareto (selected month)
      const filtered = filterByUI(RAW);
      const p = buildPareto(filtered);
      const horizontal = $("paretoOri").value === "horizontal";
      const lineAxis = horizontal ? "x1" : "y1";
      showEmpty("paretoEmpty", p.total===0);

      paretoChart = new Chart($("paretoChart").getContext("2d"), {
        type: "bar",
        data: {
          labels: p.labels,
          datasets: [
            { type:"bar", label:"件数", data: p.values, borderWidth:1 },
            { type:"line", label:"累積%", data: p.cum, yAxisID: lineAxis, xAxisID: lineAxis, borderWidth:2, pointRadius:3 }
          ]
        },
        options: {
          responsive:true, maintainAspectRatio:false,
          plugins:{ legend:{display:true}, tooltip:{mode:"index", intersect:false} },
          indexAxis: horizontal ? "y" : "x",
          scales: horizontal ? {
            y: { beginAtZero:true, ticks:{ autoSkip:false } },
            x: { beginAtZero:true, ticks:{ precision:0 } },
            x1:{ position:"top", min:0, max:100, ticks:{ callback:v=>v+"%" } }
          } : {
            x: { ticks:{ autoSkip:false } },
            y: { beginAtZero:true, ticks:{ precision:0 } },
            y1:{ position:"right", min:0, max:100, ticks:{ callback:v=>v+"%" } }
          }
        }
      });

      // 明細
      if(p.total>0){
        $("claimsBody").innerHTML = p.labels.map((k,i)=>{
          const v = p.values[i]; const pct = p.cum[i] - (i? p.cum[i-1]:0);
          return `<tr><td>${k||"（未分類）"}</td><td>${v}</td><td>${(Math.round(v/p.total*1000)/10)}%</td></tr>`;
        }).join("");
      }else{
        $("claimsBody").innerHTML = `<tr><td colspan="3" style="color:#64748b">データなし</td></tr>`;
      }
    }

    // ==== bootstrap ====
    async function bootstrap(){
      const out = await loadCSV();
      RAW = out.data || [];
      HEADERS = out.meta?.fields || Object.keys(RAW[0]||{});

      // Validasi kolom wajib
      if(!HEADERS.includes(COL_CATEGORY) || !HEADERS.includes(COL_MONTH)){
        setErr("ヘッダーに「発行実績」または「月」が見つかりません。");
        return;
      }

      PART_COL = guessPartColumn(HEADERS, RAW);
      if(!PART_COL){ setErr("部位列（シャトルガード等を含む列）が見つかりません。"); }

      // UI
      buildMonthSelect(RAW);
      buildPartChecks();

      // default: 6月 jika ada (sudah di-set di buildMonthSelect)
      drawAll();
    }

    // ==== events ====
    ["change","input"].forEach(ev=>{
      $("monthSel").addEventListener(ev, drawAll);
      $("trendMode").addEventListener(ev, drawAll);
      $("paretoOri").addEventListener(ev, drawAll);
    });
    $("partChecks").addEventListener("change", drawAll);
    $("reloadBtn").addEventListener("click", bootstrap);
    $("exportBtn").addEventListener("click", ()=>{
      const data = filterByUI(RAW);
      if(!data.length){ alert("出力対象データがありません。"); return; }
      const csv = toCSV(data);
      const blob = new Blob([csv], {type:"text/csv;charset=utf-8"});
      const a = document.createElement("a");
      a.href = URL.createObjectURL(blob);
      a.download = `品質情報_${$("monthSel").value}月.csv`;
      a.click();
    });

    window.addEventListener("DOMContentLoaded", bootstrap);
  </script>
</body>
</html>
