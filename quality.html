<!doctype html>
<html lang="ja" data-theme="light">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <title>品質情報</title>

  <!-- Chart.js & PapaParse -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.3/dist/chart.umd.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/papaparse@5.4.1/papaparse.min.js"></script>

  <style>
    :root{
      --bg1:#eef2ff; --bg2:#f8fafc; --card:#fff; --ink:#0f172a; --muted:#64748b; --border:#e5e7eb;
      --accent:#2563eb; --shadow:0 30px 60px rgba(15,23,42,.08); --radius:22px
    }
    [data-theme="dark"]{
      --bg1:#0b1220; --bg2:#0b1220; --card:#0f172a; --ink:#e5e7eb; --muted:#94a3b8; --border:#1f2937; --accent:#60a5fa; --shadow:none;
    }
    *{box-sizing:border-box}
    body{margin:0;color:var(--ink);background:linear-gradient(120deg,var(--bg1),var(--bg2));font-family:system-ui,-apple-system,Segoe UI,Roboto,"Noto Sans JP","Yu Gothic",sans-serif}
    header{position:sticky;top:0;background:#ffffffcc;backdrop-filter:blur(8px);border-bottom:1px solid var(--border);z-index:10}
    .container{max-width:1200px;margin:0 auto;padding:14px 18px}
    nav a{margin-right:14px;color:var(--ink);text-decoration:none;font-weight:600}
    nav a.active{color:var(--accent)}
    h1{font-size:22px;margin:12px 0 4px}
    .sub{color:var(--muted);font-size:13px;margin-bottom:18px}
    .card{background:var(--card);border:1px solid var(--border);border-radius:var(--radius);box-shadow:var(--shadow);padding:16px}
    .grid-2{display:grid;grid-template-columns:1fr;gap:16px}
    @media(min-width:1100px){.grid-2{grid-template-columns:1.2fr .8fr}}
    .controls{display:flex;flex-wrap:wrap;gap:10px;align-items:center;margin-bottom:12px}
    .controls label{font-size:12px;color:var(--muted)}
    .controls select,.controls input,.controls button{
      padding:8px 10px;border:1px solid var(--border);border-radius:12px;background:#fff;font-size:14px
    }
    .controls button{cursor:pointer}
    .badge{display:inline-block;padding:2px 8px;border-radius:999px;border:1px solid var(--border);font-size:12px;color:var(--muted)}
    .muted{color:var(--muted)}
    .err{background:#fff1f2;border:1px solid #fecaca;color:#991b1b;padding:10px;border-radius:12px;margin-bottom:10px}
    .hint{font-size:12px;color:#64748b;margin-top:6px}
    .chart-wrap{position:relative;height:360px}
    .nodata{position:absolute;inset:0;display:flex;align-items:center;justify-content:center;color:#64748b;font-weight:600}
    table{width:100%;border-collapse:separate;border-spacing:0}
    thead th{background:#f8fafc;color:#475569;text-align:left;font-weight:700;padding:10px 12px;border-bottom:1px solid var(--border)}
    tbody td{padding:10px 12px;border-bottom:1px solid var(--border)}
    footer{color:var(--muted);font-size:12px;margin:28px 0}
  </style>
</head>
<body>
  <header>
    <div class="container">
      <nav>
        <a href="./index.html">ホーム</a>
        <a href="./forms.html">出荷検査成績書</a>
        <a href="./sagyoutejunsho.html">出荷検査作業手順書</a>
        <a href="./charts.html">出荷検査（グラフ）</a>
        <a class="active" href="./quality.html">品質情報</a>
      </nav>
    </div>
  </header>

  <main class="container">
    <h1>品質情報 <span class="badge" id="dataRange"></span></h1>
    <div class="sub">Googleスプレッドシートの公開CSVから自動読み込み。月次トレンドとPareto、Claims明細を表示します。</div>

    <div id="errorBox" class="err" style="display:none"></div>

    <div class="card">
      <div class="controls">
        <label>顧客（カンマ区切りOK）：</label>
        <input id="customerQuery" placeholder="例: SG,CV" style="min-width:160px">

        <label>期間：</label>
        <input type="month" id="fromMonth">〜<input type="month" id="toMonth">

        <label>Pareto上位：</label>
        <select id="topN">
          <option value="8">8</option>
          <option value="10" selected>10</option>
          <option value="12">12</option>
          <option value="20">20</option>
        </select>

        <label>表示（トレンド）：</label>
        <select id="trendMode" title="Trend chart display">
          <option value="line-v" selected>折れ線（縦）</option>
          <option value="bar-v">棒（縦）</option>
          <option value="bar-h">棒（横）</option>
        </select>

        <label>表示（Pareto）：</label>
        <select id="paretoOrientation" title="Pareto orientation">
          <option value="vertical" selected>縦</option>
          <option value="horizontal">横</option>
        </select>

        <button id="reloadBtn">再読み込み</button>
        <button id="exportCsvBtn">CSV出力（絞り込み後）</button>
      </div>

      <div class="grid-2">
        <div>
          <h3 style="margin:0 0 8px">月次トレンド（不良・件数/数量）</h3>
          <div class="chart-wrap"><canvas id="trendChart"></canvas><div id="trendEmpty" class="nodata" style="display:none">データなし</div></div>
          <div class="hint">※ 数量列がない場合は件数（行数）で集計</div>
        </div>
        <div>
          <h3 style="margin:0 0 8px">Pareto（不良カテゴリ）</h3>
          <div class="chart-wrap"><canvas id="paretoChart"></canvas><div id="paretoEmpty" class="nodata" style="display:none">データなし</div></div>
        </div>
      </div>
    </div>

    <div class="card" style="margin-top:14px">
      <h3 style="margin:0 0 8px">Claims（明細）— 現在のフィルタ</h3>
      <table>
        <thead><tr><th>カテゴリ</th><th>件数/数量</th><th>構成比</th></tr></thead>
        <tbody id="claimsBody"><tr><td colspan="3" class="muted">データなし</td></tr></tbody>
      </table>
    </div>

    <footer>Design by Wahyu · データは公開CSVから自動取得</footer>
  </main>

  <script>
    // ====== CSV sumber ======
    const CSV_URL = "https://docs.google.com/spreadsheets/d/e/2PACX-1vRcfdkrzU5qYVnkGAMeVP9884E7pv5ZFlgobtY7Eb9mlbvmnXFL5v_nY_oA-sAgVJhSYKCgOk_wlO6W/pub?gid=864633681&single=true&output=csv";

    // ====== Heuristik kolom (lebih lengkap) ======
    const HINTS = {
      date:  [/^日付$|日時|検査日|出荷日|製造日|発生日|受付日|クレーム日|年月日|年月|date|created/i],
      // customer bisa nama panjang atau code/略称
      customer:[/^顧客$|顧客名|客先|得意先|取引先|customer|client|顧客略称|顧客ｺｰﾄﾞ|顧客コード|略称|略号|code|cd|得意先CD|客先CD/i],
      // defect: ambil "現象/原因/分類/項目/不良/クレーム内容" dll
      defect: [/不良|不具合|欠陥|現象|原因|クレーム|カテゴリ|category|区分|分類|項目|内容|NG内容|不良内容|故障内容/i],
      qty:    [/数量|個数|台数|件数|qty|count|数量\(件\)|数量（件）|数/i]
    };

    // deteksi alternatif jika tak ketemu: gabung 分類1/分類2 dst sebagai "カテゴリ"
    function detectMap(headers){
      const findBy = (arr)=> headers.find(h=>arr.some(r=>r.test(h))) || null;
      let map = {
        date: findBy(HINTS.date),
        customer: findBy(HINTS.customer),
        defect: findBy(HINTS.defect),
        qty: findBy(HINTS.qty)
      };

      // fallback populer
      const has = (n)=> headers.includes(n);
      if(!map.date && (has("年月")||has("月"))) map.date = has("年月")?"年月":"月";
      if(!map.customer && (has("顧客略称")||has("略称"))) map.customer = has("顧客略称")?"顧客略称":"略称";

      // kalau tidak ada defect, coba gabungkan 分類1/2/3 → synthetic
      const bunrui = headers.filter(h=>/分類|カテゴリ|区分/.test(h));
      if(!map.defect && bunrui.length){
        map.defect = "__SYNTH_DEFECT__";
        map.__defParts = bunrui.slice(0,3); // pakai maksimal 3 kolom
      }

      return map;
    }

    // ====== Utils ======
    const $ = (id)=>document.getElementById(id);
    const jpMonth = (d)=> `${d.getFullYear()}/${String(d.getMonth()+1).padStart(2,"0")}`;
    function parseDate(v){
      if(v instanceof Date) return v;
      if(v==null) return null;
      let s = String(v).trim(); if(!s) return null;
      // support YYYY/MM, YYYY-MM, YYYY年MM月, YYYY/MM/DD
      const mYM = s.match(/^(\d{4})\D(\d{1,2})$/);
      if(mYM) return new Date(+mYM[1], mYM[2]-1, 1);
      s = s.replace(/\./g,"/").replace(/年|月|\/|\-/g, m=> (m==="年"||m==="月")?"/":m);
      let m = s.match(/^(\d{4})[\/\-](\d{1,2})[\/\-](\d{1,2})/);
      if(m) return new Date(+m[1], m[2]-1, +m[3]);
      m = s.match(/^(\d{1,2})[\/\-](\d{1,2})[\/\-](\d{4})$/);
      if(m) return new Date(+m[3], m[1]-1, +m[2]);
      if(/^\d{4,6}$/.test(s)){ // Excel serial
        const base = new Date(Date.UTC(1899,11,30));
        const dt = new Date(base.getTime() + (+s)*86400000);
        return new Date(dt.getFullYear(), dt.getMonth(), dt.getDate());
      }
      const d=new Date(s); return isNaN(d)?null:d;
    }
    const toCSV = (rows)=>{
      if(!rows.length) return "";
      const headers = Object.keys(rows[0]);
      const esc = v => `"${String(v??"").replace(/"/g,'""')}"`;
      return [headers.join(","), ...rows.map(r=>headers.map(h=>esc(r[h])).join(","))].join("\n");
    };

    // ====== State ======
    let RAW=[], HEADERS=[], MAP=null;
    let trendChart=null, paretoChart=null;

    function setError(msg){ const box=$("errorBox"); if(!msg){box.style.display="none";box.textContent="";} else{box.style.display="block";box.textContent=msg;} }
    function showEmpty(which, show){ $(which+"Empty").style.display = show ? "flex" : "none"; }

    // ====== Load CSV ======
    async function loadCSV(){
      setError("");
      try{
        const res = await fetch(CSV_URL, {cache:"no-store"});
        if(!res.ok) throw new Error("HTTP "+res.status);
        const text = await res.text();
        return await new Promise(resolve=>{
          Papa.parse(text,{header:true,dynamicTyping:true,skipEmptyLines:true,complete: out=>resolve(out)});
        });
      }catch(e){
        console.error(e);
        setError("CSVの読み込みに失敗しました。公開設定/URLをご確認ください。");
        return {data:[], meta:{fields:[]}};
      }
    }

    // ====== Filters ======
    function initFilters(rows,map){
      // Range
      const dates = rows.map(r=>parseDate(resolveDate(r,map))).filter(d=>d && !isNaN(d));
      if(dates.length){
        const min = dates.reduce((a,b)=>a<b?a:b);
        const max = dates.reduce((a,b)=>a>b?a:b);
        const m2 = (d)=> `${d.getFullYear()}-${String(d.getMonth()+1).padStart(2,"0")}`;
        $("fromMonth").value = m2(new Date(min.getFullYear(), min.getMonth(), 1));
        $("toMonth").value   = m2(new Date(max.getFullYear(), max.getMonth(), 1));
        $("dataRange").textContent = `${jpMonth(min)} 〜 ${jpMonth(max)}`;
      }else{
        $("dataRange").textContent = "";
      }

      // Prefill: otomatis bulan 6 (Juni) & pelanggan SG,CV
      const now = new Date();
      const year = now.getFullYear();
      $("fromMonth").value = `${year}-06`;
      $("toMonth").value   = `${year}-06`;
      $("customerQuery").value = "SG,CV";
    }

    function resolveDate(row,map){ return row[map.date]; }
    function resolveCustomer(row,map){
      const val = String(row[map.customer]??"").trim();
      // kalau ada alternatif (略称/コード) di headers, tambahkan ke pencocokan OR
      const altKeys = ["顧客略称","略称","顧客コード","顧客ｺｰﾄﾞ","得意先CD","客先CD","コード","code","CD"];
      for(const k of altKeys){ if(HEADERS.includes(k) && String(row[k]??"")) return val+"|"+String(row[k]); }
      return val;
    }
    function resolveDefect(row,map){
      if(map.defect!=="__SYNTH_DEFECT__") return String(row[map.defect]??"").trim();
      // gabung bagian-bagian分類
      const parts = (map.__defParts||[]).map(k=>String(row[k]??"").trim()).filter(Boolean);
      return parts.join(" > ") || "（未分類）";
    }

    function getFiltered(rows,map){
      const tokens = $("customerQuery").value.split(/[,、\s]+/).map(s=>s.trim()).filter(Boolean);
      const from = $("fromMonth").value ? new Date($("fromMonth").value+"-01") : null;
      const to   = $("toMonth").value ? new Date($("toMonth").value+"-01") : null;
      const end  = to ? new Date(to.getFullYear(), to.getMonth()+1, 0) : null;

      return rows.filter(r=>{
        const d = parseDate(resolveDate(r,map));
        if(!d || isNaN(d)) return false;
        if(from && d < from) return false;
        if(end && d > end) return false;
        if(tokens.length){
          const custStr = resolveCustomer(r,map).toUpperCase();
          // cocokkan jika salah satu token muncul sebagai substring
          const ok = tokens.some(t => custStr.includes(t.toUpperCase()));
          if(!ok) return false;
        }
        return true;
      });
    }

    // ====== Aggregations ======
    function monthTrend(rows,map){
      const useQty = !!map.qty;
      const by = new Map();
      for(const r of rows){
        const d = parseDate(resolveDate(r,map)); if(!d||isNaN(d)) continue;
        const key = jpMonth(d);
        const val = useQty ? Number(r[map.qty]||0) : 1;
        by.set(key, (by.get(key)||0) + (isFinite(val)?val:0));
      }
      const labels = Array.from(by.keys()).sort();
      const values = labels.map(k=>by.get(k));
      return {labels, values};
    }

    function paretoData(rows,map,topN){
      const useQty = !!map.qty;
      const by = new Map();
      for(const r of rows){
        const cat = resolveDefect(r,map) || "（未分類）";
        const val = useQty ? Number(r[map.qty]||0) : 1;
        by.set(cat, (by.get(cat)||0) + (isFinite(val)?val:0));
      }
      let arr = Array.from(by.entries()).sort((a,b)=>b[1]-a[1]);
      const total = arr.reduce((s,[,v])=>s+v,0);
      if(arr.length > topN){
        const top = arr.slice(0, topN);
        const rest = arr.slice(topN).reduce((s,[,v])=>s+v,0);
        arr = [...top, ["その他", rest]];
      }
      const labels = arr.map(([k])=>k);
      const values = arr.map(([,v])=>v);
      const cum=[]; let acc=0;
      for(const v of values){ acc+=v; cum.push(total? Math.round(acc/total*1000)/10 : 0); }
      return {labels, values, cum, total, rowsByCat: by};
    }

    // ====== Charts ======
    function destroyCharts(){ if(trendChart){trendChart.destroy();trendChart=null;} if(paretoChart){paretoChart.destroy();paretoChart=null;} }

    function drawAll(){
      destroyCharts();

      if(!MAP || !MAP.date || !MAP.customer || !MAP.defect){
        setError("必要な列名（日付/顧客/不良カテゴリ）が検出できませんでした。シートのヘッダーをご確認ください。");
        showEmpty("trend", true); showEmpty("pareto", true);
        $("claimsBody").innerHTML = `<tr><td colspan="3" class="muted">データなし</td></tr>`;
        return;
      }
      setError("");

      const rows = getFiltered(RAW, MAP);

      // トレンド
      const t = monthTrend(rows, MAP);
      const mode = $("trendMode").value; // line-v | bar-v | bar-h
      const trendType = mode.startsWith("line") ? "line" : "bar";
      const indexAxis = (mode==="bar-h") ? "y" : "x";
      showEmpty("trend", t.labels.length===0);

      trendChart = new Chart($("trendChart").getContext("2d"), {
        type: trendType,
        data: { labels: t.labels, datasets: [{ label:"月次合計", data: t.values, tension:.3, borderWidth:2, pointRadius:3, fill:false }] },
        options: {
          responsive:true, maintainAspectRatio:false,
          plugins:{ legend:{display:true}, tooltip:{mode:"index", intersect:false} },
          indexAxis: trendType==="bar" ? indexAxis : undefined,
          scales: trendType==="bar" && indexAxis==="y" ? {
            y:{ beginAtZero:true, ticks:{ autoSkip:false } },
            x:{ beginAtZero:true, ticks:{ precision:0 } }
          } : { y:{ beginAtZero:true, ticks:{ precision:0 } } }
        }
      });

      // Pareto + 明細
      const p = paretoData(rows, MAP, +$("topN").value || 10);
      const horizontal = $("paretoOrientation").value === "horizontal";
      const lineAxis = horizontal ? "x1" : "y1";
      showEmpty("pareto", p.labels.length===0);

      paretoChart = new Chart($("paretoChart").getContext("2d"), {
        type: "bar",
        data: {
          labels: p.labels,
          datasets: [
            { type:"bar", label:"件数/数量", data: p.values, borderWidth:1 },
            { type:"line", label:"累積%", data: p.cum, yAxisID: lineAxis, xAxisID: lineAxis, borderWidth:2, pointRadius:3 }
          ]
        },
        options: {
          responsive:true, maintainAspectRatio:false,
          plugins:{ legend:{display:true}, tooltip:{mode:"index", intersect:false} },
          indexAxis: horizontal ? "y" : "x",
          scales: horizontal ? {
            y: { beginAtZero:true, ticks:{ autoSkip:false } },
            x: { beginAtZero:true, ticks:{ precision:0 } },
            x1:{ position:"top", min:0, max:100, ticks:{ callback:v=>v+"%" } }
          } : {
            x: { ticks:{ autoSkip:false } },
            y: { beginAtZero:true, ticks:{ precision:0 } },
            y1:{ position:"right", min:0, max:100, ticks:{ callback:v=>v+"%" } }
          }
        }
      });

      // 明細テーブル
      if(p.total>0){
        const rowsArr = Array.from(p.rowsByCat.entries()).sort((a,b)=>b[1]-a[1]);
        $("claimsBody").innerHTML = rowsArr.map(([k,v])=>{
          const pct = Math.round((v/p.total)*1000)/10;
          return `<tr><td>${k||"（未分類）"}</td><td>${v}</td><td>${pct}%</td></tr>`;
        }).join("");
      }else{
        $("claimsBody").innerHTML = `<tr><td colspan="3" class="muted">データなし</td></tr>`;
      }
    }

    // ====== Bootstrap ======
    async function bootstrap(){
      const out = await loadCSV();
      RAW = out.data || [];
      HEADERS = out.meta?.fields || Object.keys(RAW[0]||{});
      MAP = detectMap(HEADERS);

      // Inisialisasi filter + default ke Juni & SG,CV
      initFilters(RAW, MAP);
      drawAll();
    }

    // ====== Events ======
    ["change","input"].forEach(ev=>{
      $("customerQuery").addEventListener(ev, drawAll);
      $("fromMonth").addEventListener(ev, drawAll);
      $("toMonth").addEventListener(ev, drawAll);
      $("topN").addEventListener(ev, drawAll);
      $("trendMode").addEventListener(ev, drawAll);
      $("paretoOrientation").addEventListener(ev, drawAll);
    });
    $("reloadBtn").onclick = bootstrap;
    $("exportCsvBtn").onclick = ()=>{
      if(!MAP){ setError("列検出に失敗したため、エクスポートできません。"); return; }
      const filtered = getFiltered(RAW, MAP);
      const csv = toCSV(filtered);
      const blob = new Blob([csv], {type:"text/csv;charset=utf-8"});
      const a = document.createElement("a");
      a.href = URL.createObjectURL(blob);
      a.download = `品質情報_${new Date().toISOString().slice(0,10)}.csv`;
      a.click();
    };

    window.addEventListener("DOMContentLoaded", bootstrap);
  </script>
</body>
</html>
