<!doctype html>
<html lang="ja" data-theme="light">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>品質情報（リアルタイム）| 品質管理生産技術システム</title>

  <!-- Chart.js & optional datalabels -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.4/dist/chart.umd.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-datalabels@2.2.0"></script>
  <!-- PapaParse for CSV -->
  <script src="https://cdn.jsdelivr.net/npm/papaparse@5.4.1/papaparse.min.js"></script>

  <style>
    :root{
      --bg1:#eef4ff; --bg2:#f8fafc; --card:#fff; --ink:#0f172a; --muted:#64748b; --border:#e5e7eb; --accent:#2563eb;
      --radius-lg:20px; --shadow:0 24px 40px rgba(15,23,42,.08);
    }
    *{box-sizing:border-box}
    html,body{margin:0;height:100%;font-family:system-ui,-apple-system,Segoe UI,Roboto,"Noto Sans JP","Yu Gothic",sans-serif;color:var(--ink);background:linear-gradient(120deg,var(--bg1),var(--bg2))}
    header{position:sticky;top:0;background:#ffffffcc;backdrop-filter:blur(8px);border-bottom:1px solid var(--border);z-index:10}
    .container{max-width:1120px;margin:0 auto;padding:16px 20px}
    .row{display:flex;align-items:end;justify-content:space-between;gap:16px;flex-wrap:wrap}
    h1{margin:0;font-size:clamp(20px,4vw,28px);letter-spacing:.08em}
    .sub{font-size:12px;color:var(--muted)}
    .credit{font-size:12px;color:var(--muted)}
    .right{display:flex;align-items:center;gap:10px}
    .btn-home{display:inline-flex;align-items:center;gap:6px;padding:8px 12px;border:1px solid var(--border);border-radius:999px;background:#fff;color:var(--ink);text-decoration:none;box-shadow:var(--shadow);font-size:13px}
    .btn-home:hover{border-color:var(--accent)}
    .btn-src{font-size:12px;margin-left:8px;text-decoration:underline;color:var(--accent)}
    @media print{ .no-print{ display:none !important } .btn-src{ display:none } }

    main{padding:18px 20px}
    .grid{max-width:1120px;margin:0 auto;display:grid;grid-template-columns:1fr;gap:14px}
    @media(min-width:860px){.grid{grid-template-columns:1fr 1fr}}

    .card{background:var(--card);border:1px solid var(--border);border-radius:var(--radius-lg);box-shadow:var(--shadow)}
    .card h2{margin:0;padding:12px 14px;border-bottom:1px solid var(--border);font-size:14px;letter-spacing:.06em}
    .card .body{padding:10px 12px}
    .chart-box{height:260px}

    footer{max-width:1120px;margin:12px auto 24px;padding:0 20px;color:var(--muted);font-size:12px}
    .pill{display:inline-flex;align-items:center;gap:6px;border:1px solid var(--border);border-radius:999px;padding:6px 10px;background:#fff}
    .legend{display:flex;flex-wrap:wrap;gap:8px}

    @media print{
      @page { size: A4 portrait; margin: 10mm; }
      body{background:#fff}
      header{position:static;background:#fff}
      .grid{grid-template-columns:1fr 1fr;gap:8mm}
      .chart-box{height:80mm}
      .card{box-shadow:none}
    }
  </style>
</head>
<body>
  <header>
    <div class="container">
      <div class="row">
        <div>
          <h1>品質情報（リアルタイム）</h1>
          <div class="sub" id="subtitle">読み込み中…</div><a id="openSrc" class="btn-src" href="#" target="_blank" rel="noopener">データを開く</a>
        </div>
        <div class="right">
          <a class="btn-home no-print" href="https://wahyu0312-source.github.io/kensa-portal/" title="ホームへ">Home</a>
        </div>
      </div>
    </div>
  </header>

  <main>
    <div class="grid" id="cards">
      <section class="card" id="card-monthly" hidden>
        <h2>月別推移（年月）</h2>
        <div class="body">
          <div class="chart-box"><canvas id="chartMonthly"></canvas></div>
          <div class="legend" id="legend-monthly"></div>
        </div>
      </section>

      <section class="card" id="card-type" hidden>
        <h2>クレーム種類（件数）</h2>
        <div class="body">
          <div class="chart-box"><canvas id="chartType"></canvas></div>
        </div>
      </section>

      <section class="card" id="card-customer" hidden>
        <h2>顧客名（TOP10）</h2>
        <div class="body">
          <div class="chart-box"><canvas id="chartCustomer"></canvas></div>
        </div>
      </section>

      <section class="card" id="card-dept" hidden>
        <h2>部署（TOP10）</h2>
        <div class="body">
          <div class="chart-box"><canvas id="chartDept"></canvas></div>
        </div>
      </section>
    </div>
  </main>

  <footer>
    <div id="detect"></div>
    <div class="credit">design by wahyu</div>
  </footer>

<script>
(() => {
  // ===== CONFIG =====
  const CSV_URL_BASE = 'https://docs.google.com/spreadsheets/d/e/2PACX-1vTTyGRhapP1p6YUqQiGWwmHRYZjl-kxfuYeROLQNcOk0ZZFZeaGgQRZF1PNkiLe0mGXCX5pHnRUJsG6/pub?gid=649800458&single=true&output=csv';
  const CSV_URL = CSV_URL_BASE + '&t=' + Date.now();
  const COLS = { ym: '年月', type: 'クレーム種類', customer: '顧客名', dept: '部署' };

  // ===== Helpers =====
  const el = (s)=> document.querySelector(s);
  const fmtYMD = (d)=> `${d.getFullYear()}/${String(d.getMonth()+1).padStart(2,'0')}/${String(d.getDate()).padStart(2,'0')}`;
  const isNumeric = (v)=> v!==null && v!=='' && !isNaN(Number((''+v).replace(/,/g,'')));

  // Title subtext + source link
  el('#subtitle').textContent = `データ元: Googleスプレッドシート（gid=${new URL(CSV_URL_BASE).searchParams.get('gid')}） / 生成: ${fmtYMD(new Date())}`;
  const a = el('#openSrc'); if(a){ a.href = CSV_URL_BASE; }

  // 年月 parser → returns {y,m,label} or null
  function parseYM(v){
    if(v==null) return null;
    const s = (''+v).trim();
    // patterns: 2025/06, 2025-6, 2025年6月, 2025.06
    let m = s.match(/(\d{4})\D+(\d{1,2})/);
    if(!m){
      // pure yyyymm or yyyym?
      m = s.match(/(\d{4})(\d{1,2})/);
    }
    if(!m) return null;
    const y = Number(m[1]);
    const mo = Number(m[2]);
    if(!y || !mo || mo<1 || mo>12) return null;
    return { y, m: mo, label: `${y}/${String(mo).padStart(2,'0')}` };
  }

  function idxOf(header, name){
    return header.findIndex(h => (h||'').toString().trim() === name);
  }

  function topN(mapEntries, n=10){
    return [...mapEntries].sort((a,b)=> b[1]-a[1]).slice(0,n);
  }

  // ===== Charts =====
  if (window.ChartDataLabels) { Chart.register(window.ChartDataLabels); }

  function makeLine(ctx, labels, values){
    return new Chart(ctx, {
      type:'line',
      data:{ labels, datasets:[{ data: values, fill:true, tension:.25 }]},
      options:{ responsive:true, maintainAspectRatio:false,
        plugins:{ legend:{display:false}, datalabels:{display:false} },
        scales:{ x:{ grid:{display:false} }, y:{ beginAtZero:true, grid:{color:'#eee'} } }
      }
    });
  }

  function makeBar(ctx, labels, values, {horizontal=false}={}){
    return new Chart(ctx, {
      type:'bar',
      data:{ labels, datasets:[{ data: values, borderWidth:1 }]},
      options:{ responsive:true, maintainAspectRatio:false, indexAxis: horizontal?'y':'x',
        plugins:{ legend:{display:false}, datalabels:{ anchor:'end', align:'end', formatter:v=> v, rotation: horizontal?0:-90, font:{size:10} } },
        scales:{ x:{ grid:{display:false}, ticks:{font:{size:10}} }, y:{ beginAtZero:true, grid:{color:'#eee'}, ticks:{font:{size:10}} } }
      }
    });
  }

  // ===== Load & Render =====
  async function loadCSV(){
    return await new Promise((resolve, reject)=>{
      Papa.parse(CSV_URL, {
        download:true, header:false, skipEmptyLines:true,
        complete: (r)=> resolve(r.data),
        error: (e)=> reject(e)
      });
    });
  }

  function render(data){
    if(!data || data.length<2){
      const warn=document.createElement('div');
      warn.style.cssText='max-width:1120px;margin:12px auto 0;padding:12px 16px;border:1px solid #ef4444;background:#fff1f2;border-radius:12px;color:#991b1b;font-size:13px';
      warn.textContent='CSVにデータがありません。';
      document.body.insertBefore(warn, document.body.children[1]);
      return;
    }
    const header = data[0].map(v=> (v||'').toString().trim());
    const rows = data.slice(1);
    const idxYM = idxOf(header, COLS.ym);
    const idxType = idxOf(header, COLS.type);
    const idxCust = idxOf(header, COLS.customer);
    const idxDept = idxOf(header, COLS.dept);

    // Validate required columns
    const missing = [];
    if(idxYM<0) missing.push(COLS.ym);
    if(idxType<0) missing.push(COLS.type);
    if(idxCust<0) missing.push(COLS.customer);
    if(idxDept<0) missing.push(COLS.dept);
    if(missing.length){
      const warn=document.createElement('div');
      warn.style.cssText='max-width:1120px;margin:12px auto 0;padding:12px 16px;border:1px solid #f0ad4e;background:#fffbe6;border-radius:12px;color:#6b4f00;font-size:13px';
      warn.innerHTML = '必要な列が見つかりません：<b>' + missing.join('、') + '</b>';
      document.body.insertBefore(warn, document.body.children[1]);
      el('#detect').textContent = 'ヘッダー: ' + header.join(' / ');
      return;
    }

    // Aggregations
    const mapYM = new Map();
    const mapType = new Map();
    const mapCust = new Map();
    const mapDept = new Map();

    for(const r of rows){
      const ym = parseYM(r[idxYM]);
      const type = (r[idxType]||'').toString().trim();
      const cust = (r[idxCust]||'').toString().trim();
      const dept = (r[idxDept]||'').toString().trim();

      if(ym) mapYM.set(ym.label, (mapYM.get(ym.label)||0) + 1);
      if(type) mapType.set(type, (mapType.get(type)||0) + 1);
      if(cust) mapCust.set(cust, (mapCust.get(cust)||0) + 1);
      if(dept) mapDept.set(dept, (mapDept.get(dept)||0) + 1);
    }

    // Sort 年月 chronologically
    const ymSorted = [...mapYM.keys()].sort((a,b)=>{
      const [ya,ma]=a.split('/').map(Number); const [yb,mb]=b.split('/').map(Number);
      if(ya!==yb) return ya-yb; return ma-mb;
    });
    const ymValues = ymSorted.map(k=> mapYM.get(k)||0);
    if(ymSorted.length){
      el('#card-monthly').hidden=false;
      makeLine(el('#chartMonthly'), ymSorted, ymValues);
      el('#legend-monthly').innerHTML = `<span class="pill">集計対象: ${COLS.ym}（1行=1件）</span>`;
    }

    // クレーム種類
    if(mapType.size){
      el('#card-type').hidden=false;
      const tEntries = [...mapType.entries()].sort((a,b)=> b[1]-a[1]);
      makeBar(el('#chartType'), tEntries.map(x=>x[0]), tEntries.map(x=>x[1]), {horizontal:false});
    }

    // 顧客 TOP10
    if(mapCust.size){
      el('#card-customer').hidden=false;
      const top = topN(mapCust.entries(), 10);
      makeBar(el('#chartCustomer'), top.map(x=>x[0]), top.map(x=>x[1]), {horizontal:true});
    }

    // 部署 TOP10
    if(mapDept.size){
      el('#card-dept').hidden=false;
      const top = topN(mapDept.entries(), 10);
      makeBar(el('#chartDept'), top.map(x=>x[0]), top.map(x=>x[1]), {horizontal:true});
    }

    el('#detect').textContent = `列マッピング: 年月=${COLS.ym}、クレーム種類=${COLS.type}、顧客名=${COLS.customer}、部署=${COLS.dept}`;
  }

  async function main(){
    try{
      const data = await loadCSV();
      render(data);
    }catch(err){
      console.error(err);
      const warn=document.createElement('div');
      warn.style.cssText='max-width:1120px;margin:12px auto 0;padding:12px 16px;border:1px solid #ef4444;background:#fff1f2;border-radius:12px;color:#991b1b;font-size:13px';
      warn.textContent='CSVの取得に失敗しました。公開設定やURLをご確認ください。';
      document.body.insertBefore(warn, document.body.children[1]);
    }
  }

  window.addEventListener('load', main);
})();
</script>

</body>
</html>
