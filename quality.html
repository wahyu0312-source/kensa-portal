<!doctype html>
<html lang="ja" data-theme="light">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>å“è³ªæƒ…å ±</title>

<style>
  :root{
    --bg:#f6f7fb; --panel:#fff; --ink:#0f172a; --muted:#64748b; --border:#e5e7eb; --ring:#c7d2fe;
    --accent:#2563eb; --radius-xl:22px; --radius:12px;
    --shadow-1:0 12px 30px rgba(15,23,42,.08); --shadow-2:0 30px 60px rgba(15,23,42,.10);
  }
  [data-theme="dark"]{
    --bg:#0b1220; --panel:#0f172a; --ink:#e5e7eb; --muted:#94a3b8; --border:#1f2937; --ring:#243b55;
    --accent:#60a5fa; --shadow-1:none; --shadow-2:none;
  }
  *{box-sizing:border-box}
  html,body{height:100%}
  body{
    margin:0; color:var(--ink);
    font-family:system-ui,-apple-system,Segoe UI,Roboto,"Noto Sans JP","Yu Gothic",sans-serif;
    background:
      radial-gradient(1100px 540px at -12% -12%, #c7d2fe33 0%, transparent 60%),
      radial-gradient(820px 460px at 112% -6%, #bae6fd33 0%, transparent 55%),
      linear-gradient(120deg,#f8fafc,var(--bg));
  }

  /* ===== Shell (header + sidebar + main) ===== */
  .app{
    display:grid;
    grid-template-columns:260px 1fr;
    grid-template-rows:64px 1fr;
    grid-template-areas:
      "header header"
      "side   main";
    min-height:100vh;
  }
  header{
    grid-area:header; position:sticky; top:0; z-index:50;
    backdrop-filter: blur(12px);
    background: color-mix(in srgb, var(--panel) 85%, transparent);
    border-bottom:1px solid var(--border);
  }
  .header-wrap{
    height:64px; max-width:1400px; margin:0 auto;
    display:flex; align-items:center; gap:12px; padding:0 20px;
  }
  .brand{display:flex; align-items:center; gap:10px}
  .brand img{height:36px}
  .brand .ttl{font-weight:800}
  .top-actions{display:flex; gap:8px; align-items:center; flex-wrap:wrap; margin-left:auto}
  .btn{
    height:34px; padding:0 12px; border:1px solid var(--border); border-radius:10px; background:var(--panel);
    color:var(--ink); display:inline-flex; align-items:center; gap:8px; cursor:pointer; text-decoration:none;
  }
  .btn:hover{ border-color:var(--ring) }

  /* Sidebar */
  .side{
    grid-area:side; position:sticky; top:64px; align-self:start;
    height:calc(100vh - 64px); overflow:auto; padding:18px;
  }
  .side-card{
    background:var(--panel); border:1px solid var(--border); border-radius:var(--radius-xl);
    box-shadow:var(--shadow-1); padding:14px;
  }
  .side h3{ margin:4px 8px 10px; font-size:12px; letter-spacing:.08em; color:#6b7280; text-transform:uppercase }
  .navlist{ display:grid; gap:4px }
  .slink{ display:flex; align-items:center; gap:10px; padding:10px 12px; border-radius:12px; color:var(--ink); text-decoration:none }
  .slink:hover{ background:#f1f5ff }
  [data-theme="dark"] .slink:hover{ background:#132033 }
  .ico{ width:22px; text-align:center }

  /* Main */
  main{ grid-area:main; max-width:1400px; margin:0 auto; padding:22px 20px 64px }
  .card{ background:var(--panel); border:1px solid var(--border); border-radius:var(--radius-xl); box-shadow:var(--shadow-2); padding:18px }
  .card + .card{ margin-top:16px }
  .h1{ font-size:22px; margin:0 }
  .small{ font-size:12px; color:var(--muted) }

  /* Filters */
  .grid{ display:grid; gap:12px; grid-template-columns:repeat(4,minmax(0,1fr)) }
  @media (max-width:1000px){ .grid{ grid-template-columns:repeat(2,minmax(0,1fr)) } }
  @media (max-width:620px){ .grid{ grid-template-columns:1fr } }

  .field label{ display:block; font-size:12px; font-weight:700; color:var(--muted); margin:0 0 6px }
  .select{ width:100%; height:38px; padding:0 12px; border:1px solid var(--border); border-radius:12px; background:var(--panel) }
  .btn-ghost{ background:#f1f5f9 }
  [data-theme="dark"] .btn-ghost{ background:#0b1624 }

  /* Chart boxes */
  .chart-grid{ display:grid; gap:16px; grid-template-columns:1fr 1fr }
  .chart-box{ background:var(--panel); border:1px solid var(--border); border-radius:16px; padding:12px; min-height:360px; display:flex; flex-direction:column }
  .chart-head{ display:flex; align-items:center; gap:8px; margin-bottom:6px }
  .chart-head .sp{ margin-left:auto }
  .export{ height:28px; padding:0 10px; border:1px solid var(--border); border-radius:8px; background:var(--panel); cursor:pointer; font-size:12px }
  .chart-canvas{ flex:1; min-height:300px }
  @media (max-width:900px){ .chart-grid{ grid-template-columns:1fr } }

  /* Preview table */
  table{ width:100%; border-collapse:collapse; }
  th,td{ border:1px solid var(--border); padding:8px 10px; text-align:left; font-size:13px }
  thead th{ background:#f8fafc }
  [data-theme="dark"] thead th{ background:#0b1624 }
  details summary{ cursor:pointer; font-weight:600 }
  @media (max-width:900px){ .app{ grid-template-columns:1fr; grid-template-areas:"header" "main"; } .side{ display:none } }
</style>
</head>

<body>
<div class="app">
  <!-- ===== HEADER ===== -->
  <header>
    <div class="header-wrap">
      <div class="brand">
        <img src="tsh.png" alt="TSH"><strong class="ttl">å“è³ªç®¡ç†ç”Ÿç”£æŠ€è¡“</strong>
      </div>
      <nav class="top-actions">
        <a class="btn" href="./index.html">ğŸ  ãƒ›ãƒ¼ãƒ </a>
        <a class="btn" href="./forms.html">ğŸ“„ å‡ºè·æ¤œæŸ»æˆç¸¾æ›¸</a>
        <a class="btn" href="./sagyoutejunsho.html">ğŸ“ ä½œæ¥­æ‰‹é †æ›¸</a>
        <a class="btn" href="./charts.html">ğŸ“ˆ ãƒãƒ£ãƒ¼ãƒˆ</a>
        <a class="btn" href="./quality.html" aria-current="page">ğŸ” å“è³ªæƒ…å ±</a>
        <span id="lastLoaded" class="small" style="margin-left:8px"></span>
      </nav>
    </div>
  </header>

  <!-- ===== SIDEBAR ===== -->
  <aside class="side">
    <div class="side-card">
      <h3>Pages</h3>
      <div class="navlist">
        <a class="slink" href="./index.html"><span class="ico">ğŸ </span><strong>ãƒ›ãƒ¼ãƒ </strong></a>
        <a class="slink" href="./forms.html"><span class="ico">ğŸ“„</span><strong>å‡ºè·æ¤œæŸ»æˆç¸¾æ›¸</strong></a>
        <a class="slink" href="./sagyoutejunsho.html"><span class="ico">ğŸ“</span><strong>ä½œæ¥­æ‰‹é †æ›¸</strong></a>
        <a class="slink" href="./charts.html"><span class="ico">ğŸ“ˆ</span><strong>ãƒãƒ£ãƒ¼ãƒˆ</strong></a>
        <a class="slink" href="./quality.html"><span class="ico">ğŸ”</span><strong>å“è³ªæƒ…å ±</strong></a>
        <a class="slink" href="./claim.html"><span class="ico">ğŸ§ª</span><strong>Trial Page</strong></a>
      </div>
    </div>
  </aside>

  <!-- ===== MAIN ===== -->
  <main>
    <section class="card">
      <div style="display:flex;align-items:end;gap:12px;justify-content:space-between;margin-bottom:12px">
        <h1 class="h1">å“è³ªæƒ…å ±</h1>
        <span class="small">ï¼ˆå¹´æœˆãƒ»ã‚¯ãƒ¬ãƒ¼ãƒ ç¨®é¡ãƒ»æ©Ÿç¨®åãƒ»éƒ¨ç½²ï¼‰</span>
      </div>

      <div class="grid">
        <div class="field">
          <label for="fYM">å¹´æœˆ</label>
          <select id="fYM" class="select"></select>
        </div>
        <div class="field">
          <label for="fType">ã‚¯ãƒ¬ãƒ¼ãƒ ç¨®é¡</label>
          <select id="fType" class="select"></select>
        </div>
        <div class="field">
          <label for="fModel">æ©Ÿç¨®å</label>
          <select id="fModel" class="select"></select>
        </div>
        <div class="field">
          <label for="fDept">éƒ¨ç½²</label>
          <select id="fDept" class="select"></select>
        </div>
      </div>
      <div style="margin-top:10px;display:flex;gap:8px;flex-wrap:wrap">
        <button id="clearFilters" class="btn btn-ghost">ãƒ•ã‚£ãƒ«ã‚¿å…¨è§£é™¤</button>
      </div>
    </section>

    <section class="chart-grid" style="margin-top:16px">
      <div class="chart-box">
        <div class="chart-head"><strong>ä»¶æ•°ï¼ˆå¹´æœˆï¼‰</strong><span class="sp"></span><button data-chart="ym" class="export">PNGä¿å­˜</button></div>
        <canvas id="chartYM" class="chart-canvas"></canvas>
      </div>
      <div class="chart-box">
        <div class="chart-head"><strong>ä»¶æ•°ï¼ˆã‚¯ãƒ¬ãƒ¼ãƒ ç¨®é¡ï¼‰</strong><span class="sp"></span><button data-chart="type" class="export">PNGä¿å­˜</button></div>
        <canvas id="chartType" class="chart-canvas"></canvas>
      </div>
      <div class="chart-box">
        <div class="chart-head"><strong>ä»¶æ•°ï¼ˆæ©Ÿç¨®åï¼‰</strong><span class="sp"></span><button data-chart="model" class="export">PNGä¿å­˜</button></div>
        <canvas id="chartModel" class="chart-canvas"></canvas>
      </div>
      <div class="chart-box">
        <div class="chart-head"><strong>ä»¶æ•°ï¼ˆéƒ¨ç½²ï¼‰</strong><span class="sp"></span><button data-chart="dept" class="export">PNGä¿å­˜</button></div>
        <canvas id="chartDept" class="chart-canvas"></canvas>
      </div>
    </section>

    <section class="chart-grid" style="margin-top:16px">
      <div class="chart-box">
        <div class="chart-head"><strong>ãƒ‘ãƒ¬ãƒ¼ãƒˆï¼ˆã‚¯ãƒ¬ãƒ¼ãƒ ç¨®é¡ï¼‰</strong><span class="sp"></span><button data-chart="paretoType" class="export">PNGä¿å­˜</button></div>
        <canvas id="chartParetoType" class="chart-canvas"></canvas>
      </div>
      <div class="chart-box">
        <div class="chart-head"><strong>å††ã‚°ãƒ©ãƒ•ï¼ˆéƒ¨ç½²ï¼‰</strong><span class="sp"></span><button data-chart="pieDept" class="export">PNGä¿å­˜</button></div>
        <canvas id="chartPieDept" class="chart-canvas"></canvas>
      </div>
    </section>

    <section class="card" style="margin-top:16px">
      <details>
        <summary>ãƒ‡ãƒ¼ã‚¿æ•°è¡Œãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼</summary>
        <div style="overflow:auto;margin-top:10px">
          <table>
            <thead id="previewHead"></thead>
            <tbody id="previewBody"></tbody>
          </table>
        </div>
      </details>
    </section>
  </main>
</div>

<!-- Libs -->
<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-datalabels@2.2.0"></script>
<script src="https://cdn.jsdelivr.net/npm/papaparse@5.4.1/papaparse.min.js"></script>

<script>
/* ===== CSV URL + fallbacks ===== */
const DIRECT_CSV = "https://docs.google.com/spreadsheets/d/e/2PACX-1vQGwY4tjwfHVYZMuJpqSVo9uqHexcD2bmHdCiIg85oo036PLkxe4YXhHCpJbFi1mT1VgyjfNYLHOtNb/pub?gid=1070847733&single=true&output=csv";
function buildProxyUrls(url){
  const noProto = url.replace(/^https?:\/\//, "");
  return [ url, `https://r.jina.ai/http/${noProto}`, `https://cors.isomorphic-git.org/${url}` ];
}
async function fetchTextWithFallback(url){
  const tries = buildProxyUrls(url);
  let lastErr;
  for(const u of tries){
    try{
      const res = await fetch(u, {mode:"cors"});
      if(!res.ok) throw new Error(`HTTP ${res.status}`);
      const text = await res.text();
      if(text) return { url:u, text };
    }catch(e){ lastErr = e; }
  }
  throw lastErr || new Error("Fetch failed");
}

/* ===== Utils ===== */
const $  = (s)=>document.querySelector(s);
const $$ = (s)=>Array.from(document.querySelectorAll(s));
const requiredKeys = {
  ym: ["å¹´æœˆ","yearmonth","year-month","å¹´æœˆæ—¥","ym"],
  type: ["ã‚¯ãƒ¬ãƒ¼ãƒ ç¨®é¡","ã‚¯ãƒ¬ãƒ¼ãƒ ç¨®åˆ¥","ã‚¯ãƒ¬ãƒ¼ãƒ ","ç¨®åˆ¥","claimtype"],
  model: ["æ©Ÿç¨®å","æ©Ÿç¨®","å‹å¼","model"],
  dept: ["éƒ¨ç½²","éƒ¨é–€","éƒ¨èª²","éƒ¨ç½²å","department"],
};
function normalizeHeader(h){ return String(h||"").trim().toLowerCase().replace(/[\s_\-/]/g,""); }
function autoMapHeaders(headers){
  const norm = headers.map(h=>({raw:h,n:normalizeHeader(h)}));
  const pick = (cands)=>{ for(const c of cands){ const f = norm.find(x=>x.n.includes(normalizeHeader(c))); if(f) return f.raw; } return headers[0]||""; };
  return { ym:pick(requiredKeys.ym), type:pick(requiredKeys.type), model:pick(requiredKeys.model), dept:pick(requiredKeys.dept) };
}
function normalizeYM(v){
  if(v==null) return "";
  const s=String(v).trim(); if(!s) return "";
  const m1=s.match(/^(\d{4})[-\/.](\d{1,2})(?:[-\/.]\d{1,2})?$/); if(m1) return `${m1[1]}-${m1[2].padStart(2,"0")}`;
  const m2=s.match(/(\d{4})\s*å¹´\s*(\d{1,2})/); if(m2) return `${m2[1]}-${m2[2].padStart(2,"0")}`;
  const m3=s.match(/^(\d{4})(\d{2})(\d{0,2})?$/); if(m3) return `${m3[1]}-${m3[2]}`;
  const m4=s.match(/^(\d{4})[-\/.](\d{1,2})$/);   if(m4) return `${m4[1]}-${m4[2].padStart(2,"0")}`;
  const d=new Date(s); if(!Number.isNaN(d.getTime())) return `${d.getFullYear()}-${String(d.getMonth()+1).padStart(2,"0")}`;
  return s;
}
function countsBy(arr, keyFn){
  const map=new Map();
  for(const a of arr){ const k=keyFn(a); if(!k) continue; map.set(k,(map.get(k)||0)+1); }
  return Array.from(map.entries()).sort((a,b)=>a[0]>b[0]?1:-1);
}
function uniqueValues(arr, key){
  const s=new Set(); arr.forEach(r=>{ const v=(r[key]??"").toString().trim(); if(v) s.add(v); });
  return Array.from(s).sort();
}
function downloadImageFromChart(chart, filename){ const a=document.createElement("a"); a.href=chart.toBase64Image(); a.download=filename; a.click(); }

/* Palette for éƒ¨ç½² (fixed colors for readability) */
const deptColorMap = {
  "ã‚³ãƒ³ãƒ™ãƒ¤ãƒ¼":"#3b82f6",
  "ã‚·ãƒ£ãƒˆãƒ«ã‚¬ãƒ¼ãƒ‰":"#f50b59",
};
const palette = ["#6366F1","#10B981","#EF4444","#8B5CF6","#06B6D4","#84CC16","#F97316","#14B8A6","#A855F7","#22C55E","#EAB308","#F43F5E"];
const hexToRgba=(hex,a=0.55)=>{const h=hex.replace("#","");const r=parseInt(h.slice(0,2),16),g=parseInt(h.slice(2,4),16),b=parseInt(h.slice(4,6),16);return`rgba(${r},${g},${b},${a})`};
function colorForDept(label,i){ const base = deptColorMap[label] || palette[i%palette.length]; return {bg:hexToRgba(base,0.55), bd:base }; }

/* ===== State ===== */
let rawRows=[], headers=[], mapping={ym:"",type:"",model:"",dept:""};
let chartYM, chartType, chartModel, chartDept, chartParetoType, chartPieDept;

/* ===== Render helpers ===== */
function renderPreview(rows, max=10){
  const head=$("#previewHead"), body=$("#previewBody"); head.innerHTML=""; body.innerHTML="";
  if(!rows.length) return;
  const tr=document.createElement("tr");
  headers.forEach(h=>{ const th=document.createElement("th"); th.textContent=h; tr.appendChild(th); });
  head.appendChild(tr);
  rows.slice(0,max).forEach(r=>{ const trb=document.createElement("tr"); headers.forEach(h=>{ const td=document.createElement("td"); td.textContent=r[h]??""; trb.appendChild(td); }); body.appendChild(trb); });
}
function currentFilters(){ return { ym:$("#fYM").value, type:$("#fType").value, model:$("#fModel").value, dept:$("#fDept").value }; }
function applyFilters(rows){
  const f=currentFilters();
  return rows.filter(r=>{
    if(f.ym && normalizeYM(r[mapping.ym])!==f.ym) return false;
    if(f.type && r[mapping.type]!==f.type) return false;
    if(f.model && r[mapping.model]!==f.model) return false;
    if(f.dept && r[mapping.dept]!==f.dept) return false;
    return true;
  });
}
function refreshFilters(){
  const rows=rawRows;
  const ymValues = Array.from(new Set(rows.map(r=>normalizeYM(r[mapping.ym])).filter(Boolean))).sort();
  const typeValues = uniqueValues(rows, mapping.type);
  const modelValues = uniqueValues(rows, mapping.model);
  const deptValues = uniqueValues(rows, mapping.dept);

  const fill=(sel,values,labelAll="(ã™ã¹ã¦)")=>{
    sel.innerHTML=""; const o=document.createElement("option"); o.value=""; o.textContent=labelAll; sel.appendChild(o);
    values.forEach(v=>{ const op=document.createElement("option"); op.value=v; op.textContent=v; sel.appendChild(op); });
  };
  fill($("#fYM"), ymValues);
  fill($("#fType"), typeValues);
  fill($("#fModel"), modelValues);
  fill($("#fDept"), deptValues);
}
function destroyCharts(){ [chartYM, chartType, chartModel, chartDept, chartParetoType, chartPieDept].forEach(ch=>{ if(ch) ch.destroy(); }); }

/* ===== Charts ===== */
function wrapJP(text,max=6){ const s=String(text??""); const out=[]; for(let i=0;i<s.length;i+=max) out.push(s.slice(i,i+max)); return out; }

function buildCharts(){
  const rows = applyFilters(rawRows);

  // å¹´æœˆ
  const ymCounts = countsBy(rows, r=>normalizeYM(r[mapping.ym]));
  const ymLabels = ymCounts.map(([k])=>k);
  const ymData   = ymCounts.map(([,v])=>v);

  // æ©Ÿç¨®
  const modelCounts = countsBy(rows, r=>(r[mapping.model]||"").toString().trim());
  const modelLabels = modelCounts.map(([k])=>k || "ï¼ˆæœªè¨­å®šï¼‰");
  const modelData   = modelCounts.map(([,v])=>v);

  // éƒ¨ç½²
  const deptCounts = countsBy(rows, r=>(r[mapping.dept]||"").toString().trim());
  const deptLabels = deptCounts.map(([k])=>k || "ï¼ˆæœªè¨­å®šï¼‰");
  const deptData   = deptCounts.map(([,v])=>v);
  const deptColors = deptLabels.map((l,i)=>colorForDept(l,i));

  // ç¨®é¡
  const typeCounts = countsBy(rows, r=>(r[mapping.type]||"").toString().trim());
  const typeLabels = typeCounts.map(([k])=>k || "ï¼ˆæœªè¨­å®šï¼‰");
  const typeData   = typeCounts.map(([,v])=>v);
  const typeLabelsWrapped = typeLabels.map(l=>wrapJP(l, 6));

  destroyCharts();
  try{ Chart.register(ChartDataLabels); }catch(_){}

  const barOpts = (horiz=false)=>({
    responsive:true, maintainAspectRatio:false, animation:false, indexAxis:horiz?'y':'x',
    scales:{ x:{ ticks:{ maxRotation:0, autoSkip:true } }, y:{ beginAtZero:true, ticks:{ precision:0 } } },
    plugins:{ legend:{ display:false }, datalabels:{ anchor:'end', align:horiz?'right':'top', offset:4, formatter:v=>v, font:{ weight:'600' } } }
  });

  chartYM = new Chart($("#chartYM"), { type:"bar", data:{ labels:ymLabels, datasets:[{ label:"ä»¶æ•°", data:ymData }] }, options:barOpts(false) });

  chartType = new Chart($("#chartType"), {
    type:"bar",
    data:{ labels:typeLabelsWrapped, datasets:[{ label:"ä»¶æ•°", data:typeData }] },
    options:{
      responsive:true, maintainAspectRatio:false, animation:false, indexAxis:'y',
      scales:{ y:{ beginAtZero:true, ticks:{ autoSkip:false } }, x:{ beginAtZero:true, ticks:{ precision:0 } } },
      plugins:{
        legend:{ display:false },
        tooltip:{ callbacks:{ title:(items)=> typeLabels[items[0].dataIndex] || "" } },
        datalabels:{ anchor:'end', align:'right', offset:4, formatter:v=>v, font:{ weight:'600' } }
      }
    }
  });

  const modelHoriz = modelLabels.length>6;
  chartModel = new Chart($("#chartModel"), { type:"bar", data:{ labels:modelLabels, datasets:[{ label:"ä»¶æ•°", data:modelData }] }, options:barOpts(modelHoriz) });

  const deptHoriz = deptLabels.length>6;
  chartDept = new Chart($("#chartDept"), {
    type:"bar",
    data:{ labels:deptLabels, datasets:[{ label:"ä»¶æ•°", data:deptData, backgroundColor:deptColors.map(c=>c.bg), borderColor:deptColors.map(c=>c.bd), borderWidth:1 }] },
    options:barOpts(deptHoriz)
  });

  // Pareto (ç¨®é¡)
  const totalType = typeData.reduce((a,b)=>a+b,0) || 1;
  const pairs = typeLabels.map((l,i)=>[l, typeData[i]]).sort((a,b)=>b[1]-a[1]);
  const pLabels = pairs.map(p=>p[0]); const pBars=pairs.map(p=>p[1]);
  let cum=0; const pCumPct = pBars.map(v => (cum+=v, +(cum/totalType*100).toFixed(1)));
  chartParetoType = new Chart($("#chartParetoType"), {
    data:{
      labels:pLabels,
      datasets:[
        { type:"bar", label:"ä»¶æ•°", data:pBars, yAxisID:"y", datalabels:{ align:'end', anchor:'end' } },
        { type:"line", label:"ç´¯ç©%", data:pCumPct, yAxisID:"y1", tension:0.3, pointRadius:3, datalabels:{ align:'top', formatter:v=>v+'%' } }
      ]
    },
    options:{
      responsive:true, maintainAspectRatio:false, animation:false,
      scales:{ y:{ beginAtZero:true, ticks:{ precision:0 } }, y1:{ position:"right", beginAtZero:true, min:0, max:100, ticks:{ callback:v=>v+'%' }, grid:{ drawOnChartArea:false } } },
      plugins:{ legend:{ display:true } }
    }
  });

  // Pie (éƒ¨ç½²)
  chartPieDept = new Chart($("#chartPieDept"), {
    type:"pie",
    data:{ labels:deptLabels, datasets:[{ data:deptData, backgroundColor:deptColors.map(c=>c.bg), borderColor:deptColors.map(c=>c.bd), borderWidth:1 }] },
    options:{
      responsive:true, maintainAspectRatio:false,
      plugins:{
        legend:{ position:"right" },
        datalabels:{ formatter:(v,ctx)=>{ const sum=ctx.dataset.data.reduce((a,b)=>a+b,0)||1; return Math.round(v/sum*100)+'%'; } }
      }
    }
  });
}

/* ===== Load CSV ===== */
async function loadCSV(url){
  $("#lastLoaded").textContent = "èª­ã¿è¾¼ã¿ä¸­â€¦";
  try{
    const { url:used, text } = await fetchTextWithFallback(url);
    const parsed = Papa.parse(text, { header:true, skipEmptyLines:true });
    rawRows = parsed.data;
    headers = parsed.meta.fields || Object.keys(rawRows[0]||{});
    renderPreview(rawRows);
    mapping = autoMapHeaders(headers);
    refreshFilters();
    buildCharts();
    $("#lastLoaded").textContent = `æœ€çµ‚èª­è¾¼: ${new Date().toLocaleString()}ï¼ˆ${used.includes("r.jina.ai")?"proxy":"direct"}ï¼‰`;
  }catch(e){
    console.error(e);
    $("#lastLoaded").textContent = "èª­ã¿è¾¼ã¿å¤±æ•—: " + (e?.message || e);
  }
}

/* ===== Events ===== */
["#fYM","#fType","#fModel","#fDept"].forEach(sel=>{
  $(sel).addEventListener("change", buildCharts);
});
$("#clearFilters").addEventListener("click", ()=>{ ["#fYM","#fType","#fModel","#fDept"].forEach(s=>$(s).value=""); buildCharts(); });
$$(".export").forEach(btn=>btn.addEventListener("click", ()=>{
  const map = { ym:chartYM, type:chartType, model:chartModel, dept:chartDept, paretoType:chartParetoType, pieDept:chartPieDept };
  const inst = map[btn.dataset.chart];
  if(inst) downloadImageFromChart(inst, `chart-${btn.dataset.chart}.png`);
}));

/* ===== Init ===== */
window.addEventListener("DOMContentLoaded", ()=> loadCSV(DIRECT_CSV));
</script>
</body>
</html>
