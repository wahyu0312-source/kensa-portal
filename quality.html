<!doctype html>
<html lang="ja" data-theme="light">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>品質情報</title>
  <!-- Chart.js & plugins -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.4/dist/chart.umd.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-datalabels@2.2.0"></script>
  <!-- PapaParse for CSV -->
  <script src="https://cdn.jsdelivr.net/npm/papaparse@5.4.1/papaparse.min.js"></script>
  <style>
    :root{
      --bg1:#eef4ff; --bg2:#f8fafc; --card:#fff; --ink:#0f172a; --muted:#64748b; --border:#e5e7eb; --accent:#2563eb;
      --radius-lg:20px; --shadow:0 24px 40px rgba(15,23,42,.08);
    }
    *{box-sizing:border-box}
    html,body{margin:0;height:100%;font-family:system-ui,-apple-system,Segoe UI,Roboto,"Noto Sans JP","Yu Gothic",sans-serif;color:var(--ink);background:linear-gradient(120deg,var(--bg1),var(--bg2))}
    header{position:sticky;top:0;background:#ffffffcc;backdrop-filter:blur(8px);border-bottom:1px solid var(--border);z-index:10}
    .container{max-width:1120px;margin:0 auto;padding:16px 20px}
    .row{display:flex;align-items:end;justify-content:space-between;gap:16px;flex-wrap:wrap}
    h1{margin:0;font-size:clamp(20px,4vw,28px);letter-spacing:.08em}
    .sub{font-size:12px;color:var(--muted)}
    .credit{font-size:12px;color:var(--muted)}

    main{padding:18px 20px}
    .grid{max-width:1120px;margin:0 auto;display:grid;grid-template-columns:1fr;gap:14px}
    @media(min-width:860px){.grid{grid-template-columns:1fr 1fr}}

    .card{background:var(--card);border:1px solid var(--border);border-radius:var(--radius-lg);box-shadow:var(--shadow)}
    .card h2{margin:0;padding:12px 14px;border-bottom:1px solid var(--border);font-size:14px;letter-spacing:.06em}
    .card .body{padding:10px 12px}
    .chart-box{height:260px} /* screen height */
    /* compact footer */
    footer{max-width:1120px;margin:12px auto 24px;padding:0 20px;color:var(--muted);font-size:12px}

    .pill{display:inline-flex;align-items:center;gap:6px;border:1px solid var(--border);border-radius:999px;padding:6px 10px;background:#fff}
    .legend{display:flex;flex-wrap:wrap;gap:8px}

    /* Print: A4 1 page fit */
    @media print{
      @page { size: A4 portrait; margin: 10mm; }
      body{background:#fff}
      header{position:static;background:#fff}
      .grid{grid-template-columns:1fr 1fr;gap:8mm}
      .chart-box{height:80mm} /* 2x2 charts + header fits into 1 page */
      .card{box-shadow:none}
    }
  </style>
</head>
<body>
  <header>
    <div class="container">
      <div class="row">
        <div>
          <h1>品質情報</h1>
          <div class="sub" id="subtitle">読み込み中…</div>
        </div>
        <div class="credit">design by wahyu</div>
      </div>
    </div>
  </header>

  <main>
    <div class="grid" id="cards">
      <!-- 月別推移 -->
      <section class="card" id="card-monthly" hidden>
        <h2>月別推移（直近12か月）</h2>
        <div class="body">
          <div class="chart-box"><canvas id="chartMonthly"></canvas></div>
          <div class="legend" id="legend-monthly"></div>
        </div>
      </section>

      <!-- 顧客別 Top10 -->
      <section class="card" id="card-customer" hidden>
        <h2>顧客別（TOP10）</h2>
        <div class="body">
          <div class="chart-box"><canvas id="chartCustomer"></canvas></div>
        </div>
      </section>

      <!-- 部位別 or 不良分類（自動判定） -->
      <section class="card" id="card-category" hidden>
        <h2 id="category-title">分類別（TOP10）</h2>
        <div class="body">
          <div class="chart-box"><canvas id="chartCategory"></canvas></div>
        </div>
      </section>

      <!-- 予備：不良・変更などの件数 Pareto（表示枠が余ったときのみ） -->
      <section class="card" id="card-pareto" hidden>
        <h2>不良/変更 主要項目（Pareto）</h2>
        <div class="body">
          <div class="chart-box"><canvas id="chartPareto"></canvas></div>
        </div>
      </section>
    </div>
  </main>

  <footer>
    <div id="detect"></div>
  </footer>

<script>
(() => {
  const CSV_URL = 'https://docs.google.com/spreadsheets/d/e/2PACX-1vRkHKcql0V0V2rD6VMmbCCib5djCj74e3beh3krOSplI7pWQvFDGK-54UOCh3sCGZHSxkjIK9gHxz7j/pub?gid=1162640324&single=true&output=csv';
  const state = {
    header: [],
    rows: [],
    cols: {
      date: null,
      qty: null,
      customer: null,
      part: null,
      issueCountCols: []
    }
  };

  const el = sel => document.querySelector(sel);
  const fmtYMD = d => {
    const y = d.getFullYear();
    const m = String(d.getMonth()+1).padStart(2,'0');
    const da = String(d.getDate()).padStart(2,'0');
    return `${y}/${m}/${da}`;
  };

  // Init subtitle
  el('#subtitle').textContent = `データ元: Googleスプレッドシート（${new URL(CSV_URL).searchParams.get('gid')}） / 生成: ${fmtYMD(new Date())}`;

  // Helpers
  function tryParseDate(v){
    if(!v) return null;
    const t = (''+v).trim()
      .replace(/年|\.|年|\./g,'/')
      .replace(/月/g,'/')
      .replace(/日/g,'');
    const cand = [t, t.replace(/(\d{4})\/(\d{1,2})\/(\d{1,2}).*/, '$1/$2/$3')];
    for(const s of cand){
      const d = new Date(s);
      if(!isNaN(d)) return d;
    }
    return null;
  }
  const isNumeric = v => v !== null && v !== '' && !isNaN(Number((''+v).toString().replace(/,/g,'')));

  function detectColumns(header, rows){
    const lower = header.map(h => (h||'').toString());
    const includesAny = (s, arr) => arr.some(k => s.includes(k));

    // date column: pick with most parseable values
    const dateKeys = ['日','年月日','Date','DATE','date','出荷日','製造日','発行'];
    let bestDateIdx = -1, bestScore = -1;
    header.forEach((h, i) => {
      const hs = (h||'')+'';
      if(includesAny(hs, dateKeys)){
        let score=0; for(const r of rows){ if(tryParseDate(r[i])) score++; }
        if(score>bestScore){ bestScore=score; bestDateIdx=i; }
      }
    });

    // qty column: numeric and name suggests quantity
    const qtyKeys = ['数量','数','Qty','QTY','台数','個数','数量(済)','済'];
    let qtyIdx = -1; let qtyScore=-1;
    header.forEach((h,i)=>{
      const hs=(h||'')+'';
      const score = rows.slice(0,200).reduce((acc,r)=>acc + (isNumeric(r[i])?1:0),0);
      if(includesAny(hs, qtyKeys) && score>Math.max(qtyScore, 3)) { qtyIdx=i; qtyScore=score; }
    });

    // customer column
    const custKeys = ['顧客','客先','Customer','顧客名','得意先'];
    let custIdx = -1;
    header.forEach((h,i)=>{ if(includesAny((h||'')+'', custKeys) && custIdx===-1) custIdx=i; });

    // part column
    const partKeys = ['部位','品名','品目','機種','型式','製品名','ASSY'];
    let partIdx = -1;
    header.forEach((h,i)=>{ if(includesAny((h||'')+'', partKeys) && partIdx===-1) partIdx=i; });

    // issue count columns: numeric & header suggests defects/changes
    const issueKeys = ['クレーム','不良','不具合','変更','設計','是正','手直し','修正','社内'];
    const issueCols = [];
    header.forEach((h,i)=>{
      const hs=(h||'')+'';
      const numericRatio = rows.length ? rows.slice(0,200).reduce((a,r)=> a + (isNumeric(r[i])?1:0),0) / Math.min(rows.length,200) : 0;
      if(includesAny(hs, issueKeys) || /件|回|数$/.test(hs)){
        if(numericRatio>0.3) issueCols.push(i);
      }
    });

    return {date: bestDateIdx>-1?bestDateIdx:null, qty: qtyIdx>-1?qtyIdx:null, customer: custIdx>-1?custIdx:null, part: partIdx>-1?partIdx:null, issueCountCols: issueCols};
  }

  function groupByMonth(rows, dateIdx, qtyIdx){
    const map = new Map();
    for(const r of rows){
      const d = tryParseDate(r[dateIdx]);
      if(!d) continue;
      const ym = `${d.getFullYear()}-${String(d.getMonth()+1).padStart(2,'0')}`;
      const val = qtyIdx!=null && isNumeric(r[qtyIdx]) ? Number((''+r[qtyIdx]).replace(/,/g,'')) : 1;
      map.set(ym, (map.get(ym)||0) + val);
    }
    // last 12 months timeline
    const now = new Date();
    const labels=[]; const data=[];
    for(let i=11;i>=0;i--){
      const dt = new Date(now.getFullYear(), now.getMonth()-i, 1);
      const ym = `${dt.getFullYear()}-${String(dt.getMonth()+1).padStart(2,'0')}`;
      labels.push(`${dt.getFullYear()}/${String(dt.getMonth()+1).padStart(2,'0')}`);
      data.push(map.get(ym)||0);
    }
    return {labels, data};
  }

  function topN(rows, idx, qtyIdx, n=10){
    const counts = new Map();
    for(const r of rows){
      const key = (r[idx]||'').toString().trim();
      if(!key) continue;
      const val = qtyIdx!=null && isNumeric(r[qtyIdx]) ? Number((''+r[qtyIdx]).replace(/,/g,'')) : 1;
      counts.set(key, (counts.get(key)||0) + val);
    }
    return [...counts.entries()].sort((a,b)=> b[1]-a[1]).slice(0,n);
  }

  function sumNumericByCols(rows, colIdxs){
    const sums = [];
    for(const i of colIdxs){
      let s=0; for(const r of rows){ if(isNumeric(r[i])) s+= Number((''+r[i]).replace(/,/g,'')); }
      sums.push([i,s]);
    }
    return sums.sort((a,b)=> b[1]-a[1]);
  }

  // Chart makers
  Chart.register(ChartDataLabels);
  function makeBar(ctx, labels, values, {horizontal=false, title, maxBars=10}={}){
    return new Chart(ctx, {
      type: 'bar',
      data: { labels, datasets: [{ label: title||'', data: values, borderWidth: 1 }]},
      options: {
        responsive:true, maintainAspectRatio:false,
        indexAxis: horizontal? 'y':'x',
        plugins:{ legend:{display:false}, tooltip:{enabled:true}, datalabels:{
          anchor: 'end', align: 'end', formatter:(v)=> v==null? '': (v>=1000? v.toLocaleString(): v),
          clamp:true, clip:true, rotation: horizontal?0:-90, font:{size:10}
        }},
        scales:{
          x:{ticks:{maxRotation:0,minRotation:0, font:{size:10}}, grid:{display:false}},
          y:{beginAtZero:true, grid:{color:'#eee'}, ticks:{font:{size:10}}}
        }
      }
    });
  }

  function makeLine(ctx, labels, values){
    return new Chart(ctx, {
      type: 'line',
      data: { labels, datasets: [{ label:'月別合計', data: values, fill:true, tension:.25 }]},
      options:{ responsive:true, maintainAspectRatio:false,
        plugins:{ legend:{display:false}, datalabels:{display:false}},
        scales:{ x:{ grid:{display:false}}, y:{ beginAtZero:true, grid:{color:'#eee'}} }
      }
    });
  }

  function makePareto(ctx, labels, values){
    const total = values.reduce((a,b)=>a+b,0)||1;
    const cum = values.reduce((arr,v,i)=>{ arr.push((v + (arr[i-1]||0))); return arr; },[]).map(v=> (v/total*100));
    return new Chart(ctx, {
      type:'bar',
      data:{ labels, datasets:[
        { label:'件数', data: values, yAxisID:'y' },
        { label:'累積%', data: cum, type:'line', yAxisID:'y1', borderWidth:2, pointRadius:2 }
      ]},
      options:{ responsive:true, maintainAspectRatio:false,
        plugins:{ legend:{position:'bottom'}, datalabels:{ formatter:(v,ctx)=> ctx.dataset.type==='line'? '': v, align:'end', anchor:'end', font:{size:10} }},
        scales:{ y:{ beginAtZero:true, grid:{color:'#eee'} }, y1:{ beginAtZero:true, max:100, position:'right', grid:{display:false}, ticks:{callback:(v)=>v+'%'} }, x:{ grid:{display:false}, ticks:{font:{size:10}}} }
      }
    });
  }

  // Render pipeline
  function render(){
    const {header, rows, cols} = state;

    // 1) Monthly trend (requires date)
    if(cols.date!=null){
      const {labels, data} = groupByMonth(rows, cols.date, cols.qty);
      if(data.some(v=>v>0)){
        el('#card-monthly').hidden=false;
        makeLine(el('#chartMonthly'), labels, data);
        el('#legend-monthly').innerHTML = `<span class="pill">集計対象: ${header[cols.date]||'日付'}${cols.qty!=null?` × ${header[cols.qty]}`:'（1件=1カウント）'}</span>`;
      }
    }

    // Prepare a list for the remaining 2 slots (fit 1 page)
    const slots = [];

    // 2) Customer top10
    if(cols.customer!=null){
      const data = topN(rows, cols.customer, cols.qty, 10);
      if(data.length){
        slots.push(() => {
          el('#card-customer').hidden=false;
          const labels = data.map(d=>d[0]);
          const values = data.map(d=>d[1]);
          makeBar(el('#chartCustomer'), labels, values, {horizontal:true});
        });
      }
    }

    // 3) Part / Category top10
    if(cols.part!=null){
      const data = topN(rows, cols.part, cols.qty, 10);
      if(data.length){
        slots.push(() => {
          el('#card-category').hidden=false;
          el('#category-title').textContent = `${header[cols.part]} 別（TOP10）`;
          const labels = data.map(d=>d[0]);
          const values = data.map(d=>d[1]);
          makeBar(el('#chartCategory'), labels, values, {horizontal:false});
        });
      }
    }

    // 4) Pareto of issue-count columns (fallback if we still have a slot)
    if(state.cols.issueCountCols?.length){
      const sums = sumNumericByCols(rows, state.cols.issueCountCols);
      if(sums.length){
        slots.push(() => {
          el('#card-pareto').hidden=false;
          const top = sums.slice(0,10);
          const labels = top.map(([i])=> header[i]);
          const values = top.map(([,v])=> v);
          makePareto(el('#chartPareto'), labels, values);
        });
      }
    }

    // Execute up to 2 of the queued slots so that total visible charts (incl. monthly) <= 3
    let used = 0;
    for(const run of slots){ if(used>=2) break; run(); used++; }

    // Column detection summary
    const detect = [
      cols.date!=null? `日付=「${header[cols.date]}」`:null,
      cols.qty!=null? `数量=「${header[cols.qty]}」`:null,
      cols.customer!=null? `顧客=「${header[cols.customer]}」`:null,
      cols.part!=null? `分類=「${header[cols.part]}」`:null,
      (cols.issueCountCols?.length? `不良/変更などの数値列=${cols.issueCountCols.map(i=>`「${header[i]}」`).join('、')}`:null)
    ].filter(Boolean).join(' ／ ');
    el('#detect').textContent = detect? `自動検出: ${detect}`: '';
  }

  function load(){
    Papa.parse(CSV_URL, {
      download:true, header:false, skipEmptyLines:true,
      complete: results => {
        if(!results.data || results.data.length<2){
          el('#subtitle').textContent = 'データの取得に失敗しました（行が不足しています）';
          return;
        }
        state.header = results.data[0];
        state.rows = results.data.slice(1);
        state.cols = detectColumns(state.header, state.rows);
        render();
      },
      error: err => {
        console.error(err);
        el('#subtitle').textContent = 'データの取得に失敗しました';
      }
    });
  }

  window.addEventListener('load', load);
})();
</script>
</body>
</html>
