<!doctype html>
<html lang="ja" data-theme="light">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>品質情報（グラフ）</title>
<style>
  :root{--bg1:#eef2ff;--bg2:#f8fafc;--card:#fff;--ink:#0f172a;--muted:#64748b;--border:#e5e7eb;--accent:#2563eb;--shadow:0 30px 60px rgba(15,23,42,.08);--radius:20px;--grid:#e5e7eb}
  [data-theme="dark"]{--bg1:#0b1220;--bg2:#0b1220;--card:#0f172a;--ink:#e5e7eb;--muted:#94a3b8;--border:#1f2937;--accent:#60a5fa;--shadow:none;--grid:#223044}
  *{box-sizing:border-box} html,body{height:100%}
  body{margin:0;color:var(--ink);font-family:system-ui,-apple-system,Segoe UI,Roboto,"Noto Sans JP","Yu Gothic",sans-serif;
       background:
        radial-gradient(1200px 600px at -10% -10%, #c7d2fe33 0%, transparent 60%),
        radial-gradient(900px 500px at 110% 0%, #bae6fd33 0%, transparent 55%),
        linear-gradient(120deg,var(--bg1),var(--bg2))}
  header{position:sticky;top:0;z-index:10;background:#ffffffcc;backdrop-filter:blur(10px);border-bottom:1px solid var(--border)}
  [data-theme="dark"] header{background:#0f172acc}
  .wrap{max-width:1200px;margin:0 auto;padding:12px 20px}
  .row{display:flex;justify-content:space-between;align-items:center;gap:16px}
  nav a{margin-left:18px;color:var(--accent);font-weight:700;text-decoration:none}
  nav a:hover{text-decoration:underline}
  .controls{display:flex;gap:8px;align-items:center}
  .btn{padding:8px 12px;border:1px solid var(--border);border-radius:10px;background:var(--card);color:var(--ink);cursor:pointer}
  .btn[disabled]{opacity:.6;cursor:not-allowed}
  .small{font-size:12px;color:var(--muted)}
  main{max-width:1200px;margin:26px auto;padding:0 20px}
  .card{background:var(--card);border:1px solid var(--border);border-radius:20px;box-shadow:0 30px 60px rgba(15,23,42,.08);padding:18px}
  .filterbar{display:flex;gap:8px;align-items:center;flex-wrap:wrap}
  .chart-grid{display:grid;grid-template-columns:1fr 1fr;gap:16px}
  .chart-box{background:var(--card);border:1px solid var(--border);border-radius:16px;padding:12px;min-height:360px;display:flex;align-items:center;justify-content:center}
  .chart-box.wide{grid-column:1/-1}
  .chart-box canvas{width:100%!important;height:320px!important}
  @media (max-width:900px){.chart-grid{grid-template-columns:1fr}}
  .banner{max-width:1200px;margin:0 auto 10px;padding:8px 12px;border:1px solid #f0ad4e;background:#fffbe6;color:#6b4f00;border-radius:10px;font-size:13px}
  .chip{display:inline-block;font-size:12px;background:#e2e8f0;border:1px solid #cbd5e1;border-radius:999px;padding:2px 8px;margin-left:8px}
  .footer{margin:18px 0 8px;text-align:center;font-size:12px;color:var(--muted)}
</style>
</head>
<body>
<header>
  <div class="wrap row">
    <div style="display:flex;align-items:center;gap:10px">
      <img src="tsh.png" alt="TSH" style="height:36px">
      <strong>品質情報</strong>
      <span id="stat" class="chip" style="display:none"></span>
    </div>
    <nav><a href="./index.html">ホーム</a></nav>
    <div class="controls">
      <button id="btnRefresh" class="btn" type="button">Refresh now</button>
      <label class="small" style="display:flex;align-items:center;gap:6px"><input id="chkDark" type="checkbox"> Dark</label>
    </div>
  </div>
</header>

<main>
  <div id="err" class="banner" style="display:none"></div>

  <section class="card" style="margin-bottom:16px">
    <div class="filterbar">
      <label class="small">Top 部署:</label>
      <select id="selTop" class="btn">
        <option>5</option><option selected>10</option><option>15</option><option>30</option>
      </select>

      <label class="small">月:</label>
      <select id="selMonth" class="btn"><option value="ALL" selected>All</option></select>

      <label class="small">向き:</label>
      <select id="selOrient" class="btn">
        <option value="h">Horizontal</option>
        <option value="v" selected>Vertical</option>
      </select>
    </div>
    <div class="small" id="chartNote">ピボット表（年月×部署×クレーム種類）から集計。</div>
  </section>

  <section class="card">
    <div class="chart-grid">
      <div class="chart-box"><canvas id="chartDept"></canvas></div>
      <div class="chart-box"><canvas id="chartType"></canvas></div>
      <div class="chart-box wide"><canvas id="chartMonth"></canvas></div>
    </div>
  </section>

  <div class="footer">Design by Wahyu</div>
</main>

<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-datalabels@2"></script>
<script>
Chart.register(ChartDataLabels);

/* ====== 1) CSV Sumber + 2 fallback anti-CORS ====== */
const CSV_DIRECT =
 "https://docs.google.com/spreadsheets/d/e/2PACX-1vQGwY4tjwfHVYZMuJpqSVo9uqHexcD2bmHdCiIg85oo036PLkxe4YXhHCpJbFi1mT1VgyjfNYLHOtNb/pub?gid=865157145&single=true&output=csv";
const CSV_PROXY_RJINA = "https://r.jina.ai/" + CSV_DIRECT;
const CSV_PROXY_ISO   = "https://cors.isomorphic-git.org/" + CSV_DIRECT;
const CSV_URLS = [CSV_DIRECT, CSV_PROXY_RJINA, CSV_PROXY_ISO];

/* ====== 2) Util ====== */
const S=s=>String(s??'').trim();
const intTick=v=>Number.isInteger(v)?v:'';
function showErr(m){ const b=document.getElementById('err'); b.textContent=m; b.style.display='block'; }
function hideErr(){ const b=document.getElementById('err'); b.style.display='none'; b.textContent=''; }
function stat(m){ const el=document.getElementById('stat'); el.textContent=m; el.style.display='inline-block'; }

function parseCSV(t){
  const rows=[], re=/\s*("(?:[^"]|"")*"|[^,]*)\s*(,|\n|$)/g;
  let m, row=[]; t=t.replace(/\r\n?/g,"\n");
  for(let i=0;i<t.length;){
    re.lastIndex=i; m=re.exec(t); if(!m) break;
    let cell=m[1]; if(cell.startsWith('"')) cell=cell.slice(1,-1).replace(/""/g,'"');
    row.push(cell); i=re.lastIndex;
    if(m[2]==="\n"||m[2]===""){ rows.push(row); row=[]; }
  }
  return rows.filter(r=>r.length && r.some(c=>S(c)!==""));
}

async function fetchAnyCSV(){
  for(const u of CSV_URLS){
    try{
      const res=await fetch(u + (u.includes('?')?'&':'?') + '_ts=' + Date.now(), {cache:'no-store'});
      if(!res.ok) continue;
      const txt=await res.text();
      const arr=parseCSV(txt);
      if(arr.length>=2) return {mode:(u===CSV_DIRECT?'csv':'csv-proxy'), rows:arr};
    }catch(e){}
  }
  throw new Error('CSV fetch failed');
}

/* ====== 3) Deteksi & Parse PIVOT ======
   Struktur target: ada baris header berisi "部署",
   kolom ke kanan adalah jenisクレーム, kolom pertama berisi bulan (Jun/Jul/…),
   ada baris "Jun Total", "Grand Total" yang harus di-skip.
==================================================== */
function parsePivot(rows){
  // cari baris header yg punya "部署"
  let headerRow = -1, deptCol = -1;
  for(let r=0;r<Math.min(20,rows.length);r++){
    const i = rows[r].findIndex(c=>S(c)==='部署');
    if(i>=0){ headerRow=r; deptCol=i; break; }
  }
  if(headerRow<0) throw new Error('Pivot header (部署) not found');

  // Kolom bulan (biasanya A). Ambil kolom pertama yg mengandung "月" atau "Month"
  let monthCol = 0;
  const hr = rows[headerRow];
  const monthIdx = hr.findIndex(c=>/(月|Month)/i.test(S(c)));
  if(monthIdx>=0) monthCol = monthIdx; // kalau headernya eksplisit
  else monthCol = 0; // default A

  // Daftar jenis (kanan dari 部署)
  const kinds = [];
  for(let c=deptCol+1; c<rows[headerRow].length; c++){
    const name=S(rows[headerRow][c]);
    if(!name) continue;
    if(/Grand\s*Total/i.test(name)) break; // stop di total
    kinds.push({name, col:c});
  }
  if(kinds.length===0) throw new Error('クレーム種類 header not found');

  // Kumpulkan data
  const data = []; // {month, dept, byKind:{}, total}
  const monthsSet=new Set(), deptsSet=new Set(), kindsSet=new Set(kinds.map(k=>k.name));

  for(let r=headerRow+1; r<rows.length; r++){
    const row=rows[r];
    const month=S(row[monthCol]);
    const dept=S(row[deptCol]);

    // skip baris total & kosong
    if(!dept || /Total/i.test(month) || /Grand\s*Total/i.test(dept)) continue;

    const byKind={}; let total=0;
    for(const k of kinds){
      const v = parseFloat(S(row[k.col]).replace(/,/g,'')) || 0;
      byKind[k.name]=v; total+=v;
    }
    if(total===0) continue;

    monthsSet.add(month);
    deptsSet.add(dept);
    data.push({month, dept, byKind, total});
  }

  return {
    data,
    months: [...monthsSet],
    depts:  [...deptsSet],
    kinds:  kinds.map(k=>k.name)
  };
}

/* ====== 4) State & Palette ====== */
let PIV=null; // {data, months, depts, kinds}
let charts={dept:null,type:null,month:null};
const isDark=()=> document.documentElement.getAttribute('data-theme')==='dark';
const PALETTE_LIGHT=['#93c5fd','#a5b4fc','#fda4af','#fdba74','#86efac','#67e8f9','#f5d0fe','#c4b5fd','#fecaca','#fde68a','#bbf7d0','#bae6fd'];
const PALETTE_DARK=['#60a5fa','#818cf8','#fca5a5','#fbbf24','#4ade80','#22d3ee','#f0abfc','#a78bfa','#f87171','#fde047','#86efac','#93c5fd'];
const hexToRgba=(h,a=0.8)=>{const b=parseInt(h.replace('#',''),16);return`rgba(${(b>>16)&255},${(b>>8)&255},${b&255},${a})`};
function softPalette(n,a=0.8){ const base=isDark()?PALETTE_DARK:PALETTE_LIGHT; return Array.from({length:n},(_,i)=>hexToRgba(base[i%base.length],a)); }
function applyChartDefaults(){
  const st=getComputedStyle(document.documentElement);
  Chart.defaults.color=st.getPropertyValue('--ink').trim()||'#0f172a';
  Chart.defaults.borderColor=st.getPropertyValue('--grid').trim()||'#e5e7eb';
  Chart.defaults.font.family='system-ui,-apple-system,Segoe UI,Roboto,"Noto Sans JP","Yu Gothic",sans-serif';
}

/* ====== 5) Aggregate (from Pivot) ====== */
function aggregateFromPivot({monthPick, topN}){
  const rows = PIV.data.filter(r => monthPick==='ALL' ? true : r.month===monthPick);

  // byDept
  const mDept=new Map();
  for(const r of rows){ mDept.set(r.dept,(mDept.get(r.dept)||0)+r.total); }
  const byDept=[...mDept.entries()].sort((a,b)=>b[1]-a[1]);
  const byDeptTop=byDept.slice(0, topN);

  // byType
  const mType=new Map();
  for(const r of rows){
    for(const k of PIV.kinds){
      mType.set(k,(mType.get(k)||0)+(r.byKind[k]||0));
    }
  }
  const byType=[...mType.entries()].sort((a,b)=>b[1]-a[1]);

  // byMonth (seluruh data, bukan hanya filter monthPick) → untuk trend
  const mMonth=new Map();
  for(const r of PIV.data){ mMonth.set(r.month,(mMonth.get(r.month)||0)+r.total); }
  const byMonth=[...mMonth.entries()].sort((a,b)=>PIV.months.indexOf(a[0])-PIV.months.indexOf(b[0]));

  return {
    byDeptTop,
    byType,
    byMonth
  };
}

/* ====== 6) Render ====== */
function render(){
  applyChartDefaults();

  const topN=+document.getElementById('selTop').value||10;
  const monthPick=document.getElementById('selMonth').value;
  const orient=document.getElementById('selOrient').value==='h'?'y':'x';

  const agg=aggregateFromPivot({monthPick, topN});
  document.getElementById('chartNote').textContent =
    `月: ${monthPick==='ALL'?'全月':monthPick}｜Top 部署: ${topN}`;

  const draw=(id,title,labels,values)=>{
    const ctx=document.getElementById(id).getContext('2d');
    const colors=softPalette(values.length,isDark()?0.7:0.8);
    const maxV=Math.max(1,...values);
    return new Chart(ctx,{type:'bar',
      data:{labels,datasets:[{label:'件数',data:values,backgroundColor:colors,borderColor:colors,borderWidth:1,maxBarThickness:28,categoryPercentage:.7,barPercentage:.9}]},
      options:{indexAxis:orient,maintainAspectRatio:false,plugins:{legend:{display:false},title:{display:true,text:title},datalabels:{anchor:'end',align:orient==='y'?'right':'top',formatter:v=>v}},
        scales:orient==='y'?{x:{beginAtZero:true,suggestedMax:maxV*1.15,ticks:{callback:intTick}},y:{grid:{display:false}}}
                           :{y:{beginAtZero:true,suggestedMax:maxV*1.15,ticks:{callback:intTick}},x:{grid:{display:false}}}}
    });
  };

  // Dept
  charts.dept && charts.dept.destroy();
  charts.dept = draw(
    'chartDept',
    `部署別（件数｜${monthPick==='ALL'?'全月':monthPick}）`,
    agg.byDeptTop.map(x=>x[0]),
    agg.byDeptTop.map(x=>x[1])
  );

  // Type
  charts.type && charts.type.destroy();
  charts.type = draw(
    'chartType',
    `種類別（件数｜${monthPick==='ALL'?'全月':monthPick}）`,
    agg.byType.map(x=>x[0]),
    agg.byType.map(x=>x[1])
  );

  // Month (trend)
  charts.month && charts.month.destroy();
  const ctxM=document.getElementById('chartMonth').getContext('2d');
  const mLabels=agg.byMonth.map(x=>x[0]);
  const mValues=agg.byMonth.map(x=>x[1]);
  charts.month=new Chart(ctxM,{
    type:'bar',
    data:{labels:mLabels,datasets:[{label:'件数',data:mValues,backgroundColor:softPalette(mValues.length),borderWidth:1}]},
    options:{indexAxis:'x',maintainAspectRatio:false,plugins:{legend:{display:false},title:{display:true,text:'月別（件数）'},datalabels:{anchor:'end',align:'top',formatter:v=>v}},
      scales:{y:{beginAtZero:true,ticks:{callback:intTick}}}}
  });
}

/* ====== 7) Load ====== */
async function load(){
  hideErr(); stat('Loading…');
  try{
    const any = await fetchAnyCSV(); // rows: array of arrays
    // Cari header baris dengan "部署"
    // Kalau tidak ketemu, kirim pesan.
    PIV = parsePivot(any.rows); // {data, months, depts, kinds}

    // isi pilihan bulan
    const selMonth=document.getElementById('selMonth');
    selMonth.innerHTML = '<option value="ALL">All</option>' + PIV.months.map(m=>`<option value="${m}">${m}</option>`).join('');
    selMonth.value = 'ALL';

    stat(`Data: OK (${any.mode}, rows: ${any.rows.length})`);
    render();
  }catch(e){
    console.error(e);
    showErr('読み込みに失敗しました（CSV が取得できません / ピボット表の見出し「部署」を確認）。');
    stat('No data');
  }
}

/* ====== 8) Events ====== */
document.getElementById('btnRefresh').addEventListener('click', load);
['selTop','selMonth','selOrient'].forEach(id=>document.getElementById(id).addEventListener('change', render));
document.getElementById('chkDark').addEventListener('change',e=>{
  document.documentElement.setAttribute('data-theme', e.target.checked?'dark':'light'); render();
});
window.addEventListener('DOMContentLoaded', load);
</script>
</body>
</html>
