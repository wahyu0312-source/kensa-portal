<!doctype html>
<html lang="ja" data-theme="light">
<head>
  <meta charset="utf-8">
  <meta http-equiv="Cache-Control" content="no-store, no-cache, must-revalidate"/>
  <meta http-equiv="Pragma" content="no-cache"/>
  <meta http-equiv="Expires" content="0"/>
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <title>品質情報</title>

  <!-- libs -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.3/dist/chart.umd.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/papaparse@5.4.1/papaparse.min.js"></script>

  <style>
    :root{
      --bg1:#eef2ff; --bg2:#f8fafc; --card:#fff; --ink:#0f172a; --muted:#64748b; --border:#e5e7eb;
      --accent:#2563eb; --shadow:0 30px 60px rgba(15,23,42,.08); --radius:22px
    }
    *{box-sizing:border-box}
    body{margin:0;color:var(--ink);background:linear-gradient(120deg,var(--bg1),var(--bg2));font-family:system-ui,-apple-system,Segoe UI,Roboto,"Noto Sans JP","Yu Gothic",sans-serif}
    header{position:sticky;top:0;background:#ffffffcc;backdrop-filter:blur(8px);border-bottom:1px solid var(--border);z-index:10}
    .container{max-width:1200px;margin:0 auto;padding:14px 18px}
    nav a{margin-right:14px;color:var(--ink);text-decoration:none;font-weight:600}
    nav a.active{color:var(--accent)}
    h1{font-size:22px;margin:12px 0 4px}
    .sub{color:var(--muted);font-size:13px;margin-bottom:18px}
    .card{background:var(--card);border:1px solid var(--border);border-radius:var(--radius);box-shadow:var(--shadow);padding:16px}
    .grid-2{display:grid;grid-template-columns:1fr;gap:16px}
    @media(min-width:1100px){.grid-2{grid-template-columns:1.2fr .8fr}}
    .grid-4{display:grid;grid-template-columns:1fr;gap:16px}
    @media(min-width:1100px){.grid-4{grid-template-columns:1fr 1fr}}
    @media(min-width:1400px){.grid-4{grid-template-columns:repeat(4,1fr)}}
    .controls{display:flex;flex-wrap:wrap;gap:10px;align-items:center;margin-bottom:12px}
    .controls label{font-size:12px;color:var(--muted)}
    .controls select,.controls button{
      padding:8px 10px;border:1px solid var(--border);border-radius:12px;background:#fff;font-size:14px;cursor:pointer
    }
    .checks{display:flex;gap:12px;flex-wrap:wrap}
    .badge{display:inline-block;padding:2px 8px;border-radius:999px;border:1px solid var(--border);font-size:12px;color:var(--muted)}
    .err{background:#fff1f2;border:1px solid #fecaca;color:#991b1b;padding:10px;border-radius:12px;margin-bottom:10px;display:none}
    .chart-wrap{position:relative;height:320px}
    .small-chart .chart-wrap{height:260px}
    .nodata{position:absolute;inset:0;display:flex;align-items:center;justify-content:center;color:#64748b;font-weight:600}
    table{width:100%;border-collapse:separate;border-spacing:0}
    thead th{background:#f8fafc;color:#475569;text-align:left;font-weight:700;padding:10px 12px;border-bottom:1px solid var(--border)}
    tbody td{padding:10px 12px;border-bottom:1px solid var(--border)}
    footer{color:#64748b;font-size:12px;margin:28px 0}
    .panel-title{margin:0 0 8px;font-size:14px;color:#334155;font-weight:700}
    .muted{color:#64748b}
  </style>
</head>
<body>
  <header>
    <div class="container">
      <nav>
        <a href="./index.html">ホーム</a>
        <a href="./forms.html">出荷検査成績書</a>
        <a href="./sagyoutejunsho.html">出荷検査作業手順書</a>
        <a href="./charts.html">出荷検査（グラフ）</a>
        <a class="active" href="./quality.html">品質情報</a>
      </nav>
    </div>
  </header>

  <main class="container">
    <h1>品質情報 <span class="badge" id="verBadge">v-part-panels-3</span> <span class="badge" id="dataRange"></span></h1>
    <div class="sub">CSV（公開）: <b>月</b>で期間選択、<b>部位</b>（SG/CV/WB/SC）で絞り込み。上：総合トレンド&総合Pareto、下：<b>部位別</b> Pareto（選択月）。</div>

    <div id="err" class="err"></div>

    <div class="card">
      <div class="controls">
        <label>月：</label>
        <select id="monthSel"></select>

        <label>表示（トレンド）：</label>
        <select id="trendMode">
          <option value="line-v" selected>折れ線（縦）</option>
          <option value="bar-v">棒（縦）</option>
          <option value="bar-h">棒（横）</option>
        </select>

        <label>表示（Pareto）：</label>
        <select id="paretoOri">
          <option value="vertical" selected>縦</option>
          <option value="horizontal">横</option>
        </select>

        <label>Pareto上位：</label>
        <select id="topN">
          <option value="10" selected>10</option>
          <option value="12">12</option>
          <option value="20">20</option>
        </select>

        <button id="reloadBtn">再読み込み</button>
        <button id="exportBtn">CSV出力（絞り込み後）</button>
      </div>

      <div class="controls" style="margin-top:6px">
        <label>部位：</label>
        <div class="checks" id="partChecks"></div>
      </div>

      <div class="grid-2" style="margin-top:10px">
        <div>
          <h3 class="panel-title">月次トレンド（1〜12月｜選択部位合計）</h3>
          <div class="chart-wrap"><canvas id="trendChart"></canvas><div id="trendEmpty" class="nodata" style="display:none">データなし</div></div>
        </div>
        <div>
          <h3 class="panel-title">Pareto（発行実績｜選択月｜選択部位合計）</h3>
          <div class="chart-wrap"><canvas id="paretoChart"></canvas><div id="paretoEmpty" class="nodata" style="display:none">データなし</div></div>
        </div>
      </div>
    </div>

    <div class="card" style="margin-top:14px">
      <h3 style="margin:0 0 8px">部位別可視化（選択月｜発行実績のPareto）</h3>
      <div class="grid-4">
        <div class="small-chart" id="panelSG">
          <h4 class="panel-title">シャトルガード（SG）</h4>
          <div class="chart-wrap"><canvas id="paretoSG"></canvas><div id="emptySG" class="nodata" style="display:none">データなし</div></div>
        </div>
        <div class="small-chart" id="panelCV">
          <h4 class="panel-title">コンベヤー（CV）</h4>
          <div class="chart-wrap"><canvas id="paretoCV"></canvas><div id="emptyCV" class="nodata" style="display:none">データなし</div></div>
        </div>
        <div class="small-chart" id="panelWB">
          <h4 class="panel-title">ウィンベンド（WB）</h4>
          <div class="chart-wrap"><canvas id="paretoWB"></canvas><div id="emptyWB" class="nodata" style="display:none">データなし</div></div>
        </div>
        <div class="small-chart" id="panelSC">
          <h4 class="panel-title">スクリューカバー（SC）</h4>
          <div class="chart-wrap"><canvas id="paretoSC"></canvas><div id="emptySC" class="nodata" style="display:none">データなし</div></div>
        </div>
      </div>
      <div class="muted" style="margin-top:8px">※ チェックを外した部位のパネルは自動的に非表示になります。</div>
    </div>

    <div class="card" style="margin-top:14px">
      <h3 style="margin:0 0 8px">Claims（明細）— 現在のフィルタ</h3>
      <table>
        <thead><tr><th>カテゴリ（発行実績）</th><th>件数</th><th>構成比</th></tr></thead>
        <tbody id="claimsBody"><tr><td colspan="3" class="muted">データなし</td></tr></tbody>
      </table>
    </div>

    <footer>Design by Wahyu · データは公開CSVから自動取得</footer>
  </main>

  <script>
    // ==== SOURCE ====
    const CSV_URL_BASE = "https://docs.google.com/spreadsheets/d/e/2PACX-1vQonny5Rq7uIRcB2AagV1P1vlFSXzS8r88z4_FTPMSFj9aFeNNK_QLMQquHmZ2Fzo1VKJTRg_z6HNJG/pub?gid=864633681&single=true&output=csv";

    // ==== PARTS (kolom eksplisit + sinonim) ====
    const PARTS = [
      { key:"SG", label:"シャトルガード", code:"SG", candidates:[
        "シャトルガード（SG）","シャトルガード (SG)","シャトルガード","SG","ｼｬﾄﾙｶﾞｰﾄﾞ（SG）"
      ]},
      { key:"CV", label:"コンベヤー",     code:"CV", candidates:[
        "コンベヤー（CV）","コンベヤー (CV)","コンベヤー","CV","ｺﾝﾍﾞﾔｰ（CV）"
      ]},
      { key:"WB", label:"ウィンベンド",   code:"WB", candidates:[
        "ウィンベンド（WB）","ウィンベンド (WB)","ウィンベンド","WB"
      ]},
      { key:"SC", label:"スクリューカバー", code:"SC", candidates:[
        "スクリューカバー（SC）","スクリューカバー (SC)","スクリューカバー","SC"
      ]},
    ];
    const COL_CATEGORY = "発行実績";
    const COL_MONTH    = "月";

    const $ = id => document.getElementById(id);
    const uniq = a => Array.from(new Set(a));
    function setErr(msg){ const e=$("err"); if(!msg){e.style.display="none"; e.textContent="";} else {e.style.display="block"; e.textContent=msg;} }
    function showEmpty(id, show){ $(id).style.display = show ? "flex" : "none"; }
    function toCSV(rows){
      if(!rows.length) return "";
      const headers = Object.keys(rows[0]);
      const esc = v => `"${String(v??"").replace(/"/g,'""')}"`;
      return [headers.join(","), ...rows.map(r=>headers.map(h=>esc(r[h])).join(","))].join("\n");
    }
    function nrm(s){ return String(s??"").trim().replace(/[（）\s]/g, m => ({'（':'(', '）':')'}[m] || '') ); }

    let RAW=[], HEADERS=[], PART_COLS={}, charts={}, trendChart=null, paretoChart=null;

    // mapping kolom parts secara eksplisit
    function mapPartColumns(headers){
      const map = {};
      headers = headers.map(h=>String(h));
      for(const p of PARTS){
        let found = null;
        for(const cand of p.candidates){
          found = headers.find(h => nrm(h) === nrm(cand));
          if(found) break;
        }
        if(!found){
          // toleransi: nama mengandung label + kode
          found = headers.find(h => nrm(h).includes(nrm(p.label)) && nrm(h).includes(`(${p.code})`));
        }
        if(found) map[p.key] = found;
      }
      return map;
    }

    async function loadCSV(){
      try{
        const url = CSV_URL_BASE + "&_t=" + Date.now(); // cache buster
        const res = await fetch(url, {cache:"no-store"});
        if(!res.ok) throw new Error("HTTP "+res.status);
        const text = await res.text();
        const out = await new Promise(resolve=>{
          Papa.parse(text,{header:true,dynamicTyping:true,skipEmptyLines:true,complete: r=>resolve(r)});
        });
        return out;
      }catch(e){
        console.error(e); setErr("CSVの読み込みに失敗しました。公開設定/URLをご確認ください。");
        return {data:[], meta:{fields:[]}};
      }
    }

    function buildMonthSelect(rows){
      const months = uniq(rows.map(r=> Number(r[COL_MONTH]) ).filter(n=>Number.isFinite(n) && n>=1 && n<=12)).sort((a,b)=>a-b);
      const sel = $("monthSel");
      sel.innerHTML = months.map(m=>`<option value="${m}">${m}月</option>`).join("");
      const def = months.includes(6) ? 6 : (months[0] || "");
      sel.value = def;
      $("dataRange").textContent = months.length ? `${months[0]}〜${months[months.length-1]}月` : "";
    }

    function buildPartChecks(){
      const wrap = $("partChecks");
      wrap.innerHTML = PARTS.map(p=>{
        const id = "p_"+p.key;
        const defaultOn = (p.key==="SG" || p.key==="CV"); // default SG+CV
        return `<label style="display:inline-flex;align-items:center;gap:6px">
          <input type="checkbox" id="${id}" data-key="${p.key}" ${defaultOn?'checked':''}>
          <span>${p.label}（${p.code}）</span>
        </label>`;
      }).join("");
    }
    function selectedKeys(){
      return Array.from($("partChecks").querySelectorAll("input[type=checkbox]"))
        .filter(cb=>cb.checked).map(cb=>cb.getAttribute("data-key"));
    }
    function sumParts(row, keys){
      let s=0;
      for(const k of keys){
        const col = PART_COLS[k];
        const v = Number(row[col] ?? 0);
        s += (Number.isFinite(v) ? v : 0);
      }
      return s;
    }

    // ==== aggregations ====
    function buildTrend(rows){
      const keys = selectedKeys();
      const byMonth = new Array(12).fill(0);
      rows.forEach(r=>{
        const m = Number(r[COL_MONTH]);
        if(Number.isFinite(m) && m>=1 && m<=12){
          byMonth[m-1] += sumParts(r, keys);
        }
      });
      const labels = Array.from({length:12}, (_,i)=>`${i+1}月`);
      return {labels, values: byMonth};
    }

    function rowsForMonth(rows){
      const month = Number($("monthSel").value);
      return rows.filter(r=> Number(r[COL_MONTH])===month );
    }

    function buildPareto(rows, keys, topN){
      const by = new Map();
      for(const r of rows){
        const cat = String(r[COL_CATEGORY] ?? "").trim() || "（未分類）";
        const val = sumParts(r, keys);
        if(val>0) by.set(cat, (by.get(cat)||0) + val);
      }
      let arr = Array.from(by.entries()).sort((a,b)=>b[1]-a[1]);
      const total = arr.reduce((s,[,v])=>s+v,0);
      if(topN && arr.length>topN){
        const top = arr.slice(0, topN);
        const rest = arr.slice(topN).reduce((s,[,v])=>s+v,0);
        arr = [...top, ["その他", rest]];
      }
      const labels = arr.map(([k])=>k);
      const values = arr.map(([,v])=>v);
      const cum=[]; let acc=0;
      for(const v of values){ acc+=v; cum.push(total? Math.round(acc/total*1000)/10 : 0); }
      return {labels, values, cum, total};
    }

    function buildParetoForPart(rows, partKey, topN){ return buildPareto(rows, [partKey], topN); }

    function destroyCharts(){
      if(trendChart){trendChart.destroy();trendChart=null;}
      if(paretoChart){paretoChart.destroy();paretoChart=null;}
      for(const k in charts){ charts[k].destroy(); delete charts[k]; }
    }

    function drawAll(){
      destroyCharts();
      if(!RAW.length || !Object.keys(PART_COLS).length){
        setErr("部位列（SG/CV/WB/SC）が見つかりません。ヘッダー名をご確認ください。");
        showEmpty("trendEmpty", true); showEmpty("paretoEmpty", true);
        ["SG","CV","WB","SC"].forEach(k=>showEmpty("empty"+k, true));
        $("claimsBody").innerHTML = `<tr><td colspan="3" class="muted">データなし</td></tr>`;
        return;
      }
      setErr("");

      const topN = +$("topN").value || 10;

      // TREND
      const t = buildTrend(RAW);
      const mode = $("trendMode").value;
      const trendType = mode.startsWith("line") ? "line" : "bar";
      const indexAxis = mode==="bar-h" ? "y" : "x";
      showEmpty("trendEmpty", t.values.every(v=>v===0));
      trendChart = new Chart($("trendChart").getContext("2d"), {
        type: trendType,
        data: { labels: t.labels, datasets: [{ label:"件数", data: t.values, tension:.3, borderWidth:2, pointRadius:3, fill:false }] },
        options: {
          responsive:true, maintainAspectRatio:false,
          plugins:{ legend:{display:true}, tooltip:{mode:"index", intersect:false} },
          indexAxis: trendType==="bar" ? indexAxis : undefined,
          scales: trendType==="bar" && indexAxis==="y" ? {
            y:{ beginAtZero:true, ticks:{ autoSkip:false } },
            x:{ beginAtZero:true, ticks:{ precision:0 } }
          } : { y:{ beginAtZero:true, ticks:{ precision:0 } } }
        }
      });

      // PARETO (total)
      const monthRows = rowsForMonth(RAW);
      const pAll = buildPareto(monthRows, selectedKeys(), topN);
      const horizontal = $("paretoOri").value === "horizontal";
      const lineAxis = horizontal ? "x1" : "y1";
      showEmpty("paretoEmpty", pAll.total===0);
      paretoChart = new Chart($("paretoChart").getContext("2d"), {
        type: "bar",
        data: { labels: pAll.labels,
          datasets: [
            { type:"bar", label:"件数", data: pAll.values, borderWidth:1 },
            { type:"line", label:"累積%", data: pAll.cum, yAxisID: lineAxis, xAxisID: lineAxis, borderWidth:2, pointRadius:3 }
          ]},
        options: {
          responsive:true, maintainAspectRatio:false,
          plugins:{ legend:{display:true}, tooltip:{mode:"index", intersect:false} },
          indexAxis: horizontal ? "y" : "x",
          scales: horizontal ? {
            y: { beginAtZero:true, ticks:{ autoSkip:false } },
            x: { beginAtZero:true, ticks:{ precision:0 } },
            x1:{ position:"top", min:0, max:100, ticks:{ callback:v=>v+"%" } }
          } : {
            x: { ticks:{ autoSkip:false } },
            y: { beginAtZero:true, ticks:{ precision:0 } },
            y1:{ position:"right", min:0, max:100, ticks:{ callback:v=>v+"%" } }
          }
        }
      });

      // 明細（総合）
      if(pAll.total>0){
        $("claimsBody").innerHTML = pAll.labels.map((k,i)=>{
          const v = pAll.values[i];
          const pct = Math.round(v/pAll.total*1000)/10;
          return `<tr><td>${k||"（未分類）"}</td><td>${v}</td><td>${pct}%</td></tr>`;
        }).join("");
      }else{
        $("claimsBody").innerHTML = `<tr><td colspan="3" class="muted">データなし</td></tr>`;
      }

      // 部位別
      const checked = new Set(selectedKeys());
      const renderPart = (key)=>{
        const panel = document.getElementById("panel"+key);
        if(!checked.has(key) || !PART_COLS[key]){ panel.style.display="none"; return; }
        panel.style.display="block";

        const p = buildParetoForPart(monthRows, key, topN);
        const horiz = $("paretoOri").value === "horizontal";
        const la = horiz ? "x1" : "y1";
        showEmpty("empty"+key, p.total===0);

        const ctx = document.getElementById("pareto"+key).getContext("2d");
        charts[key] = new Chart(ctx, {
          type:"bar",
          data:{
            labels: p.labels,
            datasets: [
              { type:"bar", label:"件数", data:p.values, borderWidth:1 },
              { type:"line", label:"累積%", data:p.cum, yAxisID:la, xAxisID:la, borderWidth:2, pointRadius:3 }
            ]
          },
          options:{
            responsive:true, maintainAspectRatio:false,
            plugins:{ legend:{display:true}, tooltip:{mode:"index", intersect:false} },
            indexAxis: horiz ? "y":"x",
            scales: horiz ? {
              y:{ beginAtZero:true, ticks:{ autoSkip:false } },
              x:{ beginAtZero:true, ticks:{ precision:0 } },
              x1:{ position:"top", min:0, max:100, ticks:{ callback:v=>v+"%" } }
            } : {
              x:{ ticks:{ autoSkip:false } },
              y:{ beginAtZero:true, ticks:{ precision:0 } },
              y1:{ position:"right", min:0, max:100, ticks:{ callback:v=>v+"%" } }
            }
          }
        });
      };
      ["SG","CV","WB","SC"].forEach(renderPart);
    }

    async function bootstrap(){
      const out = await loadCSV();
      RAW = out.data || [];
      HEADERS = out.meta?.fields || Object.keys(RAW[0]||{});

      if(!HEADERS.includes(COL_CATEGORY) || !HEADERS.includes(COL_MONTH)){
        setErr("ヘッダーに「発行実績」または「月」が見つかりません。"); return;
      }
      PART_COLS = mapPartColumns(HEADERS);

      // log mapping supaya bisa dicek cepat di Console
      console.log("Mapped columns:", PART_COLS, "All headers:", HEADERS);

      buildMonthSelect(RAW);
      buildPartChecks();
      drawAll();
    }

    // events
    ["change","input"].forEach(ev=>{
      $("monthSel").addEventListener(ev, drawAll);
      $("trendMode").addEventListener(ev, drawAll);
      $("paretoOri").addEventListener(ev, drawAll);
      $("topN").addEventListener(ev, drawAll);
    });
    $("partChecks").addEventListener("change", drawAll);
    $("reloadBtn").addEventListener("click", bootstrap);
    $("exportBtn").addEventListener("click", ()=>{
      const month = Number($("monthSel").value);
      const keys = selectedKeys();
      const rows = RAW.filter(r=> Number(r[COL_MONTH])===month );
      if(!rows.length){ alert("出力対象データがありません。"); return; }
      const cols = [COL_MONTH, COL_CATEGORY, ...keys.map(k=>PART_COLS[k]).filter(Boolean)];
      const out = rows.map(r=>{
        const o={}; cols.forEach(c=>o[c]=r[c]); return o;
      });
      const blob = new Blob([toCSV(out)], {type:"text/csv;charset=utf-8"});
      const a = document.createElement("a");
      a.href = URL.createObjectURL(blob);
      a.download = `品質情報_${month}月.csv`;
      a.click();
    });

    window.addEventListener("DOMContentLoaded", bootstrap);
  </script>
</body>
</html>
