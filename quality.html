<!doctype html>
<html lang="ja" data-theme="light">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>品質情報（グラフ｜CSV）</title>
<style>
  :root{
    --bg1:#eef2ff; --bg2:#f8fafc;
    --card:#fff; --ink:#0f172a; --muted:#64748b; --border:#e5e7eb;
    --accent:#2563eb; --shadow:0 30px 60px rgba(15,23,42,.08); --radius:20px;
    --grid:#e5e7eb;
  }
  [data-theme="dark"]{
    --bg1:#0b1220; --bg2:#0b1220;
    --card:#0f172a; --ink:#e5e7eb; --muted:#94a3b8; --border:#1f2937;
    --accent:#60a5fa; --shadow:none; --grid:#223044;
  }
  *{box-sizing:border-box}
  html,body{height:100%}
  body{
    margin:0; color:var(--ink);
    font-family: system-ui,-apple-system,Segoe UI,Roboto,"Noto Sans JP","Yu Gothic",sans-serif;
    background:
      radial-gradient(1200px 600px at -10% -10%, #c7d2fe33 0%, transparent 60%),
      radial-gradient(900px 500px at 110% 0%, #bae6fd33 0%, transparent 55%),
      linear-gradient(120deg,var(--bg1),var(--bg2));
  }
  header{position:sticky;top:0;z-index:10;background:#ffffffcc;border-bottom:1px solid var(--border);backdrop-filter:blur(10px)}
  [data-theme="dark"] header{background:#0f172acc}
  .wrap{max-width:1200px;margin:0 auto;padding:12px 20px}
  .row{display:flex;justify-content:space-between;align-items:center;gap:16px}
  .controls{display:flex;gap:8px;align-items:center}
  .btn{padding:8px 12px;border:1px solid var(--border);border-radius:10px;background:var(--card);color:var(--ink);cursor:pointer}
  .btn[disabled]{opacity:.6;cursor:not-allowed}
  .small{font-size:12px;color:var(--muted)}
  main{max-width:1200px;margin:26px auto;padding:0 20px}
  .card{background:var(--card);border:1px solid var(--border);border-radius:var(--radius);box-shadow:var(--shadow);padding:18px}
  .card-title{display:flex;align-items:center;justify-content:space-between;gap:16px;margin:0 0 12px}
  .filterbar{display:flex;gap:8px;align-items:center;flex-wrap:wrap}
  select.btn{appearance:none;padding-right:26px;background-image:
    linear-gradient(45deg,transparent 50%,#64748b 50%),
    linear-gradient(135deg,#64748b 50%,transparent 50%);background-position:
    calc(100% - 18px) calc(1em - 2px), calc(100% - 13px) calc(1em - 2px);
    background-size:5px 5px;background-repeat:no-repeat}
  .grid{display:grid;grid-template-columns:1fr 1fr;gap:16px}
  .box{background:var(--card);border:1px solid var(--border);border-radius:16px;padding:12px;min-height:380px;display:flex;align-items:center;justify-content:center}
  .box.wide{grid-column:1/-1}
  .box canvas{width:100%!important;height:330px!important}
  @media (max-width:900px){.grid{grid-template-columns:1fr}}
  .banner{padding:8px 12px;border:1px solid #f59e0b;background:#fef3c7;color:#78350f;border-radius:8px;margin-bottom:12px}
</style>
</head>
<body>
<header>
  <div class="wrap row">
    <strong>品質情報</strong>
    <div class="controls">
      <button id="btnRefresh" class="btn" type="button">Refresh now</button>
      <label class="small" style="display:flex;align-items:center;gap:6px">
        <input id="chkDark" type="checkbox"> Dark
      </label>
    </div>
  </div>
</header>

<main>
  <section class="card" style="margin-bottom:16px">
    <div id="banner" class="banner" style="display:none"></div>
    <div class="card-title">
      <h2 style="margin:0">出荷検査 — グラフ</h2>
      <div class="small">source: publish CSV</div>
    </div>
    <div class="filterbar" aria-label="フィルター">
      <label class="small">年:</label>
      <select id="selYear" class="btn"></select>

      <label class="small">月:</label>
      <select id="selMonth" class="btn">
        <option value="ALL">All</option>
        <option value="01">1</option><option value="02">2</option><option value="03">3</option>
        <option value="04">4</option><option value="05">5</option><option value="06">6</option>
        <option value="07">7</option><option value="08">8</option><option value="09">9</option>
        <option value="10">10</option><option value="11">11</option><option value="12">12</option>
      </select>

      <label class="small">向き:</label>
      <select id="selOrient" class="btn">
        <option value="v" selected>Vertical</option>
        <option value="h">Horizontal</option>
      </select>

      <button id="btnReset" class="btn" type="button">Reset</button>
    </div>
    <div class="small" id="note">読み込み中…</div>
  </section>

  <section class="card" aria-label="チャート">
    <div class="grid">
      <div class="box"><canvas id="cDept"></canvas></div>
      <div class="box"><canvas id="cType"></canvas></div>
      <div class="box wide"><canvas id="cDeptTop"></canvas></div>
    </div>
  </section>
</main>

<!-- libs -->
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-datalabels@2"></script>

<script>
/** ================== CONFIG ================== */
/* Pakai link CSV publish yang kamu berikan */
const PUBLISHED_CSV_URL =
  "https://docs.google.com/spreadsheets/d/e/2PACX-1vQGwY4tjwfHVYZMuJpqSVo9uqHexcD2bmHdCiIg85oo036PLkxe4YXhHCpJbFi1mT1VgyjfNYLHOtNb/pub?gid=1070847733&single=true&output=csv";

/** ================== HELPERS ================== */
const S = v => String(v ?? "").trim();
const intTick = v => Number.isInteger(v) ? v : "";
function showBanner(msg){
  const b = document.getElementById("banner");
  b.textContent = msg;
  b.style.display = msg ? "block" : "none";
}
function parseCSV(text){
  // quick check HTML?
  if (/^\s*</.test(text)) throw new Error("Google mengembalikan HTML, bukan CSV. Cek: Publish to the web & akses publik.");
  const rows = [], re=/\s*("(?:[^"]|"")*"|[^,]*)\s*(,|\n|$)/g;
  text = text.replace(/\r\n?/g,"\n");
  let m, row=[];
  for (let i=0;i<text.length;){
    re.lastIndex=i; m=re.exec(text); if(!m) break;
    let cell=m[1];
    if(cell.startsWith('"')) cell=cell.slice(1,-1).replace(/""/g,'"');
    row.push(cell); i=re.lastIndex;
    if(m[2]==="\n"||m[2]===""){ rows.push(row); row=[]; }
  }
  return rows.filter(r=>r.length && r.some(c=>S(c)!==""));
}
function indexByName(header){
  const map={}; header.forEach((h,i)=>map[S(h)]=i);
  const find = names => { for(const n of names){ if(n in map) return map[n]; } return null; };
  const fuzzy = re => { for(let i=0;i<header.length;i++){ if(re.test(S(header[i]))) return i; } return null; };
  return {
    idxDate : find(["出荷日","年月日","日付","Date"]) ?? fuzzy(/(日付|date)/i),
    idxDept : find(["部署","部門","部"]) ?? fuzzy(/部署|部門|部\b/),
    idxType : find(["クレーム種類","クレーム種別","種類"]) ?? fuzzy(/(クレーム|種|type)/i),
  };
}
function parseDateFlexible(str){
  const s=S(str);
  // YYYY/MM/DD or YYYY-MM-DD
  let m=s.match(/^(\d{4})\D(\d{1,2})\D(\d{1,2})/);
  if(m) return new Date(+m[1], +m[2]-1, +m[3]);
  // English "Monday, June 02, 2025"
  const d=new Date(s);
  return isNaN(d)?null:d;
}
function monthKey(d){ return String(d.getMonth()+1).padStart(2,"0"); }
function getTheme(){
  const cs=getComputedStyle(document.documentElement);
  return {
    ink: cs.getPropertyValue('--ink').trim()||'#0f172a',
    grid: cs.getPropertyValue('--grid').trim()||'#e5e7eb'
  };
}
function palette(n){
  const base = ['#93c5fd','#a5b4fc','#fda4af','#fdba74','#86efac','#67e8f9','#f5d0fe','#c4b5fd','#fecaca','#fde68a','#bbf7d0','#bae6fd'];
  return Array.from({length:n},(_,i)=>base[i%base.length]);
}

/** ================== STATE ================== */
Chart.register(ChartDataLabels);
let cached = {header:[], rows:[], idx:null};
let charts = {dept:null, type:null, deptTop:null};

/** ================== LOAD ================== */
async function load(){
  try{
    showBanner("");
    document.getElementById("note").textContent = "Loading...";
    const btn = document.getElementById('btnRefresh'); btn.disabled=true;

    const res = await fetch(PUBLISHED_CSV_URL + "&_ts=" + Date.now(), {cache:"no-store"});
    if(!res.ok) throw new Error("HTTP "+res.status);
    const text = await res.text();
    const arr = parseCSV(text);
    if(!arr.length) throw new Error("CSV kosong.");

    const header = arr[0], rows = arr.slice(1);
    const idx = indexByName(header);

    if(idx.idxDate==null || idx.idxDept==null || idx.idxType==null){
      throw new Error("Nama kolom wajib tidak ditemukan. Butuh: 年月日/日付(Date),  部署,  クレーム種類.");
    }

    // Build years for filter
    const yearSet = new Set();
    const cleanRows = [];
    for(const r of rows){
      const d = parseDateFlexible(r[idx.idxDate]);
      if(!d || isNaN(d)) continue;
      yearSet.add(d.getFullYear());
      cleanRows.push(r);
    }
    cached = {header, rows:cleanRows, idx};

    const years = [...yearSet].sort();
    const selYear = document.getElementById("selYear");
    selYear.innerHTML = years.map(y=>`<option value="${y}">${y}</option>`).join("");
    selYear.value = years.at(-1) ?? new Date().getFullYear();

    render();
    btn.disabled=false;
    document.getElementById("note").textContent = "OK";
  }catch(e){
    console.error(e);
    showBanner("Gagal membaca CSV. " + e.message + "  — Cek: Publish to the web (CSV), akses publik, tab & kolom.");
    document.getElementById("note").textContent = "読み込み失敗";
    document.getElementById('btnRefresh').disabled=false;
  }
}

/** ================== RENDER ================== */
function render(){
  if(!cached.rows?.length) return;
  const year = document.getElementById("selYear").value;
  const month = document.getElementById("selMonth").value;
  const orient = document.getElementById("selOrient").value; // v|h
  const {idxDate, idxDept, idxType} = cached.idx;

  // filter by period
  const filtered = [];
  for(const r of cached.rows){
    const d = parseDateFlexible(r[idxDate]);
    if(!d) continue;
    if(String(d.getFullYear())!==String(year)) continue;
    if(month!=="ALL" && monthKey(d)!==month) continue;
    filtered.push(r);
  }

  const countMap = (arr, getter) => {
    const m=new Map();
    for(const r of arr){ const k=S(getter(r)); if(!k) continue; m.set(k,(m.get(k)||0)+1); }
    return m;
  };

  const mpDept = countMap(filtered, r=>r[idxDept]);
  const mpType = countMap(filtered, r=>r[idxType]);

  // total TOP 10 dept (tahun terpilih, semua bulan)
  const mpDeptTop = countMap(
    cached.rows.filter(r => String(parseDateFlexible(r[idxDate])?.getFullYear())===String(year)),
    r=>r[idxDept]
  );

  const toArrays = (mp, topN=null) => {
    let arr=[...mp.entries()].sort((a,b)=>b[1]-a[1]);
    if(topN) arr=arr.slice(0, topN);
    return {labels:arr.map(a=>a[0]), data:arr.map(a=>a[1])};
  };

  const dept = toArrays(mpDept);
  const typ  = toArrays(mpType);
  const deptTop = toArrays(mpDeptTop, 10);

  const theme=getTheme();
  const idxAxis = orient==='h' ? 'y' : 'x';

  // destroy old
  charts.dept?.destroy(); charts.type?.destroy(); charts.deptTop?.destroy();

  // Dept chart
  charts.dept = new Chart(document.getElementById('cDept').getContext('2d'), {
    type:'bar',
    data:{ labels:dept.labels, datasets:[{label:'件数', data:dept.data, backgroundColor:palette(dept.data.length)}]},
    options:{
      indexAxis: idxAxis,
      maintainAspectRatio:false,
      plugins:{
        legend:{display:false},
        title:{display:true, text:`部署別（件数）｜${year}年${month==='ALL'?' 全月':' '+parseInt(month,10)+'月'}`},
        datalabels:{anchor:'end', align:orient==='h'?'right':'top', formatter:v=>v}
      },
      scales: orient==='h' ? {
        x:{beginAtZero:true,ticks:{callback:intTick},grid:{color:theme.grid}},
        y:{grid:{display:false}}
      } : {
        y:{beginAtZero:true,ticks:{callback:intTick},grid:{color:theme.grid}},
        x:{grid:{display:false}}
      }
    }
  });

  // Type chart
  charts.type = new Chart(document.getElementById('cType').getContext('2d'), {
    type:'bar',
    data:{ labels:typ.labels, datasets:[{label:'件数', data:typ.data, backgroundColor:palette(typ.data.length)}]},
    options:{
      indexAxis: idxAxis,
      maintainAspectRatio:false,
      plugins:{
        legend:{display:false},
        title:{display:true, text:`種類別（件数）｜${year}年${month==='ALL'?' 全月':' '+parseInt(month,10)+'月'}`},
        datalabels:{anchor:'end', align:orient==='h'?'right':'top', formatter:v=>v}
      },
      scales: orient==='h' ? {
        x:{beginAtZero:true,ticks:{callback:intTick},grid:{color:theme.grid}},
        y:{grid:{display:false}}
      } : {
        y:{beginAtZero:true,ticks:{callback:intTick},grid:{color:theme.grid}},
        x:{grid:{display:false}}
      }
    }
  });

  // Dept TOP 10
  charts.deptTop = new Chart(document.getElementById('cDeptTop').getContext('2d'), {
    type:'bar',
    data:{ labels:deptTop.labels, datasets:[{label:'件数', data:deptTop.data, backgroundColor:palette(deptTop.data.length)}]},
    options:{
      indexAxis: idxAxis,
      maintainAspectRatio:false,
      plugins:{
        legend:{display:false},
        title:{display:true, text:`部署別 TOP10（件数）｜${year}年 合計`},
        datalabels:{anchor:'end', align:orient==='h'?'right':'top', formatter:v=>v}
      },
      scales: orient==='h' ? {
        x:{beginAtZero:true,ticks:{callback:intTick},grid:{color:theme.grid}},
        y:{grid:{display:false}}
      } : {
        y:{beginAtZero:true,ticks:{callback:intTick},grid:{color:theme.grid}},
        x:{grid:{display:false}}
      }
    }
  });

  document.getElementById('note').textContent =
    `レコード: ${filtered.length}（${year}年${month==='ALL'?' 全月':' '+parseInt(month,10)+'月'}）`;
}

/** ================== EVENTS ================== */
document.getElementById('btnRefresh').addEventListener('click', load);
document.getElementById('btnReset').addEventListener('click', ()=>{
  const ySel=document.getElementById('selYear');
  if(ySel.options.length) ySel.value = ySel.options[ySel.options.length-1].value;
  document.getElementById('selMonth').value="ALL";
  document.getElementById('selOrient').value="v";
  render();
});
['selYear','selMonth','selOrient'].forEach(id=>{
  document.getElementById(id).addEventListener('change', render);
});
document.getElementById('chkDark').addEventListener('change', e=>{
  document.documentElement.setAttribute('data-theme', e.target.checked?'dark':'light');
  render();
});

/** ================== INIT ================== */
window.addEventListener('DOMContentLoaded', load);
</script>
</body>
</html>
