<!doctype html>
<html lang="ja" data-theme="light">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>品質情報（グラフ｜CSV 自動検出）</title>
  <style>
    :root{
      --bg1:#eef2ff; --bg2:#f8fafc;
      --card:#fff; --ink:#0f172a; --muted:#64748b; --border:#e5e7eb;
      --accent:#2563eb; --shadow:0 30px 60px rgba(15,23,42,.08); --radius:18px;
      --grid:#e5e7eb;
    }
    [data-theme="dark"]{
      --bg1:#0b1220; --bg2:#0b1220;
      --card:#0f172a; --ink:#e5e7eb; --muted:#94a3b8; --border:#1f2937;
      --accent:#60a5fa; --shadow:none; --grid:#223044;
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{
      margin:0;color:var(--ink);
      font-family:system-ui,-apple-system,Segoe UI,Roboto,"Noto Sans JP","Yu Gothic",sans-serif;
      background:
        radial-gradient(1200px 600px at -10% -10%, #c7d2fe33 0%, transparent 60%),
        radial-gradient(900px 500px at 110% 0%, #bae6fd33 0%, transparent 55%),
        linear-gradient(120deg,var(--bg1),var(--bg2));
      padding-bottom:40px;
    }
    header{position:sticky;top:0;z-index:9;background:#ffffffcc;backdrop-filter:blur(10px);border-bottom:1px solid var(--border)}
    [data-theme="dark"] header{background:#0f172acc}
    .wrap{max-width:1200px;margin:0 auto;padding:12px 20px}
    .row{display:flex;justify-content:space-between;align-items:center;gap:12px}
    nav a{margin-left:16px;color:var(--accent);font-weight:700;text-decoration:none}
    nav a:hover{text-decoration:underline}
    .controls{display:flex;gap:8px;align-items:center;flex-wrap:wrap}
    .btn{padding:8px 12px;border:1px solid var(--border);border-radius:10px;background:var(--card);color:var(--ink);cursor:pointer}
    .small{font-size:12px;color:var(--muted)}
    main{max-width:1200px;margin:22px auto;padding:0 20px}
    .card{background:var(--card);border:1px solid var(--border);border-radius:var(--radius);box-shadow:var(--shadow);padding:16px}
    .card-title{display:flex;align-items:center;justify-content:space-between;gap:16px;margin:0 0 10px}
    .filterbar{display:flex;gap:8px;align-items:center;flex-wrap:wrap}
    select.btn{appearance:none;padding-right:26px;background-image:
      linear-gradient(45deg,transparent 50%,#64748b 50%),
      linear-gradient(135deg,#64748b 50%,transparent 50%);
      background-position:calc(100% - 18px) calc(1em - 2px),calc(100% - 13px) calc(1em - 2px);
      background-size:5px 5px;background-repeat:no-repeat}
    .chart-grid{display:grid;grid-template-columns:1fr 1fr;gap:16px}
    .chart-box{background:var(--card);border:1px solid var(--border);border-radius:16px;padding:12px;min-height:360px;display:flex;align-items:center;justify-content:center}
    .chart-box.wide{grid-column:1/-1}
    .chart-box canvas{width:100%!important;height:320px!important}
    @media (max-width:900px){.chart-grid{grid-template-columns:1fr}}
    footer{position:fixed;bottom:0;left:0;right:0;text-align:center;font-size:12px;color:var(--muted);background:#f1f5f9}
    [data-theme="dark"] footer{background:#0b1220}
  </style>
</head>
<body>
<header>
  <div class="wrap row">
    <div style="display:flex;align-items:center;gap:10px">
      <strong>品質情報</strong>
      <span class="small">（グラフ｜CSV 自動検出）</span>
    </div>
    <div class="controls">
      <button id="btnRefresh" class="btn" type="button">Loading…</button>
      <label class="small" style="display:flex;align-items:center;gap:6px">
        <input id="chkDark" type="checkbox"> Dark
      </label>
    </div>
  </div>
</header>

<main>
  <section class="card" style="margin-bottom:14px">
    <div class="card-title">
      <h2 style="margin:0;font-size:18px">出荷検査 — グラフ</h2>
      <div class="small" id="srcInfo"></div>
    </div>

    <div class="filterbar">
      <label class="small">年:</label>
      <select id="selYear" class="btn"></select>

      <label class="small">月:</label>
      <select id="selMonth" class="btn">
        <option value="ALL" selected>All</option>
        <option value="01">1</option><option value="02">2</option><option value="03">3</option>
        <option value="04">4</option><option value="05">5</option><option value="06">6</option>
        <option value="07">7</option><option value="08">8</option><option value="09">9</option>
        <option value="10">10</option><option value="11">11</option><option value="12">12</option>
      </select>

      <label class="small">向き:</label>
      <select id="selOrient" class="btn">
        <option value="v" selected>Vertical</option>
        <option value="h">Horizontal</option>
      </select>

      <button id="btnReset" class="btn">Reset</button>
      <span class="small" id="note"></span>
    </div>
  </section>

  <section class="card">
    <div class="chart-grid">
      <div class="chart-box"><canvas id="chartDept" aria-label="部署別（件数）"></canvas></div>
      <div class="chart-box"><canvas id="chartType" aria-label="種類別（件数）"></canvas></div>
      <div class="chart-box wide"><canvas id="chartMonthly" aria-label="月別（件数）"></canvas></div>
    </div>
  </section>
</main>

<footer>Design by Wahyu</footer>

<script src="https://cdn.jsdelivr.net/npm/chart.js@4"></script>
<script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-datalabels@2"></script>

<script>
/* ====== GANTI DI SINI: link CSV ====== */
const CSV_URL = "https://docs.google.com/spreadsheets/d/e/2PACX-1vQGwY4tjwfHVYZMuJpqSVo9uqHexcD2bmHdCiIg85oo036PLkxe4YXhHCpJbFi1mT1VgyjfNYLHOtNb/pub?gid=1070847733&single=true&output=csv";
/* ===================================== */

Chart.register(ChartDataLabels);
const $ = (id) => document.getElementById(id);
const S = (v) => String(v ?? '').trim();

function parseCSV(text){
  const out=[], re=/\s*("(?:[^"]|"")*"|[^,]*)\s*(,|\n|$)/gy;
  text=text.replace(/\r\n?/g,"\n");
  let m,row=[];
  for(let i=0;i<text.length;){
    re.lastIndex=i; m=re.exec(text); if(!m) break;
    let cell=m[1]; if(cell.startsWith('"')) cell=cell.slice(1,-1).replace(/""/g,'"');
    row.push(cell); i=re.lastIndex;
    if(m[2]==="\n"||m[2]===""){ out.push(row); row=[]; }
  }
  return out.filter(r=>r.length && r.some(c=>S(c)!==""));
}

// ===== RAW mode detection =====
function findRawIdx(header){
  const map={}; header.forEach((h,i)=>map[S(h)]=i);
  const find=(...names)=>{ for(const n of names){ if(map[n]!=null) return map[n]; } return null; };
  const fuzzy=(re)=>{ for(let i=0;i<header.length;i++){ if(re.test(S(header[i]))) return i; } return null; };
  return {
    date: find("年月日","日付","発行日","Date") ?? fuzzy(/(年月日|日付|date|発行)/i),
    dept: find("部署","部署名","部門") ?? fuzzy(/部署|部門/),
    type: find("クレーム種類","クレーム種別","種類","区分") ?? fuzzy(/(種類|種別|区分)/)
  };
}

// ===== PIVOT mode detection =====
function findPivotIdx(header){
  const month = header.findIndex(h=>/(Month|月)/i.test(S(h)));
  const dept  = header.findIndex(h=>/(部署|部門)/.test(S(h)));
  if(month<0 || dept<0) return null;
  const typeCols = header.map((_,i)=>i)
    .filter(i=> i!==month && i!==dept && !/total/i.test(S(header[i])));
  return {month, dept, typeCols};
}

function parseJPDate(s){
  const t=S(s);
  let m=t.match(/^(\d{4})\D(\d{1,2})\D(\d{1,2})/);
  if(m) return new Date(+m[1], +m[2]-1, +m[3]);
  const d=new Date(t);
  return isNaN(d)?null:d;
}

const MONTH_NAME = {jan:1,feb:2,mar:3,apr:4,may:5,jun:6,jul:7,aug:8,sep:9,oct:10,nov:11,dec:12};
function monthToNum(v){
  const t=S(v).toLowerCase();
  let m=t.match(/(\d{1,2})\s*月/); if(m) return +m[1];
  for(const k in MONTH_NAME){ if(t.startsWith(k)) return MONTH_NAME[k]; }
  return null;
}

const state = { header:[], rows:[], mode:'raw', rawIdx:null, pivotIdx:null, charts:{dept:null,type:null,monthly:null} };

function uniqueYearsRaw(rows, idx){
  const ys=new Set();
  for(const r of rows){
    const d=parseJPDate(r[idx.date]); if(d) ys.add(String(d.getFullYear()));
  }
  return [...ys].sort();
}
function uniqueYearsPivot(rows, idx){
  // coba ambil dari string bulan (kalau ada tahun di dalamnya)
  const ys=new Set();
  for(const r of rows){
    const m=S(r[idx.month]);
    const y = (m.match(/(19|20)\d{2}/)||[])[0];
    if(y) ys.add(y);
  }
  const arr=[...ys].sort();
  return arr.length?arr:[String(new Date().getFullYear())];
}

function buildFilters(){
  const selYear=$("selYear");
  let years=[];
  if(state.mode==='raw') years=uniqueYearsRaw(state.rows, state.rawIdx);
  else years=uniqueYearsPivot(state.rows, state.pivotIdx);
  selYear.innerHTML = years.map(y=>`<option value="${y}">${y}</option>`).join("");
  selYear.value = years.at(-1);
}

function destroyCharts(){
  for(const k of ["dept","type","monthly"]){
    if(state.charts[k]){ state.charts[k].destroy(); state.charts[k]=null; }
  }
}
function palette(n, a=0.85){
  const L=['#93c5fd','#a5b4fc','#fda4af','#fdba74','#86efac','#67e8f9','#f5d0fe','#c4b5fd','#fecaca','#fde68a','#bbf7d0','#bae6fd'];
  const D=['#60a5fa','#818cf8','#fca5a5','#fbbf24','#4ade80','#22d3ee','#f0abfc','#a78bfa','#f87171','#fde047','#86efac','#93c5fd'];
  const base=document.documentElement.getAttribute("data-theme")==="dark"?D:L;
  const rgba=(hex,a)=>{const h=hex.replace('#','');const b=parseInt(h,16);return`rgba(${(b>>16)&255},${(b>>8)&255},${b&255},${a})`};
  return Array.from({length:n},(_,i)=>rgba(base[i%base.length],a));
}

function render(){
  destroyCharts();
  const orient=$("selOrient").value; const indexAxis=(orient==='h')?'y':'x';
  const themeInk=getComputedStyle(document.documentElement).getPropertyValue('--ink').trim()||'#0f172a';
  const themeGrid=getComputedStyle(document.documentElement).getPropertyValue('--grid').trim()||'#e5e7eb';

  let deptArr=[], typeArr=[], monthly={labels:[...Array(12)].map((_,i)=>String(i+1)), data:Array(12).fill(0)};
  const pickYear=$("selYear").value;
  const pickMonth=$("selMonth").value; // 01..12 or ALL

  if(state.mode==='raw'){
    const {rows, rawIdx:idx}=state;
    const dept=new Map(), typ=new Map(), mon=new Map();
    for(const r of rows){
      const d=parseJPDate(r[idx.date]); if(!d) continue;
      const y=String(d.getFullYear()); const m=String(d.getMonth()+1).padStart(2,'0');
      if(y!==pickYear) continue;
      if(pickMonth!=='ALL' && m!==pickMonth) continue;
      const dv = idx.dept!=null? S(r[idx.dept])||'不明' :'不明';
      const tv = idx.type!=null? S(r[idx.type])||'不明' :'不明';
      dept.set(dv,(dept.get(dv)||0)+1);
      typ.set(tv,(typ.get(tv)||0)+1);
      mon.set(m,(mon.get(m)||0)+1);
    }
    deptArr=[...dept.entries()].sort((a,b)=>b[1]-a[1]);
    typeArr=[...typ.entries()].sort((a,b)=>b[1]-a[1]);
    monthly.labels=[...Array(12)].map((_,i)=>String(i+1));
    monthly.data=monthly.labels.map(mm=> mon.get(mm.padStart(2,'0'))||0);
    $("note").textContent="source: RAW CSV（行数カウント）";
  }else{
    const {rows, pivotIdx:idx}=state;
    const dept=new Map(), typ=new Map(), mon=new Map();
    for(const r of rows){
      const mo=S(r[idx.month]); if(!mo || /total/i.test(mo)) continue; // skip Total rows
      const mNum=monthToNum(mo); // 1..12 or null
      const y = (mo.match(/(19|20)\d{2}/)||[])[0] || pickYear; // pakai tahun pick kalau tidak ada
      if(String(y)!==String(pickYear)) continue;
      if(pickMonth!=='ALL' && mNum!==+pickMonth) continue;

      const dv = idx.dept!=null? S(r[idx.dept])||'不明' :'不明';
      let rowSum=0;
      for(const c of idx.typeCols){
        const v=+S(r[c]).replace(/,/g,'')||0;
        rowSum+=v;
        const name=S(state.header[c])||`種別${c}`;
        typ.set(name,(typ.get(name)||0)+v);
      }
      dept.set(dv,(dept.get(dv)||0)+rowSum);
      if(mNum) mon.set(String(mNum).padStart(2,'0'), (mon.get(String(mNum).padStart(2,'0'))||0)+rowSum);
    }
    deptArr=[...dept.entries()].sort((a,b)=>b[1]-a[1]);
    typeArr=[...typ.entries()].sort((a,b)=>b[1]-a[1]);
    monthly.labels=[...Array(12)].map((_,i)=>String(i+1));
    monthly.data=monthly.labels.map(mm=> mon.get(mm.padStart(2,'0'))||0);
    $("note").textContent="source: PIVOT CSV（件数合計）";
  }

  // Dept
  (function(){
    const ctx=$("chartDept").getContext("2d");
    state.charts.dept=new Chart(ctx,{
      type:'bar',
      data:{labels:deptArr.map(d=>d[0]), datasets:[{label:'件数', data:deptArr.map(d=>d[1]), backgroundColor:palette(deptArr.length)}]},
      options:{
        indexAxis, maintainAspectRatio:false,
        plugins:{legend:{display:false}, title:{display:true,text:`部署別（件数）｜${pickYear}${pickMonth!=="ALL"?"／"+(+pickMonth)+"月":""}`},
          datalabels:{anchor:'end', align:(orient==='h'?'right':'top'), color:themeInk, formatter:v=>v}},
        scales:(orient==='h')?{x:{beginAtZero:true,ticks:{precision:0},grid:{color:themeGrid}},y:{grid:{display:false}}}
                             :{y:{beginAtZero:true,ticks:{precision:0},grid:{color:themeGrid}},x:{grid:{display:false}}}
      }
    });
  })();

  // Type
  (function(){
    const ctx=$("chartType").getContext("2d");
    state.charts.type=new Chart(ctx,{
      type:'bar',
      data:{labels:typeArr.map(d=>d[0]), datasets:[{label:'件数', data:typeArr.map(d=>d[1]), backgroundColor:palette(typeArr.length)}]},
      options:{
        indexAxis, maintainAspectRatio:false,
        plugins:{legend:{display:false}, title:{display:true,text:`種類別（件数）｜${pickYear}${pickMonth!=="ALL"?"／"+(+pickMonth)+"月":""}`},
          datalabels:{anchor:'end', align:(orient==='h'?'right':'top'), color:themeInk, formatter:v=>v}},
        scales:(orient==='h')?{x:{beginAtZero:true,ticks:{precision:0},grid:{color:themeGrid}},y:{grid:{display:false}}}
                             :{y:{beginAtZero:true,ticks:{precision:0},grid:{color:themeGrid}},x:{grid:{display:false}}}
      }
    });
  })();

  // Monthly
  (function(){
    const ctx=$("chartMonthly").getContext("2d");
    state.charts.monthly=new Chart(ctx,{
      type:'bar',
      data:{labels:monthly.labels, datasets:[{label:'件数', data:monthly.data, backgroundColor:palette(12)}]},
      options:{
        indexAxis:(orient==='h')?'y':'x', maintainAspectRatio:false,
        plugins:{legend:{display:false}, title:{display:true,text:`月別（件数）｜${pickYear}`},
          datalabels:{display:(ctx)=>ctx.dataset.data[ctx.dataIndex]>0,anchor:'end',align:(orient==='h'?'right':'top'),color:themeInk,formatter:v=>v}},
        scales:(orient==='h')?{x:{beginAtZero:true,ticks:{precision:0},grid:{color:themeGrid}},y:{grid:{display:false}}}
                             :{y:{beginAtZero:true,ticks:{precision:0},grid:{color:themeGrid}},x:{grid:{display:false}}}
      }
    });
  })();
}

async function load(){
  try{
    $("btnRefresh").disabled=true;
    $("btnRefresh").textContent="Loading…";
    const res=await fetch(CSV_URL + "&_ts="+Date.now(),{cache:"no-store"});
    if(!res.ok) throw new Error("HTTP "+res.status);
    const text=await res.text();
    if(!/^["\w]/.test(text)) console.warn("Response head:", text.slice(0,120));
    const arr=parseCSV(text);
    if(!arr.length) throw new Error("CSV kosong");
    state.header=arr[0]; state.rows=arr.slice(1);

    // deteksi mode
    const rawIdx=findRawIdx(state.header);
    const pivotIdx=findPivotIdx(state.header);
    if(rawIdx.date!=null) { state.mode='raw'; state.rawIdx=rawIdx; }
    else if(pivotIdx){ state.mode='pivot'; state.pivotIdx=pivotIdx; }
    else throw new Error("Struktur CSV tidak dikenali (tidak ada kolom tanggal/Month+部署).");

    $("srcInfo").textContent = CSV_URL.replace(/\?.*$/,"").slice(0,90)+"…";
    buildFilters();
    render();
  }catch(e){
    console.error(e);
    alert("Gagal membaca CSV. Cek: Publish to the web (CSV), akses publik, dan nama kolom.");
  }finally{
    $("btnRefresh").disabled=false;
    $("btnRefresh").textContent="Refresh now";
  }
}

$("btnRefresh").addEventListener("click", load);
$("btnReset").addEventListener("click", ()=>{
  const ySel=$("selYear"); if(ySel.options.length) ySel.value=ySel.options[ySel.options.length-1].value;
  $("selMonth").value="ALL"; $("selOrient").value="v"; render();
});
["selYear","selMonth","selOrient"].forEach(id=>$(id).addEventListener("change", render));
$("chkDark").addEventListener("change",e=>{
  document.documentElement.setAttribute("data-theme", e.target.checked?"dark":"light"); render();
});
window.addEventListener("DOMContentLoaded", load);
</script>
</body>
</html>
