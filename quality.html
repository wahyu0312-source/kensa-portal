<!doctype html>
<html lang="ja" data-theme="light">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>品質情報（グラフ）</title>
<style>
  :root{--bg1:#eef2ff;--bg2:#f8fafc;--card:#fff;--ink:#0f172a;--muted:#64748b;--border:#e5e7eb;--accent:#2563eb;--shadow:0 30px 60px rgba(15,23,42,.08);--radius:20px;--grid:#e5e7eb}
  [data-theme="dark"]{--bg1:#0b1220;--bg2:#0b1220;--card:#0f172a;--ink:#e5e7eb;--muted:#94a3b8;--border:#1f2937;--accent:#60a5fa;--shadow:none;--grid:#223044}
  *{box-sizing:border-box}html,body{height:100%}
  body{margin:0;color:var(--ink);font-family:system-ui,-apple-system,Segoe UI,Roboto,"Noto Sans JP","Yu Gothic",sans-serif;background:
    radial-gradient(1200px 600px at -10% -10%, #c7d2fe33 0%, transparent 60%),
    radial-gradient(900px 500px at 110% 0%, #bae6fd33 0%, transparent 55%),
    linear-gradient(120deg,var(--bg1),var(--bg2))}
  header{position:sticky;top:0;z-index:10;background:#ffffffcc;backdrop-filter:blur(10px);border-bottom:1px solid var(--border)}
  [data-theme="dark"] header{background:#0f172acc}
  .wrap{max-width:1200px;margin:0 auto;padding:12px 20px}
  .row{display:flex;justify-content:space-between;align-items:center;gap:16px}
  nav a{margin-left:18px;color:var(--accent);font-weight:700;text-decoration:none}
  nav a:hover{text-decoration:underline}
  .controls{display:flex;gap:8px;align-items:center}
  .btn{padding:8px 12px;border:1px solid var(--border);border-radius:10px;background:var(--card);color:var(--ink);cursor:pointer}
  .btn[disabled]{opacity:.6;cursor:not-allowed}
  .small{font-size:12px;color:var(--muted)}
  main{max-width:1200px;margin:26px auto;padding:0 20px}
  .card{background:var(--card);border:1px solid var(--border);border-radius:var(--radius);box-shadow:var(--shadow);padding:18px}
  .card-title{display:flex;align-items:center;justify-content:space-between;gap:16px;margin:0 0 10px}
  .filterbar{display:flex;gap:8px;align-items:center;flex-wrap:wrap}
  select.btn{appearance:none;padding-right:26px;background-image:
    linear-gradient(45deg,transparent 50%,#64748b 50%),
    linear-gradient(135deg,#64748b 50%,transparent 50%);background-position:calc(100% - 18px) calc(1em - 2px),calc(100% - 13px) calc(1em - 2px);
    background-size:5px 5px;background-repeat:no-repeat}
  .chart-grid{display:grid;grid-template-columns:1fr 1fr;gap:16px}
  .chart-box{background:var(--card);border:1px solid var(--border);border-radius:16px;padding:12px;min-height:380px;display:flex;align-items:center;justify-content:center}
  .chart-box.wide{grid-column:1/-1}
  .chart-box canvas{width:100%!important;height:330px!important}
  @media (max-width:900px){.chart-grid{grid-template-columns:1fr}}
  .banner{max-width:1200px;margin:0 auto 10px;padding:8px 12px;border:1px solid #f0ad4e;background:#fffbe6;color:#6b4f00;border-radius:10px;font-size:13px}
  .chip{display:inline-block;font-size:12px;background:#e2e8f0;border:1px solid #cbd5e1;border-radius:999px;padding:2px 8px;margin-left:8px}
  .footer{margin:18px 0 8px;text-align:center;font-size:12px;color:var(--muted)}
</style>
</head>
<body>
<header>
  <div class="wrap row">
    <div style="display:flex;align-items:center;gap:10px">
      <img src="tsh.png" alt="TSH" style="height:36px">
      <strong>品質管理生産技術</strong>
      <span id="stat" class="chip" style="display:none"></span>
    </div>
    <nav>
      <a href="./index.html">ホーム</a>
      <a href="./charts.html"><strong>出荷検査（グラフ）</strong></a>
    </nav>
    <div class="controls">
      <button id="btnRefresh" class="btn" type="button">Refresh now</button>
      <label class="small" style="display:flex;align-items:center;gap:6px"><input id="chkDark" type="checkbox"> Dark</label>
    </div>
  </div>
</header>

<main>
  <div id="err" class="banner" style="display:none"></div>

  <section class="card" style="margin-bottom:16px">
    <div class="card-title">
      <h2 style="margin:0">品質情報 — グラフ</h2>
      <div class="filterbar">
        <label class="small">Top 顧客:</label>
        <select id="selTop" class="btn">
          <option value="5">5</option><option value="10" selected>10</option><option value="15">15</option><option value="30">30</option>
        </select>

        <label class="small">年:</label>
        <select id="selYear" class="btn"></select>

        <label class="small">月:</label>
        <select id="selMonth" class="btn">
          <option value="ALL" selected>All</option>
          <option value="01">1</option><option value="02">2</option><option value="03">3</option>
          <option value="04">4</option><option value="05">5</option><option value="06">6</option>
          <option value="07">7</option><option value="08">8</option><option value="09">9</option>
          <option value="10">10</option><option value="11">11</option><option value="12">12</option>
        </select>

        <label class="small">クレーム種類:</label>
        <select id="selType" class="btn"><option value="ALL" selected>All</option></select>

        <label class="small">顧客:</label>
        <select id="selCust" class="btn"><option value="">(指定なし)</option></select>

        <label class="small">向き:</label>
        <select id="selOrient" class="btn"><option value="h">Horizontal</option><option value="v" selected>Vertical</option></select>
      </div>
    </div>
    <div class="small" id="chartNote">集計は1行=1件。列: 年月 / クレーム種類 / 顧客名 / 部署。</div>
  </section>

  <section class="card" aria-label="チャート">
    <div class="chart-grid">
      <div class="chart-box"><canvas id="chartDept"></canvas></div>
      <div class="chart-box"><canvas id="chartType"></canvas></div>
      <div class="chart-box wide"><canvas id="chartCust"></canvas></div>
    </div>
  </section>

  <div class="footer">Design by Wahyu</div>
</main>

<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-datalabels@2"></script>
<script>
Chart.register(ChartDataLabels);

/* ====== SOURCES ====== */
const GVIZ_URLS = [
  "https://docs.google.com/spreadsheets/d/e/2PACX-1vTTyGRhapP1p6YUqQiGWwmHRYZjl-kxfuYeROLQNcOk0ZZFZeaGgQRZF1PNkiLe0mGXCX5pHnRUJsG6/gviz/tq?gid=649800458",
  "https://r.jina.ai/https://docs.google.com/spreadsheets/d/e/2PACX-1vTTyGRhapP1p6YUqQiGWwmHRYZjl-kxfuYeROLQNcOk0ZZFZeaGgQRZF1PNkiLe0mGXCX5pHnRUJsG6/gviz/tq?gid=649800458"
];
const PUBHTML_URLS = [
  "https://r.jina.ai/https://docs.google.com/spreadsheets/d/e/2PACX-1vTTyGRhapP1p6YUqQiGWwmHRYZjl-kxfuYeROLQNcOk0ZZFZeaGgQRZF1PNkiLe0mGXCX5pHnRUJsG6/pubhtml?gid=649800458&single=true"
];

const S = s => String(s ?? '').trim();
const intTick = v => Number.isInteger(v) ? v : '';
function showErr(msg){ const b=document.getElementById('err'); b.textContent=msg; b.style.display='block'; }
function hideErr(){ const b=document.getElementById('err'); b.style.display='none'; b.textContent=''; }
function stat(msg){ const el=document.getElementById('stat'); el.textContent=msg; el.style.display='inline-block'; }

/* ====== GViz JSONP (tanpa CORS) ====== */
function parseGvizTable(tbl){
  const header = (tbl.cols||[]).map(c => (c && (c.label||c.id)) ? String(c.label||c.id).trim() : "");
  const rows = (tbl.rows||[]).map(r => (r.c||[]).map((cell) => {
    let v = cell ? cell.v : "";
    return v==null ? "" : (v instanceof Date ? `${v.getFullYear()}-${String(v.getMonth()+1).padStart(2,'0')}` : String(v));
  }));
  return { header, rows };
}
function fetchGvizJSONP(base){
  return new Promise((resolve,reject)=>{
    const old=((window.google||{}).visualization||{}).Query?.setResponse;
    window.google=window.google||{}; window.google.visualization=window.google.visualization||{};
    window.google.visualization.Query=window.google.visualization.Query||{};
    window.google.visualization.Query.setResponse = (resp)=>{
      cleanup();
      try{
        if(resp && resp.table){
          const out=parseGvizTable(resp.table);
          if(out.header.length && out.rows.length){ resolve(out); return; }
        }
        reject(new Error('GViz empty'));
      }catch(e){ reject(e); }
    };
    const s=document.createElement('script');
    const url=base + (base.includes('?')?'&':'?') + 'tqx=out:json&tq=' + encodeURIComponent('select *') + '&_ts=' + Date.now();
    let to=setTimeout(()=>{ cleanup(); reject(new Error('GViz timeout')); },12000);
    function cleanup(){ clearTimeout(to); s.remove(); if(old) window.google.visualization.Query.setResponse=old; }
    s.onerror=()=>{ cleanup(); reject(new Error('GViz onerror')); };
    s.src=url; document.body.appendChild(s);
  });
}

/* ====== pubHTML fallback ====== */
function parsePubHtml(html){
  const doc=new DOMParser().parseFromString(html,'text/html');
  const table=doc.querySelector('table.waffle')||doc.querySelector('table');
  if(!table) return {header:[],rows:[]};
  const rows=Array.from(table.rows).map(tr=>Array.from(tr.cells).map(td=>S(td.textContent)));
  const clean=rows.filter(r=>r.some(c=>c!==''));
  return {header:clean[0]||[], rows:clean.slice(1)};
}

/* ====== Index & helpers ====== */
function indexByName(header){
  const map={}; header.forEach((h,i)=>map[S(h)]=i);
  const find=(names)=>{ for(const n of names){ if(n in map) return map[n]; } return null; };
  const findF=(re)=>{ for(let i=0;i<header.length;i++){ if(re.test(S(header[i]))) return i; } return null; };
  return {
    ym:   find(["年月"]) ?? findF(/年\s*月/),
    type: find(["クレーム種類","種類","種別"]) ?? findF(/(クレーム|種類|種別)/),
    cust: find(["顧客名","客先","Customer"])  ?? findF(/(顧客|客先|customer)/i),
    dept: find(["部署","部門","課"])          ?? findF(/(部署|部門|課)/),
    date: find(["日付","出荷日","受付日","発生日","Date"]) ?? findF(/(日付|出荷日|受付日|発生日|date)/i),
  };
}
function parseYMText(str){
  const s=S(str);
  let m=s.match(/^(\d{4})\D(\d{1,2})$/) || s.match(/^(\d{4})(\d{1,2})$/) || s.match(/^(\d{4})年?(\d{1,2})月?$/);
  if(!m) return null; const y=+m[1], mo=+m[2]; return (y && mo>=1 && mo<=12) ? {y, m:mo} : null;
}
function parseJPDate(str){
  const s=S(str); const m=s.match(/^(\d{4})\D(\d{1,2})\D(\d{1,2})/);
  if(m) return new Date(+m[1], +m[2]-1, +m[3]); const d=new Date(s); return isNaN(d)?null:d;
}

/* ====== State + render ====== */
let cached={header:[],rows:[],idx:null};
let charts={dept:null,type:null,cust:null};
const isDark=()=> document.documentElement.getAttribute('data-theme')==='dark';
const PALETTE_LIGHT=['#93c5fd','#a5b4fc','#fda4af','#fdba74','#86efac','#67e8f9','#f5d0fe','#c4b5fd','#fecaca','#fde68a','#bbf7d0','#bae6fd'];
const PALETTE_DARK=['#60a5fa','#818cf8','#fca5a5','#fbbf24','#4ade80','#22d3ee','#f0abfc','#a78bfa','#f87171','#fde047','#86efac','#93c5fd'];
const hexToRgba=(hex,a=0.8)=>{const h=hex.replace('#','');const b=parseInt(h,16);return`rgba(${(b>>16)&255},${(b>>8)&255},${b&255},${a})`};
function softPalette(n,a=0.8){ const base=isDark()?PALETTE_DARK:PALETTE_LIGHT; return Array.from({length:n},(_,i)=>hexToRgba(base[i%base.length],a)); }
function applyChartDefaults(){
  const st=getComputedStyle(document.documentElement);
  Chart.defaults.color=st.getPropertyValue('--ink').trim()||'#0f172a';
  Chart.defaults.borderColor=st.getPropertyValue('--grid').trim()||'#e5e7eb';
  Chart.defaults.font.family='system-ui,-apple-system,Segoe UI,Roboto,"Noto Sans JP","Yu Gothic",sans-serif';
}
function aggregate({rows,idx,topN,yearPick,monthPick,typePick,custPick}){
  const mDept=new Map(), mType=new Map(), mCust=new Map();
  for(const r of rows){
    let ym = idx.ym!=null ? parseYMText(r[idx.ym]) : null;
    if(!ym && idx.date!=null){ const d=parseJPDate(r[idx.date]); if(d) ym={y:d.getFullYear(), m:d.getMonth()+1}; }
    if(!ym) continue;
    if(String(ym.y)!==String(yearPick)) continue;
    if(monthPick!=='ALL' && ym.m!==parseInt(monthPick,10)) continue;
    const type=S(r[idx.type]??''); const cust=S(r[idx.cust]??'')||'不明'; const dept=S(r[idx.dept]??'')||'不明';
    if(typePick!=='ALL' && type!==typePick) continue; if(custPick && cust!==custPick) continue;
    mDept.set(dept,(mDept.get(dept)||0)+1); mType.set(type,(mType.get(type)||0)+1); mCust.set(cust,(mCust.get(cust)||0)+1);
  }
  const toTop=(mp,n)=>{const arr=[...mp.entries()].sort((a,b)=>b[1]-a[1]).slice(0,n);return{labels:arr.map(x=>x[0]),data:arr.map(x=>x[1])}};
  return {byDept:toTop(mDept,mDept.size||1),byType:toTop(mType,mType.size||1),byCust:toTop(mCust,topN)};
}
function render(){
  applyChartDefaults();
  const topN=+document.getElementById('selTop').value||10;
  const yearPick=document.getElementById('selYear').value;
  const monthPick=document.getElementById('selMonth').value;
  const typePick=document.getElementById('selType').value;
  const custPick=document.getElementById('selCust').value;
  const agg=aggregate({rows:cached.rows,idx:cached.idx,topN,yearPick,monthPick,typePick,custPick});
  const note=`${yearPick}年 ${monthPick==='ALL'?'全月':(parseInt(monthPick,10)+'月')}｜種類:${typePick==='ALL'?'全て':typePick}｜顧客:${custPick||'(指定なし)'}`;
  document.getElementById('chartNote').textContent=note;

  const orient=document.getElementById('selOrient').value==='h'?'y':'x';
  const draw=(id,title,labels,values)=>{
    const ctx=document.getElementById(id).getContext('2d'); const colors=softPalette(values.length,isDark()?0.7:0.8);
    const maxV=Math.max(1,...values);
    return new Chart(ctx,{type:'bar',
      data:{labels,datasets:[{label:'件数',data:values,backgroundColor:colors,borderColor:colors,borderWidth:1,maxBarThickness:28,categoryPercentage:.7,barPercentage:.9}]},
      options:{indexAxis:orient,maintainAspectRatio:false,plugins:{legend:{display:false},title:{display:true,text:title},datalabels:{anchor:'end',align:orient==='y'?'right':'top',formatter:v=>v}},
        scales:orient==='y'?{x:{beginAtZero:true,suggestedMax:maxV*1.15,ticks:{callback:intTick}},y:{grid:{display:false}}}
                           :{y:{beginAtZero:true,suggestedMax:maxV*1.15,ticks:{callback:intTick}},x:{grid:{display:false}}}}
    });
  };
  charts.dept && charts.dept.destroy(); charts.type && charts.type.destroy(); charts.cust && charts.cust.destroy();
  charts.dept=draw('chartDept','部署別（件数）',agg.byDept.labels,agg.byDept.data);
  charts.type=draw('chartType','種類別（件数）',agg.byType.labels,agg.byType.data);
  charts.cust=draw('chartCust',`顧客別 TOP${topN}（件数）`,agg.byCust.labels,agg.byCust.data);
}

/* ====== Load: GViz → pubHTML fallback ====== */
async function load(){
  hideErr(); stat('Loading…');
  try{
    // 1) GViz JSONP first
    for(const u of GVIZ_URLS){
      try{
        const out = await fetchGvizJSONP(u);
        const idx = indexByName(out.header);
        if([idx.ym,idx.type,idx.cust,idx.dept].every(v=>v==null)) throw new Error('Header NG');
        cached={header:out.header,rows:out.rows,idx};
        // build filters
        const yearSet=new Set(), typeSet=new Set(), custTotals=new Map();
        for(const r of out.rows){
          let ym = idx.ym!=null ? parseYMText(r[idx.ym]) : null;
          if(!ym && idx.date!=null){ const d=parseJPDate(r[idx.date]); if(d) ym={y:d.getFullYear(), m:d.getMonth()+1}; }
          if(ym) yearSet.add(String(ym.y));
          const t=S(r[idx.type]??''); if(t) typeSet.add(t);
          const c=S(r[idx.cust]??'')||'不明'; custTotals.set(c,(custTotals.get(c)||0)+1);
        }
        const years=[...yearSet].sort(); const types=[...typeSet].sort();
        const customers=[...custTotals.entries()].sort((a,b)=>b[1]-a[1]).map(([c])=>c);
        const ySel=document.getElementById('selYear'); ySel.innerHTML=years.map(y=>`<option value="${y}">${y}</option>`).join(''); ySel.value=years.at(-1)||new Date().getFullYear();
        document.getElementById('selType').innerHTML=`<option value="ALL">All</option>`+types.map(t=>`<option value="${t}">${t}</option>`).join('');
        document.getElementById('selCust').innerHTML=`<option value="">(指定なし)</option>`+customers.map(c=>`<option value="${c}">${c}</option>`).join('');
        stat(`Data: OK (mode: gviz, rows: ${out.rows.length}, cols: ${out.header.length})`);
        render(); return;
      }catch(e){ /* try next */ }
    }
    // 2) pubHTML fallback
    for(const u of PUBHTML_URLS){
      try{
        const res=await fetch(u+'&_ts='+Date.now(),{cache:'no-store'}); if(!res.ok) continue;
        const html=await res.text(); const out=parsePubHtml(html);
        const idx=indexByName(out.header);
        if(!(out.header.length && out.rows.length) || [idx.ym,idx.type,idx.cust,idx.dept].every(v=>v==null)) continue;
        cached={header:out.header,rows:out.rows,idx};
        // build filters (same as above)
        const yearSet=new Set(), typeSet=new Set(), custTotals=new Map();
        for(const r of out.rows){
          let ym = idx.ym!=null ? parseYMText(r[idx.ym]) : null;
          if(!ym && idx.date!=null){ const d=parseJPDate(r[idx.date]); if(d) ym={y:d.getFullYear(), m:d.getMonth()+1}; }
          if(ym) yearSet.add(String(ym.y));
          const t=S(r[idx.type]??''); if(t) typeSet.add(t);
          const c=S(r[idx.cust]??'')||'不明'; custTotals.set(c,(custTotals.get(c)||0)+1);
        }
        const years=[...yearSet].sort(); const types=[...typeSet].sort();
        const customers=[...custTotals.entries()].sort((a,b)=>b[1]-a[1]).map(([c])=>c);
        const ySel=document.getElementById('selYear'); ySel.innerHTML=years.map(y=>`<option value="${y}">${y}</option>`).join(''); ySel.value=years.at(-1)||new Date().getFullYear();
        document.getElementById('selType').innerHTML=`<option value="ALL">All</option>`+types.map(t=>`<option value="${t}">${t}</option>`).join('');
        document.getElementById('selCust').innerHTML=`<option value="">(指定なし)</option>`+customers.map(c=>`<option value="${c}">${c}</option>`).join('');
        stat(`Data: OK (mode: html, rows: ${out.rows.length}, cols: ${out.header.length})`);
        render(); return;
      }catch(e){ /* try next */ }
    }
    throw new Error('No data from GViz/pubHTML');
  }catch(e){
    console.error(e); showErr('読み込みに失敗しました（GViz/pubHTMLの両方でデータが取れません）。'); stat('No data');
  }
}

/* ====== UI ====== */
document.getElementById('btnRefresh').addEventListener('click', load);
['selTop','selYear','selMonth','selType','selCust','selOrient'].forEach(id=>document.getElementById(id).addEventListener('change', render));
document.getElementById('chkDark').addEventListener('change',e=>{
  document.documentElement.setAttribute('data-theme', e.target.checked?'dark':'light'); render();
});
window.addEventListener('DOMContentLoaded', load);
</script>
</body>
</html>
