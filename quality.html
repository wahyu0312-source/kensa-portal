<!doctype html>
<html lang="ja">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>品質情報（リアルタイム・ダッシュボード）</title>
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.4/dist/chart.umd.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-datalabels@2.2.0"></script>
  <script src="https://cdn.jsdelivr.net/npm/papaparse@5.4.1/papaparse.min.js"></script>
  <style>
    :root{
      --bg:#f6f8fc; --card:#fff; --ink:#0f172a; --muted:#64748b; --border:#e5e7eb; --accent:#2563eb;
      --radius:16px; --shadow:0 18px 32px rgba(15,23,42,.08);
    }
    *{box-sizing:border-box}
    html,body{margin:0;height:100%;background:var(--bg);color:var(--ink);font-family:system-ui,-apple-system,Segoe UI,Roboto,"Noto Sans JP","Yu Gothic",sans-serif}
    header{position:sticky;top:0;background:#ffffffcc;backdrop-filter:blur(8px);border-bottom:1px solid var(--border);z-index:10}
    .container{max-width:1200px;margin:0 auto;padding:14px 18px}
    .row{display:flex;align-items:end;justify-content:space-between;gap:16px;flex-wrap:wrap}
    h1{margin:0;font-size:clamp(18px,4vw,26px)}
    .sub{font-size:12px;color:var(--muted)}
    .right{display:flex;gap:10px;align-items:center}
    .btn{display:inline-flex;align-items:center;gap:6px;padding:8px 12px;border:1px solid var(--border);border-radius:999px;background:#fff;color:var(--ink);text-decoration:none;box-shadow:var(--shadow);font-size:13px}
    .btn:hover{border-color:var(--accent)}
    main{padding:18px}
    .controls{max-width:1200px;margin:0 auto 14px;padding:12px;background:#fff;border:1px solid var(--border);border-radius:var(--radius);box-shadow:var(--shadow);display:flex;flex-wrap:wrap;gap:10px}
    .controls label{font-size:12px;color:var(--muted)}
    .controls .g{display:flex;flex-direction:column;gap:6px}
    .controls select,.controls input{padding:8px 10px;border:1px solid var(--border);border-radius:10px;background:#fff;min-width:120px}
    .grid{max-width:1200px;margin:0 auto;display:grid;grid-template-columns:1fr;gap:14px}
    @media(min-width:960px){.grid{grid-template-columns:1fr 1fr}}
    .card{background:var(--card);border:1px solid var(--border);border-radius:var(--radius);box-shadow:var(--shadow)}
    .card h2{margin:0;padding:10px 14px;border-bottom:1px solid var(--border);font-size:14px}
    .card .body{padding:10px 12px}
    .chart{height:280px}
    footer{max-width:1200px;margin:16px auto;padding:0 18px;color:var(--muted);font-size:12px}
    .warn{max-width:1200px;margin:12px auto 0;padding:12px 16px;border:1px solid #f0ad4e;background:#fffbe6;border-radius:12px;color:#6b4f00;font-size:13px}
  </style>
</head>
<body>
  <header>
    <div class="container">
      <div class="row">
        <div>
          <h1>品質情報（リアルタイム）</h1>
          <div class="sub" id="subtitle">読み込み中…</div>
        </div>
        <div class="right">
          <a class="btn" id="openSrc" href="#" target="_blank" rel="noopener">データを開く</a>
          <a class="btn" href="https://wahyu0312-source.github.io/kensa-portal/">Home</a>
        </div>
      </div>
    </div>
  </header>

  <section class="controls">
    <div class="g">
      <label>Top 件数</label>
      <select id="topN">
        <option>5</option><option selected>10</option><option>15</option><option>20</option>
      </select>
    </div>
    <div class="g">
      <label>Year</label>
      <select id="yearSel"><option value="all">All</option></select>
    </div>
    <div class="g">
      <label>Quarter</label>
      <select id="qSel">
        <option value="all">All</option>
        <option value="Q1">Q1 (1-3)</option>
        <option value="Q2">Q2 (4-6)</option>
        <option value="Q3">Q3 (7-9)</option>
        <option value="Q4">Q4 (10-12)</option>
      </select>
    </div>
    <div class="g">
      <label>クレーム種類（絞り込み）</label>
      <select id="typeSel"><option value="all">All</option></select>
    </div>
    <div class="g">
      <label>顧客名（絞り込み）</label>
      <input id="custFilter" placeholder="部分一致…" />
    </div>
    <div class="g">
      <label>部署（絞り込み）</label>
      <input id="deptFilter" placeholder="部分一致…" />
    </div>
    <div class="g" style="align-self:flex-end">
      <button id="refreshBtn" class="btn" type="button">Refresh now</button>
    </div>
  </section>

  <main>
    <div class="grid">
      <section class="card">
        <h2>月別推移（件数）</h2>
        <div class="body"><canvas id="cMonthly" class="chart"></canvas></div>
      </section>
      <section class="card">
        <h2>クレーム種類（件数）</h2>
        <div class="body"><canvas id="cType" class="chart"></canvas></div>
      </section>
      <section class="card">
        <h2>顧客名（TOP）</h2>
        <div class="body"><canvas id="cCust" class="chart"></canvas></div>
      </section>
      <section class="card">
        <h2>部署（TOP）</h2>
        <div class="body"><canvas id="cDept" class="chart"></canvas></div>
      </section>
    </div>
  </main>

  <footer>
    <div id="footInfo"></div>
    <div>design by wahyu</div>
  </footer>

<script>
(() => {
  // ====== Config ======
  const SRC = 'https://docs.google.com/spreadsheets/d/e/2PACX-1vTTyGRhapP1p6YUqQiGWwmHRYZjl-kxfuYeROLQNcOk0ZZFZeaGgQRZF1PNkiLe0mGXCX5pHnRUJsG6/pub?gid=649800458&single=true&output=csv';
  const COLS = { ym: '年月', date: '受付日', type: 'クレーム種類', customer: '顧客名', dept: '部署' };

  // ====== State ======
  let DATA = [];      // tidy rows: {y,m,ym,type,cust,dept}
  let CHARTS = {};    // refs

  // ====== Helpers ======
  const el = s => document.querySelector(s);
  const fmtYMD = d => `${d.getFullYear()}/${String(d.getMonth()+1).padStart(2,'0')}/${String(d.getDate()).padStart(2,'0')}`;
  function parseYMText(v){
    if(v==null) return null;
    const s = (''+v).trim();
    // 2025/06 , 2025-6 , 2025年6月 , 202506
    let m = s.match(/(\\d{4})\\D+?(\\d{1,2})/);
    if(!m) m=s.match(/(\\d{4})(\\d{2})/);
    if(!m) return null;
    const y=+m[1], mo=+m[2];
    if(!y || !mo || mo<1 || mo>12) return null;
    return {y, m:mo};
  }
  function parseDate(v){
    const s=(''+v).trim().replace(/[年月]/g,'/').replace(/[日.]/g,'');
    const d=new Date(s);
    return isNaN(d)? null : d;
  }
  function monthToQuarter(m){ return m<=3?'Q1': m<=6?'Q2': m<=9?'Q3':'Q4'; }
  function uniq(arr){ return [...new Set(arr)]; }

  function destroyCharts(){
    Object.values(CHARTS).forEach(c=>{ try{ c.destroy(); }catch{} });
    CHARTS={};
  }

  if (window.ChartDataLabels) Chart.register(window.ChartDataLabels);

  function makeLine(ctx, labels, values){
    return new Chart(ctx, {
      type:'line',
      data:{ labels, datasets:[{ data: values, fill:true, tension:.25 }]},
      options:{ responsive:true, maintainAspectRatio:false,
        plugins:{ legend:{display:false}, datalabels:{display:false} },
        scales:{ x:{ grid:{display:false} }, y:{ beginAtZero:true, grid:{color:'#eee'} } }
      }
    });
  }
  function makeBar(ctx, labels, values, horizontal=false){
    return new Chart(ctx, {
      type:'bar',
      data:{ labels, datasets:[{ data: values, borderWidth:1 }]},
      options:{ responsive:true, maintainAspectRatio:false, indexAxis: horizontal?'y':'x',
        plugins:{ legend:{display:false}, datalabels:{ anchor:'end', align:'end', formatter:v=> v, rotation: horizontal?0:-90, font:{size:10} } },
        scales:{ x:{ grid:{display:false}, ticks:{font:{size:10}} }, y:{ beginAtZero:true, grid:{color:'#eee'}, ticks:{font:{size:10}} } }
      }
    });
  }

  // ====== Load ======
  async function loadCSV(){
    return await new Promise((resolve, reject)=>{
      Papa.parse(SRC + '&t=' + Date.now(), {
        download:true, header:true, skipEmptyLines:true,
        complete: (r)=> resolve(r.data),
        error: reject
      });
    });
  }

  function detectColumns(sampleRow){
    const headers = Object.keys(sampleRow || {});
    const find = (name, alts=[]) => {
      if(headers.includes(name)) return name;
      const candidates = [name, ...alts];
      for(const h of headers){
        if(candidates.some(k => h.includes(k))) return h;
      }
      return null;
    };
    const hYM = find(COLS.ym, ['年月']);
    const hDate = find(COLS.date, ['日','DATE','Date']);
    const hType = find(COLS.type, ['種類','種別']);
    const hCust = find(COLS.customer, ['顧客','客先','Customer']);
    const hDept = find(COLS.dept, ['部署','部門','課']);
    return { hYM, hDate, hType, hCust, hDept, headers };
  }

  function tidyRows(rows){
    const det = detectColumns(rows[0]||{});
    const out = [];
    for(const r of rows){
      let y=null,m=null;
      if(det.hYM && r[det.hYM]){
        const p = parseYMText(r[det.hYM]);
        if(p){ y=p.y; m=p.m; }
      }
      if((!y || !m) && det.hDate && r[det.hDate]){
        const d = parseDate(r[det.hDate]);
        if(d){ y=d.getFullYear(); m=d.getMonth()+1; }
      }
      if(!y || !m) continue; // skip rows without year-month
      out.push({
        y, m, ym: `${y}/${String(m).padStart(2,'0')}`,
        type: (r[det.hType]||'').toString().trim(),
        cust: (r[det.hCust]||'').toString().trim(),
        dept: (r[det.hDept]||'').toString().trim()
      });
    }
    el('#footInfo').textContent = `列検出: 年月=${det.hYM||'(なし→受付日から算出)'} / 日付=${det.hDate||'(なし)'} / 種類=${det.hType||'(なし)'} / 顧客=${det.hCust||'(なし)'} / 部署=${det.hDept||'(なし)'}`;
    return out;
  }

  function filterRows(rows){
    const yearSel = el('#yearSel').value;
    const qSel = el('#qSel').value;
    const tSel = el('#typeSel').value;
    const custKey = el('#custFilter').value.trim();
    const deptKey = el('#deptFilter').value.trim();
    return rows.filter(r => {
      if(yearSel!=='all' && r.y!==+yearSel) return false;
      if(qSel!=='all' && monthToQuarter(r.m)!==qSel) return false;
      if(tSel!=='all' && r.type!==tSel) return false;
      if(custKey && !r.cust.includes(custKey)) return false;
      if(deptKey && !r.dept.includes(deptKey)) return false;
      return true;
    });
  }

  function aggregateAndDraw(){
    const rows = filterRows(DATA);
    // Monthly
    const ymKeys = uniq(rows.map(r=> r.ym)).sort((a,b)=>{
      const [ya,ma]=a.split('/').map(Number); const [yb,mb]=b.split('/').map(Number);
      return ya!==yb? ya-yb : ma-mb;
    });
    const ymCount = new Map(); rows.forEach(r => ymCount.set(r.ym, (ymCount.get(r.ym)||0)+1));
    const monthlyVals = ymKeys.map(k => ymCount.get(k)||0);
    destroyCharts();
    if(ymKeys.length){
      CHARTS.monthly = makeLine(el('#cMonthly'), ymKeys, monthlyVals);
    }

    const topN = +el('#topN').value;
    // Type
    const typeCount = new Map(); rows.forEach(r => { if(r.type) typeCount.set(r.type,(typeCount.get(r.type)||0)+1); });
    if(typeCount.size){
      const entries = [...typeCount.entries()].sort((a,b)=> b[1]-a[1]);
      CHARTS.type = makeBar(el('#cType'), entries.map(e=>e[0]).slice(0,topN), entries.map(e=>e[1]).slice(0,topN), false);
    }
    // Customer
    const custCount = new Map(); rows.forEach(r => { if(r.cust) custCount.set(r.cust,(custCount.get(r.cust)||0)+1); });
    if(custCount.size){
      const entries = [...custCount.entries()].sort((a,b)=> b[1]-a[1]).slice(0,topN);
      CHARTS.cust = makeBar(el('#cCust'), entries.map(e=>e[0]), entries.map(e=>e[1]), true);
    }
    // Dept
    const deptCount = new Map(); rows.forEach(r => { if(r.dept) deptCount.set(r.dept,(deptCount.get(r.dept)||0)+1); });
    if(deptCount.size){
      const entries = [...deptCount.entries()].sort((a,b)=> b[1]-a[1]).slice(0,topN);
      CHARTS.dept = makeBar(el('#cDept'), entries.map(e=>e[0]), entries.map(e=>e[1]), true);
    }
  }

  async function main(){
    try{
      el('#openSrc').href = SRC;
      el('#subtitle').textContent = `データ元: Googleスプレッドシート（gid=${new URL(SRC).searchParams.get('gid')}） / 読込: ${fmtYMD(new Date())}`;
      const rows = await loadCSV(); // header:true
      if(!rows || !rows.length){
        const w=document.createElement('div'); w.className='warn'; w.textContent='CSVにデータがありません。'; document.body.insertBefore(w, document.body.children[1]); return;
      }
      DATA = tidyRows(rows);
      // Fill controls
      const years = uniq(DATA.map(r=> r.y)).sort((a,b)=> a-b);
      const yearSel = el('#yearSel'); years.forEach(y=>{ const o=document.createElement('option'); o.value=String(y); o.textContent=String(y); yearSel.appendChild(o); });
      const types = uniq(DATA.map(r=> r.type)).filter(Boolean).sort(); const typeSel = el('#typeSel'); types.forEach(t=>{ const o=document.createElement('option'); o.value=t; o.textContent=t; typeSel.appendChild(o); });
      // Events
      ['change','keyup'].forEach(ev=>{
        el('#yearSel').addEventListener(ev, aggregateAndDraw);
        el('#qSel').addEventListener(ev, aggregateAndDraw);
        el('#typeSel').addEventListener(ev, aggregateAndDraw);
        el('#custFilter').addEventListener(ev, aggregateAndDraw);
        el('#deptFilter').addEventListener(ev, aggregateAndDraw);
        el('#topN').addEventListener(ev, aggregateAndDraw);
      });
      el('#refreshBtn').onclick = async ()=>{ const rows = await loadCSV(); DATA = tidyRows(rows); aggregateAndDraw(); };
      // First render
      aggregateAndDraw();
    }catch(err){
      console.error(err);
      const w=document.createElement('div'); w.className='warn'; w.textContent='CSVの取得に失敗しました。公開設定やURLをご確認ください。'; document.body.insertBefore(w, document.body.children[1]);
    }
  }

  window.addEventListener('load', main);
})();
</script>

</body>
</html>
