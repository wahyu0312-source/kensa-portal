<!doctype html>
<html lang="ja">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>Admin Serial (GAS) ‚Äî Prefix Manager</title>
<style>
  :root{
    --ink:#0f172a; --muted:#64748b; --b:#e5e7eb; --accent:#2563eb; --ok:#10b981; --warn:#f59e0b; --bad:#b91c1c;
    --card:#fff; --shadow:0 20px 40px rgba(2,6,23,.08); --radius:14px;
  }
  *{box-sizing:border-box}
  body{margin:0;font-family:system-ui,-apple-system,Segoe UI,Roboto,"Noto Sans JP","Yu Gothic",sans-serif;color:var(--ink);background:#f6f7fb}
  header{position:sticky;top:0;z-index:10;background:#ffffffcc;backdrop-filter:blur(8px);border-bottom:1px solid var(--b)}
  .wrap{max-width:1100px;margin:0 auto;padding:12px 16px;display:flex;gap:12px;align-items:center;justify-content:space-between}
  .title{display:flex;gap:10px;align-items:center}
  .title b{font-size:18px}
  .toolbar{display:flex;gap:8px;flex-wrap:wrap}
  .btn{padding:8px 12px;border:1px solid var(--b);border-radius:10px;background:#fff;cursor:pointer;display:inline-flex;gap:8px;align-items:center}
  .btn:disabled{opacity:.6;cursor:wait}
  main{max-width:1100px;margin:22px auto;padding:0 16px}
  .card{background:var(--card);border:1px solid var(--b);border-radius:var(--radius);box-shadow:var(--shadow);padding:14px}
  .hint{color:var(--muted);font-size:12px;margin-top:8px}
  .list{display:flex;flex-direction:column;gap:10px;margin-top:10px}
  .row{display:grid;grid-template-columns: 260px 1fr 110px 110px auto;gap:8px;align-items:center;border:1px solid var(--b);border-radius:12px;padding:8px;background:#fff}
  .row .prefix{font-family:ui-monospace,Menlo,Consolas,monospace;background:#f8fafc;padding:8px;border-radius:10px;border:1px solid var(--b)}
  .row input[type="text"], .row input[type="number"]{width:100%;padding:8px;border-radius:10px;border:1px solid var(--b)}
  .row .btns{display:flex;gap:6px;justify-content:flex-end;flex-wrap:wrap}
  .pill{padding:2px 8px;border-radius:999px;border:1px solid var(--b);color:var(--muted);font-size:12px}
  .ok{background:#ecfdf5;border-color:#bbf7d0;color:#065f46}
  .bad{background:#fef2f2;border-color:#fecaca;color:#7f1d1d}
  .warn{background:#fffbeb;border-color:#fde68a;color:#92400e}
  .ghost{opacity:.85}
  .menubar{ position:relative }
  .menu-btn{ padding:8px 12px; border:1px solid var(--b); border-radius:10px; background:#fff; cursor:pointer }
  .menu{
    position:absolute; top:110%; right:0; min-width:220px; background:#fff;
    border:1px solid var(--b); border-radius:12px; box-shadow:var(--shadow);
    padding:6px; display:none; z-index:100;
  }
  .menu.open{ display:block }
  .menu .sec{ padding:6px 10px 4px; font-size:12px; color:var(--muted) }
  .menu a, .menu button{
    display:flex; align-items:center; gap:8px; width:100%;
    padding:9px 10px; border:0; background:transparent; border-radius:8px; text-align:left; color:var(--ink);
  }
  .menu a{text-decoration:none}
  .menu a:hover, .menu button:hover{ background:#f1f5f9 }
  .sep{ height:1px; background:var(--b); margin:6px }
  @media (max-width: 900px){ .row{grid-template-columns: 1fr 1fr 110px 110px auto} .row .prefix{font-size:12px}}
</style>
</head>
<body>
<header>
  <div class="wrap">
    <div class="title">
      <img src="./tsh.png" alt="TSH" style="height:28px">
      <b>Admin Serial (GAS)</b>
      <span id="ping" class="pill ghost">checking‚Ä¶</span>
    </div>
    <div class="toolbar">
      <button id="btnAdd" class="btn">Ôºã Tambah Prefix</button>
      <button id="btnRefresh" class="btn">Refresh Semua</button>
      <button id="btnExport" class="btn">Export</button>
      <button id="btnImport" class="btn">Import</button>

      <!-- dropdown ÁÆ°ÁêÜ kecil -->
      <div class="menubar">
        <button id="menuBtn" class="menu-btn" type="button">ÁÆ°ÁêÜ ‚ñæ</button>
        <div id="menu" class="menu" role="menu" aria-hidden="true">
          <div class="sec">„Éä„Éì</div>
          <a href="./" role="menuitem">üè† „Éà„ÉÉ„Éó</a>
          <a href="./forms.html" role="menuitem">üìÑ Âá∫Ëç∑Ê§úÊüªÊàêÁ∏æÊõ∏</a>
          <a href="./quality.html" role="menuitem">üìä ÂìÅË≥™ÊÉÖÂ†±</a>
        </div>
      </div>
    </div>
  </div>
</header>

<main>
  <section class="card">
    <div style="display:flex;justify-content:space-between;align-items:center;gap:12px">
      <h2 style="margin:4px 0">Prefix list</h2>
      <span id="count" class="pill"></span>
    </div>
    <div id="list" class="list"></div>
    <div class="hint">
      Catatan: daftar prefix ini disimpan lokal (localStorage). Operasi <b>Info / SetÊ°Å / SetÊ¨° / Issue</b> mengakses GAS:
      <code id="gasUrlShow"></code>.
    </div>
  </section>
</main>

<input id="fileImport" type="file" accept="application/json" style="display:none">

<script>
/* ================== KONFIG ================== */
// URL GAS (sudah diisi sesuai permintaan)
const GAS_URL = 'https://script.google.com/macros/s/AKfycbxWxAa_dWQNoUPhWnkw3P22jgeW4vb44Z5ISuUyUWsAAroFzzE6iIVWMIpqqio6E5OgqA/exec';

// key penyimpanan local
const STORE = 'ADMIN_PREFIX_LIST_V2';

/* ================ UTIL & API ================ */
const S = v => String(v ?? '').trim();

async function api(payload){
  const r = await fetch(GAS_URL, {
    method:'POST',
    headers:{ 'Content-Type':'text/plain;charset=utf-8' }, // simple request (tanpa preflight)
    body: JSON.stringify(payload),
    redirect:'follow'
  });
  if(!r.ok){
    const t = await r.text().catch(()=> '');
    throw new Error(`HTTP ${r.status} ${r.statusText} :: ${t.slice(0,200)}`);
  }
  const text = await r.text();
  try{ return JSON.parse(text); }
  catch{ throw new Error('Bad JSON: '+text.slice(0,200)); }
}

function loadStore(){
  try{
    const arr = JSON.parse(localStorage.getItem(STORE)||'[]');
    if(Array.isArray(arr)) return arr;
  }catch(e){}
  return [];
}
function saveStore(arr){ localStorage.setItem(STORE, JSON.stringify(arr)); }
function toast(msg){ try{ console.log(msg); }catch(e){} alert(msg); }

/* ================ RENDER LIST ================ */
function render(){
  const list = document.getElementById('list');
  const data = loadStore();
  document.getElementById('count').textContent = `${data.length} prefix`;
  list.innerHTML = '';

  if(!data.length){
    list.innerHTML = '<div class="row" style="justify-content:center;color:#64748b">Belum ada data. Klik ‚ÄúÔºã Tambah Prefix‚Äù.</div>';
    return;
  }

  data.forEach((it, idx)=>{
    const row = document.createElement('div');
    row.className = 'row';
    row.innerHTML = `
      <div class="prefix" title="APP_NS::SERIAL_PREFIX">${escapeHtml(it.prefix)}</div>
      <input type="text" class="inpLabel" placeholder="Label / catatan" value="${escapeAttr(it.label||'')}">
      <input type="number" class="inpNext" placeholder="Set Ê¨°Áï™Âè∑" min="1" step="1" value="${escapeAttr(it.next||'')}">
      <input type="number" class="inpDigits" placeholder="Ê°ÅÊï∞" min="1" max="12" step="1" value="${escapeAttr(it.digits||'')}">
      <div class="btns">
        <button class="btn btnInfo">Info</button>
        <button class="btn btnDigits">SetÊ°Å</button>
        <button class="btn btnNext">SetÊ¨°</button>
        <button class="btn btnIssue" style="border-color:#fecaca;background:#fff5f5">Issue</button>
        <button class="btn btnDel">Hapus</button>
      </div>
    `;
    list.appendChild(row);

    const inpLabel  = row.querySelector('.inpLabel');
    const inpNext   = row.querySelector('.inpNext');
    const inpDigits = row.querySelector('.inpDigits');

    // simpan inline perubahan label/kolom input
    inpLabel.addEventListener('change', ()=>{ data[idx].label = S(inpLabel.value); saveStore(data); });
    inpNext.addEventListener('change',  ()=>{ data[idx].next  = S(inpNext.value);  saveStore(data); });
    inpDigits.addEventListener('change',()=>{ data[idx].digits= S(inpDigits.value);saveStore(data); });

    // tombol Info
    row.querySelector('.btnInfo').addEventListener('click', async ()=>{
      try{
        const res = await api({ action:'getInfo', prefix: it.prefix });
        alert(`Prefix: ${it.prefix}\nLast: ${res.last}\nNext: ${res.next}\nDigits: ${res.digits ?? '(belum disetel)'}`);
        if(res.digits && !inpDigits.value){ inpDigits.value = res.digits; data[idx].digits = res.digits; saveStore(data); }
      }catch(e){ toast('Gagal getInfo: '+e.message); }
    });

    // tombol SetÊ°Å
    row.querySelector('.btnDigits').addEventListener('click', async ()=>{
      const d = parseInt(inpDigits.value,10);
      if(!(d>=1 && d<=12)){ toast('MasukkanÊ°ÅÊï∞ 1..12'); return; }
      try{
        const res = await api({ action:'setDigits', prefix: it.prefix, digits: d });
        if(res && (res.ok || res.digits || res.result)){ toast('SetÊ°Å OK'); } else { toast('SetÊ°Å selesai'); }
      }catch(e){ toast('Gagal setDigits: '+e.message); }
    });

    // tombol SetÊ¨°
    row.querySelector('.btnNext').addEventListener('click', async ()=>{
      const n = parseInt(inpNext.value,10);
      if(!(n>=1)){ toast('Masukkan Ê¨°Áï™Âè∑ minimal 1'); return; }
      try{
        const res = await api({ action:'setNext', prefix: it.prefix, next: n });
        if(res && res.ok){ toast('SetÊ¨° OK'); } else { toast('SetÊ¨° selesai'); }
      }catch(e){ toast('Gagal setNext: '+e.message); }
    });

    // tombol Issue (ambil nomor berikutnya dari server)
    row.querySelector('.btnIssue').addEventListener('click', async ()=>{
      try{
        const res = await api({ action:'nextSuffix', prefix: it.prefix });
        alert(`Issued: ${String(res.suffix).padStart(parseInt(inpDigits.value||'0',10)||0,'0')}`);
      }catch(e){ toast('Gagal issue: '+e.message); }
    });

    // tombol Hapus
    row.querySelector('.btnDel').addEventListener('click', ()=>{
      if(confirm(`Hapus prefix ini?\n${it.prefix}`)){
        data.splice(idx,1); saveStore(data); render();
      }
    });
  });
}

function escapeHtml(s){ return String(s).replace(/[&<>"']/g, c=>({ '&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;' }[c])); }
function escapeAttr(s){ return escapeHtml(s).replace(/"/g,'&quot;'); }

/* ================ AKSI TOOLBAR ================ */
document.getElementById('btnAdd').addEventListener('click', ()=>{
  const full = prompt('Masukkan FULL prefix (format: APP_NS::SERIAL_PREFIX)\ncontoh: okuma46::2825-');
  if(!full) return;
  const label = prompt('Label/Note (opsional):','');
  const data = loadStore();
  if(data.some(x=>x.prefix===full)){ toast('Prefix sudah ada di daftar'); return; }
  data.push({ prefix: full, label: S(label) });
  saveStore(data); render();
});

document.getElementById('btnRefresh').addEventListener('click', async ()=>{
  const data = loadStore(); if(!data.length) return;
  try{
    // ambil info semua prefix (serial)
    for(const it of data){
      try{
        const res = await api({ action:'getInfo', prefix: it.prefix });
        // hanya tampilkan; field akan terisi bila kosong
        console.log(it.prefix, res);
      }catch(e){ console.warn('getInfo error', it.prefix, e); }
    }
    toast('Refresh selesai (lihat console untuk detail).');
  }catch(e){ toast('Gagal refresh: '+e.message); }
});

document.getElementById('btnExport').addEventListener('click', ()=>{
  const blob = new Blob([JSON.stringify(loadStore(),null,2)], {type:'application/json'});
  const url = URL.createObjectURL(blob);
  const a = Object.assign(document.createElement('a'), { href:url, download:'admin-prefix-backup.json' });
  document.body.appendChild(a); a.click(); a.remove(); URL.revokeObjectURL(url);
});

document.getElementById('btnImport').addEventListener('click', ()=>{
  document.getElementById('fileImport').click();
});
document.getElementById('fileImport').addEventListener('change', async (ev)=>{
  const f = ev.target.files[0]; if(!f) return;
  try{
    const text = await f.text();
    const arr = JSON.parse(text);
    if(!Array.isArray(arr)) throw new Error('Format tidak valid');
    saveStore(arr); render(); toast('Import OK');
  }catch(e){ toast('Gagal import: '+e.message); }
  ev.target.value='';
});

/* ================ MENU kecil ================ */
const _menuBtn = document.getElementById('menuBtn');
const _menu    = document.getElementById('menu');
function closeMenu(){ _menu?.classList.remove('open'); _menu?.setAttribute('aria-hidden','true'); }
_menuBtn?.addEventListener('click', (e)=>{ e.stopPropagation(); _menu.classList.toggle('open'); _menu.setAttribute('aria-hidden', _menu.classList.contains('open')?'false':'true'); });
document.addEventListener('click', closeMenu);
document.addEventListener('keydown', (e)=>{ if(e.key==='Escape') closeMenu(); });

/* ================ BOOT ================= */
async function pingServer(){
  document.getElementById('gasUrlShow').textContent = GAS_URL;
  try{
    // ping via GET hanya untuk tampilkan status (doGet di GAS akan membalas ok:true)
    const r = await fetch(GAS_URL, { method:'GET', redirect:'follow' });
    const txt = await r.text();
    const ok = /"ok"\s*:\s*true/.test(txt);
    const pill = document.getElementById('ping');
    pill.textContent = ok ? 'backend: OK' : 'backend: ?';
    pill.className = 'pill ' + (ok ? 'ok' : 'warn');
  }catch(e){
    const pill = document.getElementById('ping');
    pill.textContent = 'backend: NG';
    pill.className = 'pill bad';
  }
}

window.addEventListener('DOMContentLoaded', ()=>{ render(); pingServer(); });
</script>
</body>
</html>
