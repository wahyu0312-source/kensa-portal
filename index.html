<!doctype html>
<html lang="ja">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>å“è³ªç®¡ç†ç”Ÿç”£æŠ€è¡“ã‚·ã‚¹ãƒ†ãƒ </title>
<style>
:root{
  --bg:#f6f7fb; --panel:#fff; --ink:#0f172a; --muted:#64748b; --border:#e5e7eb; --ring:#c7d2fe;
  --blue:#2563eb; --green:#10b981; --orange:#f59e0b; --purple:#8b5cf6; --sky:#0ea5e9; --danger:#dc2626;
  --radius:14px; --radius-xl:22px; --shadow:0 12px 30px rgba(15,23,42,.08);
}
*{box-sizing:border-box}
body{margin:0; background:var(--bg); color:var(--ink); font-family:system-ui,-apple-system,Segoe UI,Roboto,"Noto Sans JP","Yu Gothic",sans-serif}
a{color:inherit; text-decoration:none}
.container{max-width:1400px; margin:0 auto; padding:16px}

/* Header */
.header{
  display:flex; align-items:center; justify-content:space-between;
  padding:12px 16px; background:#fff; border-bottom:1px solid var(--border); position:sticky; top:0; z-index:50
}
.brand{display:flex; align-items:center; gap:10px}
.brand img{width:auto; height:32px; object-fit:contain}
.actions{display:flex; gap:8px; align-items:center}
.btn{height:34px; padding:0 12px; border:1px solid var(--border); border-radius:10px; background:#fff; cursor:pointer}
.badge{height:28px; padding:0 10px; display:inline-flex; align-items:center; gap:8px; font-weight:700; background:#f1f5f9; border:1px solid var(--border); border-radius:999px}

/* Urgent banner */
.urgent{
  margin:16px auto; max-width:1400px;
  background:#fee2e2; color:#991b1b; font-weight:800; border:1px solid #fecaca;
  border-radius:12px; padding:12px 16px; display:none; justify-content:center; align-items:center; gap:10px;
  animation:pulse 1.6s ease-in-out infinite;
}
@keyframes pulse{0%,100%{opacity:1}50%{opacity:.75}}

/* Panel & table */
.panel{background:#fff; border:1px solid var(--border); border-radius:var(--radius-xl); box-shadow:var(--shadow); padding:14px}
.panel + .panel{margin-top:14px}
.panel h2{margin:0 0 12px}

.table{width:100%; border-collapse:separate; border-spacing:0; min-width:900px}
.table th{position:sticky; top:66px; background:#f8fafc; font-weight:800; text-align:left; padding:12px 10px; z-index:1; border-bottom:1px solid var(--border)}
.table td{padding:12px 10px; border-bottom:1px solid var(--border); vertical-align:middle}

/* Left status card */
.statusCard{
  width:280px; background:#f8fafc; border:1px solid var(--border); border-radius:16px; padding:12px;
}
.statusPill{display:inline-flex; align-items:center; gap:6px; padding:6px 10px; border-radius:999px; color:#fff; font-weight:800; margin-right:10px}
.tag-blue{background:var(--blue)} .tag-green{background:var(--green)} .tag-orange{background:var(--orange)}
.tag-purple{background:var(--purple)} .tag-sky{background:var(--sky)} .tag-danger{background:var(--danger)}
.small{font-size:12px; color:#334155}

/* Chips row (status filter) */
.filterBar{display:flex; gap:10px; flex-wrap:wrap; align-items:center}
.chip{display:inline-flex; align-items:center; gap:10px; padding:8px 12px; border:1px solid var(--border); background:#fff; border-radius:999px; font-weight:700}
.chip .count{min-width:26px; height:26px; padding:0 8px; border-radius:999px; background:#eef2ff; display:inline-flex; align-items:center; justify-content:center}

/* destination numbers */
.destWrap{display:flex; gap:10px; flex-wrap:wrap}
.dest{padding:6px 12px; background:#f1f5f9; border:1px solid var(--border); border-radius:999px; white-space:nowrap}

/* Responsive header chip scroll on mobile */
@media (max-width:900px){
  .table{min-width:700px}
}
</style>
</head>
<body>

<header class="header">
  <div class="brand">
    <img src="tsh.png" alt="TSH" onerror="this.src='tsh.png'">
    <strong>å“è³ªç®¡ç†ç”Ÿç”£æŠ€è¡“</strong>
  </div>
  <div class="actions">
    <button class="btn" id="btnRefresh">âŸ³ Refresh</button>
    <button class="btn" id="btnLive" aria-pressed="false">â— Live</button>
    <span class="badge" id="lastUpdate">â€”</span>
  </div>
</header>

<div id="urgentBanner" class="urgent">âš  è‡³æ€¥æ¡ˆä»¶ãŒã‚ã‚Šã¾ã™ï¼æ—©æ€¥ã«ç¢ºèªã—ã¦ãã ã•ã„ã€‚</div>

<main class="container">

  <!-- æœ¬æ—¥å‡ºè· -->
  <section class="panel">
    <h2>æœ¬æ—¥å‡ºè·</h2>
    <table class="table">
      <thead>
        <tr>
          <th style="width:300px">çŠ¶æ³</th>
          <th>å‡ºè·æ—¥</th>
          <th>é¡§å®¢å</th>
          <th>å›³ç•ª / æ©Ÿç¨®</th>
          <th>æ•°é‡</th>
          <th>é€ã‚Šå…ˆ / æ³¨ç•ª</th>
        </tr>
      </thead>
      <tbody id="todayBody"></tbody>
    </table>
  </section>

  <!-- å…¨ä»¶ä¸€è¦§ -->
  <section class="panel">
    <h2>å…¨ä»¶ä¸€è¦§</h2>

    <!-- dropdown filter: status chips disatukan -->
    <details style="margin:0 0 10px">
      <summary class="btn">ğŸ” ãƒ•ã‚£ãƒ«ã‚¿ãƒ¼ã‚’é–‹ã</summary>
      <div class="filterBar" id="filterBar"></div>
    </details>

    <div style="display:flex; gap:10px; align-items:center; margin:6px 0 10px">
      <label class="small">å‡ºè·æ—¥ï¼š</label>
      <input type="date" id="filterDate" class="btn" style="height:36px">
      <button class="btn" id="btnTodayOnly">æœ¬æ—¥å‡ºè·ã®ã¿</button>
      <button class="btn" id="btnClear">Clear</button>
    </div>

    <table class="table">
      <thead>
        <tr>
          <th style="width:300px">çŠ¶æ³</th>
          <th>å‡ºè·æ—¥</th>
          <th>é¡§å®¢å</th>
          <th>å›³ç•ª / æ©Ÿç¨®</th>
          <th>æ•°é‡</th>
          <th>é€ã‚Šå…ˆ / æ³¨ç•ª</th>
        </tr>
      </thead>
      <tbody id="allBody"></tbody>
    </table>
    <div class="small" id="hint"></div>
  </section>
</main>

<script>
/* ====== Konfigurasi sumber data ====== */
const SHEET_ID = "1lYl7oYk6atnm3KqC6VwufARX3ooRyJ2VmC_xYFb4-OE";
const TAB_NAME = "æœ€æ–°æƒ…å ±";
const CSV_URL  = `https://docs.google.com/spreadsheets/d/${SHEET_ID}/gviz/tq?tqx=out:csv&sheet=${encodeURIComponent(TAB_NAME)}`;
const S = s => String(s ?? '').trim();

/* ====== Status map (termasuk status baru) ====== */
const STATUS_MAP = [
  {key:'ãƒ¬ãƒ¼ã‚¶åŠ å·¥', label:'ãƒ¬ãƒ¼ã‚¶åŠ å·¥', color:'tag-blue',   icon:'ğŸ› ï¸'},
  {key:'æ¿é‡‘åŠ å·¥',   label:'æ¿é‡‘åŠ å·¥',   color:'tag-purple', icon:'ğŸ”©'},
  {key:'å¤–æ³¨',       label:'å¤–æ³¨',       color:'tag-orange', icon:'ğŸ­'},
  {key:'åŠ å·¥æ¸ˆ',     label:'åŠ å·¥æ¸ˆ',     color:'tag-sky',    icon:'âœ…'},
  {key:'çµ„ç«‹ä¸­',     label:'çµ„ç«‹ä¸­',     color:'tag-orange', icon:'ğŸ§°'},
  {key:'çµ„ç«‹å®Œäº†',   label:'çµ„ç«‹å®Œäº†',   color:'tag-green',  icon:'ğŸ§©'},
  {key:'æ¤œæŸ»ä¸­',     label:'æ¤œæŸ»ä¸­',     color:'tag-blue',   icon:'ğŸ”¬'},
  {key:'æ¤œæŸ»æ¸ˆ',     label:'æ¤œæŸ»æ¸ˆ',     color:'tag-green',  icon:'âœ…'},
  {key:'å‡ºè·æº–å‚™æ¸ˆ', label:'å‡ºè·æº–å‚™æ¸ˆ', color:'tag-sky',    icon:'ğŸšš'},
  // ===== Tambahan baru =====
  {key:'æ¤œæŸ»ä¿ç•™',   label:'æ¤œæŸ»ä¿ç•™',   color:'tag-orange', icon:'â¸ï¸'},
  {key:'å‡ºè·æ¸ˆ',     label:'å‡ºè·æ¸ˆ',     color:'tag-green',  icon:'ğŸ“¦'},
];

function normalizeStatus(raw){
  const t=S(raw);
  // status baru
  if(t.includes('æ¤œæŸ»ä¿ç•™')) return 'æ¤œæŸ»ä¿ç•™';
  if(t.includes('å‡ºè·æ¸ˆ'))   return 'å‡ºè·æ¸ˆ';
  // status map (exact contains)
  for(const s of STATUS_MAP){ if(t.includes(s.key)) return s.key; }
  // fallback heuristik
  if(/æ¤œæŸ»ä¸­|æ¤œ/.test(t)) return 'æ¤œæŸ»ä¸­';
  if(/æ¤œæŸ»æ¸ˆ|æ¸ˆ|å®Œäº†|OK|Done/i.test(t)) return 'æ¤œæŸ»æ¸ˆ';
  if(/çµ„ç«‹ä¸­|çµ„/.test(t)) return 'çµ„ç«‹ä¸­';
  if(/çµ„ç«‹å®Œäº†/.test(t)) return 'çµ„ç«‹å®Œäº†';
  return t||'';
}

/* ===== CSV parser simpel ===== */
function parseCSV(t){
  const rows=[], re=/\s*("(?:[^"]|"")*"|[^,]*)\s*(,|\n|$)/g; let m,row=[];
  t=t.replace(/\r\n?/g,"\n");
  for(let i=0;i<t.length;){ re.lastIndex=i; m=re.exec(t); if(!m) break;
    let cell=m[1]; if(cell.startsWith('"')) cell=cell.slice(1,-1).replace(/""/g,'"');
    row.push(cell); i=re.lastIndex; if(m[2]==="\n"||m[2]===""){ rows.push(row); row=[]; } }
  return rows.filter(r=>r.length && r.some(c=>S(c)!==""));
}

/* ===== Index kolom dinamis ===== */
function indexByHeader(header){
  const map={}; header.forEach((h,i)=>map[S(h)]=i);
  const find=nms=>{ for(const n of nms){ if(n in map) return map[n]; } return null; };
  const findFz=re=>{ for(let i=0;i<header.length;i++){ if(re.test(S(header[i]))) return i; } return null; };
  return {
    date:find(["å‡ºè·æ—¥","æ—¥ä»˜","Date"]),
    cust:find(["é¡§å®¢å","å®¢å…ˆ","Customer"]),
    draw:find(["å›³ç•ª","Drawing","å›³é¢"]),
    machine:find(["æ©Ÿç¨®","æ©Ÿç¨®å","Machine"]),
    item:find(["å•†å“å","å“å","Item"]),
    qty:find(["æ•°é‡","Qty"]),
    to:find(["é€ã‚Šå…ˆ","ç´å“å…ˆ","é€ä»˜å…ˆ"]),
    note:find(["æ³¨ç•ª","æ³¨æ–‡ç•ªå·","å‚™è€ƒ","æ³¨æ–‡","Order"]),
    status_done:find(["è£½å“çŠ¶æ³","è£½å“çŠ¶æ…‹","ç´å“çŠ¶æ³"]) ?? findFz(/(è£½å“|ç´å“).*(çŠ¶æ³|çŠ¶æ…‹)/),
    status_flag:find(["Status","ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹","çŠ¶æ…‹","è‡³æ€¥"]) ?? findFz(/status|è‡³æ€¥/i),
  };
}
const valAt=(row,idx)=>(idx==null?"":(row[idx]??""));

/* ===== Util tanggal ===== */
function parseJPDate(str){
  const s=String(str??"").trim();
  const mJP=s.match(/^(\d{4})\D(\d{1,2})\D(\d{1,2})/);
  if(mJP) return new Date(mJP[1],mJP[2]-1,mJP[3]);
  const p=s.replaceAll('-','/').split('/'); if(p.length===3) return new Date(p[0],p[1]-1,p[2]);
  const d=new Date(s); return isNaN(d)?null:d;
}
function sameYMD(a,b){return a&&b&&a.getFullYear()===b.getFullYear()&&a.getMonth()===b.getMonth()&&a.getDate()===b.getDate()}
function toInputDate(d){const z=n=>String(n).padStart(2,'0'); return `${d.getFullYear()}-${z(d.getMonth()+1)}-${z(d.getDate())}`}

/* ===== State ===== */
let cached={header:[], rows:[], idx:null};

/* ===== Render helper ===== */
function statusBadge(key){
  const def = STATUS_MAP.find(s=>s.key===key);
  const color = def?.color || 'tag-blue';
  const icon  = def?.icon  || 'ğŸ·ï¸';
  const label = def?.label || key || 'â€”';
  return `<span class="statusPill ${color}">${icon} ${label}</span>`;
}
function urgentPill(){ return `<span class="statusPill tag-danger">âš  è‡³æ€¥</span>`; }

function renderRow(row,idx){
  const stKey = normalizeStatus(valAt(row, idx.status_done));
  const isUrg = idx.status_flag!=null && /è‡³æ€¥|urgent|ç·Šæ€¥|1|true/i.test(S(valAt(row,idx.status_flag)));
  const date  = parseJPDate(valAt(row,idx.date));
  const dateChip = date ? `<span class="chip"><span>ğŸ“…</span>${toInputDate(date)}</span>` : '';

  const left = `
    <div class="statusCard">
      <div style="display:flex; gap:8px; align-items:center; margin-bottom:8px">
        ${statusBadge(stKey)} ${isUrg?urgentPill():''}
      </div>
      <div class="small" style="margin:4px 0">æ›´æ–°æ—¥ï¼š<strong id="ts">â€”</strong></div>
      <div class="small">æ›´æ–°è€…ï¼š<strong id="who">â€”</strong></div>
    </div>`;

  const center = `
    ${dateChip}
    <div class="small" style="margin-top:8px">${S(valAt(row,idx.cust))||''}</div>`;

  const right1 = `
    <div>${S(valAt(row,idx.draw))||''}</div>
    <div class="small">${S(valAt(row,idx.machine))||''}</div>`;

  const qty = S(valAt(row,idx.qty))||'';

  const dest = S(valAt(row,idx.to))||'';
  const note = S(valAt(row,idx.note))||'';
  const chips = (note||'')
    .split(/\s+/).filter(Boolean)
    .map(x=>`<span class="dest">${x}</span>`).join('');

  const toCell = `
    <div class="small" style="margin-bottom:6px">${dest||'â€”'}</div>
    <div class="destWrap">${chips}</div>`;

  return `<tr>
    <td>${left}</td>
    <td>${dateChip}</td>
    <td>${S(valAt(row,idx.cust))||''}</td>
    <td>${right1}</td>
    <td style="font-weight:800">${qty}</td>
    <td>${toCell}</td>
  </tr>`;
}

/* ===== Filter bar (chips) ===== */
let activeFilter = 'ALL';
function buildFilterBar(rows, idx){
  const cnt = {};
  const all = rows.length;
  for(const r of rows){
    const k = normalizeStatus(valAt(r,idx.status_done));
    cnt[k] = (cnt[k]||0)+1;
  }
  const bar = document.getElementById('filterBar');
  bar.innerHTML = '';
  const addChip = (key, label, count) => {
    const chip = document.createElement('button');
    chip.className = 'chip';
    chip.innerHTML = `${label} <span class="count">${count}</span>`;
    chip.onclick = ()=>{ activeFilter = key; applyAllFilter(); };
    bar.appendChild(chip);
  };
  addChip('ALL', 'ğŸŒ ã™ã¹ã¦', all);
  for(const s of STATUS_MAP){
    addChip(s.key, `${s.icon} ${s.label}`, cnt[s.key]||0);
  }
}

/* ===== Apply filters & render ===== */
function applyAllFilter(){
  const {rows, idx} = cached;
  const dateStr = document.getElementById('filterDate').value;
  const targetDate = dateStr ? new Date(dateStr+'T00:00:00') : null;

  let view = rows;
  if (targetDate){
    view = view.filter(r => {
      const d=parseJPDate(valAt(r, idx.date)); return d && sameYMD(d,targetDate);
    });
  }
  if (activeFilter !== 'ALL'){
    view = view.filter(r => normalizeStatus(valAt(r,idx.status_done))===activeFilter);
  }

  document.getElementById('allBody').innerHTML = view.map(r=>renderRow(r,idx)).join('');
}

function renderToday(){
  const {rows, idx} = cached;
  const today = new Date();
  const todayRows = rows.filter(r=>{
    const d=parseJPDate(valAt(r,idx.date)); return d && sameYMD(d,today);
  });
  document.getElementById('todayBody').innerHTML = todayRows.map(r=>renderRow(r,idx)).join('');
  // Banner urgent di tengah
  const urgentCount = todayRows.filter(r => idx.status_flag!=null && /è‡³æ€¥|urgent|ç·Šæ€¥|1|true/i.test(S(valAt(r,idx.status_flag)))).length;
  const ub = document.getElementById('urgentBanner');
  ub.style.display = urgentCount>0 ? 'flex' : 'none';
  ub.textContent = urgentCount>0 ? `âš  è‡³æ€¥æ¡ˆä»¶ãŒ ${urgentCount} ä»¶ã‚ã‚Šã¾ã™ï¼æ—©æ€¥ã«ç¢ºèªã—ã¦ãã ã•ã„ã€‚` : '';
}

/* ===== Load & bootstrap ===== */
async function load(){
  document.getElementById('btnRefresh').disabled = true;
  const res = await fetch(CSV_URL+'&_ts='+Date.now(), {cache:'no-store'});
  const text = await res.text();
  const data = parseCSV(text);
  const header = data[0], rowsRaw = data.slice(1);
  const idx = indexByHeader(header);
  cached = {header, rows:rowsRaw, idx};

  // Build filter & render
  buildFilterBar(rowsRaw, idx);
  renderToday();
  applyAllFilter();

  document.getElementById('lastUpdate').textContent = 'Last update: '+(new Date()).toLocaleString();
  document.getElementById('hint').textContent = `ãƒ‡ãƒ¼ã‚¿å…ƒ: ${TAB_NAME}ï¼ˆ${rowsRaw.length} è¡Œï¼‰`;
  document.getElementById('btnRefresh').disabled = false;
}

/* ===== Event ===== */
document.getElementById('btnRefresh').addEventListener('click', load);
document.getElementById('btnLive').addEventListener('click', (e)=>{
  const on = e.target.getAttribute('aria-pressed')==='true';
  e.target.setAttribute('aria-pressed', (!on)+'');
});
document.getElementById('filterDate').addEventListener('change', applyAllFilter);
document.getElementById('btnTodayOnly').addEventListener('click', ()=>{
  document.getElementById('filterDate').value = toInputDate(new Date());
  applyAllFilter();
});
document.getElementById('btnClear').addEventListener('click', ()=>{
  document.getElementById('filterDate').value='';
  activeFilter='ALL';
  applyAllFilter();
});

/* Init */
load();
</script>
</body>
</html>
