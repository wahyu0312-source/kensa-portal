<!doctype html>
<html lang="ja">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>品質管理生産技術 - 出荷状況</title>
  <style>
    :root{
      --bg1:#eef2ff; --bg2:#f8fafc;
      --card:#ffffff; --ink:#0f172a; --muted:#64748b; --border:#e5e7eb;
      --accent:#2563eb; --danger:#b91c1c;
      --shadow:0 30px 60px rgba(15,23,42,.08);
      --radius:22px;
      --done:#eaf3ff; /* biru muda kolom selesai */
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{
      margin:0; color:var(--ink);
      font-family:system-ui,-apple-system,"Segoe UI",Roboto,"Noto Sans JP","Yu Gothic",sans-serif;
      background:
        radial-gradient(1200px 600px at -10% -10%, #c7d2fe 0%, transparent 60%),
        radial-gradient(900px 500px at 110% 0%, #bae6fd 0%, transparent 55%),
        linear-gradient(120deg,var(--bg1),var(--bg2));
    }
    header{
      position:sticky;top:0;z-index:10;
      background:#ffffffcc; backdrop-filter:blur(10px);
      border-bottom:1px solid var(--border);
    }
    .wrap{max-width:1200px;margin:0 auto;padding:12px 20px}
    .row{display:flex;justify-content:space-between;align-items:center;gap:16px}
    .brand{display:flex;align-items:center;gap:12px}
    .brand svg{width:40px;height:40px}
    .brand-title{display:flex;flex-direction:column}
    nav a{margin-left:20px;color:var(--accent);font-weight:700;text-decoration:none}
    nav a:hover{text-decoration:underline}

    .controls{display:flex;gap:8px;align-items:center}
    .btn{padding:8px 12px;border:1px solid var(--border);border-radius:10px;background:#fff;cursor:pointer}
    .btn.active{border-color:#93c5fd;background:#f0f9ff}
    .small{font-size:12px;color:var(--muted)}

    main{max-width:1200px;margin:28px auto;padding:0 20px}
    h1{margin:0 0 8px 0}
    .card{
      background:linear-gradient(180deg,#ffffffcc,#fffffff2);
      border:1px solid var(--border); border-radius:var(--radius);
      box-shadow:var(--shadow);
      padding:18px; overflow:auto;
    }

    table{width:100%;border-collapse:separate;border-spacing:0;min-width:600px}
    thead th{
      background:#f8fafc; color:#475569; position:sticky;top:0; z-index:1;
      text-align:left; font-weight:700; padding:12px 14px; border-bottom:1px solid var(--border)
    }
    tbody td{
      padding:12px 14px; border-bottom:1px solid var(--border); white-space:nowrap
    }
    tbody tr:hover{background:#f1f5ff}

    /* highlight kolom selesai */
    th.col-done, td.col-done{ background: var(--done) !important; }

    .section-title{display:flex;align-items:center;gap:10px;margin:24px 0 12px 0}
    .dot{width:12px;height:12px;border-radius:50%;background:#ef4444;display:inline-block}
    .chip{font-size:12px;border-radius:999px;padding:4px 10px;border:1px solid var(--border);background:#fff}
    .chip.bad{border-color:var(--danger);color:var(--danger)}
    .list{list-style:none;margin:0;padding:0}
    .li{
      display:flex;justify-content:space-between;align-items:center;gap:8px;
      padding:12px 10px;border-bottom:1px dashed var(--border)
    }
    .muted{color:var(--muted)}
    .hint{margin-top:6px}

    /* 🔔 Banner urgent kedap-kedip */
    #urgent-banner {
      display:none;
      background:#b91c1c;
      color:white;
      padding:10px 16px;
      border-radius:10px;
      margin-bottom:14px;
      font-weight:bold;
      text-align:center;
      animation: blink 1s infinite;
    }
    @keyframes blink {
      0%, 50%, 100% { background-color:#b91c1c; }
      25%, 75% { background-color:#ef4444; }
    }
  </style>
</head>
<body>
<header>
  <div class="wrap row">
    <div class="brand">
      <svg viewBox="0 0 64 64">
        <circle cx="32" cy="32" r="30" fill="#2563eb22"/>
        <path d="M12 34h40M12 30h40M20 18h24v6H20zM20 40h24v6H20z"
              stroke="#2563eb" stroke-width="2" fill="none" stroke-linecap="round"/>
        <circle cx="20" cy="32" r="3" fill="#2563eb"/>
        <circle cx="44" cy="32" r="3" fill="#2563eb"/>
      </svg>
      <div class="brand-title">
        <strong>品質管理生産技術</strong>
        <span class="muted" style="font-size:12px">東京精密発條株式会社</span>
      </div>
    </div>

    <nav>
      <a href="./index.html"><strong>ホーム</strong></a>
      <a href="./forms.html">出荷検査成績書</a>
      <a href="./sagyoutejunsho.html">作業手順書</a>
    </nav>

    <div class="controls">
      <button id="btnRefresh" class="btn">Refresh now</button>
      <button id="btnLive" class="btn">Live: Off</button>
      <span id="intervalInfo" class="small">Interval: 60s</span>
    </div>
  </div>
</header>

<main>
  <!-- Banner urgent -->
  <div id="urgent-banner">⚠ 至急案件があります！早急に確認してください。</div>

  <!-- 出荷状況 -->
  <div style="display:flex;justify-content:space-between;align-items:end">
    <h1>出荷状況一覧</h1>
    <span id="lastUpdated" class="small"></span>
  </div>
  <section class="card">
    <table id="shipTable">
      <thead><tr id="shipHead"></tr></thead>
      <tbody id="shipBody"></tbody>
    </table>
    <div class="muted hint" id="shipHint"></div>
  </section>

  <!-- Urgent -->
  <div class="section-title">
    <span class="dot"></span>
    <h2 style="margin:0">Urgent（至急）</h2>
    <span id="urgentCount" class="chip">0 件</span>
  </div>
  <section class="card">
    <ul id="urgentList" class="list"></ul>
  </section>
</main>

<footer class="wrap muted" style="text-align:center;padding:24px 20px">
  &copy; <span id="year"></span> wahyu
</footer>

<script>
  document.getElementById('year').textContent = new Date().getFullYear();

  const SHEET_ID = "1lYl7oYk6atnm3KqC6VwufARX3ooRyJ2VmC_xYFb4-OE";
  const TAB_NAME = "最新情報";
  const CSV_URL  = `https://docs.google.com/spreadsheets/d/${SHEET_ID}/gviz/tq?tqx=out:csv&sheet=${encodeURIComponent(TAB_NAME)}`;

  function parseCSV(text){
    const rows=[], re=/\s*("(?:[^"]|"")*"|[^,]*)\s*(,|\n|$)/g;
    let m, row=[]; text=text.replace(/\r\n?/g,"\n");
    for (let i=0;i<text.length;){
      re.lastIndex=i; m=re.exec(text); if(!m) break;
      let cell=m[1]; if(cell.startsWith('"')) cell=cell.slice(1,-1).replace(/""/g,'"');
      row.push(cell); i=re.lastIndex;
      if(m[2]==="\n"||m[2]===""){ rows.push(row); row=[]; }
    }
    return rows.filter(r=>r.length && r.some(c=>String(c).trim()!==""));
  }
  const S = s => String(s ?? '').trim();

  function indexByName(header){
    const map={}; header.forEach((h,i)=> map[S(h)] = i);
    const find = names => { for(const n of names){ if(n in map) return map[n]; } return null; };
    return {
      date:   find(["出荷日","日付","Date"]),
      draw:   find(["図番","Drawing","図面"]),
      order:  find(["注番","注文番号","Order"]),
      cust:   find(["顧客名","客先","Customer"]),
      item:   find(["商品名","品名","Item"]),
      qty:    find(["数量","Qty"]),
      status: find(["Status","ステータス","至急","状態"])
    };
  }

  const DONE_NAMES = ["長谷部","石橋","都合"];
  function isDoneCell(val){
    const v = S(val);
    if(!v) return false;
    if(v.includes("済")) return true;
    return DONE_NAMES.some(n => v.includes(n));
  }
  function isUrgent(statusValue){
    const v = S(statusValue).toLowerCase();
    return v==="至急" || v==="urgent" || v==="緊急" || v==="true" || v==="1";
  }

  let aborter = null;
  async function load(){
    try{
      if(aborter) aborter.abort();
      aborter = new AbortController();
      const res  = await fetch(CSV_URL + "&_ts=" + Date.now(), {signal: aborter.signal, cache:'no-store'});
      if(!res.ok) throw new Error("HTTP " + res.status);
      const text = await res.text();
      const data = parseCSV(text);
      if(!data.length) return;

      let header = data[0];
      let rows   = data.slice(1);

      const colDone = new Array(header.length).fill(true);
      for(let c=0;c<header.length;c++){
        for(let r=0;r<rows.length;r++){
          const val = rows[r][c];
          if(!isDoneCell(val)){ colDone[c] = false; break; }
        }
      }

      const idx = indexByName(header);
      // 🚨 Sort urgent ke atas
      rows.sort((a, b) => {
        const aUrg = isUrgent(a[idx.status ?? -1]);
        const bUrg = isUrgent(b[idx.status ?? -1]);
        if (aUrg && !bUrg) return -1;
        if (!aUrg && bUrg) return 1;
        return 0;
      });

      const headEl = document.getElementById('shipHead');
      headEl.innerHTML = header.map((h,i)=>`<th class="${colDone[i]?'col-done':''}">${h}</th>`).join('');

      const tbody = document.getElementById('shipBody');
      tbody.innerHTML = '';
      rows.forEach(r=>{
        const cells=[...r]; while(cells.length<header.length) cells.push('');
        const tds = cells.map((c,i)=>{
          const cls = colDone[i] ? 'col-done' : '';
          return `<td class="${cls}">${c}</td>`;
        }).join('');
        tbody.insertAdjacentHTML('beforeend', `<tr>${tds}</tr>`);
      });

      document.getElementById('shipHint').textContent =
        `データ元: ${TAB_NAME}（${rows.length} 行）`;
      document.getElementById('lastUpdated').textContent =
        'Last update: ' + new Date().toLocaleString();

      // URGENT list
      const urgList = rows
        .map(r=>({
          item:S(r[idx.item  ?? -1]),
          draw:S(r[idx.draw  ?? -1]),
          order:S(r[idx.order ?? -1]),
          cust:S(r[idx.cust  ?? -1]),
          date:S(r[idx.date  ?? -1]),
          qty: S(r[idx.qty   ?? -1]),
          status:S(r[idx.status ?? -1])
        }))
        .filter(o=>isUrgent(o.status));

      const ul = document.getElementById('urgentList');
      const badge = document.getElementById('urgentCount');
      ul.innerHTML = '';
      badge.textContent = `${urgList.length} 件`;

      if(urgList.length===0){
        ul.innerHTML = `<li class="li"><span class="muted">現在、至急品目はありません。</span></li>`;
        document.getElementById('urgent-banner').style.display = 'none';
      }else{
        urgList.forEach(u=>{
          ul.insertAdjacentHTML('beforeend', `
            <li class="li">
              <div>
                <strong>${u.item || '(品名未設定)'}</strong>
                <span class="chip bad">至急</span>
                <div class="muted">
                  顧客: ${u.cust || '-'} ／ 出荷日: ${u.date || '-'}
                  ${u.draw ? ' ／ 図番: ' + u.draw : ''}${u.order ? ' ／ 注番: ' + u.order : ''}
                </div>
              </div>
              <span class="chip">${u.qty ? '数量: '+u.qty : ''}</span>
            </li>
          `);
        });
        document.getElementById('urgent-banner').style.display = 'block';
      }
    }catch(e){
      if(e.name === 'AbortError') return;
      console.error(e);
      document.getElementById('shipHint').textContent = '読み込みに失敗しました。シート名/公開設定をご確認ください。';
    }
  }

  let timer = null;
  let intervalMs = 60000;

  function startAutoRefresh(ms){
    intervalMs = ms;
    clearInterval(timer);
    timer = setInterval(()=>{ if(document.visibilityState === 'visible'){ load(); } }, intervalMs);
    document.getElementById('intervalInfo').textContent = `Interval: ${Math.round(intervalMs/1000)}s`;
    const liveBtn = document.getElementById('btnLive');
    if(intervalMs <= 5000){ liveBtn.classList.add('active'); liveBtn.textContent = 'Live: On'; }
    else { liveBtn.classList.remove('active'); liveBtn.textContent = 'Live: Off'; }
  }

  document.getElementById('btnRefresh').addEventListener('click', load);
  document.getElementById('btnLive').addEventListener('click', ()=>{
    startAutoRefresh(intervalMs <= 5000 ? 60000 : 5000);
    load();
  });
  document.addEventListener('visibilitychange', ()=>{ if(document.visibilityState === 'visible'){ load(); } });

  window.addEventListener('DOMContentLoaded', ()=>{ load(); startAutoRefresh(60000); });
</script>
</body>
</html>
