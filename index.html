<!doctype html>
<html lang="ja">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>品質管理生産技術</title>
  <style>
    :root{
      --bg:#f5f7fb; --card:#ffffff; --text:#0f172a; --muted:#64748b; --border:#e5e7eb;
      --accent:#2563eb; --accent-hover:#1d4ed8; --shadow:0 6px 20px rgba(0,0,0,.05);
      --success:#22c55e; --danger:#ef4444; --warn:#f59e0b; --info:#3b82f6;
    }
    *{box-sizing:border-box}
    html,body{margin:0;padding:0;background:var(--bg);color:var(--text);
      font-family:system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial}
    .container{max-width:1200px;margin:0 auto;padding:24px}

    /* header */
    .header{position:sticky;top:0;background:#fff;padding:14px 24px;
      display:flex;align-items:center;justify-content:space-between;
      border-bottom:1px solid var(--border);box-shadow:0 2px 6px rgba(0,0,0,.04);z-index:10}
    .brand{display:flex;flex-direction:column}
    .brand .title{font-weight:800;letter-spacing:.2px;font-size:1.8rem}
    .brand .subtitle{color:var(--muted);font-weight:700}
    .nav a{color:var(--muted);text-decoration:none;margin-left:20px;font-weight:600}
    .nav a:hover{color:var(--accent)}

    /* cards */
    .card{background:var(--card);border:1px solid var(--border);border-radius:16px;
      padding:20px;box-shadow:var(--shadow);transition:.2s}
    .card:hover{transform:translateY(-2px);box-shadow:0 10px 25px rgba(0,0,0,.08)}
    .hero{display:flex;gap:8px;flex-direction:column;margin-top:18px}

    /* status small cards */
    .cards-grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(180px,1fr));gap:16px;margin-top:14px}
    .stat{display:flex;flex-direction:column;gap:6px;text-align:center;padding:18px}
    .stat .k{color:var(--muted);font-size:.95rem}
    .stat .v{font-size:2.1rem;font-weight:800;color:var(--accent)}

    /* controls */
    .card-head{display:flex;align-items:center;justify-content:space-between;gap:12px;margin-top:12px}
    .controls{color:var(--muted);display:flex;align-items:center;gap:10px}
    select{padding:8px 10px;border:1px solid var(--border);border-radius:10px;background:#fff}
    .btn{padding:10px 14px;border-radius:10px;border:none;
      background:var(--accent);color:#fff;font-weight:700;cursor:pointer;transition:.2s}
    .btn:hover{background:var(--accent-hover)}

    /* table */
    .table-wrap{overflow:auto;border:1px solid var(--border);border-radius:12px;margin-top:12px;background:#fff}
    table{width:100%;border-collapse:collapse;font-size:.95rem}
    th,td{border-bottom:1px solid var(--border);padding:11px 12px;text-align:left;white-space:nowrap}
    th{color:var(--muted);font-weight:700;background:#f9fafb;position:sticky;top:0;z-index:5}
    tbody tr:nth-child(even){background:#f9fafb}

    /* badges */
    .badge{display:inline-block;padding:4px 10px;border-radius:999px;font-size:.8rem;font-weight:700}
    .status-OK{background:var(--success);color:#fff}
    .status-NG{background:var(--danger);color:#fff}
    .status-WIP{background:var(--warn);color:#fff}
    .status-その他{background:var(--info);color:#fff}

    .empty{color:var(--muted);padding:16px;text-align:center}

    /* footer */
    .footer{color:var(--muted);text-align:center;padding:30px 0;font-size:.95rem}
    .footer span{margin:0 6px}
  </style>
</head>
<body>
  <header class="header">
    <div class="brand">
      <div class="title">品質管理生産技術</div>
      <div class="subtitle">東京精密発條株式会社</div>
    </div>
    <nav class="nav">
      <a href="./index.html"><strong>ホーム</strong></a>
      <a href="./forms.html">出荷検査成績書</a>
    </nav>
  </header>

  <main class="container">
    <section class="card hero">
      <h1 style="margin:0">出荷・工程ステータス</h1>
      <p class="muted" style="margin:0">Google スプレッドシートの最新情報</p>
    </section>

    <section class="cards-grid" id="status-cards"></section>

    <section class="card">
      <div class="card-head">
        <h2 style="margin:0">最新データ</h2>
        <div class="controls">
          <label>表示件数</label>
          <select id="limit">
            <option value="20">20</option>
            <option value="50" selected>50</option>
            <option value="100">100</option>
          </select>
          <span>件</span>
          <button id="refresh" class="btn">再読込</button>
        </div>
      </div>
      <div class="table-wrap">
        <table>
          <thead><tr id="thead-row"></tr></thead>
          <tbody id="tbody"></tbody>
        </table>
        <div id="empty" class="empty" style="display:none">データがありません</div>
      </div>
    </section>
  </main>

  <footer class="footer">
    <span>&copy; <span id="year"></span> 品質管理生産技術</span>
    <span>|</span>
    <span>Design by ワーユ</span>
  </footer>

  <script>
    document.getElementById('year').textContent = new Date().getFullYear();

    // ===== CSV publish-to-web URL (sheet yang benar) =====
    const CSV_URL = "https://docs.google.com/spreadsheets/d/e/2PACX-1vQsSzDXVBFp9wZznTVpu6Lu8A3M0vk3gftkzMzZBAeIV77gKFTW_WtiTfDyBtuIIZinJ2TTKrHpg4Fi/pub?gid=1131211024&single=true&output=csv";
    const RECENT_LIMIT_DEFAULT = 50;

    // header mapping
    const MAP = {
      ship_date:["出荷日","日付","date"],
      customer:["顧客名","会社","メーカー","customer"],
      drawing_no:["図番","図面","drawing","図面番号"],
      product:["商品名","品目","item","部品名"],
      qty:["数量","個数","qty","数量(個)"],
      destination:["送り先","送付先","納入先","destination"],
      note:["注意","注意点","指示","note"],
      remark:["備考","メモ","remark","備考欄"],
      status:["ステータス","状態","工程","status","製品"]
    };
    const DISPLAY = [
      {key:"ship_date",label:"出荷日"},
      {key:"customer",label:"顧客名"},
      {key:"drawing_no",label:"図番"},
      {key:"product",label:"商品名"},
      {key:"qty",label:"数量"},
      {key:"destination",label:"送り先"},
      {key:"note",label:"注意"},
      {key:"remark",label:"備考"},
      {key:"status",label:"ステータス"}
    ];

    // CSV parser (quoted)
    function parseCSV(text){
      const rows=[], re=/\s*("(?:[^"]|"")*"|[^,]*)\s*(,|\n|$)/g;
      let m, row=[]; text=text.replace(/\r\n?/g,"\n");
      for (let i=0;i<text.length;){
        re.lastIndex=i; m=re.exec(text); if(!m) break;
        let cell=m[1]; if(cell.startsWith('"')) cell=cell.slice(1,-1).replace(/""/g,'"');
        row.push(cell); i=re.lastIndex;
        if(m[2]==="\n"||m[2]===""){ rows.push(row); row=[]; }
      }
      return rows.filter(r=>r.length && r.join("").trim()!=="");
    }
    function findIdx(header,cands){
      const h=header.map(x=>x.trim().toLowerCase());
      for(const n of cands){ const i=h.indexOf(String(n).toLowerCase()); if(i>=0) return i; }
      return -1;
    }
    function buildMap(header){ const out={}; for(const [k,c] of Object.entries(MAP)) out[k]=findIdx(header,c); return out; }

    function renderStatus(rows,map){
      const i=map.status; if(i<0) return;
      const counts={}; rows.forEach(r=>{ const k=r[i]||"その他"; counts[k]=(counts[k]||0)+1; });
      const wrap=document.getElementById("status-cards"); wrap.innerHTML="";
      Object.entries(counts).sort((a,b)=>b[1]-a[1]).forEach(([k,v])=>{
        wrap.insertAdjacentHTML("beforeend",
          `<div class="card stat"><div class="k">${k}</div><div class="v">${v}</div></div>`);
      });
    }
    function renderHeader(){
      const tr=document.getElementById("thead-row");
      tr.innerHTML=DISPLAY.map(c=>`<th>${c.label}</th>`).join("");
    }
    function renderRows(rows,map){
      const tb=document.getElementById("tbody"); tb.innerHTML="";
      const order=DISPLAY.map(c=>c.key);
      rows.forEach(r=>{
        const tds=order.map(key=>{
          const idx=map[key]; const val=(idx>=0&&idx<r.length)?r[idx]:"";
          if(key==="status"){
            let cls="status-その他";
            if(/OK|良|Clear/i.test(val)) cls="status-OK";
            else if(/NG|不/i.test(val)) cls="status-NG";
            else if(/進行|WIP/i.test(val)) cls="status-WIP";
            return `<td><span class="badge ${cls}">${val}</span></td>`;
          }
          return `<td>${val}</td>`;
        }).join("");
        tb.insertAdjacentHTML("beforeend",`<tr>${tds}</tr>`);
      });
    }

    function showEmpty(msg){document.getElementById("tbody").innerHTML="";const el=document.getElementById("empty");el.textContent=msg;el.style.display="block";}
    function hideEmpty(){document.getElementById("empty").style.display="none";}

    async function loadCSV(){
      hideEmpty();
      const limSel=document.getElementById("limit");
      const lim=Number(limSel?.value||RECENT_LIMIT_DEFAULT);
      try{
        const bust=(CSV_URL.includes("?")?"&":"?")+"t="+Date.now();
        const res=await fetch(CSV_URL+bust,{cache:"no-store"});
        if(!res.ok){showEmpty("取得エラー");return;}
        const text=await res.text();
        const arr=parseCSV(text);
        if(!arr.length){showEmpty("データがありません");return;}
        const header=arr[0], rowsAll=arr.slice(1);
        const map=buildMap(header);
        renderStatus(rowsAll,map);
        renderHeader();
        const rows=rowsAll.slice(-lim);
        if(!rows.length){showEmpty("データがありません");return;}
        renderRows(rows,map);
      }catch(e){console.error(e);showEmpty("取得エラー");}
    }

    document.getElementById("limit").addEventListener("change",loadCSV);
    document.getElementById("refresh").addEventListener("click",loadCSV);
    window.addEventListener("DOMContentLoaded",loadCSV);
  </script>
</body>
</html>
