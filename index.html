<!doctype html>
<html lang="ja">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>品質管理生産技術システム</title>

<style>
  :root{
    --bg:#f6f7fb; --panel:#fff; --ink:#0f172a; --muted:#64748b; --border:#e5e7eb;
    --blue-50:#eff6ff; --blue-100:#dbeafe; --blue-600:#2563eb; --blue-700:#1d4ed8;
    --green:#10b981; --amber:#f59e0b; --purple:#8b5cf6; --rose:#ef4444;
    --radius-xl:22px; --radius:14px; --shadow-1:0 12px 30px rgba(15,23,42,.08);
  }
  *{box-sizing:border-box}
  html,body{height:100%}
  body{
    margin:0; color:var(--ink);
    font-family:system-ui,-apple-system,Segoe UI,Roboto,"Noto Sans JP","Yu Gothic",sans-serif;
    background:
      radial-gradient(1200px 600px at -10% -10%, #c7d2fe 0%, transparent 60%),
      radial-gradient(900px 500px at 110% 0%, #bae6fd 0%, transparent 55%),
      linear-gradient(120deg,#f8fafc,var(--bg));
  }
  a{color:inherit; text-decoration:none}

  /* ===== Topbar ===== */
  .topbar{
    position:sticky; top:0; z-index:50;
    background:#ffffffc8; backdrop-filter:blur(10px);
    border-bottom:1px solid var(--border);
  }
  .topbar .wrap{
    max-width:1400px; margin:0 auto; padding:10px 16px;
    display:flex; align-items:center; gap:10px; justify-content:space-between;
  }
  .brand{display:flex; align-items:center; gap:12px; font-weight:800}
  .brand img.logo{height:28px; width:auto; display:block}
  @media (min-width:1280px){ .brand img.logo{height:32px} }

  .actions{display:flex; gap:8px; align-items:center}
  .btn{
    height:34px; padding:0 12px; border-radius:10px;
    border:1px solid var(--border); background:#fff; cursor:pointer;
    display:inline-flex; align-items:center; gap:8px;
  }
  .help{ font-size:12px; color:var(--muted) }

  main{max-width:1400px; margin:0 auto; padding:16px}

  /* ===== Banner ===== */
  .urgent{
    background:#fee2e2; border:1px solid #fecaca; color:#991b1b;
    font-weight:800; text-align:center; padding:12px 14px; border-radius:12px;
    margin:10px 0 14px;
  }

  /* ===== Panel ===== */
  .panel{
    background:#fff; border:1px solid var(--border); border-radius:var(--radius-xl);
    box-shadow:var(--shadow-1); overflow:hidden; margin-bottom:18px;
  }
  .panel-head{
    padding:14px 16px; display:flex; align-items:center; justify-content:space-between;
    border-bottom:1px solid var(--border);
  }
  .h2{margin:0; font-size:20px}

  /* ===== chipbar & filter ===== */
  .chipbar{display:flex; gap:10px; align-items:center; flex-wrap:wrap}
  .fchip{
    display:inline-flex; align-items:center; gap:10px;
    height:42px; padding:0 14px; border-radius:999px; border:1px solid var(--border);
    background:#fff; cursor:pointer; font-weight:700; color:#1f2937;
  }
  .fchip.active{ border-color:var(--blue-600); box-shadow:0 0 0 4px var(--blue-100); }
  .fnum{
    min-width:24px; height:24px; border-radius:999px; display:inline-grid; place-items:center;
    background:var(--blue-600); color:#fff; font-size:12px; padding:0 6px;
  }

  /* ===== Responsive table wrapper (scroll on small screens) ===== */
  .table-scroll{ overflow-x:auto; }
  .grid-w{
    min-width: 1080px; /* menjaga table tetap proporsional; di HP akan scroll horizontal */
  }

  /* ===== Grid header & row ===== */
  .table-head{
    display:grid; grid-template-columns: 320px 170px 1fr 170px 140px 220px;
    padding:10px 18px; color:#475569; font-weight:800; border-bottom:1px solid var(--border);
  }
  .row{
    display:grid; grid-template-columns: 320px 170px 1fr 170px 140px 220px;
    gap:0; align-items:center; padding:14px 18px; border-bottom:1px solid var(--border);
  }
  .row:hover{ background:#f9fbff }

  /* adjust columns for medium screens */
  @media (max-width:1200px){
    .table-head, .row{ grid-template-columns: 300px 160px 1fr 160px 120px 220px; }
  }

  /* ===== Left status card ===== */
  .leftbox{
    display:grid; grid-template-columns: 88px 1fr; gap:12px; align-items:center;
    background:#f8fafc; border:1px solid var(--border); border-radius:20px; padding:12px;
  }
  .status-badge{
    width:80px; height:80px; border-radius:999px; display:grid; place-items:center;
    background:var(--blue-50); border:1px solid var(--border); font-weight:800;
    color:#1d4ed8; font-size:18px;
  }
  .meta small{ display:block; color:#64748b }
  .meta strong{ display:block; font-weight:800 }
  .pill-urgent{
    display:inline-flex; align-items:center; gap:6px; padding:6px 10px; border-radius:999px;
    background:#fee2e2; color:#991b1b; font-weight:800; margin-bottom:6px;
  }

  /* ===== Date chip ===== */
  .date-chip{
    display:inline-flex; align-items:center; gap:10px; padding:10px 14px;
    height:42px; background:#eef2ff; color:#1d4ed8; border:1px solid #e5e7eb;
    border-radius:999px; font-weight:800;
  }

  /* ===== 注番 chips fit & wrap ===== */
  .note-wrap{
    display:flex; flex-wrap:wrap; gap:8px; align-items:center;
    padding-top:6px;
  }
  .note-chip{
    display:inline-flex; align-items:center; gap:6px;
    padding:6px 10px; border-radius:999px; border:1px solid var(--border);
    background:#f8fafc; color:#334155; font-weight:700; font-size:13px;
    white-space:nowrap;
  }

  /* ===== Today scroll: desktop only ===== */
  .today-scroll{ max-height:52vh; overflow:auto; }
  @media (max-width:900px){ .today-scroll{ max-height:none; } } /* di HP biar full tanpa scroll internal */

  .muted{ color:var(--muted) }
</style>
</head>

<body>
  <!-- ===== TOPBAR ===== -->
  <header class="topbar">
    <div class="wrap">
      <div class="brand">
        <!-- gunakan path relatif agar aman di GitHub Pages -->
        <img src="./tsh.png" alt="TSH" class="logo" />
        品質管理生産技術
      </div>
      <div class="actions">
        <button id="btnRefresh" class="btn">⟳ Refresh</button>
        <button id="btnLive" class="btn" aria-pressed="false">● Live</button>
        <span id="lastUpdated" class="help"></span>
      </div>
    </div>
  </header>

  <main>
    <!-- ===== Urgent banner ===== -->
    <div id="urgentBanner" class="urgent" style="display:none"></div>

    <!-- ===== TODAY ===== -->
    <section class="panel" id="todaySection">
      <div class="panel-head">
        <h2 class="h2">本日出荷</h2>
        <div class="help">件数 <span id="todayCount">0</span></div>
      </div>
      <div class="table-scroll">
        <div class="grid-w">
          <div class="table-head">
            <div>状況</div><div>出荷日</div><div>顧客名</div><div>図番 / 機種</div><div>数量</div><div>送り先／注番</div>
          </div>
          <div id="todayBody" class="today-scroll"></div>
        </div>
      </div>
    </section>

    <!-- ===== ALL ===== -->
    <section class="panel">
      <div class="panel-head">
        <h2 class="h2">全件一覧</h2>
        <div class="chipbar">
          <button id="btnClear" class="btn">Clear</button>
          <input id="filterDate" type="date" class="btn" style="height:34px" />
          <button id="btnTodayOnly" class="btn">本日出荷のみ</button>
        </div>
      </div>

      <!-- quick filter -->
      <div style="padding:12px 16px; border-bottom:1px solid var(--border)">
        <div id="quickBar" class="chipbar"></div>
      </div>

      <div class="table-scroll">
        <div class="grid-w">
          <div class="table-head">
            <div>状況</div><div>出荷日</div><div>顧客名</div><div>図番 / 機種</div><div>数量</div><div>送り先／注番</div>
          </div>
          <div id="allBody"></div>
        </div>
      </div>

      <div class="help" style="padding:10px 16px">
        データ元: 最新情報（<span id="rowCount">0</span> 行）｜Urgent列: Status ｜ 出荷日: 出荷日
      </div>
    </section>
  </main>

<script>
/* ========= CONFIG ========= */
const SHEET_ID ="1lYl7oYk6atnm3KqC6VwufARX3ooRyJ2VmC_xYFb4-OE";
const TAB_NAME ="最新情報";
const CSV_URL  =`https://docs.google.com/spreadsheets/d/${SHEET_ID}/gviz/tq?tqx=out:csv&sheet=${encodeURIComponent(TAB_NAME)}`;
const S = s => String(s ?? '').trim();

/* Status list (untuk quick filter & ikon) */
const STATUS_LIST = [
  {k:'レーザ加工',  key:'laser',     icon:'🛠️'},
  {k:'板金加工',    key:'bend',      icon:'🧰'},
  {k:'外注',        key:'out',       icon:'🏭'},
  {k:'加工済',      key:'proc',      icon:'🧪'},
  {k:'組立中',      key:'assy',      icon:'🧳'},
  {k:'組立完了',    key:'assydone',  icon:'✅'},
  {k:'検査中',      key:'qc',        icon:'🔎'},
  {k:'検査済',      key:'qcdone',    icon:'🟢'},
  {k:'出荷準備済',  key:'ship',      icon:'🚚'},
];

/* CSV parser */
function parseCSV(t){
  const rows=[], re=/\s*("(?:[^"]|"")*"|[^,]*)\s*(,|\n|$)/g;
  let m,row=[]; t=t.replace(/\r\n?/g,"\n");
  for(let i=0;i<t.length;){
    re.lastIndex=i; m=re.exec(t); if(!m) break;
    let cell=m[1]; if(cell.startsWith('"')) cell=cell.slice(1,-1).replace(/""/g,'"');
    row.push(cell); i=re.lastIndex;
    if(m[2]==="\n"||m[2]===""){ rows.push(row); row=[]; }
  }
  return rows.filter(r=>r.length && r.some(c=>S(c)!==""));
}

/* header index */
function indexByName(header){
  const map={}; header.forEach((h,i)=>map[S(h)]=i);
  const find=nms=>{ for(const n of nms){ if(n in map) return map[n]; } return null; };
  const findFz=re=>{ for(let i=0;i<header.length;i++){ if(re.test(S(header[i]))) return i; } return null; };
  return {
    date:find(["出荷日","日付","Date"]),
    cust:find(["顧客名","客先","Customer"]),
    draw:find(["図番","図面","Drawing"]),
    machine:find(["機種","機種名","Machine"]),
    qty:find(["数量","Qty"]),
    to:find(["送り先","送付先","納品先"]),
    note:find(["注番","注文番号","備考","注文","Order"]),
    status:find(["製品状況","製品状態"]) ?? findFz(/(製品|納品).*(状況|状態)/),
    urgent:find(["Status","ステータス","状態","至急"]) ?? findFz(/status|至急/i),
    ts:find(["製品状況更新日時","更新日時"]),
    user:find(["更新者","入力者"]),
  };
}
const valAt=(row,idx)=>(idx==null?"":(row[idx]??""));

function parseJPDate(str){
  const s=String(str??"").trim();
  const mJP=s.match(/^(\d{4})\D(\d{1,2})\D(\d{1,2})/);
  if(mJP) return new Date(mJP[1],mJP[2]-1,mJP[3]);
  const p=s.replaceAll('-','/').split('/'); if(p.length===3) return new Date(p[0],p[1]-1,p[2]);
  const d=new Date(s); return isNaN(d)?null:d;
}
function sameYMD(a,b){return a&&b&&a.getFullYear()===b.getFullYear()&&a.getMonth()===b.getMonth()&&a.getDate()===b.getDate()}
function toInputDate(d){const z=n=>String(n).padStart(2,'0'); return `${d.getFullYear()}-${z(d.getMonth()+1)}-${z(d.getDate())}`}
function fmtDateYYMMDD(d){const z=n=>String(n).padStart(2,'0'); return `${String(d.getFullYear()).slice(2)}/${z(d.getMonth()+1)}/${z(d.getDate())}`}

function isUrgent(v){const t=S(v).toLowerCase(); return t==="至急"||t==="urgent"||t==="緊急"||t==="1"||t==="true"}

function getStatusKey(val){
  const raw=S(val);
  for(const s of STATUS_LIST){ if(raw.includes(s.k)) return s.key; }
  if(/検査済|済|完了/.test(raw)) return 'qcdone';
  if(/検査中/.test(raw)) return 'qc';
  if(/組立完了/.test(raw)) return 'assydone';
  if(/組立中/.test(raw)) return 'assy';
  if(/出荷/.test(raw)) return 'ship';
  return '';
}

/* render helpers */
function noteToChips(txt){
  const tokens = S(txt).split(/[,\s]+/).filter(Boolean);
  if(tokens.length===0) return '';
  return `<div class="note-wrap">` + tokens.map(t=>`<span class="note-chip">${t}</span>`).join('') + `</div>`;
}
function statusBadge(raw){
  const key = getStatusKey(raw);
  const conf = STATUS_LIST.find(s=>s.key===key);
  const text = S(raw) || '—';
  const icon = conf ? conf.icon : '•';
  return `<div class="status-badge" title="${text}">${icon}<div style="font-size:13px">${text}</div></div>`;
}
function leftBox(row, idx){
  const stRaw = valAt(row, idx.status);
  const urgent = idx.urgent!=null && isUrgent(valAt(row, idx.urgent));
  const ts = idx.ts!=null ? valAt(row, idx.ts) : '';
  const user = idx.user!=null ? valAt(row, idx.user) : '';
  const tsText = ts ? fmtDateYYMMDD(new Date(ts)) : '—';
  return `
    <div class="leftbox">
      ${statusBadge(stRaw)}
      <div class="meta">
        ${urgent?`<span class="pill-urgent">⚠ 至急</span>`:''}
        <small>更新日：</small><strong>${tsText}</strong>
        <small>更新者：</small><strong>${S(user)||'—'}</strong>
      </div>
    </div>`;
}
function renderRow(row, idx){
  const date = idx.date!=null?parseJPDate(valAt(row,idx.date)):null;
  const dateText = date? `${date.getFullYear()}-${String(date.getMonth()+1).padStart(2,'0')}-${String(date.getDate()).padStart(2,'0')}` : '';
  const drawMachine = `${S(valAt(row, idx.draw))||'—'}<br><span class="muted">${S(valAt(row, idx.machine))||'—'}</span>`;
  const notes = noteToChips(valAt(row, idx.note));
  return `
    <div class="row">
      ${leftBox(row, idx)}
      <div><span class="date-chip">📅 ${dateText||'—'}</span></div>
      <div>${S(valAt(row, idx.cust))||'—'}</div>
      <div>${drawMachine}</div>
      <div>${S(valAt(row, idx.qty))||'—'}</div>
      <div>
        <div>${S(valAt(row, idx.to))||'—'}</div>
        ${notes}
      </div>
    </div>`;
}
function renderList(rows, idx, mount){
  mount.innerHTML = rows.map(r=>renderRow(r, idx)).join('') || `<div style="padding:16px">データなし</div>`;
}

function makeComparator(idx){
  const weight = s=>{
    const m = {'qc':1,'assy':2,'laser':2,'bend':2,'out':2,'proc':2,'ship':3,'assydone':4,'qcdone':5};
    return m[getStatusKey(s)]??99;
  };
  return (a,b)=>{
    const au=idx.urgent!=null&&isUrgent(valAt(a,idx.urgent));
    const bu=idx.urgent!=null&&isUrgent(valAt(b,idx.urgent));
    if(au!==bu) return au?-1:1;
    const wa=idx.status!=null?weight(valAt(a,idx.status)):99;
    const wb=idx.status!=null?weight(valAt(b,idx.status)):99;
    if(wa!==wb) return wa-wb;
    const da=idx.date!=null?parseJPDate(valAt(a,idx.date)):null;
    const db=idx.date!=null?parseJPDate(valAt(b,idx.date)):null;
    const ta=da?da.getTime():-Infinity, tb=db?db.getTime():-Infinity;
    return tb-ta;
  };
}

/* Quick filter */
let activeFilter = 'all';
function buildQuickBar(rows, idx){
  const counts = {}; for(const s of STATUS_LIST) counts[s.key]=0;
  rows.forEach(r=>{
    const k=getStatusKey(valAt(r, idx.status)); counts[k]=(counts[k]||0)+1;
  });
  const el=document.getElementById('quickBar');
  el.innerHTML = `
    <button class="fchip ${activeFilter==='all'?'active':''}" data-key="all">🌐 すべて <span class="fnum">${rows.length}</span></button>
    ${STATUS_LIST.map(s=>`<button class="fchip ${activeFilter===s.key?'active':''}" data-key="${s.key}">${s.icon} ${s.k} <span class="fnum">${counts[s.key]||0}</span></button>`).join('')}
  `;
  [...el.querySelectorAll('.fchip')].forEach(b=>{
    b.addEventListener('click', ()=>{
      activeFilter = b.dataset.key;
      buildQuickBar(rows, idx);
      applyAllFilter();
    });
  });
}
function applyAllFilter(){
  const {rows, idx} = cache;
  const dateStr = document.getElementById('filterDate').value || null;
  let view = [...rows];
  if(dateStr && idx.date!=null){
    const target = new Date(dateStr+"T00:00:00");
    view = view.filter(r=>{const d=parseJPDate(valAt(r,idx.date)); return d&&sameYMD(d,target)});
  }
  if(activeFilter!=='all'){
    view = view.filter(r=> getStatusKey(valAt(r, idx.status))===activeFilter );
  }
  view.sort(makeComparator(idx));
  renderList(view, idx, document.getElementById('allBody'));
}

/* Today & banner */
function renderToday(){
  const {rows, idx} = cache;
  if(idx.date==null){ document.getElementById('todaySection').style.display='none'; return; }
  const today=new Date();
  const list = rows.filter(r=>{const d=parseJPDate(valAt(r,idx.date)); return d&&sameYMD(d,today)}).sort(makeComparator(idx));
  document.getElementById('todayCount').textContent = list.length;
  renderList(list, idx, document.getElementById('todayBody'));
}
function renderUrgentBanner(){
  const {rows, idx} = cache;
  const n = rows.reduce((a,r)=> a + (idx.urgent!=null && isUrgent(valAt(r, idx.urgent)) ? 1 : 0), 0);
  const b = document.getElementById('urgentBanner');
  if(n>0){ b.style.display='block'; b.textContent = `⚠ 至急案件が ${n} 件あります！早急に確認してください。`; }
  else{ b.style.display='none'; }
}

/* LOAD */
let cache={header:[], rows:[], idx:null};
async function load(){
  const btn=document.getElementById('btnRefresh'); const old=btn.textContent; btn.textContent='Loading...'; btn.disabled=true;
  try{
    const res=await fetch(CSV_URL+"&_ts="+Date.now(),{cache:'no-store'}); if(!res.ok) throw new Error(res.status);
    const text=await res.text(); const data=parseCSV(text); if(!data.length) throw new Error("CSV empty");
    const header=data[0], rows=data.slice(1); const idx=indexByName(header);
    cache={header, rows, idx};
    document.getElementById('rowCount').textContent = rows.length;
    document.getElementById('lastUpdated').textContent='Last update: '+new Date().toLocaleString();
    buildQuickBar(rows, idx);
    renderUrgentBanner();
    renderToday();
    applyAllFilter();
  }catch(e){
    console.error(e);
    alert('読み込みに失敗しました。シート名/公開設定/列名をご確認ください。');
  }finally{
    btn.textContent=old; btn.disabled=false;
  }
}

/* Events */
document.getElementById('btnRefresh').addEventListener('click', load);
document.getElementById('btnLive').addEventListener('click', (e)=>{
  const b=e.currentTarget; const on=b.getAttribute('aria-pressed')==='true';
  b.setAttribute('aria-pressed', String(!on));
});
document.getElementById('filterDate').addEventListener('change', applyAllFilter);
document.getElementById('btnTodayOnly').addEventListener('click', ()=>{
  document.getElementById('filterDate').value = toInputDate(new Date());
  applyAllFilter();
});
document.getElementById('btnClear').addEventListener('click', ()=>{
  document.getElementById('filterDate').value="";
  activeFilter='all';
  buildQuickBar(cache.rows, cache.idx);
  applyAllFilter();
});

/* Init */
window.addEventListener('DOMContentLoaded', load);
</script>
</body>
</html>
