<!doctype html>
<html lang="ja">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>ÂìÅË≥™ÁÆ°ÁêÜÁîüÁî£ÊäÄË°ì„Ç∑„Çπ„ÉÜ„É†</title>

<style>
  :root{
    /* ‚Äî‚Äî‚Äî Brand (blue) ‚Äî‚Äî‚Äî */
    --ink:#0f172a; --muted:#64748b; --muted-2:#94a3b8;
    --bg:#f6f7fb; --panel:#fff; --border:#e5e7eb; --ring:#c7d2fe;
    --accent:#2563eb; --accent-50:#eff6ff; --accent-100:#dbeafe; --accent-200:#bfdbfe; --accent-600:#2563eb; --accent-700:#1d4ed8;
    --purple:#8b5cf6; --warning:#f59e0b; --danger:#ef4444; --success:#10b981; --pink:#ec4899;
    --radius-xl:22px; --radius:14px; --radius-sm:10px;
    --shadow-1:0 12px 30px rgba(15,23,42,.08);
    --shadow-2:0 30px 60px rgba(15,23,42,.10);
  }

  *{box-sizing:border-box}
  html,body{height:100%}
  body{
    margin:0; color:var(--ink);
    font-family:system-ui,-apple-system,Segoe UI,Roboto,"Noto Sans JP","Yu Gothic",sans-serif;
    background:
      radial-gradient(900px 500px at 110% 0%, #dbeafe 0%, transparent 55%),
      radial-gradient(1200px 600px at -10% -10%, #c7d2fe 0%, transparent 60%),
      linear-gradient(120deg,#f8fafc,var(--bg));
  }
  a{color:inherit; text-decoration:none}

  /* ===== Shell ===== */
  .app{
    display:grid; grid-template-rows:64px 1fr; grid-template-areas:"header" "main"; min-height:100vh;
  }
  header{
    grid-area:header; position:sticky; top:0; z-index:50;
    backdrop-filter:blur(12px); background:#ffffffd6; border-bottom:1px solid var(--border);
  }
  .header-wrap{
    height:64px; max-width:1400px; margin:0 auto; display:flex; align-items:center; justify-content:space-between; gap:10px; padding:0 14px;
  }
  .brand{display:flex; align-items:center; gap:12px}
  .brand img{height:36px}
  .ttl{font-weight:800}
  .top-actions{display:flex; gap:8px; align-items:center; flex-wrap:wrap}
  .btn{
    display:inline-flex; align-items:center; gap:8px;
    height:36px; padding:0 14px; border-radius:12px; border:1px solid var(--border); background:#fff; cursor:pointer;
  }
  .btn:hover{border-color:var(--ring)}
  .badge{ display:inline-flex; align-items:center; gap:8px; height:28px; padding:0 10px; font-size:12px; font-weight:700; background:#f1f5f9; border:1px solid var(--border); border-radius:999px }

  /* ===== Hover Sidebar (desktop) ===== */
  .edge-hotspot{ position:fixed; left:0; top:64px; width:12px; height:calc(100vh - 64px); z-index:60; }
  .hover-side{
    position:fixed; left:0; top:64px; height:calc(100vh - 64px);
    width:260px; padding:14px 12px; overflow:auto;
    background:var(--panel); border-right:1px solid var(--border); box-shadow:var(--shadow-1);
    transform:translateX(-100%); transition:transform .22s ease; z-index:61;
  }
  .hover-side.open{ transform:translateX(0) }
  .hover-side h3{ margin:4px 8px 10px; font-size:12px; letter-spacing:.08em; color:#6b7280; text-transform:uppercase }
  .navlist{ display:grid; gap:4px }
  .slink{ display:flex; align-items:center; gap:10px; padding:10px 12px; border-radius:12px; color:var(--ink) }
  .slink:hover{ background:#f1f5ff }
  .ico{ width:22px; text-align:center }

  /* ===== Drawer (mobile) ===== */
  .drawer{ position:fixed; inset:0; z-index:80; display:none }
  .drawer.open{ display:block }
  .drawer .backdrop{ position:absolute; inset:0; background:#0006 }
  .drawer .panel{
    position:absolute; top:0; left:0; height:100%; width:min(86%,320px);
    background:#fff; border-right:1px solid var(--border); box-shadow:var(--shadow-2); padding:14px 12px; overflow:auto;
    transform:translateX(-100%); transition:transform .25s ease
  }
  .drawer.open .panel{ transform:translateX(0) }
  .drawer .close{ position:absolute; right:10px; top:10px; border:0; background:#f1f5f9; border:1px solid var(--border); border-radius:8px; padding:6px 10px; cursor:pointer }

  /* ===== Main ===== */
  main{ grid-area:main; max-width:1400px; margin:0 auto; padding:22px 20px 120px }
  .page-head{ display:flex; justify-content:space-between; align-items:end; gap:16px; margin-bottom:16px }
  .h1{ font-size:22px; margin:0 }
  .small{ font-size:12px; color:var(--muted) }

  .panel{ background:#fff; border:1px solid var(--border); border-radius:var(--radius-xl); box-shadow:var(--shadow-2); padding:18px; overflow:hidden }
  .panel + .panel{ margin-top:18px }
  .panel-title{ display:flex; align-items:center; justify-content:space-between; gap:12px; margin:0 0 12px }

  /* ===== Urgent banner ===== */
  .urgent-banner{
    display:none; place-items:center; text-align:center;
    width:100%; padding:10px 14px; border-radius:12px;
    background:#fee2e2; color:#991b1b; font-weight:800; margin-bottom:14px;
  }
  .urgent-banner span{ display:inline-block }

  /* ===== Quick status chips ===== */
  .chips{ display:flex; flex-wrap:wrap; gap:12px; margin:6px 0 14px }
  .chip{
    --bg:#f8fafc; --fg:#0f172a; --bd:#e5e7eb;
    display:inline-flex; align-items:center; gap:10px;
    padding:8px 14px; border-radius:999px; border:1px solid var(--bd);
    background:var(--bg); color:var(--fg); font-weight:700; cursor:pointer;
  }
  .chip .dot{ min-width:22px; height:22px; border-radius:999px; display:grid; place-items:center; font-size:12px; }
  .chip.on{ background:#eaf2ff; border-color:#c7d2fe; color:#1d4ed8; }
  .chip .count{ background:#fff; border:1px solid var(--bd); border-radius:999px; padding:0 6px; font-size:12px; height:20px; display:inline-grid; place-items:center; }

  /* ===== Table-like cards ===== */
  .thead{ display:grid; grid-template-columns: 1.1fr 1.1fr 1.1fr 1.1fr .7fr 1fr 1.2fr; gap:16px; padding:12px 16px; color:#475569; font-weight:800; border-bottom:1px solid var(--border); background:#f8fafc; }
  .row{ display:grid; grid-template-columns: 1.1fr 1.1fr 1.1fr 1.1fr .7fr 1fr 1.2fr; gap:16px; padding:14px 16px; align-items:center; border-bottom:1px solid var(--border); }
  .row:hover{ background:#f6f9ff }
  .left-box{
    display:grid; grid-template-columns:auto 1fr; grid-template-rows:auto auto; gap:8px 14px; align-items:center;
    padding:14px; background:#f8fafc; border:1px solid var(--border); border-radius:18px; width:min(100%,340px);
  }
  .status-pill{ display:inline-flex; align-items:center; gap:8px; background:var(--accent-600); color:#fff; font-weight:800; padding:8px 14px; border-radius:999px }
  .status-pill .i{ font-size:14px }
  .urgent-pill{ display:inline-flex; align-items:center; gap:6px; background:#fee2e2; color:#991b1b; padding:6px 10px; border-radius:999px; font-weight:800 }
  .date-chip{ display:inline-flex; align-items:center; gap:8px; background:#eaf2ff; color:#1d4ed8; font-weight:800; padding:10px 14px; border-radius:999px }
  .meta{ font-size:13px; color:#334155; }
  .meta b{ font-weight:800 }

  .footer{ position:fixed; bottom:0; left:0; right:0; z-index:31; text-align:center; font-size:12px; color:var(--muted); background:#f1f5f9; padding:4px 0; border-top:1px solid var(--border) }

  @media (max-width:1100px){
    .thead, .row{ grid-template-columns: 1.2fr .9fr .9fr .9fr .7fr 1fr 1.2fr }
  }
  @media (max-width:900px){
    .edge-hotspot, .hover-side{ display:none }
    .thead{ display:none }
    .row{ grid-template-columns: 1fr; gap:10px; border-radius:16px; border:1px solid var(--border); margin:10px 0; }
  }
</style>
</head>
<body>
<div class="app">
  <!-- ===== HEADER ===== -->
  <header>
    <div class="header-wrap">
      <button id="btnBurger" class="btn" type="button">‚ò∞</button>
      <div class="brand">
        <img src="tsh.png" alt="TSH" onerror="this.style.display='none'">
        <div class="ttl"><strong>ÂìÅË≥™ÁÆ°ÁêÜÁîüÁî£ÊäÄË°ì</strong></div>
      </div>
      <nav class="top-actions">
        <button id="btnRefresh" class="btn" type="button">‚ü≥ Refresh</button>
        <button id="btnLive" class="btn" type="button" aria-pressed="false">‚óè Live</button>
        <span id="intervalInfo" class="badge">60s</span>
        <span id="lastUpdated" class="badge">Last update: ‚Äî</span>
      </nav>
    </div>
  </header>

  <main>
    <div id="urgent-banner" class="urgent-banner"><span>‚ö† Ëá≥ÊÄ•Ê°à‰ª∂„Åå <b id="urgentCount">0</b> ‰ª∂„ÅÇ„Çä„Åæ„ÅôÔºÅÊó©ÊÄ•„Å´Á¢∫Ë™ç„Åó„Å¶„Åè„Å†„Åï„ÅÑ„ÄÇ</span></div>

    <!-- ===== ‰ªäÊó• ===== -->
    <section class="panel">
      <div class="panel-title">
        <h2 style="margin:0">Êú¨Êó•Âá∫Ëç∑</h2>
        <span class="badge">‰ª∂Êï∞&nbsp;<b id="todayCount">0</b></span>
      </div>

      <div class="thead" id="todayHead"></div>
      <div id="todayBody"></div>
    </section>

    <!-- ===== ÂÖ®‰ª∂ ===== -->
    <section class="panel">
      <div class="panel-title" style="align-items:center">
        <h2 style="margin:0">ÂÖ®‰ª∂‰∏ÄË¶ß</h2>
        <div style="display:flex; gap:8px; align-items:center; margin-left:auto">
          <label class="small">Âá∫Ëç∑Êó•Ôºö</label>
          <input type="date" id="filterDate" style="height:36px; padding:0 12px; border:1px solid var(--border); border-radius:10px; background:#fff; color:#0f172a">
          <button class="btn" id="btnToday" type="button">Êú¨Êó•Âá∫Ëç∑„ÅÆ„Åø</button>
          <button class="btn" id="btnClear" type="button">Clear</button>
        </div>
      </div>

      <!-- quick filter chips -->
      <div id="chips" class="chips"></div>

      <div class="thead" id="shipHead"></div>
      <div id="shipBody"></div>

      <div class="small" id="shipHint" style="margin-top:8px"></div>
    </section>
  </main>
</div>

<!-- ===== Hover Sidebar (desktop) ===== -->
<div id="edgeHotspot" class="edge-hotspot" aria-hidden="true"></div>
<aside id="hoverSide" class="hover-side" aria-label="Pages">
  <h3>Pages</h3>
  <div class="navlist">
    <a class="slink" href="./index.html"><span class="ico">üè†</span><strong>„Éõ„Éº„É†</strong><small style="color:#9ca3af;margin-left:6px">Dashboard</small></a>
    <a class="slink" href="./forms.html"><span class="ico">üìÑ</span><strong>Âá∫Ëç∑Ê§úÊüªÊàêÁ∏æÊõ∏</strong></a>
    <a class="slink" href="./sagyoutejunsho.html"><span class="ico">üìù</span><strong>‰ΩúÊ•≠ÊâãÈ†ÜÊõ∏</strong></a>
    <a class="slink" href="./charts.html"><span class="ico">üìà</span><strong>„ÉÅ„É£„Éº„Éà</strong></a>
    <a class="slink" href="./quality.html"><span class="ico">üîé</span><strong>ÂìÅË≥™ÊÉÖÂ†±</strong></a>
    <a class="slink" href="./claim.html"><span class="ico">üß™</span><strong>Trial Page</strong></a>
    <div style="margin-top:12px">
      <h3>Admin</h3>
      <div class="navlist">
        <a class="slink" href="./admin-numbering.html"><span class="ico">#</span><strong>Admin Numbering</strong></a>
        <a class="slink" href="./admin-prefix.html"><span class="ico">üîß</span><strong>Admin Prefix / Ë£ΩÈÄ†No</strong></a>
        <a class="slink" href="./admin-serial-gas.html"><span class="ico">‚õΩ</span><strong>Admin Serial Gas</strong></a>
        <a class="slink" href="./thanks.html"><span class="ico">‚ú®</span><strong>Thanks</strong></a>
      </div>
    </div>
  </div>
</aside>

<!-- ===== Drawer (mobile) ===== -->
<div id="drawer" class="drawer" aria-hidden="true">
  <div class="backdrop" data-close></div>
  <aside class="panel">
    <button class="close" data-close>‚úï</button>
    <div class="navlist" style="margin-top:30px">
      <a class="slink" href="./index.html"><span class="ico">üè†</span><strong>„Éõ„Éº„É†</strong></a>
      <a class="slink" href="./forms.html"><span class="ico">üìÑ</span><strong>Âá∫Ëç∑Ê§úÊüªÊàêÁ∏æÊõ∏</strong></a>
      <a class="slink" href="./sagyoutejunsho.html"><span class="ico">üìù</span><strong>‰ΩúÊ•≠ÊâãÈ†ÜÊõ∏</strong></a>
      <a class="slink" href="./charts.html"><span class="ico">üìà</span><strong>„ÉÅ„É£„Éº„Éà</strong></a>
      <a class="slink" href="./quality.html"><span class="ico">üîé</span><strong>ÂìÅË≥™ÊÉÖÂ†±</strong></a>
      <a class="slink" href="./claim.html"><span class="ico">üß™</span><strong>Trial Page</strong></a>
    </div>
  </aside>
</div>

<div class="footer">Design by Wahyu</div>

<!-- ===== LIBS ===== -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>

<script>
/* ========= Drawer (mobile) ========= */
const drawer = document.getElementById('drawer');
document.getElementById('btnBurger')?.addEventListener('click', ()=>{ drawer.classList.add('open'); drawer.setAttribute('aria-hidden','false'); });
drawer?.addEventListener('click', (e)=>{ if(e.target.hasAttribute('data-close')){ drawer.classList.remove('open'); drawer.setAttribute('aria-hidden','true'); }});

/* ========= EDGE-HOVER sidebar (desktop) ========= */
const hot = document.getElementById('edgeHotspot');
const fly = document.getElementById('hoverSide');
let hideTimer = null;
const HIDE_DELAY = 280;
function openFly(){ clearTimeout(hideTimer); fly.classList.add('open'); }
function scheduleClose(){ clearTimeout(hideTimer); hideTimer = setTimeout(()=>fly.classList.remove('open'), HIDE_DELAY); }
hot?.addEventListener('mouseenter', openFly);
hot?.addEventListener('mouseleave', scheduleClose);
fly?.addEventListener('mouseenter', ()=> clearTimeout(hideTimer));
fly?.addEventListener('mouseleave', scheduleClose);

/* ========= Data Source ========= */
const SHEET_ID ="1lYl7oYk6atnm3KqC6VwufARX3ooRyJ2VmC_xYFb4-OE";
const TAB_NAME ="ÊúÄÊñ∞ÊÉÖÂ†±";
const CSV_URL  =`https://docs.google.com/spreadsheets/d/${SHEET_ID}/gviz/tq?tqx=out:csv&sheet=${encodeURIComponent(TAB_NAME)}`;

/* ========= Helpers ========= */
const S = s => String(s ?? '').trim();

function parseCSV(t){
  const rows=[], re=/\s*("(?:[^"]|"")*"|[^,]*)\s*(,|\n|$)/g;
  let m,row=[]; t=t.replace(/\r\n?/g,"\n");
  for(let i=0;i<t.length;){ re.lastIndex=i; m=re.exec(t); if(!m) break;
    let cell=m[1]; if(cell.startsWith('"')) cell=cell.slice(1,-1).replace(/""/g,'"');
    row.push(cell); i=re.lastIndex;
    if(m[2]==="\n"||m[2]===""){ rows.push(row); row=[]; }
  }
  return rows.filter(r=>r.length && r.some(c=>S(c)!==""));
}

function indexByName(header){
  const map={}; header.forEach((h,i)=>map[S(h)]=i);
  const find=nms=>{ for(const n of nms){ if(n in map) return map[n]; } return null; };
  const findFz=re=>{ for(let i=0;i<header.length;i++){ if(re.test(S(header[i]))) return i; } return null; };
  return {
    date:find(["Âá∫Ëç∑Êó•","Êó•‰ªò","Date"]),
    cust:find(["È°ßÂÆ¢Âêç","ÂÆ¢ÂÖà","Customer"]),
    draw:find(["Âõ≥Áï™","Drawing","Âõ≥Èù¢"]),
    machine:find(["Ê©üÁ®Æ","Ê©üÁ®ÆÂêç","Machine"]),
    item:find(["ÂïÜÂìÅÂêç","ÂìÅÂêç","Item"]),
    qty:find(["Êï∞Èáè","Qty"]),
    to:find(["ÈÄÅ„ÇäÂÖà","Á¥çÂìÅÂÖà","ÈÄÅ‰ªòÂÖà"]),
    note:find(["Ê≥®Áï™","Ê≥®ÊñáÁï™Âè∑","ÂÇôËÄÉ","Ê≥®Êñá","Order","Ê≥®Èáà"]),
    status_done:find(["Ë£ΩÂìÅÁä∂Ê≥Å","Ë£ΩÂìÅÁä∂ÊÖã","Á¥çÂìÅÁä∂Ê≥Å"]) ?? findFz(/(Ë£ΩÂìÅ|Á¥çÂìÅ).*(Áä∂Ê≥Å|Áä∂ÊÖã)/),
    status_flag:find(["Status","„Çπ„ÉÜ„Éº„Çø„Çπ","Áä∂ÊÖã","Ëá≥ÊÄ•"]) ?? findFz(/status|Ëá≥ÊÄ•/i),
    qc_check:find(["Ê§úÊüª„ÉÅ„Çß„ÉÉ„ÇØ„Ç∑„Éº„Éà","Ê§úÊüªÔæÅÔΩ™ÔΩØÔΩ∏ÔΩºÔΩ∞ÔæÑ","CheckSheet"]) ?? findFz(/(Ê§úÊüª|ÔæÅÔΩ™ÔΩØÔΩ∏|„ÉÅ„Çß„ÉÉ„ÇØ).*„Ç∑„Éº„Éà|check/i),
    qc_label:find(["„ÉÜ„Éó„É©","ÔæÉÔæåÔæüÔæó","„É©„Éô„É´","Label"]) ?? findFz(/(ÔæÉÔæåÔæüÔæó|„ÉÜ„Éó„É©|ÔæóÔæçÔæûÔæô|„É©„Éô„É´|label)/i),
    qc_result:find(["Ê§úÊüªÊàêÁ∏æË°®","ÊàêÁ∏æË°®","InspectionReport"]) ?? findFz(/(Ê§úÊüª|inspection).*(ÊàêÁ∏æ|report)/i),
    qc_pack:find(["Ê¢±ÂåÖ","Packing","ÂåÖË£Ö"]) ?? findFz(/(Ê¢±ÂåÖ|packing|ÂåÖË£Ö)/i),
    updatedAt:find(["Ë£ΩÂìÅÁä∂Ê≥ÅÊõ¥Êñ∞Êó•ÊôÇ","Êõ¥Êñ∞Êó•ÊôÇ","Êõ¥Êñ∞Êó•"]),
    updatedBy:find(["Êõ¥Êñ∞ËÄÖ","ÂÖ•ÂäõËÄÖ"]),
  };
}
const valAt=(row,idx)=>(idx==null?"":(row[idx]??""));

function parseJPDate(str){
  const s=String(str??"").trim();
  const mJP=s.match(/^(\d{4})\D(\d{1,2})\D(\d{1,2})/);
  if(mJP) return new Date(mJP[1],mJP[2]-1,mJP[3]);
  const p=s.replaceAll('-','/').split('/'); if(p.length===3) return new Date(p[0],p[1]-1,p[2]);
  const d=new Date(s); return isNaN(d)?null:d;
}
function sameYMD(a,b){return a&&b&&a.getFullYear()===b.getFullYear()&&a.getMonth()===b.getMonth()&&a.getDate()===b.getDate()}
function toInputDate(d){const z=n=>String(n).padStart(2,'0'); return `${d.getFullYear()}-${z(d.getMonth()+1)}-${z(d.getDate())}`}
function fmtYYMMDD(d){const z=n=>String(n).padStart(2,'0'); return `${String(d.getFullYear()).slice(2)}/${z(d.getMonth()+1)}/${z(d.getDate())}`}

/* ========= Status mapping (ikon + label) ========= */
const STATUS_META = {
  "„É¨„Éº„Ç∂Âä†Â∑•": {icon:"üõ†Ô∏è", color:"#1d4ed8"},
  "ÊùøÈáëÂä†Â∑•":   {icon:"üõ†Ô∏è", color:"#1d4ed8"},
  "Â§ñÊ≥®":       {icon:"üèóÔ∏è", color:"#0ea5e9"},
  "Âä†Â∑•ÂÆå‰∫Ü":   {icon:"üß∞", color:"#64748b"},
  "ÁµÑÁ´ã‰∏≠":     {icon:"üß∞", color:"#f59e0b"},
  "ÁµÑÁ´ãÂÆå‰∫Ü":   {icon:"‚úÖ", color:"#10b981"},
  "Ê§úÊüª‰∏≠":     {icon:"üß™", color:"#3b82f6"},
  "Ê§úÊüªÂÆå‰∫Ü":   {icon:"‚úîÔ∏è", color:"#10b981"},
  "Ê§úÊüªÊ∏à":     {icon:"‚úîÔ∏è", color:"#10b981"},
  "Âá∫Ëç∑Ê∫ñÂÇôÊ∏à": {icon:"üöö", color:"#2563eb"},
};
const STATUS_ORDER = ["„É¨„Éº„Ç∂Âä†Â∑•","ÊùøÈáëÂä†Â∑•","Â§ñÊ≥®","Âä†Â∑•ÂÆå‰∫Ü","ÁµÑÁ´ã‰∏≠","ÁµÑÁ´ãÂÆå‰∫Ü","Ê§úÊüª‰∏≠","Ê§úÊüªÂÆå‰∫Ü","Âá∫Ëç∑Ê∫ñÂÇôÊ∏à"];

/* ========= Sorter ========= */
function getStatusFromValue(val){
  const raw=S(val);
  if(!raw) return {label:"", cls:""};
  for(const k of STATUS_ORDER){ if(raw.includes(k)) return {label:k, cls:""}; }
  // legacy fallback
  if(/(Ê§úÊüª)/.test(raw)) return {label:"Ê§úÊüª‰∏≠", cls:""};
  if(/(ÁµÑÁ´ã‰∏≠)/.test(raw)) return {label:"ÁµÑÁ´ã‰∏≠", cls:""};
  return {label:raw, cls:""};
}
function makeComparator(idx){
  const rank=s=>({ "Ê§úÊüª‰∏≠":1,"ÁµÑÁ´ã‰∏≠":2,"„É¨„Éº„Ç∂Âä†Â∑•":3,"ÊùøÈáëÂä†Â∑•":4,"Â§ñÊ≥®":5,"Âä†Â∑•ÂÆå‰∫Ü":6,"ÁµÑÁ´ãÂÆå‰∫Ü":7,"Ê§úÊüªÂÆå‰∫Ü":8,"Ê§úÊüªÊ∏à":8,"Âá∫Ëç∑Ê∫ñÂÇôÊ∏à":9 }[s]??99);
  return (a,b)=>{
    const au=idx.status_flag!=null && /Ëá≥ÊÄ•|urgent|Á∑äÊÄ•|1|true/i.test(valAt(a,idx.status_flag));
    const bu=idx.status_flag!=null && /Ëá≥ÊÄ•|urgent|Á∑äÊÄ•|1|true/i.test(valAt(b,idx.status_flag));
    if(au!==bu) return au?-1:1;
    const sa=getStatusFromValue(valAt(a,idx.status_done)).label;
    const sb=getStatusFromValue(valAt(b,idx.status_done)).label;
    if(rank(sa)!==rank(sb)) return rank(sa)-rank(sb);
    const da=idx.date!=null?parseJPDate(valAt(a,idx.date)):null;
    const db=idx.date!=null?parseJPDate(valAt(b,idx.date)):null;
    const ta=da?da.getTime():-Infinity, tb=db?db.getTime():-Infinity;
    return tb-ta;
  };
}

/* ========= Rendering ========= */
function renderHead(headerEl){
  headerEl.innerHTML = `
    <div>Áä∂Ê≥Å</div>
    <div>Âá∫Ëç∑Êó•</div>
    <div>È°ßÂÆ¢Âêç</div>
    <div>Âõ≥Áï™</div>
    <div>Ê©üÁ®Æ</div>
    <div>Êï∞Èáè</div>
    <div>ÈÄÅ„ÇäÂÖàÔºèÊ≥®Áï™</div>
  `;
}

function renderCard(row, idx){
  const stRaw = valAt(row, idx.status_done);
  const st = getStatusFromValue(stRaw).label;
  const meta = STATUS_META[st] || {icon:"üîπ", color:"#2563eb"};
  const urgent = idx.status_flag!=null && /Ëá≥ÊÄ•|urgent|Á∑äÊÄ•|1|true/i.test(valAt(row,idx.status_flag));

  const d = idx.date!=null?parseJPDate(valAt(row,idx.date)):null;
  const dateText = d ? `${d.getFullYear()}-${String(d.getMonth()+1).padStart(2,'0')}-${String(d.getDate()).padStart(2,'0')}` : "";

  const upd = idx.updatedAt!=null ? valAt(row,idx.updatedAt) : "";
  let updText = "";
  if(upd){
    const du = parseJPDate(upd);
    updText = du ? fmtYYMMDD(du) : S(upd);
  }

  const updBy = idx.updatedBy!=null ? S(valAt(row,idx.updatedBy)) : "";

  const left = `
    <div class="left-box">
      <div class="status-pill" style="background:${meta.color}">
        <span class="i">${meta.icon}</span><span>${st||'‚Äî'}</span>
      </div>
      ${urgent?`<div class="urgent-pill">‚ö† Ëá≥ÊÄ•</div>`:""}
      <div class="meta"><b>Êõ¥Êñ∞Êó•</b>Ôºö${updText||'‚Äî'}</div>
      <div class="meta"><b>Êõ¥Êñ∞ËÄÖ</b>Ôºö${updBy||'‚Äî'}</div>
    </div>
  `;

  const right = `
    <div class="date-chip">üìÖ ${dateText||'‚Äî'}</div>
    <div>${S(valAt(row, idx.cust))||'‚Äî'}</div>
    <div>${S(valAt(row, idx.draw))||'‚Äî'}</div>
    <div>${S(valAt(row, idx.machine))||'‚Äî'}</div>
    <div>${S(valAt(row, idx.qty))||'‚Äî'}</div>
    <div>
      ${S(valAt(row, idx.to))||'‚Äî'}
      ${S(valAt(row, idx.note)) ? `<span style="margin-left:10px; background:#eef2ff; border:1px solid #e5e7eb; padding:6px 10px; border-radius:999px; font-weight:700; color:#4f46e5">${S(valAt(row, idx.note))}</span>`:""}
    </div>
  `;

  return `<div class="row">${left}${right}</div>`;
}

/* ========= State ========= */
let cached={header:[],rows:[],idx:null,cmp:null};
let timer=null,intervalMs=60000;
let activeStatus=null; // quick filter status
let filteredDate=null; // date filter (for bottom only)

/* ========= Load ========= */
async function load(){
  try{
    const btn=document.getElementById('btnRefresh'); const old=btn.textContent; btn.textContent='Loading...'; btn.disabled=true;

    const res=await fetch(CSV_URL+"&_ts="+Date.now(),{cache:'no-store'});
    if(!res.ok) throw new Error("HTTP "+res.status);
    const text=await res.text(); const data=parseCSV(text); if(!data.length) throw new Error("CSV empty");
    const header=data[0], rowsRaw=data.slice(1); const idx=indexByName(header); const cmp=makeComparator(idx);
    const rows=[...rowsRaw].sort(cmp); cached={header,rows,idx,cmp};

    // urgent count (from Status column)
    const urgentCount=rows.reduce((n,r)=> n + (idx.status_flag!=null && /Ëá≥ÊÄ•|urgent|Á∑äÊÄ•|1|true/i.test(valAt(r, idx.status_flag)) ? 1 : 0), 0);
    const banner=document.getElementById('urgent-banner');
    const cnt=document.getElementById('urgentCount'); cnt.textContent=urgentCount;
    banner.style.display = urgentCount>0 ? 'grid' : 'none';

    // render heads
    renderHead(document.getElementById('todayHead'));
    renderHead(document.getElementById('shipHead'));

    // render sections
    renderTodaySection(); // always today
    filteredDate = (document.getElementById('filterDate').value || null); // keep user choice
    renderAllSection();

    // chips
    buildChips();

    // hint & timestamp
    const cols=[]; if(idx.qty!=null) cols.push('Êï∞Èáè:'+header[idx.qty]); if(idx.cust!=null) cols.push('È°ßÂÆ¢:'+header[idx.cust]); if(idx.date!=null) cols.push('Âá∫Ëç∑Êó•:'+header[idx.date]);
    document.getElementById('shipHint').textContent=`„Éá„Éº„ÇøÂÖÉ: ${TAB_NAME}Ôºà${rows.length} Ë°åÔºâÔΩú${cols.join(' ÔΩú ')} ÔΩú UrgentÂàó: ${idx.status_flag!=null ? header[idx.status_flag] : '‚Äî'}`;
    document.getElementById('lastUpdated').textContent='Last update: '+new Date().toLocaleString();

    btn.textContent=old; btn.disabled=false;
  }catch(e){
    console.error(e);
    const btn=document.getElementById('btnRefresh'); btn.textContent='Refresh'; btn.disabled=false;
    document.getElementById('shipHint').textContent='Ë™≠„ÅøËæº„Åø„Å´Â§±Êïó„Åó„Åæ„Åó„Åü„ÄÇ„Ç∑„Éº„ÉàÂêç/ÂÖ¨ÈñãË®≠ÂÆö/ÂàóÂêç„Çí„ÅîÁ¢∫Ë™ç„Åè„Å†„Åï„ÅÑ„ÄÇ';
  }
}

/* ========= Render top (today) ========= */
function renderTodaySection(){
  const {rows,idx,cmp}=cached; if(idx.date==null){ document.getElementById('todayBody').innerHTML=''; document.getElementById('todayCount').textContent='0'; return; }
  const today=new Date();
  const list=rows.filter(r=>{const d=parseJPDate(valAt(r,idx.date)); return d&&sameYMD(d,today)}).sort(cmp);
  document.getElementById('todayBody').innerHTML = list.map(r=>renderCard(r,idx)).join('') || `<div style="padding:12px 16px;color:#64748b">Êú¨Êó•Âá∫Ëç∑„ÅØ„ÅÇ„Çä„Åæ„Åõ„Çì„ÄÇ</div>`;
  document.getElementById('todayCount').textContent=list.length;
}

/* ========= Render bottom (all with filters) ========= */
function renderAllSection(){
  const {rows,idx,cmp}=cached;
  let view=[...rows];

  // date filter (bottom only)
  if(idx.date!=null && filteredDate){
    const target=new Date(filteredDate+"T00:00:00");
    view = view.filter(r=>{const d=parseJPDate(valAt(r,idx.date)); return d&&sameYMD(d,target)}).sort(cmp);
  }

  // quick status filter
  if(activeStatus){
    view = view.filter(r=> getStatusFromValue(valAt(r,idx.status_done)).label === activeStatus );
  }

  document.getElementById('shipBody').innerHTML = view.map(r=>renderCard(r,idx)).join('') || `<div style="padding:12px 16px;color:#64748b">Ë©≤ÂΩì„Éá„Éº„Çø„Åå„ÅÇ„Çä„Åæ„Åõ„Çì„ÄÇ</div>`;
}

/* ========= Chips ========= */
function buildChips(){
  const {rows,idx}=cached;
  const area=document.getElementById('chips'); area.innerHTML="";

  // count per status
  const countBy={ "„Åô„Åπ„Å¶": rows.length };
  for(const st of STATUS_ORDER) countBy[st]=0;
  for(const r of rows){
    const st = getStatusFromValue(valAt(r,idx.status_done)).label;
    if(st && st in countBy) countBy[st]++; else if(st) countBy[st]= (countBy[st]||0)+1;
  }

  function chipHTML(key, label, icon){
    const on = activeStatus===key;
    return `
      <div class="chip ${on?'on':''}" data-key="${key}">
        <span class="dot">${icon||'üåê'}</span>
        <span>${label}</span>
        <span class="count">${countBy[key]??0}</span>
      </div>`;
  }

  // all
  area.insertAdjacentHTML('beforeend', chipHTML(null, "„Åô„Åπ„Å¶", "üåê"));
  // statuses
  for(const st of STATUS_ORDER){
    const icon = (STATUS_META[st]?.icon)||'üîπ';
    area.insertAdjacentHTML('beforeend', chipHTML(st, st, icon));
  }

  // click
  area.querySelectorAll('.chip').forEach(ch=>{
    ch.addEventListener('click', ()=>{
      const key = ch.getAttribute('data-key');
      activeStatus = (key===activeStatus) ? null : key;
      buildChips();
      renderAllSection();
    });
  });
}

/* ========= Export/Refresh ========= */
function exportExcel(){
  const table=document.createElement("table");
  const headRow=document.createElement("tr");
  ["Áä∂Ê≥Å","Âá∫Ëç∑Êó•","È°ßÂÆ¢Âêç","Âõ≥Áï™","Ê©üÁ®Æ","Êï∞Èáè","ÈÄÅ„ÇäÂÖàÔºèÊ≥®Áï™"].forEach(h=>{ const th=document.createElement("th"); th.textContent=h; headRow.appendChild(th); });
  table.appendChild(headRow);
  // For simplicity: export bottom view only (filtered)
  // (You can expand to include ‚Äútoday‚Äù if you like)
  table.appendChild(document.createElement("tbody"));
  const tmp=document.createElement("div"); tmp.innerHTML=document.getElementById("shipBody").innerHTML;
  // Just dump text (simple)
  const trs=[...tmp.querySelectorAll(".row")];
  trs.forEach(row=>{
    const tr=document.createElement("tr");
    [...row.children].forEach((cell,i)=>{
      const td=document.createElement("td"); td.textContent=cell.textContent.replace(/\s+/g,' ').trim(); tr.appendChild(td);
    });
    table.querySelector("tbody").appendChild(tr);
  });
  const wb=XLSX.utils.table_to_book(table,{sheet:"Âá∫Ëç∑Áä∂Ê≥Å"});
  XLSX.writeFile(wb,"Âá∫Ëç∑Áä∂Ê≥Å.xlsx");
}

document.getElementById("btnRefresh").addEventListener("click", load);
document.getElementById("btnLive").addEventListener("click", ()=>{
  startAutoRefresh(intervalMs<=5000?60000:5000);
  load();
});
document.getElementById("btnClear").addEventListener("click", ()=>{
  document.getElementById('filterDate').value="";
  filteredDate=null;
  renderAllSection();
});
document.getElementById('btnToday').addEventListener('click', ()=>{
  const today=toInputDate(new Date());
  document.getElementById('filterDate').value=today;
  filteredDate=today;
  renderAllSection();
});
document.getElementById('filterDate').addEventListener('change', e=>{
  filteredDate = e.target.value || null;
  renderAllSection();
});

function startAutoRefresh(ms){
  intervalMs=ms; clearInterval(timer);
  timer=setInterval(()=>{ if(document.visibilityState==='visible') load(); }, intervalMs);
  document.getElementById('intervalInfo').textContent=`${Math.round(intervalMs/1000)}s`;
}

/* ===== Init ===== */
window.addEventListener('DOMContentLoaded', ()=>{
  // default: TOP shows today. BOTTOM shows ALL (no date set)
  document.getElementById('filterDate').value=""; // show all by default
  startAutoRefresh(60000);
  load();
});
</script>
</body>
</html>
