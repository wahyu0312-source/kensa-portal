<!doctype html>
<html lang="ja">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>å“è³ªç®¡ç†ç”Ÿç”£æŠ€è¡“ã‚·ã‚¹ãƒ†ãƒ </title>

<style>
  :root{
    --bg:#f6f7fb; --panel:#fff; --ink:#0f172a; --muted:#64748b; --border:#e5e7eb; --ring:#c7d2fe;
    --accent:#2563eb; --danger:#dc2626; --success:#10b981; --warning:#f59e0b; --purple:#8b5cf6;
    --radius-xl:22px; --radius:12px; --shadow-1:0 12px 30px rgba(15,23,42,.08); --shadow-2:0 30px 60px rgba(15,23,42,.10);
    --gutter-w: 88px;
  }
  *{box-sizing:border-box}
  html,body{height:100%}
  body{
    margin:0; color:var(--ink);
    font-family:system-ui,-apple-system,Segoe UI,Roboto,"Noto Sans JP","Yu Gothic",sans-serif;
    background:
      radial-gradient(1200px 600px at -10% -10%, #c7d2fe 0%, transparent 60%),
      radial-gradient(900px 500px at 110% 0%, #bae6fd 0%, transparent 55%),
      linear-gradient(120deg,#f8fafc,var(--bg));
  }
  a{color:inherit; text-decoration:none}

  /* ===== Shell ===== */
  .app{display:grid; grid-template-rows:64px 1fr; grid-template-areas:"header" "main"; min-height:100vh}
  header{grid-area:header; position:sticky; top:0; z-index:60; backdrop-filter:blur(12px); background:#ffffffc7; border-bottom:1px solid var(--border)}
  .header-wrap{height:64px; max-width:1400px; margin:0 auto; display:flex; align-items:center; justify-content:space-between; gap:10px; padding:0 14px}
  .brand{display:flex; align-items:center; gap:10px}
  .brand img{height:36px}
  .ttl{font-weight:800}
  .top-actions{display:flex; gap:8px; align-items:center; flex-wrap:wrap}
  .btn{display:inline-flex; align-items:center; gap:8px; line-height:1; height:34px; padding:0 12px; border-radius:10px; border:1px solid var(--border); background:#fff; cursor:pointer}
  .btn:hover{border-color:var(--ring)}
  .badge{height:28px; padding:0 10px; display:inline-flex; align-items:center; gap:8px; font-size:12px; font-weight:700; color:var(--ink); background:#f1f5f9; border:1px solid var(--border); border-radius:999px}
  .burger{display:none; align-items:center; justify-content:center; width:38px; height:38px; border:1px solid var(--border); border-radius:10px; background:#fff; cursor:pointer}
  .burger:active{transform:scale(.98)}

  /* ===== Hover Sidebar (desktop) ===== */
  .edge-hotspot{ position:fixed; left:0; top:64px; width:12px; height:calc(100vh - 64px); z-index:70; }
  .hover-side{
    position:fixed; left:0; top:64px; height:calc(100vh - 64px);
    width:260px; padding:14px 12px; overflow:auto;
    background:var(--panel); border-right:1px solid var(--border); box-shadow:var(--shadow-1);
    transform:translateX(-100%); transition:transform .22s ease; z-index:71;
  }
  .hover-side.open{ transform:translateX(0) }
  .hover-side h3{ margin:4px 8px 10px; font-size:12px; letter-spacing:.08em; color:#6b7280; text-transform:uppercase }
  .navlist{ display:grid; gap:4px }
  .slink{ display:flex; align-items:center; gap:10px; padding:10px 12px; border-radius:12px; color:var(--ink) }
  .slink:hover{ background:#f1f5ff }
  .ico{ width:22px; text-align:center }

  /* ===== Drawer (mobile) ===== */
  .drawer{ position:fixed; inset:0; z-index:80; display:none }
  .drawer.open{ display:block }
  .drawer .backdrop{ position:absolute; inset:0; background:#0006 }
  .drawer .panel{ position:absolute; top:0; left:0; height:100%; width:min(86%,320px); background:#fff; border-right:1px solid var(--border); box-shadow:var(--shadow-2); padding:14px 12px; overflow:auto; transform:translateX(-100%); transition:transform .25s ease }
  .drawer.open .panel{ transform:translateX(0) }
  .drawer .close{ position:absolute; right:10px; top:10px; border:0; background:#f1f5f9; border:1px solid var(--border); border-radius:8px; padding:6px 10px; cursor:pointer }

  /* ===== Main ===== */
  main{ grid-area:main; max-width:1400px; margin:0 auto; padding:22px 20px 96px }
  .page-head{ display:flex; justify-content:space-between; align-items:end; gap:16px; margin-bottom:14px }
  .h1{ font-size:22px; margin:0 }
  .small{ font-size:12px; color:var(--muted) }
  .panel{ background:#fff; border:1px solid var(--border); border-radius:var(--radius-xl); box-shadow:var(--shadow-2); padding:18px; overflow:auto }
  .panel + .panel{ margin-top:18px }
  .panel-title{ display:flex; align-items:center; justify-content:space-between; gap:12px; margin:0 0 12px }

  /* ===== Table ===== */
  table{width:100%; border-collapse:separate; border-spacing:0; min-width:1000px}
  thead th{position:sticky; top:0; z-index:2; background:#f8fafc; color:#475569; text-align:left; font-weight:800; padding:12px 14px; border-bottom:1px solid var(--border)}
  tbody td{padding:12px 14px; border-bottom:1px solid var(--border); white-space:nowrap; background:#fff}
  tbody tr:hover td{background:#f6f9ff}
  tbody tr.row-urgent td{background:#fee2e2 !important; color:#b91c1c; font-weight:600}
  .flag-urgent{display:inline-flex; align-items:center; gap:6px; padding:2px 10px; margin-right:8px; border-radius:999px; background:var(--danger); color:#fff; font-weight:800; font-size:12px}

  /* ===== LEFT GUTTER (sticky), looks like in screenshot ===== */
  .gutter-th, .gutter-td{
    position:sticky; left:0; z-index:3; width:var(--gutter-w); min-width:var(--gutter-w); max-width:var(--gutter-w);
    background:linear-gradient(180deg,#f8fafc,#eef2ff);
    border-right:1px solid var(--border);
  }
  .gutter-td{ z-index:1; background:linear-gradient(180deg,#ffffff,#f8fafc)}
  .gutter-box{
    display:flex; flex-direction:column; align-items:flex-start; gap:6px;
    padding:8px 8px; min-height:60px;
  }
  .status-badge{ display:inline-flex; align-items:center; padding:2px 10px; border-radius:999px; font-weight:800; font-size:12px; color:#fff }
  .tag-done{background:#0ea5e9}.tag-assem{background:var(--warning)}.tag-assem-done{background:var(--success)}.tag-inspect{background:#8b5cf6}.tag-not{background:#94a3b8}
  .status-meta{font-size:11px; line-height:1.25; color:#475569; white-space:normal}

  /* å‡ºè·æ—¥ chip */
  .chip{display:inline-block; padding:6px 12px; border-radius:999px; font-size:12px; font-weight:800; border:1px solid #cfe8ff; background:#e0f2fe; color:#0f172a}
  .chip-date{ background:#e0f2fe; border-color:#bae6fd}

  /* Ticker + footer */
  .marquee{position:fixed; left:20px; right:20px; bottom:20px; z-index:30; background:var(--accent); color:#fff; font-weight:800; border-radius:12px; box-shadow:var(--shadow-1); white-space:nowrap; overflow:hidden}
  .marquee span{display:inline-block; padding:8px 0 8px 100%; animation:marquee 25s linear infinite}
  @keyframes marquee{0%{transform:translateX(0)}100%{transform:translateX(-100%)}}
  .footer{position:fixed; bottom:0; left:0; right:0; z-index:31; text-align:center; font-size:12px; color:#64748b; background:#f1f5f9; padding:4px 0; border-top:1px solid var(--border)}

  .admin-only{ display:none }
  @media (max-width:900px){ .burger{ display:inline-flex } .edge-hotspot, .hover-side{ display:none } }
</style>
</head>

<body>
<div class="app">
  <!-- ===== HEADER ===== -->
  <header>
    <div class="header-wrap">
      <button id="btnBurger" class="burger" aria-label="ãƒ¡ãƒ‹ãƒ¥ãƒ¼"><span>â˜°</span></button>
      <div class="brand">
        <img src="tsh.png" alt="TSH" onerror="this.style.display='none'">
        <div class="ttl"><strong>å“è³ªç®¡ç†ç”Ÿç”£æŠ€è¡“</strong></div>
      </div>
      <nav class="top-actions">
        <button id="btnRefresh" class="btn" type="button">âŸ³ Refresh</button>
        <button id="btnLive" class="btn" type="button" aria-pressed="false">â— Live</button>
        <span id="intervalInfo" class="badge">60s</span>
        <button id="btnAdmin" class="btn" type="button" title="Admin login/logout">ç®¡ç†</button>
      </nav>
    </div>
  </header>

  <!-- ===== MAIN ===== -->
  <main>
    <div class="page-head">
      <h1 class="h1">å‡ºè·çŠ¶æ³ä¸€è¦§</h1>
      <span id="lastUpdated" class="small"></span>
    </div>

    <div id="urgent-banner" class="urgent-banner" style="display:none">ç¾åœ¨ã€è‡³æ€¥æ¡ˆä»¶ã¯ã‚ã‚Šã¾ã›ã‚“ã€‚</div>

    <!-- æœ¬æ—¥å‡ºè· -->
    <section id="todaySection" class="panel" style="display:none">
      <div class="panel-title">
        <h2 style="margin:0">æœ¬æ—¥å‡ºè·</h2>
        <span class="badge"><strong>ä»¶æ•°</strong>&nbsp;<span id="todayCount" style="font-weight:800">0</span></span>
      </div>
      <table id="todayTable">
        <thead><tr id="todayHead"></tr></thead>
        <tbody id="todayBody"></tbody>
      </table>
    </section>

    <!-- å…¨ä»¶ä¸€è¦§ -->
    <section class="panel">
      <div class="panel-title">
        <h2 style="margin:0">å…¨ä»¶ä¸€è¦§</h2>
        <div style="display:flex; gap:8px; align-items:center; flex-wrap:wrap">
          <label class="small">å‡ºè·æ—¥ï¼š</label>
          <input type="date" id="filterDate" style="height:36px; padding:0 12px; border:1px solid var(--border); border-radius:10px; background:#fff; color:#0f172a">
          <button class="btn" id="btnToday" type="button">æœ¬æ—¥å‡ºè·ã®ã¿</button>
          <button class="btn" id="btnClear" type="button">Clear</button>
          <div style="margin-left:auto; display:flex; gap:8px">
            <button class="btn" id="btnExcel" type="button">â¬‡ Excel</button>
            <button class="btn" id="btnPDF" type="button">â¬‡ PDF</button>
          </div>
        </div>
      </div>
      <table id="shipTable">
        <thead><tr id="shipHead"></tr></thead>
        <tbody id="shipBody"></tbody>
      </table>
      <div class="small" id="shipHint" style="margin-top:8px"></div>
    </section>
  </main>
</div>

<!-- ===== Hover Sidebar (desktop) ===== -->
<div id="edgeHotspot" class="edge-hotspot" aria-hidden="true"></div>
<aside id="hoverSide" class="hover-side" aria-label="Pages">
  <h3>Pages</h3>
  <div class="navlist">
    <a class="slink" href="./index.html"><span class="ico">ğŸ </span><strong>ãƒ›ãƒ¼ãƒ </strong><small style="color:#9ca3af;margin-left:6px">Dashboard</small></a>
    <a class="slink" href="./forms.html"><span class="ico">ğŸ“„</span><strong>å‡ºè·æ¤œæŸ»æˆç¸¾æ›¸</strong></a>
    <a class="slink" href="./sagyoutejunsho.html"><span class="ico">ğŸ“</span><strong>ä½œæ¥­æ‰‹é †æ›¸</strong></a>
    <a class="slink" href="./charts.html"><span class="ico">ğŸ“ˆ</span><strong>ãƒãƒ£ãƒ¼ãƒˆ</strong></a>
    <a class="slink" href="./quality.html"><span class="ico">ğŸ”</span><strong>å“è³ªæƒ…å ±</strong></a>
    <a class="slink" href="./claim.html"><span class="ico">ğŸ§ª</span><strong>Trial Page</strong></a>
  </div>
  <div class="admin-only" style="margin-top:12px">
    <h3>Admin</h3>
    <div class="navlist">
      <a class="slink" href="./admin-numbering.html"><span class="ico">#</span><strong>Admin Numbering</strong></a>
      <a class="slink" href="./admin-prefix.html"><span class="ico">ğŸ”§</span><strong>Admin Prefix / è£½é€ No</strong></a>
      <a class="slink" href="./admin-serial-gas.html"><span class="ico">â›½</span><strong>Admin Serial Gas</strong></a>
      <a class="slink" href="./thanks.html"><span class="ico">âœ¨</span><strong>Thanks</strong></a>
    </div>
  </div>
</aside>

<!-- ===== Drawer (mobile) ===== -->
<div id="drawer" class="drawer" aria-hidden="true">
  <div class="backdrop" data-close></div>
  <aside class="panel">
    <button class="close" data-close>âœ•</button>
    <div class="navlist" style="margin-top:30px">
      <a class="slink" href="./index.html"><span class="ico">ğŸ </span><strong>ãƒ›ãƒ¼ãƒ </strong><small style="color:#9ca3af;margin-left:6px">Dashboard</small></a>
      <a class="slink" href="./forms.html"><span class="ico">ğŸ“„</span><strong>å‡ºè·æ¤œæŸ»æˆç¸¾æ›¸</strong></a>
      <a class="slink" href="./sagyoutejunsho.html"><span class="ico">ğŸ“</span><strong>ä½œæ¥­æ‰‹é †æ›¸</strong></a>
      <a class="slink" href="./charts.html"><span class="ico">ğŸ“ˆ</span><strong>ãƒãƒ£ãƒ¼ãƒˆ</strong></a>
      <a class="slink" href="./quality.html"><span class="ico">ğŸ”</span><strong>å“è³ªæƒ…å ±</strong></a>
      <a class="slink" href="./claim.html"><span class="ico">ğŸ§ª</span><strong>Trial Page</strong></a>
    </div>
    <div class="admin-only" style="margin-top:12px">
      <h3>Admin</h3>
      <div class="navlist">
        <a class="slink" href="./admin-numbering.html"><span class="ico">#</span><strong>Admin Numbering</strong></a>
        <a class="slink" href="./admin-prefix.html"><span class="ico">ğŸ”§</span><strong>Admin Prefix / è£½é€ No</strong></a>
        <a class="slink" href="./admin-serial-gas.html"><span class="ico">â›½</span><strong>Admin Serial Gas</strong></a>
        <a class="slink" href="./thanks.html"><span class="ico">âœ¨</span><strong>Thanks</strong></a>
      </div>
    </div>
  </aside>
</div>

<div class="marquee"><span>å“è³ªç®¡ç†ç”Ÿç”£æŠ€è¡“ã‚·ã‚¹ãƒ†ãƒ  - æœ€æ–°ã®å‡ºè·çŠ¶æ³ã‚’è¡¨ç¤ºã—ã¦ã„ã¾ã™ - Awali Dengan Bismillah</span></div>
<div class="footer">Design by Wahyu</div>

<!-- ===== LIBS ===== -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.8.2/jspdf.plugin.autotable.min.js"></script>

<script>
  /* ========= Drawer ========= */
  const drawer = document.getElementById('drawer');
  document.getElementById('btnBurger')?.addEventListener('click', ()=>{ drawer.classList.add('open'); drawer.setAttribute('aria-hidden','false'); });
  drawer?.addEventListener('click', (e)=>{ if(e.target.hasAttribute('data-close')){ drawer.classList.remove('open'); drawer.setAttribute('aria-hidden','true'); } });

  /* ========= Admin ========= */
  const ADMIN_FLAG_KEY='kensa_admin', PREFIX_KEY='kensa_prefix';
  const LEGACY_ADMIN_KEYS=['admin_okuma','kensa_admin_okuma','admin_flag'];
  const LEGACY_PREFIX_KEYS=['prefix','okuma_prefix','kensa_prefix_okuma'];
  (function resetAdminOncePerSession(){ if(!sessionStorage.getItem('kensa_boot_done')){ localStorage.removeItem(ADMIN_FLAG_KEY); LEGACY_ADMIN_KEYS.forEach(k=>localStorage.removeItem(k)); sessionStorage.setItem('kensa_boot_done','1'); }})();
  (function migratePrefix(){ if(!localStorage.getItem(PREFIX_KEY)){ for(const k of LEGACY_PREFIX_KEYS){ const v=localStorage.getItem(k); if(v&&v.trim()){ localStorage.setItem(PREFIX_KEY,v.trim()); break; }}}})();
  function setAdmin(on){ document.querySelectorAll('.admin-only').forEach(el=> el.style.display=on?'':'none'); if(on){ localStorage.setItem(ADMIN_FLAG_KEY,'1'); LEGACY_ADMIN_KEYS.forEach(k=>localStorage.setItem(k,'1')); }else{ localStorage.removeItem(ADMIN_FLAG_KEY); LEGACY_ADMIN_KEYS.forEach(k=>localStorage.removeItem(k)); } const b=document.getElementById('btnAdmin'); if(b) b.textContent=on?'ç®¡ç†ï¼ˆONï¼‰':'ç®¡ç†';}
  function isAdmin(){ return localStorage.getItem(ADMIN_FLAG_KEY)==='1'; }
  document.getElementById('btnAdmin')?.addEventListener('click', ()=>{ if(isAdmin()){ if(confirm('Admin akan dimatikan. Lanjut?')) setAdmin(false); }else{ const code=prompt('Admin code:'); const ADMIN_CODE='admin2025'; if(code===ADMIN_CODE) setAdmin(true); else alert('Kode tidak sesuai'); }});

  /* ========= Sidebar hover ========= */
  const hot=document.getElementById('edgeHotspot'); const fly=document.getElementById('hoverSide');
  let hideTimer=null; const HIDE_DELAY=280;
  function openFly(){ clearTimeout(hideTimer); fly.classList.add('open'); } function scheduleClose(){ clearTimeout(hideTimer); hideTimer=setTimeout(()=>fly.classList.remove('open'),HIDE_DELAY); }
  hot?.addEventListener('mouseenter', openFly); hot?.addEventListener('mouseleave', scheduleClose);
  fly?.addEventListener('mouseenter', ()=>clearTimeout(hideTimer)); fly?.addEventListener('mouseleave', scheduleClose);

  /* ========= Data load ========= */
  const SHEET_ID="1lYl7oYk6atnm3KqC6VwufARX3ooRyJ2VmC_xYFb4-OE";
  const TAB_NAME="æœ€æ–°æƒ…å ±";
  const CSV_URL=`https://docs.google.com/spreadsheets/d/${SHEET_ID}/gviz/tq?tqx=out:csv&sheet=${encodeURIComponent(TAB_NAME)}`;
  const S = s => String(s ?? '').trim();

  function parseCSV(t){
    const rows=[], re=/\s*("(?:[^"]|"")*"|[^,]*)\s*(,|\n|$)/g;
    let m,row=[]; t=t.replace(/\r\n?/g,"\n");
    for(let i=0;i<t.length;){ re.lastIndex=i; m=re.exec(t); if(!m) break;
      let cell=m[1]; if(cell.startsWith('"')) cell=cell.slice(1,-1).replace(/""/g,'"');
      row.push(cell); i=re.lastIndex;
      if(m[2]==="\n"||m[2]===""){ rows.push(row); row=[]; }
    }
    return rows.filter(r=>r.length && r.some(c=>S(c)!==""));
  }

  function indexByName(header){
    const map={}; header.forEach((h,i)=>map[S(h)]=i);
    const find=nms=>{ for(const n of nms){ if(n in map) return map[n]; } return null; };
    const findFz=re=>{ for(let i=0;i<header.length;i++){ if(re.test(S(header[i]))) return i; } return null; };
    return {
      gutter:true, // kolom pertama sintetis (gutter)
      date:find(["å‡ºè·æ—¥","æ—¥ä»˜","Date"]),
      cust:find(["é¡§å®¢å","å®¢å…ˆ","Customer"]),
      draw:find(["å›³ç•ª","Drawing","å›³é¢"]),
      machine:find(["æ©Ÿç¨®","æ©Ÿç¨®å","Machine"]),
      item:find(["å•†å“å","å“å","Item"]),
      qty:find(["æ•°é‡","Qty"]),
      to:find(["é€ã‚Šå…ˆ","ç´å“å…ˆ","é€ä»˜å…ˆ"]),
      note:find(["æ³¨ç•ª","æ³¨æ–‡ç•ªå·","å‚™è€ƒ","æ³¨æ–‡","Order","æ³¨é‡ˆ"]),

      status_done:find(["è£½å“çŠ¶æ³","è£½å“çŠ¶æ…‹","ç´å“çŠ¶æ³"]) ?? findFz(/(è£½å“|ç´å“).*(çŠ¶æ³|çŠ¶æ…‹)/),
      status_ts:   find(["è£½å“çŠ¶æ³æ›´æ–°æ—¥æ™‚","æ›´æ–°æ—¥æ™‚","StatusUpdatedAt"]) ?? findFz(/(æ›´æ–°).*(æ—¥æ™‚|æ—¥ä»˜)|updated/i),
      status_user: find(["æ›´æ–°è€…","è¨˜å…¥è€…","æ‹…å½“è€…","UpdatedBy"])        ?? findFz(/(æ›´æ–°è€…|æ‹…å½“|by)/i),

      status_flag:find(["Status","ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹","çŠ¶æ…‹","è‡³æ€¥"]) ?? findFz(/status|è‡³æ€¥/i),
    };
  }
  const valAt=(row,idx)=>(idx==null?"":(row[idx]??""));

  function parseJPDate(str){
    const s=String(str??"").trim();
    const mJP=s.match(/^(\d{4})\D(\d{1,2})\D(\d{1,2})/);
    if(mJP) return new Date(mJP[1],mJP[2]-1,mJP[3]);
    const p=s.replaceAll('-','/').split('/'); if(p.length===3) return new Date(p[0],p[1]-1,p[2]);
    const d=new Date(s); return isNaN(d)?null:d;
  }
  function sameYMD(a,b){return a&&b&&a.getFullYear()===b.getFullYear()&&a.getMonth()===b.getMonth()&&a.getDate()===b.getDate()}
  function toInputDate(d){const z=n=>String(n).padStart(2,'0'); return `${d.getFullYear()}-${z(d.getMonth()+1)}-${z(d.getDate())}`}

  function isUrgent(v){const t=S(v).toLowerCase(); return t==="è‡³æ€¥"||t==="urgent"||t==="ç·Šæ€¥"||t==="1"||t==="true"}

  /* ====== Mapping status baru ====== */
  function getStatusFromValue(val){
    const raw = S(val); const t = raw.replace(/\s/g,'');
    if (!t) return { label:'æœªè¨­å®š', cls:'tag-not' };
    if (t==='ãƒ¬ãƒ¼ã‚¶åŠ å·¥')                       return { label:'ãƒ¬ãƒ¼ã‚¶åŠ å·¥', cls:'tag-assem' };
    if (t==='æ¿é‡‘åŠ å·¥' || t==='æ›²ã’åŠ å·¥')        return { label:'æ¿é‡‘åŠ å·¥', cls:'tag-assem' };
    if (t==='å¤–æ³¨')                               return { label:'å¤–æ³¨',     cls:'tag-assem' };
    if (t==='åŠ å·¥æ¸ˆ' || t==='åŠ å·¥å®Œäº†')          return { label:'åŠ å·¥æ¸ˆ', cls:'tag-assem-done' };
    if (t==='çµ„ç«‹ä¸­')                            return { label:'çµ„ç«‹ä¸­',   cls:'tag-assem' };
    if (t==='çµ„ç«‹å®Œäº†')                          return { label:'çµ„ç«‹å®Œäº†', cls:'tag-assem-done' };
    if (t==='æ¤œæŸ»ä¸­')                            return { label:'æ¤œæŸ»ä¸­',   cls:'tag-inspect' };
    if (t==='æ¤œæŸ»æ¸ˆ' || t==='æ¤œæŸ»å®Œäº†')          return { label:'æ¤œæŸ»æ¸ˆ', cls:'tag-done' };
    if (t==='å‡ºè·æº–å‚™æ¸ˆ' || t==='å‡ºè·å¾…ã¡')       return { label:'å‡ºè·æº–å‚™æ¸ˆ', cls:'tag-inspect' };
    if (/(æ¸ˆ|å®Œäº†)/.test(t)) return { label:'æ¤œæŸ»æ¸ˆ', cls:'tag-done' };
    return { label: raw, cls:'tag-not' };
  }

  function makeComparator(idx){
    const rankMap = {'æ¤œæŸ»ä¸­':1,'çµ„ç«‹ä¸­':2,'ãƒ¬ãƒ¼ã‚¶åŠ å·¥':3,'æ¿é‡‘åŠ å·¥':3,'å¤–æ³¨':3,'å‡ºè·æº–å‚™æ¸ˆ':4,'åŠ å·¥æ¸ˆ':5,'çµ„ç«‹å®Œäº†':6,'æ¤œæŸ»æ¸ˆ':7,'æœªè¨­å®š':98};
    const rank = s => (s in rankMap ? rankMap[s] : 99);
    return (a,b)=>{
      const au=idx.status_flag!=null&&isUrgent(valAt(a,idx.status_flag));
      const bu=idx.status_flag!=null&&isUrgent(valAt(b,idx.status_flag));
      if(au!==bu) return au?-1:1;
      const sa=idx.status_done!=null?(getStatusFromValue(valAt(a,idx.status_done))?.label):null;
      const sb=idx.status_done!=null?(getStatusFromValue(valAt(b,idx.status_done))?.label):null;
      if(rank(sa)!==rank(sb)) return rank(sa)-rank(sb);
      const da=idx.date!=null?parseJPDate(valAt(a,idx.date)):null;
      const db=idx.date!=null?parseJPDate(valAt(b,idx.date)):null;
      const ta=da?da.getTime():-Infinity, tb=db?db.getTime():-Infinity;
      return tb-ta;
    };
  }

  /* ====== RENDER ====== */
  function renderTable(header, idx, rows, tbodyEl, headEl){
    // sisipkan kolom gutter pada header
    const headCells = [''].concat(header);
    headEl.innerHTML = headCells.map((h,i)=> i===0 ? `<th class="gutter-th"></th>` : `<th>${h}</th>`).join('');

    tbodyEl.innerHTML='';
    rows.forEach(r=>{
      const rowUrg=idx.status_flag!=null?isUrgent(valAt(r,idx.status_flag)):false;
      const tds=header.map((_,i)=>`<td>${S(r[i])}</td>`);

      // å‡ºè·æ—¥ sebagai chip biru
      const dateCol=(idx.date!=null?idx.date:0);
      const d=idx.date!=null?parseJPDate(valAt(r,idx.date)):null;
      const dateText=d?toInputDate(d):S(r[dateCol]??'');
      const urgent=rowUrg?`<span class="flag-urgent">âš  è‡³æ€¥</span>`:'';
      tds[dateCol]=`<td>${urgent}${dateText?`<span class="chip chip-date">${dateText}</span>`:''}</td>`;

      // status + meta
      const st = idx.status_done!=null ? getStatusFromValue(valAt(r, idx.status_done)) : null;
      const tsRaw = idx.status_ts!=null ? valAt(r, idx.status_ts) : '';
      const ts = tsRaw ? new Date(tsRaw) : null;
      const tsView = (ts && !isNaN(ts))
        ? `${ts.getFullYear()}-${String(ts.getMonth()+1).padStart(2,'0')}-${String(ts.getDate()).padStart(2,'0')}`
        : '';
      const user = idx.status_user!=null ? S(valAt(r, idx.status_user)) : '';
      const gutterHtml = `
        <td class="gutter-td">
          <div class="gutter-box">
            ${st?`<span class="status-badge ${st.cls}">${st.label}</span>`:''}
            <div class="status-meta">
              ${tsView?tsView:''}${(tsView&&user)?'<br>':''}${user?user:''}
            </div>
          </div>
        </td>`;

      const tr = document.createElement('tr');
      if(rowUrg) tr.classList.add('row-urgent');
      tr.innerHTML = gutterHtml + tds.join('');
      tbodyEl.appendChild(tr);
    });
  }

  let aborter=null,isLoading=false; let cached={header:[],rows:[],idx:null,cmp:null};

  async function load(){
    try{
      if(isLoading){aborter?.abort()} isLoading=true;
      const btn=document.getElementById('btnRefresh'); const old=btn.textContent; btn.textContent='Loading...'; btn.disabled=true;
      aborter=new AbortController();
      const res=await fetch(CSV_URL+"&_ts="+Date.now(),{signal:aborter.signal,cache:'no-store'});
      if(!res.ok) throw new Error("HTTP "+res.status);
      const text=await res.text(); const data=parseCSV(text); if(!data.length) throw new Error("CSV empty");
      const header=data[0], rowsRaw=data.slice(1); const idx=indexByName(header); const cmp=makeComparator(idx);
      const rows=[...rowsRaw].sort(cmp); cached={header,rows,idx,cmp};

      const urgentCount=rows.reduce((n,r)=> n + (idx.status_flag!=null && isUrgent(valAt(r, idx.status_flag)) ? 1 : 0), 0);
      const banner=document.getElementById('urgent-banner');
      banner.style.display=urgentCount>0?'block':'none';
      banner.textContent=urgentCount>0?`âš  è‡³æ€¥æ¡ˆä»¶ãŒ ${urgentCount} ä»¶ã‚ã‚Šã¾ã™ï¼æ—©æ€¥ã«ç¢ºèªã—ã¦ãã ã•ã„ã€‚`:'';      

      renderTodaySection(); applyFilter(null);

      const cols=[]; if(idx.qty!=null) cols.push('æ•°é‡:'+header[idx.qty]);
      if(idx.cust!=null) cols.push('é¡§å®¢:'+header[idx.cust]);
      if(idx.date!=null) cols.push('å‡ºè·æ—¥:'+header[idx.date]);
      document.getElementById('shipHint').textContent=`ãƒ‡ãƒ¼ã‚¿å…ƒ: ${TAB_NAME}ï¼ˆ${rows.length} è¡Œï¼‰ï½œ${cols.join(' ï½œ ')} ï½œ Urgentåˆ—: ${idx.status_flag!=null ? header[idx.status_flag] : 'â€”'}`;
      document.getElementById('lastUpdated').textContent='Last update: '+new Date().toLocaleString();
      document.getElementById('filterDate').value=toInputDate(new Date());

      btn.textContent=old; btn.disabled=false; isLoading=false;
    }catch(e){
      console.error(e);
      const btn=document.getElementById('btnRefresh'); btn.textContent='Refresh'; btn.disabled=false; isLoading=false;
      document.getElementById('shipHint').textContent='èª­ã¿è¾¼ã¿ã«å¤±æ•—ã—ã¾ã—ãŸã€‚ã‚·ãƒ¼ãƒˆå/å…¬é–‹è¨­å®š/åˆ—åã‚’ã”ç¢ºèªãã ã•ã„ã€‚';
    }
  }

  function renderTodaySection(){
    const {header,rows,idx,cmp}=cached; if(idx.date==null){document.getElementById('todaySection').style.display='none'; return;}
    const today=new Date();
    const todayRows=rows.filter(r=>{const d=parseJPDate(valAt(r,idx.date)); return d&&sameYMD(d,today)}).sort(cmp);
    const vis=todayRows.length>0; document.getElementById('todaySection').style.display=vis?'':'none'; if(!vis) return;
    document.getElementById('todayCount').textContent=todayRows.length;
    renderTable(['',...header],idx,todayRows,document.getElementById('todayBody'),document.getElementById('todayHead'));
  }

  function applyFilter(dateStr){
    const {header,rows,idx,cmp}=cached; let view=rows;
    if(idx.date!=null && dateStr){
      const target=new Date(dateStr+"T00:00:00");
      view=rows.filter(r=>{const d=parseJPDate(valAt(r,idx.date)); return d&&sameYMD(d,target)}).sort(cmp);
    }
    renderTable(['',...header],idx,view,document.getElementById('shipBody'),document.getElementById('shipHead'));
  }

  function exportExcel(){const table=document.getElementById("shipTable"); const wb=XLSX.utils.table_to_book(table,{sheet:"å‡ºè·çŠ¶æ³"}); XLSX.writeFile(wb,"å‡ºè·çŠ¶æ³.xlsx");}
  function exportPDF(){const {jsPDF}=window.jspdf; const doc=new jsPDF({orientation:"landscape",unit:"pt",format:"a4"});
    doc.setFontSize(14); doc.text("å‡ºè·çŠ¶æ³ä¸€è¦§",40,40);
    doc.autoTable({html:"#shipTable", startY:60, styles:{fontSize:9, cellPadding:4, halign:"center", valign:"middle"}, headStyles:{fillColor:[238,242,247]}});
    doc.save("å‡ºè·çŠ¶æ³.pdf");
  }
  document.getElementById("btnExcel").addEventListener("click", exportExcel);
  document.getElementById("btnPDF").addEventListener("click", exportPDF);

  let timer=null,intervalMs=60000;
  function startAutoRefresh(ms){
    intervalMs=ms; clearInterval(timer);
    timer=setInterval(()=>{ if(document.visibilityState==='visible') load(); }, intervalMs);
    document.getElementById('intervalInfo').textContent=`${Math.round(intervalMs/1000)}s`;
    const liveBtn=document.getElementById('btnLive');
    if(intervalMs<=5000){liveBtn.classList.add('active'); liveBtn.textContent='Live: On';}
    else{liveBtn.classList.remove('active'); liveBtn.textContent='Live: Off';}
  }
  document.getElementById('btnRefresh').addEventListener('click', load);
  document.getElementById('btnLive').addEventListener('click', ()=>{ startAutoRefresh(intervalMs<=5000?60000:5000); load(); });
  document.addEventListener('visibilitychange', ()=>{ if(document.visibilityState==='visible') load(); });

  document.getElementById('filterDate').addEventListener('change', e=>applyFilter(e.target.value||null));
  document.getElementById('btnToday').addEventListener('click', ()=>applyFilter(toInputDate(new Date())));
  document.getElementById('btnClear').addEventListener('click', ()=>{document.getElementById('filterDate').value=""; applyFilter(null);});

  // Init
  window.addEventListener('DOMContentLoaded', ()=>{
    setAdmin(isAdmin());
    load(); startAutoRefresh(60000);
  });
</script>
</body>
</html>
