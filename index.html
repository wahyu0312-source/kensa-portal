<!doctype html>
<html lang="ja">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>å“è³ªç®¡ç†ç”Ÿç”£æŠ€è¡“ã‚·ã‚¹ãƒ†ãƒ </title>
<style>
  :root{
    --bg1:#eef2ff; --bg2:#f8fafc; --card:#fff; --ink:#0f172a; --muted:#64748b; --border:#e5e7eb;
    --accent:#2563eb; --danger:#b91c1c; --shadow:0 30px 60px rgba(15,23,42,.08); --radius:22px;
    --urgent-row:#fee2e2; --urgent-cell:#ef4444;
  }
  *{box-sizing:border-box}
  body{
    margin:0; color:var(--ink);
    font-family:system-ui,-apple-system,Segoe UI,Roboto,"Noto Sans JP","Yu Gothic",sans-serif;
    background:
      radial-gradient(1200px 600px at -10% -10%, #c7d2fe 0%, transparent 60%),
      radial-gradient(900px 500px at 110% 0%, #bae6fd 0%, transparent 55%),
      linear-gradient(120deg,var(--bg1),var(--bg2));
    padding-bottom:64px;
  }
  header{position:sticky;top:0;z-index:10;background:#ffffffcc;backdrop-filter:blur(10px);border-bottom:1px solid var(--border)}
  .wrap{max-width:1200px;margin:0 auto;padding:12px 20px}
  .row{display:flex;justify-content:space-between;align-items:center;gap:16px}
  nav a{margin-left:20px;color:var(--accent);font-weight:700;text-decoration:none}
  nav a:hover{text-decoration:underline}
  .controls{display:flex;gap:8px;align-items:center}
  .btn{padding:8px 12px;border:1px solid var(--border);border-radius:10px;background:#fff;cursor:pointer;text-decoration:none;display:inline-flex;align-items:center;gap:6px}
  .btn[disabled]{opacity:.6;cursor:wait}
  .btn.active{border-color:#93c5fd;background:#f0f9ff}
  .small{font-size:12px;color:var(--muted)}
  .muted{color:var(--muted)}

  main{max-width:1200px;margin:28px auto;padding:0 20px}
  .card{background:#fff;border:1px solid var(--border);border-radius:var(--radius);box-shadow:var(--shadow);padding:18px;overflow:auto}
  .card-title{display:flex;align-items:center;justify-content:space-between;margin:0 0 10px}
  .subtle{color:#475569;font-size:14px}

  table{width:100%;border-collapse:separate;border-spacing:0;min-width:900px}
  thead th{background:#f8fafc;color:#475569;position:sticky;top:0;z-index:1;text-align:left;font-weight:700;padding:12px 14px;border-bottom:1px solid var(--border)}
  tbody td{padding:12px 14px;border-bottom:1px solid var(--border);white-space:nowrap}
  tbody tr:hover{background:#f1f5ff}

  /* Urgent styles */
  tr.row-urgent td{background:var(--urgent-row)!important;color:#b91c1c;font-weight:600}
  td.cell-urgent{background:var(--urgent-cell)!important;color:#fff!important;font-weight:800!important;border-radius:8px}

  .flag-urgent{display:inline-flex;align-items:center;gap:6px;padding:2px 10px;border-radius:999px;background:#dc2626;color:#fff;font-weight:800;font-size:12px;margin-right:8px}
  .flag-urgent::before{content:"âš ";}

  /* Status badges */
  .tag{display:inline-flex;align-items:center;padding:2px 10px;border-radius:999px;font-weight:800;font-size:12px;color:#fff;margin-right:8px}
  .tag-done{background:#0ea5e9}      /* æ¸ˆ (æ¤œæŸ»æ¸ˆã¿/å®Œäº†/OK/done) */
  .tag-assem{background:#f59e0b}     /* çµ„ç«‹ä¸­ */
  .tag-assem-done{background:#10b981}/* çµ„ç«‹å®Œäº† */
  .tag-inspect{background:#8b5cf6}   /* æ¤œæŸ»ä¸­ */
  .tag-not{background:#94a3b8}       /* æœªçµ„ç«‹ */

  .chip{display:inline-flex;align-items:center;gap:8px;background:#f1f5f9;border:1px solid var(--border);padding:6px 10px;border-radius:999px}
  .chip strong{font-size:12px;color:#0f172a}
  .chip .count{font-weight:800}

  #urgent-banner{background:#b91c1c;color:#fff;padding:10px 16px;border-radius:10px;margin-bottom:14px;font-weight:bold;text-align:center;animation:blink 1s infinite}
  @keyframes blink{0%,50%,100%{background:#b91c1c}25%,75%{background:#ef4444}}

  .export-bar{margin-bottom:12px;display:flex;gap:8px;flex-wrap:wrap;justify-content:flex-end}
  .filterbar{display:flex;gap:8px;align-items:center;flex-wrap:wrap;margin:10px 0 0}
  .filterbar input[type="date"]{padding:8px 10px;border:1px solid var(--border);border-radius:10px}

  @media (max-width: 1024px){ table{min-width:unset} }
  @media (max-width: 768px){
    .row{flex-direction:column;align-items:flex-start}
    nav{display:flex;flex-wrap:wrap;gap:10px}
    table{min-width:unset;font-size:12px}
    .card{padding:12px}
    .export-bar{justify-content:flex-start}
  }

  .marquee{position:fixed;left:0;right:0;bottom:20px;background:var(--accent);color:#fff;font-weight:bold;padding:6px 0;white-space:nowrap;overflow:hidden;z-index:20}
  .marquee span{display:inline-block;padding-left:100%;animation:marquee 25s linear infinite}
  @keyframes marquee{0%{transform:translateX(0)}100%{transform:translateX(-100%)}}
  .footer{position:fixed;bottom:0;left:0;right:0;text-align:center;font-size:12px;color:var(--muted);background:#f1f5f9;padding:4px 0;z-index:21}

  /* --- ç®¡ç† dropdown --- */
  .menubar{ position:relative }
  .menu-btn{ padding:8px 12px; border:1px solid var(--border); border-radius:10px; background:#fff; cursor:pointer }
  .menu{
    position:absolute; top:110%; right:0; min-width:220px; background:#fff;
    border:1px solid var(--border); border-radius:12px; box-shadow:var(--shadow);
    padding:6px; display:none; z-index:100;
  }
  .menu.open{ display:block }
  .menu .sec{ padding:6px 10px 4px; font-size:12px; color:#6b7280 }
  .menu a, .menu button{
    display:flex; align-items:center; gap:8px; width:100%;
    padding:9px 10px; border:0; background:transparent; border-radius:8px; text-align:left; color:var(--ink);
  }
  .menu a{text-decoration:none}
  .menu a:hover, .menu button:hover{ background:#f1f5f9 }
  .sep{ height:1px; background:var(--border); margin:6px }
</style>
</head>
<body>
<header>
  <div class="wrap row">
    <div style="display:flex;align-items:center;gap:10px">
      <img src="tsh.png" alt="TSH" style="height:36px">
      <strong>å“è³ªç®¡ç†ç”Ÿç”£æŠ€è¡“</strong>
    </div>
    <nav>
      <a href="./index.html"><strong>ãƒ›ãƒ¼ãƒ </strong></a>
      <a href="./forms.html">å‡ºè·æ¤œæŸ»æˆç¸¾æ›¸</a>
      <a href="./sagyoutejunsho.html">å‡ºè·æ¤œæŸ»ä½œæ¥­æ‰‹é †æ›¸</a>
      <a href="./charts.html">å‡ºè·æ¤œæŸ»ï¼ˆã‚°ãƒ©ãƒ•ï¼‰</a>
      <a href="./quality.html">å“è³ªæƒ…å ±</a><!-- â¬…ï¸ menu baru -->
      <a href="./claim.html">å“è³ªãƒˆãƒ©ã‚¤ã‚¢ãƒ«</a>
    </nav>
    <div class="controls">
      <button id="btnRefresh" class="btn" type="button">Refresh now</button>
      <button id="btnLive" class="btn" type="button">Live: Off</button>
      <span id="intervalInfo" class="small">Interval: 60s</span>

      <!-- â–¼ ç®¡ç† dropdown -->
      <div class="menubar">
        <button id="menuBtn" class="menu-btn" type="button">ç®¡ç† â–¾</button>
        <div id="menu" class="menu" role="menu" aria-hidden="true">
          <div class="sec">ãƒŠãƒ“</div>
          <a href="./" role="menuitem">ğŸ  ãƒˆãƒƒãƒ—</a>
          <a href="./forms.html" role="menuitem">ğŸ“„ å‡ºè·æ¤œæŸ»æˆç¸¾æ›¸</a>
          <a href="./quality.html" role="menuitem">ğŸ“Š å“è³ªæƒ…å ±</a>
          <a href="./admin-prefix.html" role="menuitem">ğŸ› ï¸ Admin Prefix</a>

          <div class="sep"></div>
          <div class="sec">æ“ä½œ</div>
          <button id="m-refresh" role="menuitem">ğŸ”„ Refresh</button>
          <button id="m-live" role="menuitem">ğŸŸ¢ Live åˆ‡æ›¿</button>
        </div>
      </div>
      <!-- â–² ç®¡ç† dropdown -->
    </div>
  </div>
</header>

<main>
  <div id="urgent-banner">ç¾åœ¨ã€è‡³æ€¥æ¡ˆä»¶ã¯ã‚ã‚Šã¾ã›ã‚“ã€‚</div>

  <div style="display:flex;justify-content:space-between;align-items:end">
    <h1>å‡ºè·çŠ¶æ³ä¸€è¦§</h1>
    <span id="lastUpdated" class="small"></span>
  </div>

  <!-- æœ¬æ—¥å‡ºè· -->
  <section id="todaySection" class="card" style="display:none;margin-bottom:20px">
    <div class="card-title">
      <h2 style="margin:0">æœ¬æ—¥å‡ºè·</h2>
      <span class="chip"><strong>ä»¶æ•°</strong><span id="todayCount" class="count">0</span></span>
    </div>
    <table id="todayTable">
      <thead><tr id="todayHead"></tr></thead>
      <tbody id="todayBody"></tbody>
    </table>
  </section>

  <!-- å…¨ä»¶ä¸€è¦§ -->
  <section class="card">
    <div class="card-title">
      <h2 style="margin:0">å…¨ä»¶ä¸€è¦§</h2>
      <div class="filterbar">
        <label class="subtle">å‡ºè·æ—¥ãƒ•ã‚£ãƒ«ã‚¿ï¼š</label>
        <input type="date" id="filterDate">
        <button class="btn" id="btnToday" type="button">æœ¬æ—¥å‡ºè·ã®ã¿</button>
        <button class="btn" id="btnClear" type="button">Clear</button>
        <a class="btn" href="./charts.html" title="Grafik terpisah">ã‚°ãƒ©ãƒ•é–‹ã</a>
        <a class="btn" href="./quality.html" title="å“è³ªãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰">å“è³ªæƒ…å ±</a><!-- â¬…ï¸ tombol baru -->
      </div>
    </div>

    <div class="export-bar">
      <button class="btn" id="btnExcel" type="button">Export Excel</button>
      <button class="btn" id="btnPDF" type="button">Export PDF</button>
    </div>

    <table id="shipTable">
      <thead><tr id="shipHead"></tr></thead>
      <tbody id="shipBody"></tbody>
    </table>
    <div class="muted small" id="shipHint"></div>
  </section>
</main>

<div class="marquee"><span>å“è³ªç®¡ç†ç”Ÿç”£æŠ€è¡“ã‚·ã‚¹ãƒ†ãƒ  - æœ€æ–°ã®å‡ºè·çŠ¶æ³ã‚’è¡¨ç¤ºã—ã¦ã„ã¾ã™</span></div>
<div class="footer">Design by Wahyu</div>

<!-- Export libs -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.8.2/jspdf.plugin.autotable.min.js"></script>

<script>
  // ===== Config =====
  const SHEET_ID ="1lYl7oYk6atnm3KqC6VwufARX3ooRyJ2VmC_xYFb4-OE";
  const TAB_NAME ="æœ€æ–°æƒ…å ±";
  const CSV_URL  =`https://docs.google.com/spreadsheets/d/${SHEET_ID}/gviz/tq?tqx=out:csv&sheet=${encodeURIComponent(TAB_NAME)}`;
  const S = s => String(s ?? '').trim();

  // ===== CSV parser =====
  function parseCSV(t){
    const rows=[], re=/\s*("(?:[^"]|"")*"|[^,]*)\s*(,|\n|$)/g;
    let m, row=[]; t=t.replace(/\r\n?/g,"\n");
    for(let i=0;i<t.length;){
      re.lastIndex=i; m=re.exec(t); if(!m) break;
      let cell=m[1]; if(cell.startsWith('"')) cell=cell.slice(1,-1).replace(/""/g,'"');
      row.push(cell); i=re.lastIndex;
      if(m[2]==="\n"||m[2]===""){ rows.push(row); row=[]; }
    }
    return rows.filter(r=>r.length && r.some(c=>S(c)!==""));
  }

  // ===== Header indexer =====
  function indexByName(header){
    const map={}; header.forEach((h,i)=>map[S(h)]=i);
    const find=names=>{for(const n of names){if(n in map) return map[n];} return null;};
    const findFuzzy = (regex) => {
      for(let i=0;i<header.length;i++){
        if(regex.test(S(header[i]))) return i;
      }
      return null;
    };
    return {
      date:find(["å‡ºè·æ—¥","æ—¥ä»˜","Date"]),
      cust:find(["é¡§å®¢å","å®¢å…ˆ","Customer"]),
      draw:find(["å›³ç•ª","Drawing","å›³é¢"]),
      item:find(["å•†å“å","å“å","Item"]),
      machine:find(["æ©Ÿç¨®","æ©Ÿç¨®å","Machine"]),
      qty:find(["æ•°é‡","Qty"]),
      to:find(["é€ã‚Šå…ˆ","ç´å“å…ˆ","é€ä»˜å…ˆ"]),
      note:find(["æ³¨ç•ª","æ³¨æ–‡ç•ªå·","å‚™è€ƒ","æ³¨æ–‡","Order","æ³¨é‡ˆ"]),
      status_done:find(["è£½å“çŠ¶æ³","è£½å“çŠ¶æ…‹","ç´å“çŠ¶æ³"]) ?? findFuzzy(/(è£½å“|ç´å“).*(çŠ¶æ³|çŠ¶æ…‹)/),
      status_flag:find(["Status","ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹","çŠ¶æ…‹","è‡³æ€¥"]) ?? findFuzzy(/status|è‡³æ€¥/i),
      // QC columns (optional)
      qc_check:  find(["æ¤œæŸ»ãƒã‚§ãƒƒã‚¯ã‚·ãƒ¼ãƒˆ","æ¤œæŸ»ï¾ï½ªï½¯ï½¸ï½¼ï½°ï¾„","CheckSheet"]) ?? findFuzzy(/(æ¤œæŸ»|ï¾ï½ªï½¯ï½¸|ãƒã‚§ãƒƒã‚¯).*ã‚·ãƒ¼ãƒˆ|check/i),
      qc_label:  find(["ãƒ†ãƒ—ãƒ©","ï¾ƒï¾Œï¾Ÿï¾—","ãƒ©ãƒ™ãƒ«","Label"])            ?? findFuzzy(/(ï¾ƒï¾Œï¾Ÿï¾—|ãƒ†ãƒ—ãƒ©|ï¾—ï¾ï¾ï¾™|ãƒ©ãƒ™ãƒ«|label)/i),
      qc_result: find(["æ¤œæŸ»æˆç¸¾è¡¨","æˆç¸¾è¡¨","InspectionReport"])   ?? findFuzzy(/(æ¤œæŸ»|inspection).*(æˆç¸¾|report)/i),
      qc_pack:   find(["æ¢±åŒ…","Packing","åŒ…è£…"])                    ?? findFuzzy(/(æ¢±åŒ…|packing|åŒ…è£…)/i),
    };
  }
  const valAt = (row, idx) => (idx==null ? "" : (row[idx] ?? ""));

  // ===== Date helpers =====
  function parseJPDate(str){
    const s=String(str??"").trim();
    const mJP=s.match(/^(\d{4})\D(\d{1,2})\D(\d{1,2})/);
    if(mJP) return new Date(mJP[1], mJP[2]-1, mJP[3]);
    const parts=s.replaceAll('-','/').split('/');
    if(parts.length===3) return new Date(parts[0], parts[1]-1, parts[2]);
    const d=new Date(s);
    return isNaN(d)?null:d;
  }
  function sameYMD(a,b){ if(!a||!b) return false; return a.getFullYear()===b.getFullYear() && a.getMonth()===b.getMonth() && a.getDate()===b.getDate(); }
  function toInputDate(d){ const z=n=>String(n).padStart(2,'0'); return `${d.getFullYear()}-${z(d.getMonth()+1)}-${z(d.getDate())}`; }
  function isUrgent(v){ const t=S(v).toLowerCase(); return t==="è‡³æ€¥"||t==="urgent"||t==="ç·Šæ€¥"||t==="1"||t==="true"; }

  // ===== è£½å“çŠ¶æ³ â†’ Badge =====
  function getStatusFromValue(val){
    const raw = S(val);
    const t   = raw.replace(/\s/g,'').toLowerCase();

    // kosong / æœª / clear â†’ æœªçµ„ç«‹
    if(!t || /(æœª|clear)/.test(t)) return {label:'æœªçµ„ç«‹', cls:'tag-not'};

    // æ¤œæŸ»æ¸ˆã¿ / æ¸ˆ / å®Œäº† / ok / done â†’ æ¸ˆ
    if(/(æ¤œæŸ»æ¸ˆã¿|æ¸ˆ|å®Œäº†|ok|done)/.test(t)) return {label:'æ¸ˆ', cls:'tag-done'};

    // æ˜ç¤ºçŠ¶æ…‹
    if(/(çµ„ç«‹å®Œäº†)/.test(raw))            return {label:'çµ„ç«‹å®Œäº†', cls:'tag-assem-done'};
    if(/(æ¤œæŸ»ä¸­|æ¤œä¸­)/.test(raw))         return {label:'æ¤œæŸ»ä¸­',   cls:'tag-inspect'};
    if(/(çµ„ç«‹ä¸­|çµ„ä¸­)/.test(raw))         return {label:'çµ„ç«‹ä¸­',   cls:'tag-assem'};

    // fallback keyword
    if(/æ¤œ/.test(raw))                    return {label:'æ¤œæŸ»ä¸­',   cls:'tag-inspect'};
    if(/çµ„/.test(raw))                    return {label:'çµ„ç«‹ä¸­',   cls:'tag-assem'};

    return null; // tak dikenal
  }

  // ===== Comparator (Urgent â†’ Status â†’ Date desc) =====
  function makeComparator(idx){
    const rank = s => ({ 'æ¤œæŸ»ä¸­':1, 'çµ„ç«‹ä¸­':2, 'æœªçµ„ç«‹':3, 'çµ„ç«‹å®Œäº†':4, 'æ¸ˆ':5 }[s] ?? 99);
    return (a,b)=>{
      // Urgent first
      const au=idx.status_flag!=null && isUrgent(valAt(a, idx.status_flag));
      const bu=idx.status_flag!=null && isUrgent(valAt(b, idx.status_flag));
      if(au!==bu) return au?-1:1;

      // By è£½å“çŠ¶æ³ rank
      const sa = idx.status_done!=null ? (getStatusFromValue(valAt(a, idx.status_done))?.label) : null;
      const sb = idx.status_done!=null ? (getStatusFromValue(valAt(b, idx.status_done))?.label) : null;
      if(rank(sa)!==rank(sb)) return rank(sa)-rank(sb);

      // Newer date first
      const da=idx.date!=null ? parseJPDate(valAt(a, idx.date)) : null;
      const db=idx.date!=null ? parseJPDate(valAt(b, idx.date)) : null;
      const ta = da ? da.getTime() : -Infinity;
      const tb = db ? db.getTime() : -Infinity;
      return tb - ta;
    };
  }

  // ===== Rendering =====
  function renderTable(header, idx, rows, tbodyEl, headEl){
    headEl.innerHTML = header.map(h=>`<th>${h}</th>`).join('');
    tbodyEl.innerHTML = '';

    rows.forEach(r=>{
      const rowUrg  = idx.status_flag!=null ? isUrgent(valAt(r, idx.status_flag)) : false;

      const tds = header.map((_,i)=>`<td>${S(r[i])}</td>`);

      // Kolom tanggal (atau kolom pertama jika tidak ada)
      const dateCol = (idx.date!=null ? idx.date : 0);
      const d = idx.date!=null ? parseJPDate(valAt(r, idx.date)) : null;
      const dateText = d ? toInputDate(d) : S(r[dateCol] ?? '');

      const urgentFlag = rowUrg ? `<span class="flag-urgent">è‡³æ€¥</span>` : '';
      const statusObj = (idx.status_done!=null) ? getStatusFromValue(valAt(r, idx.status_done)) : null;
      const badge = statusObj ? `<span class="tag ${statusObj.cls}">${statusObj.label}</span>` : '';

      tds[dateCol] = `<td>${urgentFlag}${badge}${dateText}</td>`;

      tbodyEl.insertAdjacentHTML('beforeend', `<tr class="${rowUrg?'row-urgent':''}">${tds.join('')}</tr>`);
    });
  }

  // ===== Main loader =====
  let aborter=null, isLoading=false;
  let cached = { header:[], rows:[], idx:null, cmp:null };

  async function load(){
    try{
      if(isLoading){ if(aborter) aborter.abort(); }
      isLoading=true;
      const btn=document.getElementById('btnRefresh');
      const old=btn.textContent; btn.textContent='Loading...'; btn.disabled=true;

      if(aborter) aborter.abort();
      aborter=new AbortController();

      const url = CSV_URL + "&_ts=" + Date.now();
      const res=await fetch(url,{signal:aborter.signal,cache:'no-store'});
      if(!res.ok) throw new Error("HTTP "+res.status);
      const text=await res.text();
      const data=parseCSV(text);
      if(!data.length) throw new Error("CSV empty");

      const header=data[0], rowsRaw=data.slice(1);
      const idx=indexByName(header);
      const cmp = makeComparator(idx);

      const rows=[...rowsRaw].sort(cmp); // Urgentâ†’Statusâ†’Date

      cached = { header, rows, idx, cmp };

      // Urgent banner
      const urgentCount = rows.reduce((n,r)=> n + (idx.status_flag!=null && isUrgent(valAt(r, idx.status_flag)) ? 1 : 0), 0);
      document.getElementById('urgent-banner').textContent =
        urgentCount>0 ? `âš  è‡³æ€¥æ¡ˆä»¶ãŒ ${urgentCount} ä»¶ã‚ã‚Šã¾ã™ï¼æ—©æ€¥ã«ç¢ºèªã—ã¦ãã ã•ã„ã€‚` : 'ç¾åœ¨ã€è‡³æ€¥æ¡ˆä»¶ã¯ã‚ã‚Šã¾ã›ã‚“ã€‚';

      // ä»Šæ—¥ section
      renderTodaySection();

      // Main table
      applyFilter(null);

      // Info
      const cols = [];
      if(idx.qty!=null) cols.push('æ•°é‡:'+header[idx.qty]);
      if(idx.cust!=null) cols.push('é¡§å®¢:'+header[idx.cust]);
      if(idx.date!=null) cols.push('å‡ºè·æ—¥:'+header[idx.date]);
      document.getElementById('shipHint').textContent =
        `ãƒ‡ãƒ¼ã‚¿å…ƒ: ${TAB_NAME}ï¼ˆ${rows.length} è¡Œï¼‰ï½œ${cols.join(' ï½œ ')} ï½œ Urgentåˆ—: ${idx.status_flag!=null ? header[idx.status_flag] : 'â€”'}`;
      document.getElementById('lastUpdated').textContent='Last update: '+new Date().toLocaleString();

      // Prefill filter ke hari ini
      document.getElementById('filterDate').value = toInputDate(new Date());

      btn.textContent=old; btn.disabled=false; isLoading=false;
    }catch(e){
      console.error("[ERROR] load()", e);
      const btn=document.getElementById('btnRefresh');
      btn.textContent='Refresh now'; btn.disabled=false; isLoading=false;
      document.getElementById('shipHint').textContent='èª­ã¿è¾¼ã¿ã«å¤±æ•—ã—ã¾ã—ãŸã€‚ã‚·ãƒ¼ãƒˆå/å…¬é–‹è¨­å®š/åˆ—åã‚’ã”ç¢ºèªãã ã•ã„ã€‚';
    }
  }

  function renderTodaySection(){
    const { header, rows, idx, cmp } = cached;
    if(idx.date==null){ document.getElementById('todaySection').style.display='none'; return; }

    const today = new Date();
    const todayRows = rows
      .filter(r => {
        const d = parseJPDate(valAt(r, idx.date));
        return d && sameYMD(d, today);
      })
      .sort(cmp); // gunakan urutan yang sama

    const visible = todayRows.length>0;
    document.getElementById('todaySection').style.display = visible ? '' : 'none';
    if(!visible) return;

    document.getElementById('todayCount').textContent = todayRows.length;
    renderTable(header, idx, todayRows, document.getElementById('todayBody'), document.getElementById('todayHead'));
  }

  // ===== Filter handling =====
  function applyFilter(dateStr){
    const { header, rows, idx, cmp } = cached;
    let view = rows;

    if(idx.date!=null && dateStr){
      const target = new Date(dateStr+"T00:00:00");
      view = rows.filter(r => {
        const d = parseJPDate(valAt(r, idx.date));
        return d && sameYMD(d, target);
      }).sort(cmp);
    }

    renderTable(header, idx, view, document.getElementById('shipBody'), document.getElementById('shipHead'));
  }

  // ===== Export =====
  function exportExcel(){
    const table=document.getElementById("shipTable");
    const wb=XLSX.utils.table_to_book(table,{sheet:"å‡ºè·çŠ¶æ³"});
    XLSX.writeFile(wb,"å‡ºè·çŠ¶æ³.xlsx");
  }
  function exportPDF(){
    const { jsPDF } = window.jspdf;
    const doc = new jsPDF({orientation:"landscape", unit:"pt", format:"a4"});
    doc.setFontSize(14); doc.text("å‡ºè·çŠ¶æ³ä¸€è¦§", 40, 40);
    doc.autoTable({html:"#shipTable", startY:60, styles:{fontSize:9, cellPadding:4, halign:"center", valign:"middle"}, headStyles:{fillColor:[238,242,247]}});
    doc.save("å‡ºè·çŠ¶æ³.pdf");
  }
  document.getElementById("btnExcel").addEventListener("click", exportExcel);
  document.getElementById("btnPDF").addEventListener("click", exportPDF);

  // ===== Auto-refresh =====
  let timer=null, intervalMs=60000;
  function startAutoRefresh(ms){
    intervalMs=ms; clearInterval(timer);
    timer=setInterval(()=>{ if(document.visibilityState==='visible') load(); }, intervalMs);
    document.getElementById('intervalInfo').textContent=`Interval: ${Math.round(intervalMs/1000)}s`;
    const liveBtn=document.getElementById('btnLive');
    if(intervalMs<=5000){ liveBtn.classList.add('active'); liveBtn.textContent='Live: On'; }
    else{ liveBtn.classList.remove('active'); liveBtn.textContent='Live: Off'; }
  }

  // Events
  document.getElementById('btnRefresh').addEventListener('click', load);
  document.getElementById('btnLive').addEventListener('click', ()=>{ startAutoRefresh(intervalMs<=5000?60000:5000); load(); });
  document.addEventListener('visibilitychange', ()=>{ if(document.visibilityState==='visible') load(); });

  document.getElementById('filterDate').addEventListener('change', (e)=> applyFilter(e.target.value || null));
  document.getElementById('btnToday').addEventListener('click', ()=> applyFilter(toInputDate(new Date())));
  document.getElementById('btnClear').addEventListener('click', ()=>{
    document.getElementById('filterDate').value = "";
    applyFilter(null);
  });

  window.addEventListener('DOMContentLoaded', ()=>{ load(); startAutoRefresh(60000); });
</script>

<!-- ç®¡ç† menu logic -->
<script>
  const _menuBtn = document.getElementById('menuBtn');
  const _menu    = document.getElementById('menu');

  function closeMenu(){
    _menu?.classList.remove('open');
    _menu?.setAttribute('aria-hidden','true');
  }
  _menuBtn?.addEventListener('click', (e)=>{
    e.stopPropagation();
    _menu.classList.toggle('open');
    _menu.setAttribute('aria-hidden', _menu.classList.contains('open') ? 'false' : 'true');
  });
  document.addEventListener('click', closeMenu);
  document.addEventListener('keydown', (e)=>{ if(e.key==='Escape') closeMenu(); });

  // Operasi via tombol asli
  document.getElementById('m-refresh')?.addEventListener('click', ()=>{
    closeMenu();
    document.getElementById('btnRefresh')?.click();
  });
  document.getElementById('m-live')?.addEventListener('click', ()=>{
    closeMenu();
    document.getElementById('btnLive')?.click();
  });
</script>
</body>
</html>


