<!doctype html>
<html lang="ja">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>品質管理生産技術</title>
<style>
  :root{
    --bg:#f6f7fb; --panel:#fff; --ink:#0f172a; --muted:#64748b; --border:#e5e7eb; --ring:#c7d2fe;
    --accent:#2563eb; --danger:#dc2626; --success:#10b981; --warning:#f59e0b; --purple:#8b5cf6;
    --radius-xl:20px; --radius:12px; --shadow:0 15px 40px rgba(15,23,42,.08);
  }
  *{box-sizing:border-box}
  body{margin:0;font-family:system-ui,-apple-system,"Segoe UI",Roboto,"Noto Sans JP","Yu Gothic",sans-serif;background:var(--bg);color:var(--ink)}
  a{text-decoration:none;color:inherit}

  .app{display:grid;grid-template-rows:64px 1fr;grid-template-areas:"header" "main";min-height:100vh}
  header{grid-area:header;position:sticky;top:0;z-index:60;background:#ffffffc7;backdrop-filter:blur(12px);border-bottom:1px solid var(--border)}
  .header-wrap{height:64px;max-width:1400px;margin:0 auto;display:flex;align-items:center;justify-content:space-between;gap:10px;padding:0 14px}
  .brand{display:flex;align-items:center;gap:10px}
  .brand img{height:36px}
  .ttl{font-weight:800}
  .btn{display:inline-flex;align-items:center;gap:8px;height:34px;padding:0 12px;border-radius:10px;border:1px solid var(--border);background:#fff;cursor:pointer}
  .btn:hover{border-color:var(--ring)}
  .badge{height:28px;padding:0 10px;display:inline-flex;align-items:center;gap:8px;font-size:12px;font-weight:700;background:#f1f5f9;border:1px solid var(--border);border-radius:999px;color:var(--ink)}
  .burger{display:none;align-items:center;justify-content:center;width:38px;height:38px;border:1px solid var(--border);border-radius:10px;background:#fff;cursor:pointer}
  .burger:active{transform:scale(.98)}

  main{grid-area:main;max-width:1400px;margin:0 auto;padding:22px 20px 96px}

  /* Hover sidebar */
  .edge-hotspot{position:fixed;left:0;top:64px;width:12px;height:calc(100vh - 64px);z-index:70}
  .hover-side{position:fixed;left:0;top:64px;height:calc(100vh - 64px);width:260px;padding:14px 12px;overflow:auto;background:var(--panel);border-right:1px solid var(--border);box-shadow:var(--shadow);transform:translateX(-100%);transition:transform .22s ease;z-index:71}
  .hover-side.open{transform:translateX(0)}
  .hover-side h3{margin:4px 8px 10px;font-size:12px;letter-spacing:.08em;color:#6b7280;text-transform:uppercase}
  .navlist{display:grid;gap:4px}
  .slink{display:flex;align-items:center;gap:10px;padding:10px 12px;border-radius:12px}
  .slink:hover{background:#f1f5ff}
  .ico{width:22px;text-align:center}

  /* Drawer mobile */
  .drawer{position:fixed;inset:0;z-index:80;display:none}
  .drawer.open{display:block}
  .drawer .backdrop{position:absolute;inset:0;background:#0006}
  .drawer .panel{position:absolute;top:0;left:0;height:100%;width:min(86%,320px);background:#fff;border-right:1px solid var(--border);box-shadow:0 30px 60px rgba(15,23,42,.10);padding:14px 12px;overflow:auto;transform:translateX(-100%);transition:transform .25s ease}
  .drawer.open .panel{transform:translateX(0)}
  .drawer .close{position:absolute;right:10px;top:10px;border:0;background:#f1f5f9;border:1px solid var(--border);border-radius:8px;padding:6px 10px;cursor:pointer}

  /* Urgent banner */
  .urgent-banner{margin:12px 0 6px;background:#fee2e2;border:1px solid #fecaca;color:#991b1b;padding:12px 14px;border-radius:12px;text-align:center;font-weight:800;animation:blink 1.8s linear infinite}
  @keyframes blink{0%,100%{opacity:1;}50%{opacity:.82}}

  /* Panels / table */
  .panel{background:#fff;border:1px solid var(--border);border-radius:20px;box-shadow:var(--shadow);padding:10px}
  .panel + .panel{margin-top:18px}
  h2{margin:8px 0 12px;display:flex;align-items:center;gap:10px}
  .thead{display:grid;grid-template-columns:300px 150px 1fr 210px 80px 1fr;gap:10px;padding:10px 12px;color:#475569}
  .row{display:grid;grid-template-columns:300px 150px 1fr 210px 80px 1fr;gap:10px;align-items:center;padding:14px 12px;border-top:1px solid var(--border)}
  .row:first-child{border-top:0}

  .sbox{display:flex;flex-direction:column;gap:10px;background:#f8fafc;border:1px solid var(--border);border-radius:16px;padding:12px}
  .slabel{display:inline-flex;align-items:center;gap:8px;padding:8px 12px;border-radius:999px;font-weight:700;color:#fff}
  .slabel.shipok{background:#0891b2}
  .slabel.prep{background:#0284c7}
  .slabel.inspect{background:#4f46e5}
  .slabel.hold{background:#dc2626}
  .slabel.assem{background:#f59e0b}
  .slabel.assemok{background:#10b981}
  .slabel.kensaok{background:#16a34a}
  .slabel.proc{background:#22c55e}
  .slabel.laser{background:#ef4444}
  .slabel.sheet{background:#eab308}
  .slabel.out{background:#6366f1}
  .urgent{display:inline-flex;align-items:center;gap:6px;padding:4px 8px;border-radius:999px;background:#fee2e2;color:#b91c1c;font-weight:700}
  .meta{display:grid;gap:6px}
  .meta small{color:#64748b}
  .chip{display:inline-flex;align-items:center;gap:8px;background:#f1f5f9;border:1px solid var(--border);border-radius:999px;padding:8px 12px}
  .num{font-size:18px;font-weight:900}
  .codegroup{display:flex;flex-wrap:wrap;gap:10px}
  .code{display:inline-flex;align-items:center;padding:8px 12px;border-radius:999px;background:#edf2ff;border:1px solid #c7d2fe}

  /* Dropdowns */
  .dropdown{position:relative}
  .drop-btn{display:inline-flex;align-items:center;gap:8px;height:36px;padding:0 12px;border-radius:10px;border:1px solid var(--border);background:#fff;cursor:pointer}
  .drop-menu{position:absolute;top:42px;left:0;min-width:300px;background:#fff;border:1px solid var(--border);border-radius:12px;box-shadow:var(--shadow);padding:10px;display:none;z-index:20}
  .dropdown.open .drop-menu{display:block}
  .chips{display:flex;flex-wrap:wrap;gap:8px}
  .chipbtn{display:inline-flex;align-items:center;gap:8px;padding:8px 12px;border:1px solid var(--border);border-radius:999px;background:#f8fafc;cursor:pointer}
  .chipbtn.active{border-color:var(--accent);box-shadow:0 0 0 3px rgba(37,99,235,.15)}
  .count{font-weight:800;background:#eef2ff;border:1px solid #c7d2fe;border-radius:999px;padding:2px 8px}
  .clearlink{color:#2563eb;cursor:pointer}

  @media (max-width:1100px){
    .thead,.row{grid-template-columns:280px 140px 1fr 200px 70px 1fr}
  }
  @media (max-width:900px){
    .burger{display:inline-flex}
    .edge-hotspot,.hover-side{display:none}
    .thead{display:none}
    .row{grid-template-columns:1fr}
  }
</style>
</head>
<body>
<div class="app">
  <!-- HEADER -->
  <header>
    <div class="header-wrap">
      <button id="btnBurger" class="burger" aria-label="メニュー">☰</button>
      <div class="brand">
        <img src="tsh.png" alt="TSH" onerror="this.style.display='none'">
        <div class="ttl"><strong>品質管理生産技術</strong></div>
      </div>

      <nav class="top-actions" style="display:flex;gap:8px;align-items:center;flex-wrap:wrap">
        <div class="dropdown" id="dateDropdown">
          <button class="drop-btn" type="button">📅 日付フィルター</button>
          <div class="drop-menu">
            <div style="display:grid;gap:8px">
              <button class="chipbtn" data-date-mode="all">🌐 すべて</button>
              <button class="chipbtn" data-date-mode="today">☀ 本日</button>
              <button class="chipbtn" id="latestBtn" data-date-mode="latest">🕒 最新日</button>
              <div style="display:flex;align-items:center;gap:8px">
                <input id="datePick" type="date" style="height:36px;padding:0 10px;border:1px solid var(--border);border-radius:8px">
                <button class="btn" id="applyPick" type="button">適用</button>
              </div>
              <div style="text-align:right"><span class="clearlink" id="clearDate">クリア</span></div>
            </div>
          </div>
        </div>

        <div class="dropdown" id="statusDropdown">
          <button class="drop-btn" type="button">🔎 ステータス フィルター</button>
          <div class="drop-menu">
            <div class="chips" id="chipsBox"></div>
            <div style="margin-top:10px;text-align:right"><span class="clearlink" id="clearFilter">すべて表示</span></div>
          </div>
        </div>

        <button id="btnRefresh" class="btn" type="button">⟳ Refresh</button>
        <button id="btnLive" class="btn" type="button" aria-pressed="false">● Live</button>
        <span id="intervalInfo" class="badge">60s</span>
        <span id="lastup" class="badge muted">—</span>
      </nav>
    </div>
  </header>

  <!-- MAIN -->
  <main>
    <div id="urgentBanner" class="urgent-banner" style="display:none"></div>

    <section class="panel" id="todaySec" style="display:none">
      <h2>本日出荷 <span id="todayCount" class="badge">0件</span></h2>
      <div class="thead"><div>状況</div><div>出荷日</div><div>顧客名</div><div>図番／機種</div><div>数量</div><div>送り先／注番</div></div>
      <div id="todayBody"></div>
    </section>

    <section class="panel">
      <h2>全件一覧（本日以外） <span id="allCount" class="badge">0件</span></h2>
      <div class="thead"><div>状況</div><div>出荷日</div><div>顧客名</div><div>図番／機種</div><div>数量</div><div>送り先／注番</div></div>
      <div id="allBody"></div>
    </section>
  </main>

  <!-- Hover Sidebar -->
  <div id="edgeHotspot" class="edge-hotspot" aria-hidden="true"></div>
  <aside id="hoverSide" class="hover-side" aria-label="Pages">
    <h3>Pages</h3>
    <div class="navlist">
      <a class="slink" href="./index.html"><span class="ico">🏠</span><strong>ホーム</strong><small style="color:#9ca3af;margin-left:6px">Dashboard</small></a>
      <a class="slink" href="./forms.html"><span class="ico">📄</span><strong>出荷検査成績書</strong></a>
      <a class="slink" href="./sagyoutejunsho.html"><span class="ico">📝</span><strong>作業手順書</strong></a>
      <!-- … item lain … -->
<a class="slink" href="https://script.google.com/macros/s/AKfycby8r4RhaLzwpsbl8W57-iH3GA_GF_zHmP72maD6wz8N98aOjryECfmmkOKFzZCOK_rP7Q/exec" target="_blank" rel="noopener noreferrer">
  <span class="ico">✍️</span><strong>出荷検査確認書 – 入力フォーム</strong>
</a>

<!-- Kembalikan tautan lama juga -->
<a class="slink" href="https://script.google.com/macros/s/AKfycbx1d5ugMfPp0lrG1AVw6VYV8CiZECKt3tBNFlm6a9y7xSej7PVDsKGjehoNJsUBrBhaRA/exec" target="_blank" rel="noopener noreferrer">
  <span class="ico">✍️</span><strong>進捗状況入力フォーム</strong>
</a>

      <a class="slink" href="./charts.html"><span class="ico">📈</span><strong>チャート</strong></a>
      <a class="slink" href="./quality.html"><span class="ico">🔎</span><strong>品質情報</strong></a>
      <a class="slink" href="./claim.html"><span class="ico">🧪</span><strong>Trial Page</strong></a>
    </div>
  </aside>

  <!-- Drawer mobile -->
  <div id="drawer" class="drawer" aria-hidden="true">
    <div class="backdrop" data-close></div>
    <aside class="panel">
      <button class="close" data-close>✕</button>
      <div class="navlist" style="margin-top:30px">
        <a class="slink" href="./index.html"><span class="ico">🏠</span><strong>ホーム</strong><small style="color:#9ca3af;margin-left:6px">Dashboard</small></a>
        <a class="slink" href="./forms.html"><span class="ico">📄</span><strong>出荷検査成績書</strong></a>
        <a class="slink" href="./sagyoutejunsho.html"><span class="ico">📝</span><strong>作業手順書</strong></a>
        <!-- … item lain … -->
<a class="slink" href="https://script.google.com/macros/s/AKfycby8r4RhaLzwpsbl8W57-iH3GA_GF_zHmP72maD6wz8N98aOjryECfmmkOKFzZCOK_rP7Q/exec" target="_blank" rel="noopener noreferrer">
  <span class="ico">✍️</span><strong>出荷検査確認書 – 入力フォーム</strong>
</a>

<!-- Kembalikan tautan lama juga -->
<a class="slink" href="https://script.google.com/macros/s/AKfycbx1d5ugMfPp0lrG1AVw6VYV8CiZECKt3tBNFlm6a9y7xSej7PVDsKGjehoNJsUBrBhaRA/exec" target="_blank" rel="noopener noreferrer">
  <span class="ico">✍️</span><strong>進捗状況入力フォーム</strong>
</a>

        <a class="slink" href="./charts.html"><span class="ico">📈</span><strong>チャート</strong></a>
        <a class="slink" href="./quality.html"><span class="ico">🔎</span><strong>品質情報</strong></a>
        <a class="slink" href="./claim.html"><span class="ico">🧪</span><strong>Trial Page</strong></a>
      </div>
    </aside>
  </div>
</div>

<script>
/* ===== Drawer & hover ===== */
const drawer = document.getElementById('drawer');
document.getElementById('btnBurger')?.addEventListener('click', ()=>{ drawer.classList.add('open'); drawer.setAttribute('aria-hidden','false');});
drawer?.addEventListener('click', e=>{ if(e.target.hasAttribute('data-close')){ drawer.classList.remove('open'); drawer.setAttribute('aria-hidden','true');}});

const hot=document.getElementById('edgeHotspot'); const fly=document.getElementById('hoverSide');
let hideTimer=null; const HIDE_DELAY=280;
function openFly(){clearTimeout(hideTimer); fly.classList.add('open')}
function scheduleClose(){clearTimeout(hideTimer); hideTimer=setTimeout(()=>fly.classList.remove('open'),HIDE_DELAY)}
hot?.addEventListener('mouseenter', openFly); hot?.addEventListener('mouseleave', scheduleClose);
fly?.addEventListener('mouseenter', ()=>clearTimeout(hideTimer)); fly?.addEventListener('mouseleave', scheduleClose);

/* ===== Data source ===== */
const SHEET_ID ="1lYl7oYk6atnm3KqC6VwufARX3ooRyJ2VmC_xYFb4-OE";
const TAB_NAME ="最新情報";
const CSV_URL = `https://docs.google.com/spreadsheets/d/${SHEET_ID}/gviz/tq?tqx=out:csv&sheet=${encodeURIComponent(TAB_NAME)}`;

const safeTrim = s => String(s ?? '').trim();
function parseCSV(t){
  const out=[], re=/\s*("(?:[^"]|"")*"|[^,]*)\s*(,|\n|$)/g; let row=[], m; t=t.replace(/\r\n?/g,"\n");
  for(let i=0;i<t.length;){ re.lastIndex=i; m=re.exec(t); if(!m) break;
    let cell=m[1]; if(cell.startsWith('"')) cell=cell.slice(1,-1).replace(/""/g,'"');
    row.push(cell); i=re.lastIndex; if(m[2]==="\n"||m[2]===""){ out.push(row); row=[]; }
  } return out.filter(r=>r.length && r.some(c=>safeTrim(c)!==""));
}
function indexByName(header){
  const map={}; header.forEach((h,i)=>map[safeTrim(h)]=i);
  const f = n => (n in map ? map[n] : null);
  const fRx = rx => { for(let i=0;i<header.length;i++){ if(rx.test(safeTrim(header[i]))) return i; } return null; };
  return {
    date: f('出荷日'), cust: f('顧客名'), draw: fRx(/図番|図面|Drawing/), machine: fRx(/機種/),
    qty: f('数量'), to: fRx(/送り先|送付先|納品先/), note: fRx(/注番|備考|注文/),
    status: fRx(/製品状況|製品状態|納品状況/), ts: f('製品状況更新日時'), user: f('更新者'),
    urgent: fRx(/Status|至急|ステータス/i)
  };
}
const valAt=(r,i)=> (i==null?'':(r[i]??''));
function parseJPDate(str){
  const s=safeTrim(str); if(!s) return null;
  const m=s.match(/^(\d{4})\D(\d{1,2})\D(\d{1,2})(?:\D(\d{1,2})\D(\d{1,2}))?/);
  if(m) return new Date(m[1],m[2]-1,m[3],m[4]||0,m[5]||0);
  const d=new Date(s); return isNaN(d)?null:d;
}
function fmtTS(d){ if(!d) return ''; const z=n=>String(n).padStart(2,'0'); return `${String(d.getFullYear()).slice(2)}/${z(d.getMonth()+1)}/${z(d.getDate())} ${z(d.getHours())}:${z(d.getMinutes())}` }
function fmtDate(d){ if(!d) return ''; const z=n=>String(n).padStart(2,'0'); return `${d.getFullYear()}-${z(d.getMonth()+1)}-${z(d.getDate())}` }
function sameYMD(a,b){return a&&b&&a.getFullYear()===b.getFullYear()&&a.getMonth()===b.getMonth()&&a.getDate()===b.getDate()}

/* ===== Status dictionary ===== */
const STATUS = [
  {key:'shipok',   label:'出荷済',     icon:'📦', cls:'shipok',  rx:/出荷済/},
  {key:'prep',     label:'出荷準備済', icon:'🚚', cls:'prep',    rx:/出荷準備済/},
  {key:'inspect',  label:'検査中',     icon:'🔬', cls:'inspect', rx:/検査中/},
  {key:'kensaok',  label:'検査済',     icon:'✅', cls:'kensaok', rx:/検査済/},
  {key:'hold',     label:'検査保留',   icon:'⛔', cls:'hold',    rx:/検査保留|保留/},
  {key:'assem',    label:'組立中',     icon:'🧰', cls:'assem',   rx:/組立中/},
  {key:'assemok',  label:'組立完了',   icon:'✅', cls:'assemok', rx:/組立(完了|済)/},
  {key:'proc',     label:'加工済',     icon:'🔧', cls:'proc',    rx:/加工済/},
  {key:'laser',    label:'レーザ加工', icon:'🪚', cls:'laser',   rx:/レーザ/},
  {key:'sheet',    label:'板金加工',   icon:'🔩', cls:'sheet',   rx:/板金/},
  {key:'out',      label:'外注',       icon:'🏭', cls:'out',     rx:/外注/},
];

/* map status string -> dict */
function statusInfo(raw){
  const t=safeTrim(raw);
  for(const s of STATUS){ if(s.rx.test(t)) return {label:s.label, cls:s.cls}; }
  return {label: t || '—', cls:'inspect'};
}
function isUrgent(v){const t=safeTrim(v).toLowerCase(); return t==='至急'||t==='urgent'||t==='緊急'||t==='1'||t==='true'}

/* ===== STATE: filters ===== */
let cache={header:[],rows:[],idx:null};
let activeStatusKey=null;
let dateFilter={mode:'all', date:null};

/* ===== Utils ===== */
function applyStatusFilter(rows, idx){
  if(!activeStatusKey) return rows;
  const d=STATUS.find(s=>s.key===activeStatusKey);
  if(!d) return rows;
  return rows.filter(r=> d.rx.test(safeTrim(valAt(r,idx.status))));
}
function getShipDate(r, idx){ return parseJPDate(valAt(r,idx.date)); }
function latestShipDate(rows, idx){
  let best=null;
  for(const r of rows){
    const d=getShipDate(r,idx);
    if(d && (!best || d>best)) best=d;
  }
  return best;
}
function applyDateFilter(rows, idx){
  if(idx.date==null) return rows;
  const today=new Date();
  if(dateFilter.mode==='today'){
    return rows.filter(r=>{ const d=getShipDate(r,idx); return d && sameYMD(d,today); });
  }
  if(dateFilter.mode==='latest'){
    const ld = latestShipDate(rows, idx);
    if(!ld) return rows;
    return rows.filter(r=>{ const d=getShipDate(r,idx); return d && sameYMD(d, ld); });
  }
  if(dateFilter.mode==='pick' && dateFilter.date){
    return rows.filter(r=>{ const d=getShipDate(r,idx); return d && fmtDate(d)===dateFilter.date; });
  }
  return rows;
}

/* ===== Rendering ===== */
function makeRow(r, idx){
  const st = statusInfo(valAt(r,idx.status));
  const ts = parseJPDate(valAt(r,idx.ts));
  const user = safeTrim(valAt(r,idx.user));
  const urgentChip = idx.urgent!=null && isUrgent(valAt(r,idx.urgent)) ? `<span class="urgent">⚠ 至急</span>` : '';
  const sbox = `<div class="sbox">
      <div class="slabel ${st.cls}">${st.label}</div>
      ${urgentChip}
      <div class="meta"><div><small>更新日：</small><strong>${ts?fmtTS(ts):'—'}</strong></div><div><small>更新者：</small><strong>${user||'—'}</strong></div></div>
    </div>`;
  const d=parseJPDate(valAt(r,idx.date)); const dateChip=`<span class="chip">📅 ${d?fmtDate(d):'—'}</span>`;
  const cust=safeTrim(valAt(r,idx.cust)), draw=safeTrim(valAt(r,idx.draw)), machine=safeTrim(valAt(r,idx.machine)), qty=safeTrim(valAt(r,idx.qty)), to=safeTrim(valAt(r,idx.to)), note=safeTrim(valAt(r,idx.note));
  const codes=[]; if(note) note.split(/\s+/).filter(Boolean).forEach(c=>codes.push(`<span class="code">${c}</span>`));
  return `<div class="row">
    <div>${sbox}</div>
    <div>${dateChip}</div>
    <div><div style="font-weight:800">${cust||'—'}</div></div>
    <div><div style="font-weight:700">${draw||'—'}</div><div class="muted" style="margin-top:4px">${machine||''}</div></div>
    <div class="num">${qty||''}</div>
    <div><div style="font-weight:700">${to||'—'}</div><div class="codegroup" style="margin-top:8px">${codes.join('')}</div></div>
  </div>`;
}

function render(){
  const {rows,idx}=cache;

  const counts = {}; for(const s of STATUS) counts[s.key]=0;
  rows.forEach(r=>{ const t=safeTrim(valAt(r,idx.status)); for(const s of STATUS){ if(s.rx.test(t)){ counts[s.key]++; break; } }});
  renderChips(counts);

  const urgentCount=idx.urgent!=null ? rows.filter(r=>isUrgent(valAt(r,idx.urgent))).length : 0;
  const ub=document.getElementById('urgentBanner');
  if(urgentCount>0){ ub.style.display='block'; ub.textContent=`⚠ 至急案件が ${urgentCount} 件あります！早急に確認してください。`; }
  else{ ub.style.display='none'; ub.textContent=''; }

  let filtered = applyStatusFilter(rows, idx);
  filtered = applyDateFilter(filtered, idx);
  filtered.sort((a,b)=>{
    const da=getShipDate(a,idx), db=getShipDate(b,idx);
    if(da && db && da.getTime()!==db.getTime()) return db-da;
    const ta=parseJPDate(valAt(a,idx.ts)), tb=parseJPDate(valAt(b,idx.ts));
    if(ta && tb) return tb-ta;
    return 0;
  });

  const today=new Date();
  const rowsToday = idx.date!=null ? filtered.filter(r=>{ const d=getShipDate(r,idx); return d && sameYMD(d,today); }) : [];
  const rowsNotToday = idx.date!=null ? filtered.filter(r=>{ const d=getShipDate(r,idx); return !(d && sameYMD(d,today)); }) : filtered.slice();

  const secToday=document.getElementById('todaySec');
  if(rowsToday.length){ secToday.style.display=''; document.getElementById('todayBody').innerHTML = rowsToday.map(r=>makeRow(r,idx)).join(''); }
  else{ secToday.style.display='none'; document.getElementById('todayBody').innerHTML=''; }
  document.getElementById('todayCount').textContent = `${rowsToday.length}件`;

  document.getElementById('allBody').innerHTML = rowsNotToday.map(r=>makeRow(r,idx)).join('');
  document.getElementById('allCount').textContent = `${rowsNotToday.length}件`;

  const ld = latestShipDate(rows, idx);
  const latestBtn = document.getElementById('latestBtn');
  if(ld){ latestBtn.textContent = `🕒 最新日 (${fmtDate(ld)})`; }
  highlightDateButtons();
}

function renderChips(counts){
  const box=document.getElementById('chipsBox');
  const makeChip=(key,label,icon,cnt)=>`<button class="chipbtn ${activeStatusKey===key?'active':''}" data-key="${key}">${icon} ${label} <span class="count">${cnt}</span></button>`;
  let html = `<button class="chipbtn ${!activeStatusKey?'active':''}" data-key="">🌐 すべて <span class="count">${cache.rows.length}</span></button>`;
  for(const s of STATUS){ html += makeChip(s.key,s.label,s.icon, counts[s.key]||0); }
  box.innerHTML=html;
  box.querySelectorAll('.chipbtn').forEach(b=>{
    b.addEventListener('click', ()=>{
      const k=b.getAttribute('data-key'); activeStatusKey = k || null;
      render(); closeAllDropdowns();
    });
  });
}

/* ===== Fetch & live ===== */
async function load(){
  const btn=document.getElementById('btnRefresh'); const old=btn.textContent;
  try{
    btn.textContent='Loading…'; btn.disabled=true;
    const res=await fetch(CSV_URL+'&_ts='+Date.now(),{cache:'no-store'});
    const text=await res.text();
    const data=parseCSV(text);
    const header=data[0], rows=data.slice(1);
    const idx=indexByName(header);
    cache={header,rows,idx};
    render();
    document.getElementById('lastup').textContent='Last update: '+new Date().toLocaleString();
  }finally{
    btn.textContent=old; btn.disabled=false;
  }
}
let timer=null,intervalMs=60000;
function startAuto(ms){ intervalMs=ms; clearInterval(timer); timer=setInterval(()=>{ if(document.visibilityState==='visible') load(); }, intervalMs); document.getElementById('intervalInfo').textContent=Math.round(intervalMs/1000)+'s'; const b=document.getElementById('btnLive'); b.textContent=intervalMs<=5000?'● Live: On':'● Live: Off';}
document.getElementById('btnRefresh').addEventListener('click', load);
document.getElementById('btnLive').addEventListener('click', ()=>{ startAuto(intervalMs<=5000?60000:5000); load(); });
document.addEventListener('visibilitychange', ()=>{ if(document.visibilityState==='visible') load(); });

/* ===== Dropdown behaviors ===== */
const dropdownStatus=document.getElementById('statusDropdown');
dropdownStatus.querySelector('.drop-btn').addEventListener('click', ()=> dropdownStatus.classList.toggle('open'));

const dropdownDate=document.getElementById('dateDropdown');
dropdownDate.querySelector('.drop-btn').addEventListener('click', ()=> dropdownDate.classList.toggle('open'));

document.getElementById('clearFilter').addEventListener('click', ()=>{ activeStatusKey=null; render(); closeAllDropdowns();});
document.getElementById('clearDate').addEventListener('click', ()=>{ dateFilter={mode:'all',date:null}; document.getElementById('datePick').value=''; render(); closeAllDropdowns(); });

document.getElementById('applyPick').addEventListener('click', ()=>{
  const v=document.getElementById('datePick').value;
  if(v){ dateFilter={mode:'pick', date:v}; render(); closeAllDropdowns(); }
});

dropdownDate.querySelectorAll('[data-date-mode]').forEach(btn=>{
  btn.addEventListener('click', ()=>{
    const mode=btn.getAttribute('data-date-mode');
    if(mode==='all') dateFilter={mode:'all',date:null};
    if(mode==='today') dateFilter={mode:'today',date:null};
    if(mode==='latest') dateFilter={mode:'latest',date:null};
    render(); closeAllDropdowns();
  });
});

function closeAllDropdowns(){
  dropdownStatus.classList.remove('open');
  dropdownDate.classList.remove('open');
}
document.addEventListener('click', (e)=>{ 
  if(!dropdownStatus.contains(e.target)) dropdownStatus.classList.remove('open'); 
  if(!dropdownDate.contains(e.target)) dropdownDate.classList.remove('open'); 
});

function highlightDateButtons(){
  dropdownDate.querySelectorAll('[data-date-mode]').forEach(b=>b.classList.remove('active'));
  const b = dropdownDate.querySelector(`[data-date-mode="${dateFilter.mode==='pick'?'custom':dateFilter.mode}"]`);
  if(b) b.classList.add('active');
}

/* boot */
load(); startAuto(60000);
</script>
</body>
</html>
