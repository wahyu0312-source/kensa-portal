<!doctype html>
<html lang="ja">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>å“è³ªç®¡ç†ç”Ÿç”£æŠ€è¡“ - å‡ºè·çŠ¶æ³ä¸€è¦§</title>
  <style>
    :root{
      --bg1:#f0f4ff; --bg2:#e6ecff; --card:#ffffff; --text:#0f172a; --muted:#64748b; --border:#e5e7eb;
      --accent:#2563eb; --danger:#b91c1c; --shadow:0 8px 24px rgba(15,23,42,.08);
    }
    *{box-sizing:border-box}
    body{margin:0;font-family:system-ui,-apple-system,Segoe UI,Roboto,"Noto Sans JP","Yu Gothic",Helvetica,Arial;
      background:linear-gradient(135deg,var(--bg1),var(--bg2));color:var(--text);}
    header{background:#fff;border-bottom:1px solid var(--border);padding:12px 24px;
      display:flex;align-items:center;justify-content:space-between;box-shadow:var(--shadow);}
    .brand{display:flex;align-items:center;gap:12px}
    .brand img{width:42px;height:42px;border-radius:50%;object-fit:cover}
    .brand .title{font-weight:700;font-size:1.1rem}
    .brand .subtitle{color:var(--muted);font-size:.9rem}
    nav a{text-decoration:none;margin-left:20px;color:var(--muted);font-weight:700}
    nav a:hover{color:var(--accent)}

    main{max-width:1200px;margin:30px auto;padding:0 20px}
    h1{font-size:1.5rem;margin:0 0 16px 0}
    h2{margin:0}

    .card{background:var(--card);padding:20px;border-radius:16px;box-shadow:var(--shadow);overflow:auto;border:1px solid var(--border)}

    table{width:100%;border-collapse:collapse;font-size:.95rem}
    th,td{padding:10px 12px;border-bottom:1px solid var(--border);white-space:nowrap;text-align:left}
    thead th{background:#f9fafb;color:#475569;position:sticky;top:0}
    tbody tr:last-child td{border-bottom:none}
    tbody tr:hover{background:#f3f6ff}
    .right{text-align:right}
    .red{color:var(--danger);font-weight:700}
    .muted{color:var(--muted)}

    .section-title{display:flex;align-items:center;gap:10px;margin:24px 0 12px 0}
    .chip{font-size:12px;border-radius:999px;padding:4px 10px;border:1px solid var(--border);background:#fff}
    .chip.urgent{border-color:var(--danger);color:var(--danger)}
    .list{list-style:none;margin:0;padding:0}
    .list li{display:flex;justify-content:space-between;align-items:center;padding:10px 12px;border-bottom:1px dashed var(--border)}
    .hint{margin-top:8px}
  </style>
</head>
<body>
  <header>
    <div class="brand">
      <img src="https://upload.wikimedia.org/wikipedia/commons/thumb/f/f8/Tokyo_Seimitsu_company_logo.svg/512px-Tokyo_Seimitsu_company_logo.svg.png" alt="logo">
      <div>
        <div class="title">å“è³ªç®¡ç†ç”Ÿç”£æŠ€è¡“</div>
        <div class="subtitle">æ±äº¬ç²¾å¯†ç™ºæ¢æ ªå¼ä¼šç¤¾</div>
      </div>
    </div>
    <nav>
      <a href="./index.html">ãƒ›ãƒ¼ãƒ </a>
      <a href="./forms.html"><strong>å‡ºè·æ¤œæŸ»æˆç¸¾æ›¸</strong></a>
      <a href="./sagyoutejunsho.html">ä½œæ¥­æ‰‹é †æ›¸</a>
    </nav>
  </header>

  <main>
    <h1>å‡ºè·çŠ¶æ³ä¸€è¦§</h1>

    <!-- å‡ºè·çŠ¶æ³ãƒ†ãƒ¼ãƒ–ãƒ«ï¼ˆSpreadsheet Aï¼‰ -->
    <section class="card" id="tableCard">
      <table id="sheet-table">
        <thead><tr id="thead"></tr></thead>
        <tbody id="tbody"></tbody>
      </table>
      <div class="muted hint" id="tableHint"></div>
    </section>

    <!-- Urgentï¼ˆè‡³æ€¥ï¼‰ï¼ˆSpreadsheet Bï¼‰ -->
    <div class="section-title">
      <h2>ğŸ”´ Urgentï¼ˆè‡³æ€¥ï¼‰</h2>
      <span id="urgentCount" class="chip">0 ä»¶</span>
    </div>
    <section class="card">
      <ul id="urgentList" class="list"></ul>
      <div id="noUrgent" class="muted" style="display:none">ç¾åœ¨ã€è‡³æ€¥å“ç›®ã¯ã‚ã‚Šã¾ã›ã‚“ã€‚</div>
      <div class="muted hint" id="urgentHint"></div>
    </section>
  </main>

  <footer class="muted" style="text-align:center;padding:24px">
    &copy; <span id="year"></span> æ±äº¬ç²¾å¯†ç™ºæ¢æ ªå¼ä¼šç¤¾
  </footer>

  <script>
    document.getElementById("year").textContent = new Date().getFullYear();

    // ============================
    // KONFIGURASI GOOGLE SHEETS
    // ============================
    // Spreadsheet A (å‡ºè·çŠ¶æ³ä¸€è¦§)
    const SHIP_SHEET_ID = "1lYl7oYk6atnm3KqC6VwufARX3ooRyJ2VmC_xYFb4-OE";
    const SHIP_TAB      = "æœ€æ–°æƒ…å ±";     // ganti ke tab yang kamu pakai (mis. "æœ€æ–°æƒ…å ±")
    // Spreadsheet B (Urgent)
    const URG_SHEET_ID  = "1jOB1xz1N4AcSQRYkBSoeqDmAAEQLp1dALlpal2ON5wo";
    const URG_TAB       = "urgent";         // silakan buat tab ini; bebas asal konsisten

    const csvUrl = (sheetId, tab) =>
      `https://docs.google.com/spreadsheets/d/${sheetId}/gviz/tq?tqx=out:csv&sheet=${encodeURIComponent(tab)}&_ts=${Date.now()}`;

    // ============================
    // CSV parser sederhana
    // ============================
    function parseCSV(text){
      const rows=[], re=/\s*("(?:[^"]|"")*"|[^,]*)\s*(,|\n|$)/g;
      let m, row=[]; text=text.replace(/\r\n?/g,"\n");
      for (let i=0;i<text.length;){
        re.lastIndex=i; m=re.exec(text); if(!m) break;
        let cell=m[1]; if(cell.startsWith('"')) cell=cell.slice(1,-1).replace(/""/g,'"');
        row.push(cell); i=re.lastIndex;
        if(m[2]==="\n"||m[2]===""){ rows.push(row); row=[]; }
      }
      // buang baris kosong total
      return rows.filter(r=>r.length && r.some(c=>String(c).trim()!==""));
    }
    const S = s => String(s ?? "").trim();

    function buildIndex(header){
      const map = {}; header.forEach((h,i)=> map[S(h)] = i);
      const find = (names) => { for(const n of names) if(n in map) return map[n]; return null; };
      return {
        date:  find(["å‡ºè·æ—¥","æ—¥ä»˜","Date"]),
        cust:  find(["é¡§å®¢å","å®¢å…ˆ","Customer"]),
        item:  find(["å•†å“å","å“å","Item"]),
        qty:   find(["æ•°é‡","Qty"]),
        done:  find(["æ¸ˆã¿","é€²æ—","Status"]),
        urg:   find(["è‡³æ€¥","Urgent"]),
        dest:  find(["é€ã‚Šå…ˆ","Destination"]),
        order: find(["æ³¨ç•ª","Order"]),
        model: find(["æ©Ÿç¨®","Model"]),
        draw:  find(["å›³ç•ª","Drawing"])
      };
    }

    // ================
    // å‡ºè·çŠ¶æ³: render
    // ================
    async function loadShip(){
      const res  = await fetch(csvUrl(SHIP_SHEET_ID, SHIP_TAB));
      if(!res.ok) throw new Error("HTTP "+res.status);
      const data = parseCSV(await res.text());
      if(!data.length) return;

      let header = data[0], rows = data.slice(1);
      const headerWords = new Set(["å‡ºè·æ—¥","é¡§å®¢å","å›³ç•ª","æ©Ÿç¨®","å•†å“å","æ•°é‡","é€ã‚Šå…ˆ","æ³¨ç•ª","æ¸ˆã¿","å‚™è€ƒ","è£½å“çŠ¶æ³"]);
      if(!headerWords.has(S(header[0]))){
        header = ["å‡ºè·æ—¥","é¡§å®¢å","å›³ç•ª","æ©Ÿç¨®","å•†å“å","æ•°é‡","é€ã‚Šå…ˆ","æ³¨ç•ª","æ¸ˆã¿"];
        rows   = data;
      }

      // header
      document.getElementById("thead").innerHTML =
        header.map(h=>`<th>${h}</th>`).join("");

      // rows
      const tbody = document.getElementById("tbody");
      tbody.innerHTML = "";
      rows.forEach(r=>{
        const cells=[...r]; while(cells.length<header.length) cells.push("");
        const html = cells.map((c,idx)=>{
          const lab=S(header[idx]);
          const isDoneCol=/æ¸ˆ/.test(lab);
          const ng=isDoneCol && S(c) && S(c)!=="æ¸ˆã¿";
          const alignRight=/æ•°é‡|Qty|æ•°/.test(lab);
          return `<td class="${ng?'red':''}" style="${alignRight?'text-align:right':''}">${c}</td>`;
        }).join("");
        tbody.insertAdjacentHTML("beforeend", `<tr>${html}</tr>`);
      });

      document.getElementById("tableHint").textContent =
        `ãƒ‡ãƒ¼ã‚¿å…ƒ: ${SHIP_TAB}ï¼ˆ${rows.length} è¡Œï¼‰`;
      return {header, rows};
    }

    // ==================
    // Urgentï¼ˆå°‚ç”¨ã‚·ãƒ¼ãƒˆï¼‰
    // ==================
    async function loadUrgentDedicated(){
      const res  = await fetch(csvUrl(URG_SHEET_ID, URG_TAB));
      if(!res.ok) throw new Error("HTTP "+res.status);
      const data = parseCSV(await res.text());
      if(!data.length) throw new Error("empty urgent sheet");
      const header = data[0], rows = data.slice(1);
      const idx = buildIndex(header);

      const urgent = rows.map(r=>({
        date:S(r[idx.date ?? -1]),
        cust:S(r[idx.cust ?? -1]),
        item:S(r[idx.item ?? -1]),
        qty: S(r[idx.qty  ?? -1]),
        done:S(r[idx.done ?? -1])
      })).filter(u=>Object.values(u).some(x=>S(x)!==""));

      renderUrgent(urgent, `ãƒ‡ãƒ¼ã‚¿å…ƒ: ${URG_TAB}ï¼ˆ${urgent.length} ä»¶ï¼‰`);
    }

    // ==================
    // Urgentï¼ˆfallbackï¼‰
    // ==================
    function loadUrgentFromMain(mainHeader, mainRows){
      const idx = buildIndex(mainHeader);
      const urgent = [];
      mainRows.forEach(r=>{
        const urg  = r[idx.urg  ?? -1];
        const done = r[idx.done ?? -1];
        let isUrg = false;
        if(idx.urg != null){
          const v = S(urg).toLowerCase();
          isUrg = v==="true" || v==="1" || v.includes("è‡³æ€¥");
        }else if(idx.done != null){
          isUrg = S(done) && S(done)!=="æ¸ˆã¿";
        }
        if(isUrg){
          urgent.push({
            date:S(r[idx.date ?? -1]),
            cust:S(r[idx.cust ?? -1]),
            item:S(r[idx.item ?? -1]),
            qty: S(r[idx.qty  ?? -1]),
            done:S(done)
          });
        }
      });
      renderUrgent(urgent, `ãƒ‡ãƒ¼ã‚¿å…ƒ: ${SHIP_TAB}ï¼ˆãƒ•ã‚£ãƒ«ã‚¿ï¼‰${urgent.length?`ï¼š${urgent.length} ä»¶`:''}`);
    }

    // ================
    // Render Urgent UI
    // ================
    function renderUrgent(list, hint){
      const ul = document.getElementById("urgentList");
      const no = document.getElementById("noUrgent");
      const badge = document.getElementById("urgentCount");
      ul.innerHTML = "";
      badge.textContent = `${list.length} ä»¶`;
      document.getElementById("urgentHint").textContent = hint || "";

      if(list.length===0){ no.style.display='block'; return; }
      no.style.display='none';

      list.forEach(u=>{
        const li = document.createElement("li");
        li.innerHTML = `
          <div>
            <strong>${u.item || '(å“åæœªè¨­å®š)'}</strong> <span class="chip urgent">è‡³æ€¥</span>
            <div class="muted">é¡§å®¢: ${u.cust || '-'} ï¼ å‡ºè·æ—¥: ${u.date || '-'}</div>
          </div>
          <span class="chip">
            ${u.qty ? ('æ•°é‡: ' + u.qty) : ''} ${u.done && u.done!=='æ¸ˆã¿' ? 'ï¼ çŠ¶æ…‹: '+u.done : ''}
          </span>`;
        ul.appendChild(li);
      });
    }

    // ==================
    // Boot + Refresh
    // ==================
    async function boot(){
      try{
        const main = await loadShip(); // tabel utama
        try{
          await loadUrgentDedicated(); // prioritas: sheet urgent khusus
        }catch(_){
          if(main) loadUrgentFromMain(main.header, main.rows); // fallback
        }
      }catch(e){
        console.error(e);
        document.getElementById("tableHint").textContent = "èª­ã¿è¾¼ã¿ã«å¤±æ•—ã—ã¾ã—ãŸã€‚ã‚·ãƒ¼ãƒˆå/å…¬é–‹è¨­å®šã‚’ã”ç¢ºèªãã ã•ã„ã€‚";
        document.getElementById("urgentHint").textContent = "";
      }
    }

    window.addEventListener("DOMContentLoaded", boot);
    setInterval(boot, 60000); // auto-refresh 60 dtk
  </script>
</body>
</html>

