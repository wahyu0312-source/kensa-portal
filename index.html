<!doctype html>
<html lang="ja">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Kensa Portal</title>
  <style>
    :root{--bg:#0b1020;--card:#111834;--text:#e6e9f2;--muted:#9aa4bf;--accent:#7c9eff;--border:#1b2347;}
    *{box-sizing:border-box} html,body{margin:0;padding:0;background:var(--bg);color:var(--text);}
    .container{max-width:1100px;margin:0 auto;padding:20px}
    .header{display:flex;align-items:center;justify-content:space-between;gap:16px}
    .brand{font-weight:700;font-size:1.2rem;letter-spacing:.5px}
    .header a{margin-right:12px;color:var(--muted);text-decoration:none}
    .header a:hover{color:var(--text)}
    .card{background:linear-gradient(180deg,rgba(255,255,255,.04),rgba(255,255,255,.02));border:1px solid var(--border);border-radius:16px;padding:18px;box-shadow:0 10px 30px rgba(0,0,0,.25)}
    .hero.card{display:flex;flex-direction:column;gap:6px}
    .cards-grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(180px,1fr));gap:14px;margin-top:12px}
    .stat{display:flex;flex-direction:column;gap:4px}.stat .k{color:var(--muted);font-size:.9rem}.stat .v{font-size:2rem;font-weight:700}
    .card-head{display:flex;align-items:center;justify-content:space-between;gap:12px;margin-top:12px}
    .controls{color:var(--muted);display:flex;align-items:center;gap:8px}
    .table-wrap{overflow:auto;border:1px solid var(--border);border-radius:12px;margin-top:10px}
    table{width:100%;border-collapse:collapse}
    th,td{border-bottom:1px solid var(--border);padding:10px 12px;text-align:left;white-space:nowrap}
    th{color:var(--muted);font-weight:600;background:rgba(255,255,255,.03);position:sticky;top:0}
    .badge{border:1px solid var(--border);padding:2px 8px;border-radius:999px}
    .footer{color:var(--muted);font-size:.9rem;text-align:center;padding:24px 0}
  </style>
</head>
<body>
  <header class="container header">
    <div class="brand">Kensa Portal</div>
    <nav>
      <a href="./index.html">ホーム</a>
      <a href="./forms.html">フォーム</a>
    </nav>
  </header>

  <main class="container">
    <section class="hero card">
      <h1>出荷・工程ステータス</h1>
      <p>Google スプレッドシートの最新情報</p>
    </section>

    <section class="cards-grid" id="status-cards"></section>

    <section class="card">
      <div class="card-head">
        <h2>最新データ</h2>
        <div class="controls">
          <label>表示件数</label>
          <select id="limit">
            <option value="20">20</option>
            <option value="50" selected>50</option>
            <option value="100">100</option>
          </select>
          <span>件</span>
          <button id="refresh" style="margin-left:8px">再読込</button>
        </div>
      </div>
      <div class="table-wrap">
        <table>
          <thead><tr id="thead-row"></tr></thead>
          <tbody id="tbody"></tbody>
        </table>
      </div>
    </section>
  </main>

  <footer class="container footer">
    <span>&copy; <span id="year"></span> Kensa</span>
  </footer>

  <script>
    document.getElementById('year').textContent = new Date().getFullYear();

    // ==== KONFIG JP ====
    const CSV_URL = "https://docs.google.com/spreadsheets/d/e/2PACX-1vRnouue0U6I91_wLiiRChdRzaQ_bTAicgk8ApzeTP0771weOiQQnKJ0Myizc-yXuLGI9rK2sdZRUGkL/pub?output=csv";
    const RECENT_LIMIT_DEFAULT = 50;

    // header mapping: tambahkan/ubah sesuai header di Sheet (row 1)
    const MAP = {
      ship_date:   ["出荷日","日付","date"],
      customer:    ["顧客名","会社","メーカー","customer"],
      drawing_no:  ["図番","図面","drawing","図面番号"],
      product:     ["商品名","品目","item","部品名"],
      qty:         ["数量","個数","qty","数量(個)"],
      destination: ["送り先","送付先","納入先","destination"],
      note:        ["注意","注意点","指示","note"],
      remark:      ["備考","メモ","remark","備考欄"],
      status:      ["ステータス","状態","工程","status","製品"] // 「Clear」が入る列名もここに
    };

    const DISPLAY = [
      { key:"ship_date",  label:"出荷日" },
      { key:"customer",   label:"顧客名" },
      { key:"drawing_no", label:"図番" },
      { key:"product",    label:"商品名" },
      { key:"qty",        label:"数量" },
      { key:"destination",label:"送り先" },
      { key:"note",       label:"注意" },
      { key:"remark",     label:"備考" },
      { key:"status",     label:"ステータス" }
    ];

    // ==== CSV parser (quoted) ====
    function parseCSV(text){
      const rows=[], re=/\s*("(?:[^"]|"")*"|[^,]*)\s*(,|\n|$)/g;
      let m, row=[]; text=text.replace(/\r\n?/g,"\n");
      for (let i=0;i<text.length;){
        re.lastIndex=i; m=re.exec(text); if(!m) break;
        let cell=m[1]; if(cell.startsWith('"')) cell=cell.slice(1,-1).replace(/""/g,'"');
        row.push(cell); i=re.lastIndex;
        if(m[2]==="\n"||m[2]===""){ rows.push(row); row=[]; }
      }
      return rows.filter(r=>r.length && r.join("").trim()!=="");
    }
    function findIdx(header, cands){
      const h=header.map(x=>x.trim().toLowerCase());
      for(const n of cands){ const i=h.indexOf(String(n).toLowerCase()); if(i>=0) return i; }
      return -1;
    }
    function buildMap(header){
      const out={}; for(const [k,c] of Object.entries(MAP)) out[k]=findIdx(header,c); return out;
    }

    function renderStatus(rows, map){
      const i=map.status; if(i<0) return;
      const counts={}; rows.forEach(r=>{ const k=r[i]||"Unknown"; counts[k]=(counts[k]||0)+1; });
      const wrap=document.getElementById("status-cards"); wrap.innerHTML="";
      Object.entries(counts).sort((a,b)=>b[1]-a[1]).forEach(([k,v])=>{
        wrap.insertAdjacentHTML("beforeend", `<div class="card stat"><div class="k">${k}</div><div class="v">${v}</div></div>`);
      });
    }

    function renderHeader(){
      const tr=document.getElementById("thead-row");
      tr.innerHTML = DISPLAY.map(c=>`<th>${c.label}</th>`).join("");
    }
    function renderRows(rows, map){
      const tb=document.getElementById("tbody"); tb.innerHTML="";
      const order=DISPLAY.map(c=>c.key);
      rows.forEach(r=>{
        const tds=order.map(key=>{
          const idx=map[key]; const val=(idx>=0&&idx<r.length)?r[idx]:"";
          return key==="status" ? `<td><span class="badge">${val}</span></td>` : `<td>${val}</td>`;
        }).join("");
        tb.insertAdjacentHTML("beforeend", `<tr>${tds}</tr>`);
      });
    }

    async function loadCSV(){
      const limSel=document.getElementById("limit");
      const lim = Number(limSel?.value || RECENT_LIMIT_DEFAULT);
      const bust = (CSV_URL.includes("?")?"&":"?") + "t=" + Date.now(); // anti-cache
      const res = await fetch(CSV_URL + bust, { cache:"no-store" });
      const text = await res.text();
      const arr  = parseCSV(text);
      if (!arr.length) return;
      const header = arr[0], rowsAll = arr.slice(1);
      const map = buildMap(header);

      renderStatus(rowsAll, map);
      renderHeader();
      renderRows(rowsAll.slice(-lim), map); // ambil baris terbawah (terbaru)
    }

    document.getElementById("limit").addEventListener("change", loadCSV);
    document.getElementById("refresh").addEventListener("click", loadCSV);
    window.addEventListener("DOMContentLoaded", loadCSV);
  </script>
</body>
</html>
