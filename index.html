<!doctype html>
<html lang="ja">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>品質管理生産技術システム</title>
<style>
  :root{
    --bg:#f6f7fb; --panel:#fff; --ink:#0f172a; --muted:#64748b; --border:#e5e7eb;
    --accent:#2563eb; --danger:#dc2626; --success:#10b981; --warning:#f59e0b; --purple:#8b5cf6;
    --radius-xl:22px; --shadow-2:0 30px 60px rgba(15,23,42,.10);
  }
  *{box-sizing:border-box} body{margin:0;color:var(--ink);font-family:system-ui,-apple-system,Segoe UI,Roboto,"Noto Sans JP","Yu Gothic",sans-serif;background:linear-gradient(120deg,#f8fafc,var(--bg))}
  .panel{background:#fff;border:1px solid var(--border);border-radius:22px;box-shadow:var(--shadow-2);padding:18px;overflow:auto}
  .btn{display:inline-flex;align-items:center;gap:8px;height:34px;padding:0 12px;border-radius:10px;border:1px solid var(--border);background:#fff;cursor:pointer}
  table{width:100%;border-collapse:separate;border-spacing:0;min-width:900px}
  thead th{position:sticky;top:0;background:#f8fafc;color:#475569;text-align:left;font-weight:800;padding:12px 14px;border-bottom:1px solid var(--border)}
  tbody td{padding:12px 14px;border-bottom:1px solid var(--border);white-space:nowrap}
  .tag{display:inline-flex;align-items:center;padding:2px 10px;border-radius:999px;font-weight:800;font-size:12px;color:#fff;margin-right:8px}
  .tag-done{background:#0ea5e9}.tag-assem{background:var(--warning)}.tag-assem-done{background:var(--success)}.tag-inspect{background:#8b5cf6}.tag-not{background:#94a3b8}
</style>
</head>
<body>
<main style="max-width:1400px;margin:24px auto;padding:0 20px">
  <h1 style="margin:0 0 12px">出荷状況一覧</h1>
  <div class="panel">
    <div style="display:flex;gap:8px;align-items:center;flex-wrap:wrap;margin-bottom:10px">
      <label>出荷日：</label>
      <input type="date" id="filterDate" style="height:36px;padding:0 12px;border:1px solid var(--border);border-radius:10px;background:#fff;color:#0f172a">
      <button class="btn" id="btnToday" type="button">本日出荷のみ</button>
      <button class="btn" id="btnClear" type="button">Clear</button>
      <div style="margin-left:auto;display:flex;gap:8px">
        <button class="btn" id="btnExcel" type="button">⬇ Excel</button>
        <button class="btn" id="btnPDF" type="button">⬇ PDF</button>
        <button class="btn" id="btnRefresh" type="button">⟳ Refresh</button>
      </div>
    </div>
    <table id="shipTable">
      <thead><tr id="shipHead"></tr></thead>
      <tbody id="shipBody"></tbody>
    </table>
    <div id="shipHint" style="margin-top:8px;font-size:12px;color:#64748b"></div>
  </div>
</main>

<!-- libs -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.8.2/jspdf.plugin.autotable.min.js"></script>

<script>
  // ==== config CSV ====
  const SHEET_ID ="1lYl7oYk6atnm3KqC6VwufARX3ooRyJ2VmC_xYFb4-OE";
  const TAB_NAME ="最新情報";
  const CSV_URL  =`https://docs.google.com/spreadsheets/d/${SHEET_ID}/gviz/tq?tqx=out:csv&sheet=${encodeURIComponent(TAB_NAME)}`;
  const S = s => String(s ?? '').trim();

  function parseCSV(t){
    const rows=[], re=/\s*("(?:[^"]|"")*"|[^,]*)\s*(,|\n|$)/g;
    let m,row=[]; t=t.replace(/\r\n?/g,"\n");
    for(let i=0;i<t.length;){ re.lastIndex=i; m=re.exec(t); if(!m) break;
      let cell=m[1]; if(cell.startsWith('"')) cell=cell.slice(1,-1).replace(/""/g,'"');
      row.push(cell); i=re.lastIndex; if(m[2]==="\n"||m[2]===""){ rows.push(row); row=[]; }
    }
    return rows.filter(r=>r.length && r.some(c=>S(c)!==""));
  }

  function indexByName(header){
    const map={}; header.forEach((h,i)=>map[S(h)]=i);
    const find=nms=>{ for(const n of nms){ if(n in map) return map[n]; } return null; };
    const findFz=re=>{ for(let i=0;i<header.length;i++){ if(re.test(S(header[i]))) return i; } return null; };
    return {
      date:find(["出荷日","日付","Date"]),
      cust:find(["顧客名","客先","Customer"]),
      draw:find(["図番","Drawing","図面"]),
      item:find(["商品名","品名","Item"]),
      machine:find(["機種","機種名","Machine"]),
      qty:find(["数量","Qty"]),
      to:find(["送り先","納品先","送付先"]),
      note:find(["注番","注文番号","備考","注文","Order","注釈"]),
      status_done:find(["製品状況","製品状態","納品状況"]) ?? findFz(/(製品|納品).*(状況|状態)/),
      status_ts:   find(["製品状況更新日時","更新日時","StatusUpdatedAt"]) ?? findFz(/(更新).*(日時|日付)|updated/i),
      status_user: find(["更新者","記入者","担当者","UpdatedBy"])        ?? findFz(/(更新者|担当|by)/i),
    };
  }
  const valAt=(row,idx)=>(idx==null?"":(row[idx]??""));

  function parseJPDate(str){
    const s=String(str??"").trim();
    const mJP=s.match(/^(\d{4})\D(\d{1,2})\D(\d{1,2})/);
    if(mJP) return new Date(mJP[1],mJP[2]-1,mJP[3]);
    const p=s.replaceAll('-','/').split('/'); if(p.length===3) return new Date(p[0],p[1]-1,p[2]);
    const d=new Date(s); return isNaN(d)?null:d;
  }
  function sameYMD(a,b){return a&&b&&a.getFullYear()===b.getFullYear()&&a.getMonth()===b.getMonth()&&a.getDate()===b.getDate()}
  function toInputDate(d){const z=n=>String(n).padStart(2,'0'); return `${d.getFullYear()}-${z(d.getMonth()+1)}-${z(d.getDate())}`}

  /* ====== Mapping status terbaru ====== */
  function getStatusFromValue(val){
    const raw = S(val);
    const t = raw.replace(/\s/g,'');

    if (!t) return { label:'未設定', cls:'tag-not' };

    // 加工系（進行中）
    if (t==='レーザ加工')          return { label:'レーザ加工', cls:'tag-assem' };
    if (t==='板金加工' || t==='曲げ加工') return { label:'板金加工', cls:'tag-assem' };
    if (t==='外注')                return { label:'外注',     cls:'tag-assem' };

    // 加工完了
    if (t==='加工済' || t==='加工完了') return { label:'加工済', cls:'tag-assem-done' };

    // 組立
    if (t==='組立中')   return { label:'組立中',   cls:'tag-assem' };
    if (t==='組立完了') return { label:'組立完了', cls:'tag-assem-done' };

    // 検査
    if (t==='検査中')   return { label:'検査中',   cls:'tag-inspect' };
    if (t==='検査済' || t==='検査完了') return { label:'検査済', cls:'tag-done' };

    // 出荷
    if (t==='出荷準備済' || t==='出荷待ち') return { label:'出荷準備済', cls:'tag-inspect' };

    return { label: raw, cls:'tag-not' };
  }

  function makeComparator(idx){
    // angka kecil = prioritas lebih tinggi
    const rankMap = {
      '検査中': 1,
      '組立中': 2,
      'レーザ加工': 3,
      '板金加工': 3,
      '外注': 3,
      '出荷準備済': 4,
      '加工済': 5,
      '組立完了': 6,
      '検査済': 7,
      '未設定': 98
    };
    const rank = s => (s in rankMap ? rankMap[s] : 99);
    return (a,b)=>{
      const sa=idx.status_done!=null?(getStatusFromValue(valAt(a,idx.status_done))?.label):null;
      const sb=idx.status_done!=null?(getStatusFromValue(valAt(b,idx.status_done))?.label):null;
      if(rank(sa)!==rank(sb)) return rank(sa)-rank(sb);
      const da=idx.date!=null?parseJPDate(valAt(a,idx.date)):null;
      const db=idx.date!=null?parseJPDate(valAt(b,idx.date)):null;
      const ta=da?da.getTime():-Infinity, tb=db?db.getTime():-Infinity;
      return tb-ta;
    };
  }

  function renderTable(header, idx, rows, tbodyEl, headEl){
    headEl.innerHTML=header.map(h=>`<th>${h}</th>`).join('');
    tbodyEl.innerHTML='';
    rows.forEach(r=>{
      const tds=header.map((_,i)=>`<td>${S(r[i])}</td>`);
      const dateCol=(idx.date!=null?idx.date:0);
      const d=idx.date!=null?parseJPDate(valAt(r,idx.date)):null;
      const dateText=d?toInputDate(d):S(r[dateCol]??'');

      const st=idx.status_done!=null?getStatusFromValue(valAt(r,idx.status_done)):null;
      let badge='';
      if(st){
        const tsRaw=idx.status_ts!=null ? valAt(r, idx.status_ts) : '';
        const ts=tsRaw ? new Date(tsRaw) : null;
        const tsView=(ts && !isNaN(ts)) ?
          `${ts.getFullYear()}-${String(ts.getMonth()+1).padStart(2,'0')}-${String(ts.getDate()).padStart(2,'0')} ${String(ts.getHours()).padStart(2,'0')}:${String(ts.getMinutes()).padStart(2,'0')}` : '';
        const user=idx.status_user!=null ? S(valAt(r, idx.status_user)) : '';
        const meta=(tsView||user)?`<small style="display:block;color:#64748b;margin-top:2px">${tsView}${(tsView&&user)?' ｜ ':''}${user}</small>`:'';
        badge=`<span class="tag ${st.cls}">${st.label}</span>${meta}`;
      }

      // DEFAULT: tampilkan badge di kolom 出荷日 (seperti mockup)
      tds[dateCol]=`<td>${badge}${dateText}</td>`;

      // JIKA ingin badge di kolom 製品状況, pakai baris di bawah ini dan hapus baris di atas:
      // tds[idx.status_done] = `<td>${badge}</td>`;

      tbodyEl.insertAdjacentHTML('beforeend', `<tr>${tds.join('')}</tr>`);
    });
  }

  let cached={header:[],rows:[],idx:null,cmp:null};

  async function load(){
    const res=await fetch(CSV_URL+"&_ts="+Date.now(),{cache:'no-store'});
    const text=await res.text(); const data=parseCSV(text); if(!data.length) throw new Error("CSV empty");
    const header=data[0], rowsRaw=data.slice(1); const idx=indexByName(header); const cmp=makeComparator(idx);
    const rows=[...rowsRaw].sort(cmp); cached={header,rows,idx,cmp};
    applyFilter(null);
    const cols=[]; if(idx.qty!=null) cols.push('数量:'+header[idx.qty]); if(idx.cust!=null) cols.push('顧客:'+header[idx.cust]); if(idx.date!=null) cols.push('出荷日:'+header[idx.date]);
    document.getElementById('shipHint').textContent=`データ元: ${TAB_NAME}（${rows.length} 行）｜${cols.join(' ｜ ')}`;
    document.getElementById('filterDate').value=toInputDate(new Date());
  }

  function applyFilter(dateStr){
    const {header,rows,idx,cmp}=cached; let view=rows;
    if(idx.date!=null && dateStr){
      const target=new Date(dateStr+"T00:00:00");
      view=rows.filter(r=>{const d=parseJPDate(valAt(r,idx.date)); return d&&sameYMD(d,target)}).sort(cmp);
    }
    renderTable(header,idx,view,document.getElementById('shipBody'),document.getElementById('shipHead'));
  }

  function exportExcel(){const table=document.getElementById("shipTable"); const wb=XLSX.utils.table_to_book(table,{sheet:"出荷状況"}); XLSX.writeFile(wb,"出荷状況.xlsx");}
  function exportPDF(){const {jsPDF}=window.jspdf; const doc=new jsPDF({orientation:"landscape",unit:"pt",format:"a4"}); doc.setFontSize(14); doc.text("出荷状況一覧",40,40); doc.autoTable({html:"#shipTable", startY:60, styles:{fontSize:9, cellPadding:4, halign:"center", valign:"middle"}, headStyles:{fillColor:[238,242,247]}}); doc.save("出荷状況.pdf");}

  document.getElementById("btnExcel").addEventListener("click", exportExcel);
  document.getElementById("btnPDF").addEventListener("click", exportPDF);
  document.getElementById('btnRefresh').addEventListener('click', load);
  document.getElementById('btnToday').addEventListener('click', ()=>applyFilter(toInputDate(new Date())));
  document.getElementById('btnClear').addEventListener('click', ()=>{document.getElementById('filterDate').value=""; applyFilter(null);});
  document.getElementById('filterDate').addEventListener('change', e=>applyFilter(e.target.value||null));

  window.addEventListener('DOMContentLoaded', load);
</script>
</body>
</html>
