<!doctype html>
<html lang="ja">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>品質管理生産技術システム</title>
<style>
:root{
  --bg:#f6f7fb; --panel:#fff; --ink:#0f172a; --muted:#64748b; --border:#e5e7eb; --ring:#c7d2fe;
  --blue:#2563eb; --green:#10b981; --orange:#f59e0b; --purple:#8b5cf6; --sky:#0ea5e9; --danger:#dc2626;
  --radius:14px; --radius-xl:22px; --shadow:0 12px 30px rgba(15,23,42,.08);
}
*{box-sizing:border-box}
body{margin:0; background:var(--bg); color:var(--ink); font-family:system-ui,-apple-system,Segoe UI,Roboto,"Noto Sans JP","Yu Gothic",sans-serif}
a{color:inherit; text-decoration:none}
.container{max-width:1400px; margin:0 auto; padding:16px}

/* Header */
.header{
  display:flex; align-items:center; justify-content:space-between;
  padding:12px 16px; background:#fff; border-bottom:1px solid var(--border); position:sticky; top:0; z-index:50
}
.brand{display:flex; align-items:center; gap:10px}
.brand img{width:auto; height:32px; object-fit:contain}
.actions{display:flex; gap:8px; align-items:center}
.btn{height:34px; padding:0 12px; border:1px solid var(--border); border-radius:10px; background:#fff; cursor:pointer}
.badge{height:28px; padding:0 10px; display:inline-flex; align-items:center; gap:8px; font-weight:700; background:#f1f5f9; border:1px solid var(--border); border-radius:999px}

/* Urgent banner */
.urgent{
  margin:16px auto; max-width:1400px;
  background:#fee2e2; color:#991b1b; font-weight:800; border:1px solid #fecaca;
  border-radius:12px; padding:12px 16px; display:none; justify-content:center; align-items:center; gap:10px;
  animation:pulse 1.6s ease-in-out infinite;
}
@keyframes pulse{0%,100%{opacity:1}50%{opacity:.75}}

/* Panel & table */
.panel{background:#fff; border:1px solid var(--border); border-radius:var(--radius-xl); box-shadow:var(--shadow); padding:14px}
.panel + .panel{margin-top:14px}
.panel h2{margin:0 0 12px}

.table{width:100%; border-collapse:separate; border-spacing:0; min-width:900px}
.table th{position:sticky; top:66px; background:#f8fafc; font-weight:800; text-align:left; padding:12px 10px; z-index:1; border-bottom:1px solid var(--border)}
.table td{padding:12px 10px; border-bottom:1px solid var(--border); vertical-align:middle}

/* Left status card */
.statusCard{
  width:280px; background:#f8fafc; border:1px solid var(--border); border-radius:16px; padding:12px;
}
.statusPill{display:inline-flex; align-items:center; gap:6px; padding:6px 10px; border-radius:999px; color:#fff; font-weight:800; margin-right:10px}
.tag-blue{background:var(--blue)} .tag-green{background:var(--green)} .tag-orange{background:var(--orange)}
.tag-purple{background:var(--purple)} .tag-sky{background:var(--sky)} .tag-danger{background:var(--danger)}
.small{font-size:12px; color:#334155}

/* Chips row (status filter) */
.filterBar{display:flex; gap:10px; flex-wrap:wrap; align-items:center}
.chip{display:inline-flex; align-items:center; gap:10px; padding:8px 12px; border:1px solid var(--border); background:#fff; border-radius:999px; font-weight:700}
.chip .count{min-width:26px; height:26px; padding:0 8px; border-radius:999px; background:#eef2ff; display:inline-flex; align-items:center; justify-content:center}

/* destination numbers */
.destWrap{display:flex; gap:10px; flex-wrap:wrap}
.dest{padding:6px 12px; background:#f1f5f9; border:1px solid var(--border); border-radius:999px; white-space:nowrap}

/* Responsive header chip scroll on mobile */
@media (max-width:900px){
  .table{min-width:700px}
}
</style>
</head>
<body>

<header class="header">
  <div class="brand">
    <img src="tsh.png" alt="TSH" onerror="this.src='tsh.png'">
    <strong>品質管理生産技術</strong>
  </div>
  <div class="actions">
    <button class="btn" id="btnRefresh">⟳ Refresh</button>
    <button class="btn" id="btnLive" aria-pressed="false">● Live</button>
    <span class="badge" id="lastUpdate">—</span>
  </div>
</header>

<div id="urgentBanner" class="urgent">⚠ 至急案件があります！早急に確認してください。</div>

<main class="container">

  <!-- 本日出荷 -->
  <section class="panel">
    <h2>本日出荷</h2>
    <table class="table">
      <thead>
        <tr>
          <th style="width:300px">状況</th>
          <th>出荷日</th>
          <th>顧客名</th>
          <th>図番 / 機種</th>
          <th>数量</th>
          <th>送り先 / 注番</th>
        </tr>
      </thead>
      <tbody id="todayBody"></tbody>
    </table>
  </section>

  <!-- 全件一覧 -->
  <section class="panel">
    <h2>全件一覧</h2>

    <!-- dropdown filter: status chips disatukan -->
    <details style="margin:0 0 10px">
      <summary class="btn">🔎 フィルターを開く</summary>
      <div class="filterBar" id="filterBar"></div>
    </details>

    <div style="display:flex; gap:10px; align-items:center; margin:6px 0 10px">
      <label class="small">出荷日：</label>
      <input type="date" id="filterDate" class="btn" style="height:36px">
      <button class="btn" id="btnTodayOnly">本日出荷のみ</button>
      <button class="btn" id="btnClear">Clear</button>
    </div>

    <table class="table">
      <thead>
        <tr>
          <th style="width:300px">状況</th>
          <th>出荷日</th>
          <th>顧客名</th>
          <th>図番 / 機種</th>
          <th>数量</th>
          <th>送り先 / 注番</th>
        </tr>
      </thead>
      <tbody id="allBody"></tbody>
    </table>
    <div class="small" id="hint"></div>
  </section>
</main>

<script>
/* ====== Konfigurasi sumber data ====== */
const SHEET_ID = "1lYl7oYk6atnm3KqC6VwufARX3ooRyJ2VmC_xYFb4-OE";
const TAB_NAME = "最新情報";
const CSV_URL  = `https://docs.google.com/spreadsheets/d/${SHEET_ID}/gviz/tq?tqx=out:csv&sheet=${encodeURIComponent(TAB_NAME)}`;
const S = s => String(s ?? '').trim();

/* ====== Status map (termasuk status baru) ====== */
const STATUS_MAP = [
  {key:'レーザ加工', label:'レーザ加工', color:'tag-blue',   icon:'🛠️'},
  {key:'板金加工',   label:'板金加工',   color:'tag-purple', icon:'🔩'},
  {key:'外注',       label:'外注',       color:'tag-orange', icon:'🏭'},
  {key:'加工済',     label:'加工済',     color:'tag-sky',    icon:'✅'},
  {key:'組立中',     label:'組立中',     color:'tag-orange', icon:'🧰'},
  {key:'組立完了',   label:'組立完了',   color:'tag-green',  icon:'🧩'},
  {key:'検査中',     label:'検査中',     color:'tag-blue',   icon:'🔬'},
  {key:'検査済',     label:'検査済',     color:'tag-green',  icon:'✅'},
  {key:'出荷準備済', label:'出荷準備済', color:'tag-sky',    icon:'🚚'},
  // ===== Tambahan baru =====
  {key:'検査保留',   label:'検査保留',   color:'tag-orange', icon:'⏸️'},
  {key:'出荷済',     label:'出荷済',     color:'tag-green',  icon:'📦'},
];

function normalizeStatus(raw){
  const t=S(raw);
  // status baru
  if(t.includes('検査保留')) return '検査保留';
  if(t.includes('出荷済'))   return '出荷済';
  // status map (exact contains)
  for(const s of STATUS_MAP){ if(t.includes(s.key)) return s.key; }
  // fallback heuristik
  if(/検査中|検/.test(t)) return '検査中';
  if(/検査済|済|完了|OK|Done/i.test(t)) return '検査済';
  if(/組立中|組/.test(t)) return '組立中';
  if(/組立完了/.test(t)) return '組立完了';
  return t||'';
}

/* ===== CSV parser simpel ===== */
function parseCSV(t){
  const rows=[], re=/\s*("(?:[^"]|"")*"|[^,]*)\s*(,|\n|$)/g; let m,row=[];
  t=t.replace(/\r\n?/g,"\n");
  for(let i=0;i<t.length;){ re.lastIndex=i; m=re.exec(t); if(!m) break;
    let cell=m[1]; if(cell.startsWith('"')) cell=cell.slice(1,-1).replace(/""/g,'"');
    row.push(cell); i=re.lastIndex; if(m[2]==="\n"||m[2]===""){ rows.push(row); row=[]; } }
  return rows.filter(r=>r.length && r.some(c=>S(c)!==""));
}

/* ===== Index kolom dinamis ===== */
function indexByHeader(header){
  const map={}; header.forEach((h,i)=>map[S(h)]=i);
  const find=nms=>{ for(const n of nms){ if(n in map) return map[n]; } return null; };
  const findFz=re=>{ for(let i=0;i<header.length;i++){ if(re.test(S(header[i]))) return i; } return null; };
  return {
    date:find(["出荷日","日付","Date"]),
    cust:find(["顧客名","客先","Customer"]),
    draw:find(["図番","Drawing","図面"]),
    machine:find(["機種","機種名","Machine"]),
    item:find(["商品名","品名","Item"]),
    qty:find(["数量","Qty"]),
    to:find(["送り先","納品先","送付先"]),
    note:find(["注番","注文番号","備考","注文","Order"]),
    status_done:find(["製品状況","製品状態","納品状況"]) ?? findFz(/(製品|納品).*(状況|状態)/),
    status_flag:find(["Status","ステータス","状態","至急"]) ?? findFz(/status|至急/i),
  };
}
const valAt=(row,idx)=>(idx==null?"":(row[idx]??""));

/* ===== Util tanggal ===== */
function parseJPDate(str){
  const s=String(str??"").trim();
  const mJP=s.match(/^(\d{4})\D(\d{1,2})\D(\d{1,2})/);
  if(mJP) return new Date(mJP[1],mJP[2]-1,mJP[3]);
  const p=s.replaceAll('-','/').split('/'); if(p.length===3) return new Date(p[0],p[1]-1,p[2]);
  const d=new Date(s); return isNaN(d)?null:d;
}
function sameYMD(a,b){return a&&b&&a.getFullYear()===b.getFullYear()&&a.getMonth()===b.getMonth()&&a.getDate()===b.getDate()}
function toInputDate(d){const z=n=>String(n).padStart(2,'0'); return `${d.getFullYear()}-${z(d.getMonth()+1)}-${z(d.getDate())}`}

/* ===== State ===== */
let cached={header:[], rows:[], idx:null};

/* ===== Render helper ===== */
function statusBadge(key){
  const def = STATUS_MAP.find(s=>s.key===key);
  const color = def?.color || 'tag-blue';
  const icon  = def?.icon  || '🏷️';
  const label = def?.label || key || '—';
  return `<span class="statusPill ${color}">${icon} ${label}</span>`;
}
function urgentPill(){ return `<span class="statusPill tag-danger">⚠ 至急</span>`; }

function renderRow(row,idx){
  const stKey = normalizeStatus(valAt(row, idx.status_done));
  const isUrg = idx.status_flag!=null && /至急|urgent|緊急|1|true/i.test(S(valAt(row,idx.status_flag)));
  const date  = parseJPDate(valAt(row,idx.date));
  const dateChip = date ? `<span class="chip"><span>📅</span>${toInputDate(date)}</span>` : '';

  const left = `
    <div class="statusCard">
      <div style="display:flex; gap:8px; align-items:center; margin-bottom:8px">
        ${statusBadge(stKey)} ${isUrg?urgentPill():''}
      </div>
      <div class="small" style="margin:4px 0">更新日：<strong id="ts">—</strong></div>
      <div class="small">更新者：<strong id="who">—</strong></div>
    </div>`;

  const center = `
    ${dateChip}
    <div class="small" style="margin-top:8px">${S(valAt(row,idx.cust))||''}</div>`;

  const right1 = `
    <div>${S(valAt(row,idx.draw))||''}</div>
    <div class="small">${S(valAt(row,idx.machine))||''}</div>`;

  const qty = S(valAt(row,idx.qty))||'';

  const dest = S(valAt(row,idx.to))||'';
  const note = S(valAt(row,idx.note))||'';
  const chips = (note||'')
    .split(/\s+/).filter(Boolean)
    .map(x=>`<span class="dest">${x}</span>`).join('');

  const toCell = `
    <div class="small" style="margin-bottom:6px">${dest||'—'}</div>
    <div class="destWrap">${chips}</div>`;

  return `<tr>
    <td>${left}</td>
    <td>${dateChip}</td>
    <td>${S(valAt(row,idx.cust))||''}</td>
    <td>${right1}</td>
    <td style="font-weight:800">${qty}</td>
    <td>${toCell}</td>
  </tr>`;
}

/* ===== Filter bar (chips) ===== */
let activeFilter = 'ALL';
function buildFilterBar(rows, idx){
  const cnt = {};
  const all = rows.length;
  for(const r of rows){
    const k = normalizeStatus(valAt(r,idx.status_done));
    cnt[k] = (cnt[k]||0)+1;
  }
  const bar = document.getElementById('filterBar');
  bar.innerHTML = '';
  const addChip = (key, label, count) => {
    const chip = document.createElement('button');
    chip.className = 'chip';
    chip.innerHTML = `${label} <span class="count">${count}</span>`;
    chip.onclick = ()=>{ activeFilter = key; applyAllFilter(); };
    bar.appendChild(chip);
  };
  addChip('ALL', '🌐 すべて', all);
  for(const s of STATUS_MAP){
    addChip(s.key, `${s.icon} ${s.label}`, cnt[s.key]||0);
  }
}

/* ===== Apply filters & render ===== */
function applyAllFilter(){
  const {rows, idx} = cached;
  const dateStr = document.getElementById('filterDate').value;
  const targetDate = dateStr ? new Date(dateStr+'T00:00:00') : null;

  let view = rows;
  if (targetDate){
    view = view.filter(r => {
      const d=parseJPDate(valAt(r, idx.date)); return d && sameYMD(d,targetDate);
    });
  }
  if (activeFilter !== 'ALL'){
    view = view.filter(r => normalizeStatus(valAt(r,idx.status_done))===activeFilter);
  }

  document.getElementById('allBody').innerHTML = view.map(r=>renderRow(r,idx)).join('');
}

function renderToday(){
  const {rows, idx} = cached;
  const today = new Date();
  const todayRows = rows.filter(r=>{
    const d=parseJPDate(valAt(r,idx.date)); return d && sameYMD(d,today);
  });
  document.getElementById('todayBody').innerHTML = todayRows.map(r=>renderRow(r,idx)).join('');
  // Banner urgent di tengah
  const urgentCount = todayRows.filter(r => idx.status_flag!=null && /至急|urgent|緊急|1|true/i.test(S(valAt(r,idx.status_flag)))).length;
  const ub = document.getElementById('urgentBanner');
  ub.style.display = urgentCount>0 ? 'flex' : 'none';
  ub.textContent = urgentCount>0 ? `⚠ 至急案件が ${urgentCount} 件あります！早急に確認してください。` : '';
}

/* ===== Load & bootstrap ===== */
async function load(){
  document.getElementById('btnRefresh').disabled = true;
  const res = await fetch(CSV_URL+'&_ts='+Date.now(), {cache:'no-store'});
  const text = await res.text();
  const data = parseCSV(text);
  const header = data[0], rowsRaw = data.slice(1);
  const idx = indexByHeader(header);
  cached = {header, rows:rowsRaw, idx};

  // Build filter & render
  buildFilterBar(rowsRaw, idx);
  renderToday();
  applyAllFilter();

  document.getElementById('lastUpdate').textContent = 'Last update: '+(new Date()).toLocaleString();
  document.getElementById('hint').textContent = `データ元: ${TAB_NAME}（${rowsRaw.length} 行）`;
  document.getElementById('btnRefresh').disabled = false;
}

/* ===== Event ===== */
document.getElementById('btnRefresh').addEventListener('click', load);
document.getElementById('btnLive').addEventListener('click', (e)=>{
  const on = e.target.getAttribute('aria-pressed')==='true';
  e.target.setAttribute('aria-pressed', (!on)+'');
});
document.getElementById('filterDate').addEventListener('change', applyAllFilter);
document.getElementById('btnTodayOnly').addEventListener('click', ()=>{
  document.getElementById('filterDate').value = toInputDate(new Date());
  applyAllFilter();
});
document.getElementById('btnClear').addEventListener('click', ()=>{
  document.getElementById('filterDate').value='';
  activeFilter='ALL';
  applyAllFilter();
});

/* Init */
load();
</script>
</body>
</html>
