<!doctype html>
<html lang="ja">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>品質管理生産技術 - 出荷状況</title>
<style>
  :root{
    --bg1:#eef2ff; --bg2:#f8fafc; --card:#fff; --ink:#0f172a; --muted:#64748b; --border:#e5e7eb;
    --accent:#2563eb; --danger:#b91c1c; --shadow:0 30px 60px rgba(15,23,42,.08); --radius:22px;
    --urgent-row:#fee2e2; --urgent-cell:#ef4444;
  }
  *{box-sizing:border-box}
  body{
    margin:0; color:var(--ink);
    font-family:system-ui,-apple-system,Segoe UI,Roboto,"Noto Sans JP","Yu Gothic",sans-serif;
    background:
      radial-gradient(1200px 600px at -10% -10%, #c7d2fe 0%, transparent 60%),
      radial-gradient(900px 500px at 110% 0%, #bae6fd 0%, transparent 55%),
      linear-gradient(120deg,var(--bg1),var(--bg2));
  }
  header{position:sticky;top:0;z-index:10;background:#ffffffcc;backdrop-filter:blur(10px);border-bottom:1px solid var(--border)}
  .wrap{max-width:1200px;margin:0 auto;padding:12px 20px}
  .row{display:flex;justify-content:space-between;align-items:center;gap:16px}
  nav a{margin-left:20px;color:var(--accent);font-weight:700;text-decoration:none}
  nav a:hover{text-decoration:underline}
  .controls{display:flex;gap:8px;align-items:center}
  .btn{padding:8px 12px;border:1px solid var(--border);border-radius:10px;background:#fff;cursor:pointer}
  .btn[disabled]{opacity:.6;cursor:wait}
  .btn.active{border-color:#93c5fd;background:#f0f9ff}
  .small{font-size:12px;color:var(--muted)}
  main{max-width:1200px;margin:28px auto;padding:0 20px}
  .card{background:#fff;border:1px solid var(--border);border-radius:var(--radius);box-shadow:var(--shadow);padding:18px;overflow:auto}
  table{width:100%;border-collapse:separate;border-spacing:0;min-width:600px}
  thead th{background:#f8fafc;color:#475569;position:sticky;top:0;z-index:1;text-align:left;font-weight:700;padding:12px 14px;border-bottom:1px solid var(--border)}
  tbody td{padding:12px 14px;border-bottom:1px solid var(--border);white-space:nowrap}
  tbody tr:hover{background:#f1f5ff}
  tr.row-urgent td{background:var(--urgent-row)!important;color:#b91c1c;font-weight:600}
  td.cell-urgent{background:var(--urgent-cell)!important;color:#fff!important;font-weight:800!important;border-radius:8px}
  .flag-urgent{
    display:inline-flex;align-items:center;gap:6px;
    padding:2px 10px;border-radius:999px;background:#dc2626;color:#fff;
    font-weight:800;font-size:12px;margin-right:12px
  }
  .flag-urgent::before{content:"⚠";}
  .badge-done{
    display:inline-flex;align-items:center;justify-content:center;
    width:28px;height:28px;border-radius:999px;background:#0ea5e9;color:#fff;
    font-weight:800;font-size:13px;margin-right:12px
  }
  #urgent-banner{
    background:#b91c1c;color:#fff;padding:10px 16px;border-radius:10px;margin-bottom:14px;
    font-weight:bold;text-align:center;animation:blink 1s infinite
  }
  @keyframes blink{0%,50%,100%{background:#b91c1c}25%,75%{background:#ef4444}}
</style>
</head>
<body>
<header>
  <div class="wrap row">
    <div><strong>品質管理生産技術</strong></div>
    <nav>
      <a href="./index.html"><strong>ホーム</strong></a>
      <a href="./forms.html">出荷検査成績書</a>
      <a href="./sagyoutejunsho.html">作業手順書</a>
    </nav>
    <div class="controls">
      <button id="btnRefresh" class="btn" type="button">Refresh now</button>
      <button id="btnLive" class="btn" type="button">Live: Off</button>
      <span id="intervalInfo" class="small">Interval: 60s</span>
    </div>
  </div>
</header>

<main>
  <div id="urgent-banner">現在、至急案件はありません。</div>

  <div style="display:flex;justify-content:space-between;align-items:end">
    <h1>出荷状況一覧</h1>
    <span id="lastUpdated" class="small"></span>
  </div>

  <section class="card">
    <table id="shipTable">
      <thead><tr id="shipHead"></tr></thead>
      <tbody id="shipBody"></tbody>
    </table>
    <div class="muted small" id="shipHint"></div>
  </section>
</main>

<script>
  const SHEET_ID="1lYl7oYk6atnm3KqC6VwufARX3ooRyJ2VmC_xYFb4-OE";
  const TAB_NAME="最新情報";
  const CSV_URL=`https://docs.google.com/spreadsheets/d/${SHEET_ID}/gviz/tq?tqx=out:csv&sheet=${encodeURIComponent(TAB_NAME)}`;
  const S=s=>String(s??'').trim();

  function parseCSV(t){
    const rows=[],re=/\s*("(?:[^"]|"")*"|[^,]*)\s*(,|\n|$)/g;
    let m,row=[]; t=t.replace(/\r\n?/g,"\n");
    for(let i=0;i<t.length;){
      re.lastIndex=i; m=re.exec(t); if(!m) break;
      let cell=m[1]; if(cell.startsWith('"')) cell=cell.slice(1,-1).replace(/""/g,'"');
      row.push(cell); i=re.lastIndex;
      if(m[2]==="\n"||m[2]===""){ rows.push(row); row=[]; }
    }
    return rows.filter(r=>r.length && r.some(c=>S(c)!==""));
  }

  function indexByName(header){
    const map={}; header.forEach((h,i)=>map[S(h)]=i);
    const find=names=>{for(const n of names){if(n in map) return map[n];} return null;};

    // regex bantu untuk nama yang mirip
    const findFuzzy = (regex) => {
      for(let i=0;i<header.length;i++){
        if(regex.test(S(header[i]))) return i;
      }
      return null;
    };

    return {
      // kolom utama tabel
      date:find(["出荷日","日付","Date"]),
      cust:find(["顧客名","客先","Customer"]),
      draw:find(["図番","Drawing","図面"]),
      item:find(["商品名","品名","Item"]),
      machine:find(["機種","機種名","Machine"]),
      qty:find(["数量","Qty"]),
      to:find(["送り先","納品先","送付先"]),
      note:find(["注番","注文番号","備考","注文","Order","注釈"]),

      // ✅ kolom status selesai utama
      status_done:find(["製品状況","製品状態","納品状況","Status(完了)"]) ?? findFuzzy(/(製品|納品).*(状況|状態)/),

      // ✅ kolom QC fallback (semua harus Clear/OK/Done/済)
      qc_check:  find(["検査チェックシート","検査ﾁｪｯｸｼｰﾄ","CheckSheet"]) ?? findFuzzy(/(検査|ﾁｪｯｸ|チェック).*シート|check/i),
      qc_label:  find(["テプラ","ﾃﾌﾟﾗ","ラベル","Label"])            ?? findFuzzy(/(ﾃﾌﾟﾗ|テプラ|ﾗﾍﾞﾙ|ラベル|label)/i),
      qc_result: find(["検査成績表","成績表","InspectionReport"])   ?? findFuzzy(/(検査|inspection).*(成績|report)/i),
      qc_pack:   find(["梱包","Packing","包装"])                    ?? findFuzzy(/(梱包|packing|包装)/i),

      // ✅ kolom urgent
      status_flag:find(["Status","ステータス","状態","至急"]) ?? findFuzzy(/status|至急/i),
    };
  }

  const valAt = (row, idx) => (idx==null ? "" : (row[idx] ?? ""));

  // selesai oleh status (di kolom 製品状況): OK/Done/Clear/済/出荷済/完了
  function isRowDoneByStatus(v){
    const t=S(v).toLowerCase();
    return !!t && (/(?:^|\s)(?:済|検査済|出荷済|完了|ok|done|clear)(?:\s|$)/.test(t));
  }
  // selesai oleh QC fallback: SEMUA QC clear/ok/done/済
  function isRowDoneByQC(row, idx){
    const vals = [];
    if(idx.qc_check!=null)  vals.push(S(valAt(row, idx.qc_check)).toLowerCase());
    if(idx.qc_label!=null)  vals.push(S(valAt(row, idx.qc_label)).toLowerCase());
    if(idx.qc_result!=null) vals.push(S(valAt(row, idx.qc_result)).toLowerCase());
    if(idx.qc_pack!=null)   vals.push(S(valAt(row, idx.qc_pack)).toLowerCase());
    if(vals.length===0) return false;
    return vals.every(v=>v==="clear" || v==="ok" || v==="done" || v==="済");
  }
  function isUrgent(v){
    const t=S(v).toLowerCase();
    return t==="至急"||t==="urgent"||t==="緊急"||t==="1"||t==="true";
  }

  let aborter=null;
  let isLoading=false;

  async function load(){
    try{
      if(isLoading){ if(aborter) aborter.abort(); }
      isLoading=true;
      const btn=document.getElementById('btnRefresh');
      const old=btn.textContent; btn.textContent='Loading...'; btn.disabled=true;

      if(aborter) aborter.abort();
      aborter=new AbortController();

      const res=await fetch(CSV_URL+"&_ts="+Date.now(),{signal:aborter.signal,cache:'no-store'});
      if(!res.ok) throw new Error("HTTP "+res.status);
      const text=await res.text();
      const data=parseCSV(text);
      if(!data.length) return;

      const header=data[0], rows=data.slice(1);
      const idx=indexByName(header);

      document.getElementById('shipHead').innerHTML=header.map(h=>`<th>${h}</th>`).join('');

      // Urgent ke atas
      rows.sort((a,b)=>{
        const au = idx.status_flag!=null ? isUrgent(valAt(a, idx.status_flag)) : false;
        const bu = idx.status_flag!=null ? isUrgent(valAt(b, idx.status_flag)) : false;
        return (bu?1:0)-(au?1:0);
      });

      const tbody=document.getElementById('shipBody');
      tbody.innerHTML='';

      let urgentCount=0;

      rows.forEach(r=>{
        const urgVal  = valAt(r, idx.status_flag);
        const rowUrg  = idx.status_flag!=null ? isUrgent(urgVal) : false;

        // selesai via 製品状況; kalau tidak ada → QC fallback
        let rowDone=false;
        if(idx.status_done!=null){
          rowDone = isRowDoneByStatus(valAt(r, idx.status_done));
        }else{
          rowDone = isRowDoneByQC(r, idx);
        }

        if(rowUrg) urgentCount++;

        const tds = header.map((_,i)=>{
          const v=S(r[i]);
          const isStatusCol = (idx.status_done!=null && i===idx.status_done);
          const cls = rowUrg && isStatusCol ? 'cell-urgent' : '';
          return `<td class="${cls}">${v}</td>`;
        });

        // chip pada kolom 出荷日
        if(tds.length){
          const dateText = idx.date!=null ? S(valAt(r, idx.date)) : S(r[0] ?? '');
          if(rowUrg){
            tds[0] = `<td><span class="flag-urgent">至急</span>${dateText}</td>`;
          }else if(rowDone){
            tds[0] = `<td><span class="badge-done">済</span>${dateText}</td>`;
          }else{
            tds[0] = `<td>${dateText}</td>`;
          }
        }

        tbody.insertAdjacentHTML(
          'beforeend',
          `<tr class="${rowUrg?'row-urgent':''}">${tds.join('')}</tr>`
        );
      });

      // Banner
      const banner=document.getElementById('urgent-banner');
      banner.textContent = urgentCount>0
        ? `⚠ 至急案件が ${urgentCount} 件あります！早急に確認してください。`
        : '現在、至急案件はありません。';

      // Hint: kolom yang terdeteksi
      const hintParts = [];
      hintParts.push(`Status列: ${idx.status_done!=null ? header[idx.status_done] : '—'}`);
      const qcCols = ['qc_check','qc_label','qc_result','qc_pack']
        .map(k=>idx[k]!=null ? header[idx[k]] : null).filter(Boolean);
      hintParts.push(`QC列: ${qcCols.length? qcCols.join(', ') : '—'}`);
      hintParts.push(`Urgent列: ${idx.status_flag!=null ? header[idx.status_flag] : '—'}`);
      document.getElementById('shipHint').textContent=`データ元: ${TAB_NAME}（${rows.length} 行）｜${hintParts.join(' ｜ ')}`;
      document.getElementById('lastUpdated').textContent='Last update: '+new Date().toLocaleString();

      btn.textContent=old; btn.disabled=false; isLoading=false;

    }catch(e){
      if(e.name!=="AbortError") console.error(e);
      const btn=document.getElementById('btnRefresh');
      btn.textContent='Refresh now'; btn.disabled=false; isLoading=false;
      document.getElementById('shipHint').textContent='読み込みに失敗しました。シート名/公開設定をご確認ください。';
    }
  }

  // Auto-refresh
  let timer=null, intervalMs=60000;
  function startAutoRefresh(ms){
    intervalMs=ms; clearInterval(timer);
    timer=setInterval(()=>{ if(document.visibilityState==='visible') load(); }, intervalMs);
    document.getElementById('intervalInfo').textContent=`Interval: ${Math.round(intervalMs/1000)}s`;
    const liveBtn=document.getElementById('btnLive');
    if(intervalMs<=5000){ liveBtn.classList.add('active'); liveBtn.textContent='Live: On'; }
    else{ liveBtn.classList.remove('active'); liveBtn.textContent='Live: Off'; }
  }
  document.getElementById('btnRefresh').addEventListener('click', load);
  document.getElementById('btnLive').addEventListener('click', ()=>{ startAutoRefresh(intervalMs<=5000?60000:5000); load(); });
  document.addEventListener('visibilitychange', ()=>{ if(document.visibilityState==='visible') load(); });

  window.addEventListener('DOMContentLoaded', ()=>{ load(); startAutoRefresh(60000); });
</script>
</body>
</html>
