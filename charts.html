<!doctype html>
<html lang="ja" data-theme="light">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>出荷検査（グラフ）</title>

<style>
  :root{
    --bg:#f6f7fb; --panel:#fff; --ink:#0f172a; --muted:#64748b; --border:#e5e7eb; --ring:#c7d2fe;
    --accent:#2563eb; --radius-xl:22px; --radius:12px;
    --shadow-1:0 12px 30px rgba(15,23,42,.08); --shadow-2:0 30px 60px rgba(15,23,42,.10);
    --grid:#e5e7eb; --ticker-h:28px;
  }
  [data-theme="dark"]{
    --bg:#0b1220; --panel:#0f172a; --ink:#e5e7eb; --muted:#94a3b8; --border:#1f2937; --ring:#243b55;
    --accent:#60a5fa; --shadow-1:none; --shadow-2:none; --grid:#223044;
  }
  *{box-sizing:border-box}
  html,body{height:100%}
  body{
    margin:0; color:var(--ink);
    font-family:system-ui,-apple-system,Segoe UI,Roboto,"Noto Sans JP","Yu Gothic",sans-serif;
    background:
      radial-gradient(1100px 540px at -12% -12%, #c7d2fe33 0%, transparent 60%),
      radial-gradient(820px 460px at 112% -6%, #bae6fd33 0%, transparent 55%),
      linear-gradient(120deg,#f8fafc,var(--bg));
    transition:padding-bottom .2s ease;
  }
  body.has-ticker{ padding-bottom: calc(64px + var(--ticker-h) + 12px); }

  /* ===== Shell (header + sidebar + main) ===== */
  .app{
    display:grid;
    grid-template-columns:260px 1fr;
    grid-template-rows:64px 1fr;
    grid-template-areas:
      "header header"
      "side   main";
    min-height:100vh;
  }
  header{
    grid-area:header; position:sticky; top:0; z-index:50;
    backdrop-filter: blur(12px);
    background: color-mix(in srgb, var(--panel) 85%, transparent);
    border-bottom:1px solid var(--border);
  }
  .header-wrap{
    height:64px; max-width:1400px; margin:0 auto;
    display:flex; align-items:center; justify-content:space-between; gap:12px; padding:0 20px;
  }
  .brand{display:flex; align-items:center; gap:10px}
  .brand img{height:36px}
  .brand .ttl{font-weight:800}

  .top-actions{display:flex; gap:8px; align-items:center; flex-wrap:wrap}
  .btn{
    height:34px; padding:0 12px; border:1px solid var(--border); border-radius:10px; background:var(--panel);
    color:var(--ink); display:inline-flex; align-items:center; gap:8px; cursor:pointer; text-decoration:none;
  }
  .btn:hover{ border-color:var(--ring) }
  .btn.active{ background:#f0f9ff }
  [data-theme="dark"] .btn.active{ background:#0b3b6f66 }
  .badge{height:28px; padding:0 10px; display:inline-flex; align-items:center; gap:8px; font-size:12px; font-weight:700;
    color:var(--ink); background:#f1f5f9; border:1px solid var(--border); border-radius:999px}
  [data-theme="dark"] .badge{ background:#0b1624 }

  /* Sidebar */
  .side{
    grid-area:side; position:sticky; top:64px; align-self:start;
    height:calc(100vh - 64px); overflow:auto; padding:18px;
  }
  .side-card{
    background:var(--panel); border:1px solid var(--border); border-radius:var(--radius-xl);
    box-shadow:var(--shadow-1); padding:14px;
  }
  .side h3{ margin:4px 8px 10px; font-size:12px; letter-spacing:.08em; color:#6b7280; text-transform:uppercase }
  .navlist{ display:grid; gap:4px }
  .slink{ display:flex; align-items:center; gap:10px; padding:10px 12px; border-radius:12px; color:var(--ink); text-decoration:none }
  .slink:hover{ background:#f1f5ff }
  [data-theme="dark"] .slink:hover{ background:#132033 }
  .ico{ width:22px; text-align:center }

  /* Main */
  main{ grid-area:main; max-width:1400px; margin:0 auto; padding:22px 20px 96px }
  .card{ background:var(--panel); border:1px solid var(--border); border-radius:var(--radius-xl); box-shadow:var(--shadow-2); padding:18px }
  .card + .card{ margin-top:16px }
  .card-title{ display:flex; align-items:center; justify-content:space-between; gap:16px; margin:0 0 10px }
  .small{ font-size:12px; color:var(--muted) }

  .filterbar{ display:flex; gap:8px; align-items:center; flex-wrap:wrap }
  select.btn{ appearance:none; padding-right:26px; background-image:
    linear-gradient(45deg,transparent 50%,#64748b 50%),
    linear-gradient(135deg,#64748b 50%,transparent 50%);
    background-position:calc(100% - 18px) calc(1em - 2px),calc(100% - 13px) calc(1em - 2px);
    background-size:5px 5px; background-repeat:no-repeat }

  .chart-grid{ display:grid; grid-template-columns:1fr 1fr; gap:16px }
  .chart-box{ background:var(--panel); border:1px solid var(--border); border-radius:16px; padding:12px; min-height:380px; display:flex; align-items:center; justify-content:center }
  .chart-box.wide{ grid-column:1/-1 }
  .chart-box canvas{ width:100%!important; height:330px!important }
  @media (max-width:900px){ .chart-grid{ grid-template-columns:1fr } }

  /* Ticker */
  .marquee{
    position:fixed; left:20px; right:20px; bottom:20px; z-index:30; height:var(--ticker-h); line-height:var(--ticker-h);
    background:var(--accent); color:#fff; font-weight:800; border-radius:12px; box-shadow:var(--shadow-1);
    white-space:nowrap; overflow:hidden; transition:transform .25s ease, opacity .2s ease;
  }
  .marquee span{ display:inline-block; padding:0 16px 0 100%; animation:marquee 24s linear infinite }
  .marquee:hover span{ animation-play-state:paused }
  .marquee.hidden{ transform:translateY(140%); opacity:0; pointer-events:none }
  .marquee .close{
    position:absolute; right:8px; top:0; bottom:0; margin:auto; height:22px; width:22px;
    border:none; border-radius:6px; background:#ffffff33; color:#fff; cursor:pointer; line-height:22px;
  }
  @keyframes marquee{0%{transform:translateX(0)}100%{transform:translateX(-100%)}}

  .footer{ position:fixed; bottom:0; left:0; right:0; text-align:center; font-size:12px; color:var(--muted);
    background:#f1f5f9; padding:4px 0; border-top:1px solid var(--border) }
  [data-theme="dark"] .footer{ background:#0b1220 }
  @media (max-width:900px){ .app{ grid-template-columns:1fr; grid-template-areas:"header" "main"; } .side{ display:none } }
</style>
</head>

<body>
<div class="app">
  <!-- ===== HEADER ===== -->
  <header>
    <div class="header-wrap">
      <div class="brand">
        <img src="tsh.png" alt="TSH">
        <strong class="ttl">品質管理生産技術</strong>
      </div>

      <nav class="top-actions" aria-label="Top navigation">
        <a class="btn" href="./index.html">🏠 ホーム</a>
        <a class="btn" href="./forms.html">📄 出荷検査成績書</a>
        <a class="btn" href="./sagyoutejunsho.html">📝 作業手順書</a>
        <a class="btn active" href="./charts.html" aria-current="page">📈 グラフ</a>

        <span class="badge" id="intervalInfo">60s</span>
        <label class="small" style="display:flex;align-items:center;gap:6px">
          <input id="chkDark" type="checkbox"> Dark
        </label>
        <button id="btnRefresh" class="btn" type="button">⟳ Refresh</button>
        <button id="btnLive" class="btn" type="button" aria-pressed="false">Live: Off</button>
      </nav>
    </div>
  </header>

  <!-- ===== SIDEBAR ===== -->
  <aside class="side">
    <div class="side-card">
      <h3>Pages</h3>
      <div class="navlist">
        <a class="slink" href="./index.html"><span class="ico">🏠</span><strong>ホーム</strong><small style="color:var(--muted)">Dashboard</small></a>
        <a class="slink" href="./forms.html"><span class="ico">📄</span><strong>出荷検査成績書</strong></a>
        <a class="slink" href="./sagyoutejunsho.html"><span class="ico">📝</span><strong>作業手順書</strong></a>
        <a class="slink" href="./charts.html"><span class="ico">📈</span><strong>チャート</strong></a>
        <a class="slink" href="./quality.html"><span class="ico">🔎</span><strong>品質情報</strong></a>
        <a class="slink" href="./claim.html"><span class="ico">🧪</span><strong>Trial Page</strong></a>
      </div>

      <h3>Admin</h3>
      <div class="navlist">
        <a class="slink" href="./admin-numbering.html"><span class="ico">#</span><strong>Admin Numbering</strong></a>
        <a class="slink" href="./admin-prefix.html"><span class="ico">🔧</span><strong>Admin Prefix</strong></a>
        <a class="slink" href="./admin-serial-gas.html"><span class="ico">⛽</span><strong>Admin Serial Gas</strong></a>
        <a class="slink" href="./thanks.html"><span class="ico">✨</span><strong>Thanks</strong></a>
      </div>
    </div>
  </aside>

  <!-- ===== MAIN ===== -->
  <main>
    <section class="card" style="margin-bottom:16px">
      <div class="card-title">
        <h2 style="margin:0">出荷検査 — グラフ</h2>
        <div style="display:flex;gap:8px;align-items:center;flex-wrap:wrap">
          <button class="btn" id="btnExcelCharts">⬇ Excel</button>
          <button class="btn" id="btnPDF">⬇ PDF</button>
        </div>
      </div>

      <div class="filterbar" aria-label="フィルター">
        <label class="small">Top 顧客:</label>
        <select id="selTop" class="btn">
          <option value="5">5</option><option value="10" selected>10</option>
          <option value="15">15</option><option value="30">30</option>
        </select>

        <label class="small">対象 年:</label>
        <select id="selYear" class="btn"></select>

        <label class="small">Quarter:</label>
        <select id="selQuarter" class="btn">
          <option value="ALL" selected>All</option>
          <option value="Q1">Q1</option><option value="Q2">Q2</option>
          <option value="Q3">Q3</option><option value="Q4">Q4</option>
        </select>

        <label class="small">月:</label>
        <select id="selMonth" class="btn" title="Quarter dipilih → opsi bulan nonaktif">
          <option value="ALL" selected>All</option>
          <option value="01">1</option><option value="02">2</option><option value="03">3</option>
          <option value="04">4</option><option value="05">5</option><option value="06">6</option>
          <option value="07">7</option><option value="08">8</option><option value="09">9</option>
          <option value="10">10</option><option value="11">11</option><option value="12">12</option>
        </select>

        <label class="small">顧客:</label>
        <select id="selCust" class="btn"></select>

        <label class="small" style="display:flex;align-items:center;gap:6px">
          <input id="chkPareto" type="checkbox"> Pareto
        </label>

        <label class="small">向き:</label>
        <select id="selOrient" class="btn" title="すべてのグラフの向き">
          <option value="h" selected>Horizontal</option>
          <option value="v">Vertical</option>
        </select>

        <button class="btn" id="btnReset" type="button" title="Reset ke default">Reset</button>
      </div>

      <div class="small" id="chartNote" style="margin-top:6px">顧客別（年／月／Quarter）・月別（顧客）の数量合計（「済」のみ集計）</div>
    </section>

    <section class="card" aria-label="チャート">
      <div class="chart-grid">
        <div class="chart-box"><canvas id="chartTopCust" aria-label="出荷検査 顧客別（期間｜済）"></canvas></div>
        <div class="chart-box"><canvas id="chartByMonth" aria-label="出荷検査 月別（済）"></canvas></div>
        <div class="chart-box wide"><canvas id="chartTopCustYear" aria-label="出荷検査 顧客別（年｜済）"></canvas></div>
      </div>
    </section>
  </main>
</div>

<!-- Ticker -->
<div id="ticker" class="marquee hidden" role="status" aria-live="polite">
  <span>出荷検査（グラフ） - 最新データで自動更新</span>
  <button id="btnCloseTicker" class="close" title="Hide">×</button>
</div>

<div class="footer">Design by Wahyu</div>

<!-- Libs -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-datalabels@2"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>

<script>
/* ===== Config & helpers ===== */
const SHEET_ID ="1lYl7oYk6atnm3KqC6VwufARX3ooRyJ2VmC_xYFb4-OE";
const TAB_NAME ="最新情報";
const CSV_URL  =`https://docs.google.com/spreadsheets/d/${SHEET_ID}/gviz/tq?tqx=out:csv&sheet=${encodeURIComponent(TAB_NAME)}`;
const S = s => String(s ?? '').trim();
const QUARTERS = {Q1:[1,2,3], Q2:[4,5,6], Q3:[7,8,9], Q4:[10,11,12]};
Chart.register(ChartDataLabels);

function parseCSV(t){
  const rows=[], re=/\s*("(?:[^"]|"")*"|[^,]*)\s*(,|\n|$)/g;
  let m, row=[]; t=t.replace(/\r\n?/g,"\n");
  for(let i=0;i<t.length;){
    re.lastIndex=i; m=re.exec(t); if(!m) break;
    let cell=m[1]; if(cell.startsWith('"')) cell=cell.slice(1,-1).replace(/""/g,'"');
    row.push(cell); i=re.lastIndex;
    if(m[2]==="\n"||m[2]===""){ rows.push(row); row=[]; }
  }
  return rows.filter(r=>r.length && r.some(c=>S(c)!==""));
}

function indexByName(header){
  const map={}; header.forEach((h,i)=>map[S(h)]=i);
  const find=(names)=>{ for(const n of names){ if(n in map) return map[n]; } return null; };
  const findFuzzy=(re)=>{ for(let i=0;i<header.length;i++){ if(re.test(S(header[i]))) return i; } return null; };
  return {
    date:find(["出荷日","日付","Date"]),
    cust:find(["顧客名","客先","Customer"]),
    qty: find(["数量","Qty","数量(個)","数量pcs"]) ?? findFuzzy(/数量|qty|個数|pcs/i),
    status_done:find(["製品状況","製品状態","納品状況"]) ?? findFuzzy(/(製品|納品).*(状況|状態)/),
    qc_check:  find(["検査チェックシート","検査ﾁｪｯｸｼｰﾄ","CheckSheet"]) ?? findFuzzy(/(検査|ﾁｪｯｸ|チェック).*シート|check/i),
    qc_label:  find(["テプラ","ﾃﾌﾟﾗ","ラベル","Label"])            ?? findFuzzy(/(ﾃﾌﾟﾗ|テプラ|ﾗﾍﾞﾙ|ラベル|label)/i),
    qc_result: find(["検査成績表","成績表","InspectionReport"])   ?? findFuzzy(/(検査|inspection).*(成績|report)/i),
    qc_pack:   find(["梱包","Packing","包装"])                    ?? findFuzzy(/(梱包|packing|包装)/i),
  };
}
const valAt = (row, idx) => (idx==null ? "" : (row[idx] ?? ""));
const parseQty = (v)=>{ const t=S(v).replace(/,/g,''); const n=parseFloat(t); return isNaN(n)?0:n; };
const ymKey=(d)=>`${d.getFullYear()}-${String(d.getMonth()+1).padStart(2,'0')}`;
const intTick=(v)=>Number.isInteger(v)?v:'';
function isDoneValue(v){ const t=S(v).toLowerCase(); return !!t && (/(済|完了|ok|done)/.test(t)); }
function isRowDoneByQC(row, idx){
  const vals=[]; if(idx.qc_check!=null) vals.push(valAt(row, idx.qc_check));
  if(idx.qc_label!=null) vals.push(valAt(row, idx.qc_label));
  if(idx.qc_result!=null) vals.push(valAt(row, idx.qc_result));
  if(idx.qc_pack!=null) vals.push(valAt(row, idx.qc_pack));
  return vals.length? vals.every(isDoneValue) : false;
}
function isDoneRow(r, idx){ if(idx.status_done!=null) return isDoneValue(valAt(r, idx.status_done)); return isRowDoneByQC(r, idx); }

function parseJPDate(str){
  const s=String(str??"").trim(); const m=s.match(/^(\d{4})\D(\d{1,2})\D(\d{1,2})/);
  if(m) return new Date(m[1], m[2]-1, m[3]);
  const parts=s.replaceAll('-','/').split('/'); if(parts.length===3) return new Date(parts[0], parts[1]-1, parts[2]);
  const d=new Date(s); return isNaN(d)?null:d;
}

/* ===== Theme & palette ===== */
const isDark = () => document.documentElement.getAttribute('data-theme') === 'dark';
const PALETTE_LIGHT = ['#93c5fd','#a5b4fc','#fda4af','#fdba74','#86efac','#67e8f9','#f5d0fe','#c4b5fd','#fecaca','#fde68a','#bbf7d0','#bae6fd'];
const PALETTE_DARK  = ['#60a5fa','#818cf8','#fca5a5','#fbbf24','#4ade80','#22d3ee','#f0abfc','#a78bfa','#f87171','#fde047','#86efac','#93c5fd'];
const hexToRgba=(hex,a=0.8)=>{const h=hex.replace('#','');const b=parseInt(h,16);return`rgba(${(b>>16)&255},${(b>>8)&255},${b&255},${a})`};
function softPalette(n, alpha=0.8){ const base=isDark()?PALETTE_DARK:PALETTE_LIGHT; return Array.from({length:n},(_,i)=>hexToRgba(base[i%base.length],alpha)); }
function getTheme(){ const st=getComputedStyle(document.documentElement); return { ink:st.getPropertyValue('--ink').trim()||'#0f172a', grid:st.getPropertyValue('--grid').trim()||'#e5e7eb' }; }
function applyChartDefaults(){
  const c=getTheme();
  Chart.defaults.color=c.ink;
  Chart.defaults.borderColor=c.grid;
  Chart.defaults.font.family='system-ui,-apple-system,Segoe UI,Roboto,"Noto Sans JP","Yu Gothic",sans-serif';
  Chart.defaults.plugins=Chart.defaults.plugins||{};
  Chart.defaults.plugins.legend=Chart.defaults.plugins.legend||{};
  Chart.defaults.plugins.legend.labels=Chart.defaults.plugins.legend.labels||{};
  Chart.defaults.plugins.legend.labels.color=c.ink;
  Chart.defaults.plugins.title=Chart.defaults.plugins.title||{};
  Chart.defaults.plugins.title.color=c.ink;
  Chart.defaults.plugins.tooltip=Chart.defaults.plugins.tooltip||{};
  Chart.defaults.plugins.tooltip.backgroundColor=isDark()?'rgba(15,23,42,.95)':'rgba(255,255,255,.95)';
  Chart.defaults.plugins.tooltip.titleColor=isDark()?'#e5e7eb':'#0f172a';
  Chart.defaults.plugins.tooltip.bodyColor=isDark()?'#e5e7eb':'#0f172a';
  Chart.defaults.plugins.tooltip.borderColor=c.grid;
  Chart.defaults.plugins.tooltip.borderWidth=1;
}

/* ===== State ===== */
let aborter=null, isLoading=false;
let cached={ header:[], rows:[], idx:null };
let charts={ topCust:null, month:null, topCustYear:null };
let lastAgg=null;

/* ===== Aggregate （済のみ） ===== */
function aggregate({rows, idx, topN, yearPick, quarterPick, monthPick, custPick}){
  const monthList = quarterPick==='ALL' ? null : QUARTERS[quarterPick];
  const mapTopCust=new Map(), mapTopCustYear=new Map(), mapMonth=new Map();

  for(const r of rows){
    if(!isDoneRow(r, idx)) continue;
    const qty = idx.qty!=null ? parseQty(valAt(r, idx.qty)) : 1;
    const cust = idx.cust!=null ? (S(valAt(r, idx.cust)) || '不明') : '不明';
    const d = idx.date!=null ? parseJPDate(valAt(r, idx.date)) : null;
    if(!d) continue;

    const y = d.getFullYear(), m = d.getMonth()+1;

    if(String(y)===String(yearPick)){
      const inQuarter = monthList ? monthList.includes(m) : true;
      const inMonth   = (monthPick==='ALL' ? true : (m===parseInt(monthPick,10)));
      if(inQuarter && inMonth){ mapTopCust.set(cust,(mapTopCust.get(cust)||0)+qty); }
      mapTopCustYear.set(cust,(mapTopCustYear.get(cust)||0)+qty);

      if(cust===custPick && (!monthList || monthList.includes(m))){
        const k=ymKey(d);
        mapMonth.set(k,(mapMonth.get(k)||0)+qty);
      }
    }
  }

  const toTop = (mp) => {
    const arr=[...mp.entries()].sort((a,b)=>b[1]-a[1]).slice(0, topN);
    return { labels:arr.map(([k])=>k), data:arr.map(([,v])=>v) };
  };

  const byTopCust     = toTop(mapTopCust);
  const byTopCustYear = toTop(mapTopCustYear);

  const monthsIdx = (monthList ?? [...Array(12)].map((_,i)=>i+1));
  const monthsKeys= monthsIdx.map(m=>`${yearPick}-${String(m).padStart(2,'0')}`);
  const byMonth   = { labels: monthsIdx.map(m=>String(m)), data: monthsKeys.map(k=>mapMonth.get(k)||0) };

  lastAgg={ byTopCust, byTopCustYear, byMonth, yearPick, quarterPick, monthPick, custPick };
  return lastAgg;
}

/* ===== Pareto overlay ===== */
function addParetoIfNeeded(cfg, labels, values, enable, isHorizontal){
  if(!enable) return;
  const total=values.reduce((n,v)=>n+v,0);
  let cum=0;
  const pct=values.map(v=>{cum+=v; return total? +(cum/total*100).toFixed(1):0;});
  const amber=isDark()?'rgba(251,191,36,.95)':'rgba(234,179,8,.95)';

  const ds={
    type:'line', label:'累積％', tension:.2, pointRadius:3,
    borderColor:amber, backgroundColor:'transparent',
    pointBackgroundColor:amber, pointBorderColor:amber,
    datalabels:{ anchor:'end', align:'top', formatter:(v)=> (typeof v==='object'? v.x:v)+'%' }
  };

  cfg.options.scales = cfg.options.scales || {};
  if(isHorizontal){
    ds.data = labels.map((lab,i)=>({x:pct[i], y:lab}));
    cfg.options.scales.x1 = { beginAtZero:true, max:100, position:'top',
      grid:{ drawOnChartArea:false }, ticks:{ callback:(v)=>v+'%' } };
  }else{
    ds.data = pct; ds.yAxisID='y1';
    cfg.options.scales.y1 = { beginAtZero:true, max:100, position:'right',
      grid:{ drawOnChartArea:false }, ticks:{ callback:(v)=>v+'%' } };
  }
  cfg.data.datasets.push(ds);
}

/* ===== Render charts ===== */
function render(){
  applyChartDefaults();

  const topN=+document.getElementById('selTop').value || 10;
  const yearPick=document.getElementById('selYear').value;
  const quarterPick=document.getElementById('selQuarter').value;
  const monthPick=document.getElementById('selMonth').value;
  const custPick=document.getElementById('selCust').value;
  const isPareto=document.getElementById('chkPareto').checked;
  const isHorizontal=document.getElementById('selOrient').value==='h';

  document.getElementById('selMonth').disabled = (quarterPick!=='ALL');

  const agg=aggregate({rows:cached.rows, idx:cached.idx, topN, yearPick, quarterPick, monthPick, custPick});
  const periodLabel = quarterPick!=='ALL' ? `${yearPick}年 ${quarterPick}` : (monthPick==='ALL'? `${yearPick}年 全月` : `${yearPick}年 ${parseInt(monthPick,10)}月`);

  const theme=getTheme();

  // Chart 1: 顧客別（期間）
  const ctx1=document.getElementById('chartTopCust').getContext('2d');
  const colors1=softPalette(agg.byTopCust.data.length, isDark()?0.7:0.8);
  const max1=Math.max(1,...agg.byTopCust.data);
  const cfg1={
    type:'bar',
    data:{ labels:agg.byTopCust.labels,
      datasets:[{ label:'数量（済）', data:agg.byTopCust.data,
        backgroundColor:colors1, borderColor:colors1, borderWidth:1,
        maxBarThickness:26, categoryPercentage:.7, barPercentage:.9 }]},
    options:{
      indexAxis: isHorizontal ? 'y':'x',
      maintainAspectRatio:false,
      layout:{padding:{top:6,right:8,left:4,bottom:0}},
      plugins:{ legend:{display:false},
        title:{display:true,text:`出荷検査（顧客別｜済｜${periodLabel}）`},
        datalabels:{ anchor:'end', align:isHorizontal?'right':'top', formatter:(v)=>v, color:theme.ink } },
      scales: isHorizontal ? {
        x:{ beginAtZero:true, suggestedMax:max1*1.15, ticks:{ callback:intTick }, grid:{color:theme.grid} },
        y:{ grid:{ display:false } }
      } : {
        y:{ beginAtZero:true, suggestedMax:max1*1.15, ticks:{ callback:intTick }, grid:{color:theme.grid} },
        x:{ grid:{ display:false } }
      }
    }
  };
  if(charts.topCust) charts.topCust.destroy();
  addParetoIfNeeded(cfg1, agg.byTopCust.labels, agg.byTopCust.data, isPareto, isHorizontal);
  charts.topCust=new Chart(ctx1,cfg1);

  // Chart 2: 月別（顧客）
  const ctx2=document.getElementById('chartByMonth').getContext('2d');
  const max2=Math.max(1,...agg.byMonth.data);
  const colors2=softPalette(agg.byMonth.data.length, isDark()?0.7:0.8);
  const cfg2={
    type:'bar',
    data:{ labels:agg.byMonth.labels,
      datasets:[{ label:'数量（済）', data:agg.byMonth.data,
        backgroundColor:colors2, borderColor:colors2, borderWidth:1,
        maxBarThickness:36, categoryPercentage:.8, barPercentage:.9 }]},
    options:{
      indexAxis: isHorizontal ? 'y':'x',
      maintainAspectRatio:false,
      layout:{padding:{top:6,right:8,left:4,bottom:0}},
      plugins:{
        legend:{ display:false },
        title:{ display:true, text:`出荷検査（月別｜済｜${yearPick}年｜${custPick}${quarterPick!=='ALL'?'｜'+quarterPick:''}）` },
        datalabels:{
          display:(ctx)=> (ctx.dataset.data[ctx.dataIndex] > 0),
          anchor:'end', align:isHorizontal?'right':'top', offset:4, rotation:0, clamp:true, clip:false,
          formatter:(v)=>v, color:theme.ink
        },
        tooltip:{ callbacks:{ label:(ctx)=> `数量: ${ctx.parsed[isHorizontal?'x':'y']}` } }
      },
      scales: isHorizontal ? {
        x:{ beginAtZero:true, suggestedMax:max2*1.15, ticks:{ callback:intTick }, grid:{color:theme.grid} },
        y:{ ticks:{ autoSkip:false, maxRotation:0 }, grid:{display:false} }
      } : {
        y:{ beginAtZero:true, suggestedMax:max2*1.15, ticks:{ callback:intTick }, grid:{color:theme.grid} },
        x:{ ticks:{ autoSkip:false, maxRotation:0 }, grid:{display:false} }
      }
    }
  };
  if(charts.month) charts.month.destroy();
  charts.month=new Chart(ctx2,cfg2);

  // Chart 3: 顧客別（年 合計）
  const ctx3=document.getElementById('chartTopCustYear').getContext('2d');
  const max3=Math.max(1,...agg.byTopCustYear.data);
  const colors3=softPalette(agg.byTopCustYear.data.length, isDark()?0.7:0.8);
  const cfg3={
    type:'bar',
    data:{ labels:agg.byTopCustYear.labels,
      datasets:[{ label:'数量（済）', data:agg.byTopCustYear.data,
        backgroundColor:colors3, borderColor:colors3, borderWidth:1,
        maxBarThickness:26, categoryPercentage:.7, barPercentage:.9 }]},
    options:{
      indexAxis: isHorizontal ? 'y':'x',
      maintainAspectRatio:false,
      layout:{padding:{top:6,right:8,left:4,bottom:0}},
      plugins:{ legend:{display:false},
        title:{display:true,text:`出荷検査（顧客別｜済｜${yearPick}年 合計）`},
        datalabels:{ anchor:'end', align:isHorizontal?'right':'top', formatter:(v)=>v, color:theme.ink } },
      scales: isHorizontal ? {
        x:{ beginAtZero:true, suggestedMax:max3*1.15, ticks:{ callback:intTick }, grid:{color:theme.grid} },
        y:{ grid:{ display:false } }
      } : {
        y:{ beginAtZero:true, suggestedMax:max3*1.15, ticks:{ callback:intTick }, grid:{color:theme.grid} },
        x:{ grid:{ display:false } }
      }
    }
  };
  if(charts.topCustYear) charts.topCustYear.destroy();
  addParetoIfNeeded(cfg3, agg.byTopCustYear.labels, agg.byTopCustYear.data, isPareto, isHorizontal);
  charts.topCustYear=new Chart(ctx3,cfg3);

  document.getElementById('chartNote').textContent = `期間: ${periodLabel} ／ 顧客: ${custPick} ／ 集計は「済」のみ`;
  lastAgg=agg;
}

/* ===== Fetch ===== */
async function load(){
  try{
    if(isLoading){ aborter?.abort(); }
    isLoading=true;
    const btn=document.getElementById('btnRefresh'); const old=btn.textContent;
    btn.textContent='Loading...'; btn.disabled=true;

    aborter=new AbortController();
    const res=await fetch(CSV_URL + "&_ts=" + Date.now(), {signal:aborter.signal, cache:'no-store'});
    if(!res.ok) throw new Error("HTTP "+res.status);
    const text=await res.text(); const arr=parseCSV(text); if(!arr.length) throw new Error('CSV empty');

    const header=arr[0], rowsRaw=arr.slice(1), idx=indexByName(header);
    const rows=[...rowsRaw];
    cached={header, rows, idx};

    const yearSet=new Set(), custTotals=new Map();
    for(const r of rows){
      if(!isDoneRow(r, idx)) continue;
      if(idx.date!=null){
        const d=parseJPDate(valAt(r, idx.date));
        if(d && d.getTime()>0) yearSet.add(String(d.getFullYear()));
      }
      if(idx.cust!=null){
        const c=S(valAt(r, idx.cust)) || '不明';
        const q=idx.qty!=null?parseQty(valAt(r, idx.qty)):1;
        custTotals.set(c,(custTotals.get(c)||0)+q);
      }
    }
    const years=[...yearSet].sort();
    const customers=[...custTotals.entries()].sort((a,b)=>b[1]-a[1]).map(([c])=>c);

    const selYear=document.getElementById('selYear');
    selYear.innerHTML = years.map(y=>`<option value="${y}">${y}</option>`).join('');
    selYear.value = years.at(-1) || new Date().getFullYear();

    const selCust=document.getElementById('selCust');
    selCust.innerHTML = customers.map(c=>`<option value="${c}">${c}</option>`).join('');
    selCust.value = customers[0] || '';

    render();

    btn.textContent=old; btn.disabled=false; isLoading=false;
  }catch(e){
    console.error(e);
    const btn=document.getElementById('btnRefresh'); btn.textContent='Refresh'; btn.disabled=false; isLoading=false;
    document.getElementById('chartNote').textContent='読み込みに失敗しました。シート名/公開設定/列名をご確認ください。';
  }
}

/* ===== Export & events ===== */
function exportChartsExcel(){
  if(!lastAgg) return;
  const wb=XLSX.utils.book_new();
  const ws1=XLSX.utils.aoa_to_sheet([["顧客名","数量（済）"], ...lastAgg.byTopCust.labels.map((n,i)=>[n,lastAgg.byTopCust.data[i]])]);
  XLSX.utils.book_append_sheet(wb, ws1, `顧客別(期間)`);
  const ws2=XLSX.utils.aoa_to_sheet([["月","数量（済）"], ...lastAgg.byMonth.labels.map((k,i)=>[k,lastAgg.byMonth.data[i]])]);
  XLSX.utils.book_append_sheet(wb, ws2, `月別(${lastAgg.custPick})`);
  const ws3=XLSX.utils.aoa_to_sheet([["顧客名","数量（済）"], ...lastAgg.byTopCustYear.labels.map((n,i)=>[n,lastAgg.byTopCustYear.data[i]])]);
  XLSX.utils.book_append_sheet(wb, ws3, `顧客別(年)`);
  XLSX.writeFile(wb, "出荷検査_グラフ集計(済).xlsx");
}

async function exportPDF(){
  const { jsPDF } = window.jspdf;
  const pdf=new jsPDF({orientation:"landscape", unit:"pt", format:"a4"});
  const items=[
    {el:document.getElementById('chartTopCust'), title:'顧客別（期間｜済）'},
    {el:document.getElementById('chartByMonth'), title:'月別（顧客｜済）'},
    {el:document.getElementById('chartTopCustYear'), title:'顧客別（年｜済）'},
  ];
  for(let i=0;i<items.length;i++){
    if(i>0) pdf.addPage();
    const png=items[i].el.toDataURL('image/png',1.0);
    const pageW=pdf.internal.pageSize.getWidth();
    const pageH=pdf.internal.pageSize.getHeight();
    const margin=36;
    const w=pageW-margin*2, h=pageH-margin*2-24;
    pdf.setFontSize(14); pdf.text(items[i].title, margin, margin);
    pdf.addImage(png,'PNG', margin, margin+12, w, h, undefined, 'FAST');
  }
  pdf.save('出荷検査_グラフ(PDF).pdf');
}

/* ===== Live & ticker ===== */
let timer=null, intervalMs=60000;
function startAutoRefresh(ms){
  intervalMs=ms; clearInterval(timer);
  timer=setInterval(()=>{ if(document.visibilityState==='visible') load(); }, intervalMs);
  document.getElementById('intervalInfo').textContent = `${Math.round(intervalMs/1000)}s`;
  const liveBtn=document.getElementById('btnLive');
  if(intervalMs<=5000){ liveBtn.classList.add('active'); liveBtn.textContent='Live: On'; }
  else{ liveBtn.classList.remove('active'); liveBtn.textContent='Live: Off'; }
}
function setTickerVisible(on){
  const el=document.getElementById('ticker');
  el.classList.toggle('hidden', !on);
  document.body.classList.toggle('has-ticker', on);
  localStorage.setItem('tickerOn', on ? '1':'0');
}

/* ===== Events ===== */
document.getElementById('btnRefresh').addEventListener('click', load);
document.getElementById('btnLive').addEventListener('click', ()=>{ startAutoRefresh(intervalMs<=5000?60000:5000); load(); });
document.addEventListener('visibilitychange', ()=>{ if(document.visibilityState==='visible') load(); });

['selTop','selYear','selQuarter','selMonth','selCust','chkPareto','selOrient'].forEach(id=>{
  document.getElementById(id).addEventListener('change', render);
});
document.getElementById('btnExcelCharts').addEventListener('click', exportChartsExcel);
document.getElementById('btnPDF').addEventListener('click', exportPDF);
document.getElementById('btnReset').addEventListener('click', ()=>{
  document.getElementById('selTop').value="10";
  const ySel=document.getElementById('selYear'); if(ySel.options.length) ySel.value=ySel.options[ySel.options.length-1].value;
  document.getElementById('selQuarter').value="ALL";
  document.getElementById('selMonth').value="ALL";
  const cSel=document.getElementById('selCust'); if(cSel.options.length) cSel.value=cSel.options[0].value;
  document.getElementById('selOrient').value="h";
  document.getElementById('chkPareto').checked=false;
  render();
});
document.getElementById('chkDark').addEventListener('change',(e)=>{
  document.documentElement.setAttribute('data-theme', e.target.checked?'dark':'light');
  render();
});
document.getElementById('btnCloseTicker').addEventListener('click', ()=> setTickerVisible(false));

/* ===== Init ===== */
window.addEventListener('DOMContentLoaded', ()=>{
  const savedTicker = localStorage.getItem('tickerOn') === '1';
  setTickerVisible(savedTicker);
  load(); startAutoRefresh(60000);
});
</script>
</body>
</html>
