<!doctype html>
<html lang="ja">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>品質管理生産技術 – チャート</title>
<style>
  :root{--bg:#f6f7fb;--panel:#fff;--ink:#0f172a;--muted:#64748b;--border:#e5e7eb;--ring:#c7d2fe;--accent:#2563eb;--shadow:0 15px 40px rgba(15,23,42,.08)}
  *{box-sizing:border-box} body{margin:0;font-family:system-ui,-apple-system,"Segoe UI",Roboto,"Noto Sans JP","Yu Gothic",sans-serif;background:var(--bg);color:var(--ink)}
  .app{display:grid;grid-template-rows:64px 1fr;min-height:100vh}
  header{position:sticky;top:0;z-index:60;background:#ffffffc7;backdrop-filter:blur(12px);border-bottom:1px solid var(--border)}
  .header-wrap{height:64px;max-width:1400px;margin:0 auto;display:flex;align-items:center;justify-content:space-between;gap:10px;padding:0 14px}
  .brand{display:flex;align-items:center;gap:10px}.brand img{height:36px}.ttl{font-weight:800}
  .btn{display:inline-flex;align-items:center;gap:8px;height:34px;padding:0 12px;border-radius:10px;border:1px solid var(--border);background:#fff;cursor:pointer}
  .badge{height:28px;padding:0 10px;display:inline-flex;align-items:center;gap:8px;font-size:12px;font-weight:700;background:#f1f5f9;border:1px solid var(--border);border-radius:999px;color:#0f172a}
  .burger{display:none;align-items:center;justify-content:center;width:38px;height:38px;border:1px solid var(--border);border-radius:10px;background:#fff;cursor:pointer}
  main{max-width:1400px;margin:0 auto;padding:22px 20px 130px}
  .edge-hotspot{position:fixed;left:0;top:64px;width:12px;height:calc(100vh - 64px);z-index:70}
  .hover-side{position:fixed;left:0;top:64px;height:calc(100vh - 64px);width:260px;padding:14px 12px;overflow:auto;background:#fff;border-right:1px solid var(--border);box-shadow:var(--shadow);transform:translateX(-100%);transition:transform .22s ease;z-index:71}
  .hover-side.open{transform:translateX(0)} .navlist{display:grid;gap:4px} .slink{display:flex;align-items:center;gap:10px;padding:10px 12px;border-radius:12px}
  .slink:hover{background:#f1f5ff}
  .drawer{position:fixed;inset:0;z-index:80;display:none}.drawer.open{display:block}
  .drawer .backdrop{position:absolute;inset:0;background:#0006}
  .drawer .panel{position:absolute;top:0;left:0;height:100%;width:min(86%,320px);background:#fff;border-right:1px solid var(--border);box-shadow:0 30px 60px rgba(15,23,42,.10);padding:14px 12px;overflow:auto;transform:translateX(-100%);transition:transform .25s ease}
  .drawer.open .panel{transform:translateX(0)} .drawer .close{position:absolute;right:10px;top:10px;border:0;background:#f1f5f9;border:1px solid var(--border);border-radius:8px;padding:6px 10px;cursor:pointer}
  .urgent-banner{margin:12px 0 6px;background:#fee2e2;border:1px solid #fecaca;color:#991b1b;padding:12px 14px;border-radius:12px;text-align:center;font-weight:800;display:none}
  .error-banner{margin:10px 0;padding:10px 12px;border-radius:12px;background:#fff7ed;border:1px solid #fed7aa;color:#9a3412;display:none}
  .panel{background:#fff;border:1px solid var(--border);border-radius:20px;box-shadow:var(--shadow);padding:14px}
  .grid{display:grid;grid-template-columns:1fr 1fr;gap:16px} @media (max-width:1000px){.grid{grid-template-columns:1fr}}
  .filterbar{display:flex;gap:8px;align-items:center;flex-wrap:wrap;margin:8px 0 14px}
  .chipbtn{display:inline-flex;align-items:center;gap:8px;padding:8px 12px;border:1px solid var(--border);border-radius:999px;background:#f8fafc;cursor:pointer}
  .chipbtn.active{border-color:#2563eb;box-shadow:0 0 0 3px rgba(37,99,235,.15)}
  .toggle{display:inline-flex;border:1px solid var(--border);border-radius:999px;overflow:hidden;background:#fff}
  .toggle button{padding:8px 12px;border:0;background:transparent;cursor:pointer}
  .toggle button.active{background:#eef2ff;box-shadow:inset 0 0 0 2px #c7d2fe;font-weight:700}
  .badge.muted{opacity:.75}
  .cwrap{height:320px;position:relative} .cwrap.tall{height:380px}
  .loading{position:absolute;inset:0;display:grid;place-items:center;color:#64748b;font-weight:700}
  .chartbar{display:flex;gap:8px;align-items:center;flex-wrap:wrap;margin:2px 0 10px}
  .chartbar .btn,.fab .btn{height:30px;padding:0 10px;border-radius:9px}
  .fab{position:fixed;right:16px;bottom:16px;z-index:120;display:grid;gap:8px;justify-items:end}
  .fab .card{background:#fff;border:1px solid var(--border);border-radius:14px;box-shadow:var(--shadow);padding:8px 10px;display:flex;align-items:center;gap:8px}
  .fab .hint{font-size:12px;color:#475569}
  @media (max-width:900px){.burger{display:inline-flex}.edge-hotspot,.hover-side{display:none}}
</style>
<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.3/dist/chart.umd.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-datalabels@2.2.0/dist/chartjs-plugin-datalabels.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/jspdf@2.5.1/dist/jspdf.umd.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/jspdf-autotable@3.8.2/dist/jspdf.plugin.autotable.min.js"></script>
</head>
<body>
<div class="app">
  <header>
    <div class="header-wrap">
      <button id="btnBurger" class="burger" aria-label="メニュー">☰</button>
      <div class="brand"><img src="tsh.png" alt="" onerror="this.style.display='none'"><div class="ttl"><strong>品質管理生産技術</strong></div></div>
      <nav style="display:flex;gap:8px;align-items:center;flex-wrap:wrap">
        <div class="dropdown" id="statusDropdown">
          <button class="btn drop-btn" type="button">🔎 ステータス フィルター</button>
          <div class="drop-menu"><div class="chips" id="chipsBox"></div>
            <div style="margin-top:10px;text-align:right"><span id="clearFilter" style="color:#2563eb;cursor:pointer">すべて表示</span></div>
          </div>
        </div>
      </nav>
    </div>
  </header>

  <main>
    <div id="urgentBanner" class="urgent-banner"></div>
    <div id="errorBanner" class="error-banner"></div>

    <section class="panel">
      <div class="filterbar">
        <strong style="color:#475569">範囲:</strong>
        <button class="chipbtn" data-range="all">🌐 All</button>
        <button class="chipbtn" data-range="14d">🗓️ 14日</button>
        <button class="chipbtn" data-range="30d">📅 30日</button>
        <button class="chipbtn" data-range="ytd">🗂️ 年内(YTD)</button>
        <span style="width:12px"></span>
        <strong style="color:#475569">メトリクス:</strong>
        <div class="toggle" id="metricToggle" role="tablist" aria-label="metric">
          <button type="button" role="tab" data-metric="qty">数量</button>
          <button type="button" role="tab" data-metric="count">件数</button>
        </div>
        <span id="metricBadge" class="badge muted">表示: —</span>
      </div>

      <div class="grid">
        <div class="panel">
          <div class="chartbar"><strong>出荷（日次・直近）</strong><button id="dailyOrient" class="btn">縦</button><button id="dailyExport" class="btn">Export</button></div>
          <div class="cwrap"><div class="loading">Loading…</div><canvas id="dailyShip"></canvas></div>
        </div>
        <div class="panel">
          <div class="chartbar"><strong>出荷（月次・年内）</strong><button id="monthlyOrient" class="btn">縦</button><button id="monthlyExport" class="btn">Export</button></div>
          <div class="cwrap"><div class="loading">Loading…</div><canvas id="monthlyQty"></canvas></div>
        </div>
        <div class="panel">
          <div class="chartbar">
            <strong id="hCust">顧客別 出荷（Top 10）</strong>
            <button id="custTypeBar"  class="btn">Bar</button>
            <button id="custTypeBarH" class="btn">BarH</button>
            <button id="custTypePie"  class="btn">Pie</button>
            <button id="custTypePareto" class="btn">Pareto</button>
            <button id="custTop" class="btn">Top10</button>
            <button id="custExport" class="btn">Export</button>
          </div>
          <div class="cwrap tall"><div class="loading">Loading…</div><canvas id="custQty"></canvas></div>
        </div>
        <div class="panel">
          <div class="chartbar">
            <strong>顧客別 月次 出荷（YTD）</strong>
            <button id="custMonTop" class="btn">Top6</button>
            <button id="custMonOrient" class="btn">縦</button>
            <button id="custMonExport" class="btn">Export</button>
          </div>
          <div class="cwrap tall"><div class="loading">Loading…</div><canvas id="custMonthly"></canvas></div>
        </div>
      </div>
    </section>
  </main>

  <div id="edgeHotspot" class="edge-hotspot" aria-hidden="true"></div>
  <aside id="hoverSide" class="hover-side" aria-label="Pages">
    <h3 style="margin:4px 8px 10px;font-size:12px;letter-spacing:.08em;color:#6b7280;text-transform:uppercase">Pages</h3>
    <div class="navlist">
      <a class="slink" href="./index.html">🏠 <strong>ホーム</strong></a>
      <a class="slink" href="./forms.html">📄 <strong>出荷検査成績書</strong></a>
      <a class="slink" href="./sagyoutejunsho.html">📝 <strong>作業手順書</strong></a>
      <a class="slink" href="./charts.html">📈 <strong>チャート</strong></a>
      <a class="slink" href="./quality.html">🔎 <strong>品質情報</strong></a>
      <a class="slink" href="./claim.html">🧪 <strong>Trial Page</strong></a>
    </div>
  </aside>

  <div id="drawer" class="drawer" aria-hidden="true">
    <div class="backdrop" data-close></div>
    <aside class="panel">
      <button class="close" data-close>✕</button>
      <div class="navlist" style="margin-top:30px">
        <a class="slink" href="./index.html">🏠 <strong>ホーム</strong></a>
        <a class="slink" href="./forms.html">📄 <strong>出荷検査成績書</strong></a>
        <a class="slink" href="./sagyoutejunsho.html">📝 <strong>作業手順書</strong></a>
        <a class="slink" href="./charts.html">📈 <strong>チャート</strong></a>
        <a class="slink" href="./quality.html">🔎 <strong>品質情報</strong></a>
        <a class="slink" href="./claim.html">🧪 <strong>Trial Page</strong></a>
      </div>
    </aside>
  </div>
</div>

<div class="fab" aria-live="polite">
  <div class="card">
    <button id="btnRefresh" class="btn" type="button">⟳ Refresh</button>
    <button id="btnLive" class="btn" type="button" aria-pressed="false">● Live</button>
    <button id="btnLabels" class="btn" type="button">123 Labels</button>
    <span id="intervalInfo" class="badge">—</span>
  </div>
  <div class="card hint"><span id="lastup">Last update: —</span></div>
</div>

<script>
window.addEventListener('load', () => {
  /* ===== Persist ===== */
  const LS='kensaCharts';
  const get=()=>{ try{return JSON.parse(localStorage.getItem(LS)||'{}')}catch{return{}} };
  const set=(p)=>localStorage.setItem(LS, JSON.stringify(Object.assign(get(), p)));

  /* ===== Sidebar & drawer ===== */
  const drawer=document.getElementById('drawer');
  document.getElementById('btnBurger')?.addEventListener('click',()=>{drawer.classList.add('open');drawer.setAttribute('aria-hidden','false')});
  drawer?.addEventListener('click',e=>{if(e.target.hasAttribute('data-close')){drawer.classList.remove('open');drawer.setAttribute('aria-hidden','true')}})
  const hot=document.getElementById('edgeHotspot'), fly=document.getElementById('hoverSide'); let t=null;
  const openFly=()=>{clearTimeout(t);fly.classList.add('open')}, closeFly=()=>{clearTimeout(t);t=setTimeout(()=>fly.classList.remove('open'),260)};
  hot?.addEventListener('mouseenter',openFly); hot?.addEventListener('mouseleave',closeFly);
  fly?.addEventListener('mouseenter',()=>clearTimeout(t)); fly?.addEventListener('mouseleave',closeFly);

  /* ===== Data Source (GViz + Publish-to-web fallback) ===== */
  const SHEET_ID  ="1lYl7oYk6atnm3KqC6VwufARX3ooRyJ2VmC_xYFb4-OE"; // sama seperti file kamu
  const TAB_NAME  ="最新情報";
  const SHEET_GID = "0"; // ganti ke gid tab 最新情報 jika sudah "Publish to web"
  const GVIZ = `https://docs.google.com/spreadsheets/d/${SHEET_ID}/gviz/tq?tqx=out:csv&sheet=${encodeURIComponent(TAB_NAME)}`;
  const PUB  = `https://docs.google.com/spreadsheets/d/${SHEET_ID}/pub?gid=${SHEET_GID}&single=true&output=csv`;

  const fetchCSV = async (url, ms=8000) => {
    const ctrl=new AbortController(); const to=setTimeout(()=>ctrl.abort(), ms);
    try{
      const res=await fetch(url+'&_ts='+Date.now(),{signal:ctrl.signal,headers:{'Accept':'text/csv'}});
      if(!res.ok) throw new Error('HTTP '+res.status);
      return await res.text();
    }finally{ clearTimeout(to); }
  };

  const getCSVRobust = async ()=>{
    try{ return await fetchCSV(GVIZ, 6000); }
    catch(e1){
      try{ return await fetchCSV(PUB, 6000); }
      catch(e2){ throw new Error('Fetch gagal (gviz & publish). Periksa izin sheet dan “Publish to web”.'); }
    }
  };

  /* ===== Utils ===== */
  const $ = (q)=>document.querySelector(q);
  const showErr=(msg)=>{ const b=$('#errorBanner'); b.textContent=msg; b.style.display='block'; };
  const hideErr=()=>{ const b=$('#errorBanner'); b.style.display='none'; };
  const S = s => String(s==null?'':s).trim();
  function parseCSV(t){
    const out=[], re=/\s*("(?:[^"]|"")*"|[^,]*)\s*(,|\n|$)/g; let row=[], m; t=t.replace(/\r\n?/g,"\n");
    for(let i=0;i<t.length;){ re.lastIndex=i; m=re.exec(t); if(!m) break;
      let cell=m[1]; if(cell.startsWith('"')) cell=cell.slice(1,-1).replace(/""/g,'"');
      row.push(cell); i=re.lastIndex; if(m[2]==="\n"||m[2]===""){ out.push(row); row=[]; }
    } return out.filter(r=>r.length && r.some(c=>S(c)!==""));
  }
  function indexByName(header){
    const map={}; header.forEach((h,i)=>map[S(h)]=i);
    const f = n => (n in map ? map[n] : null);
    const fRx = rx => { for(let i=0;i<header.length;i++){ if(rx.test(S(header[i]))) return i; } return null; };
    return {
      date: f('出荷日'), cust: f('顧客名'), qty: f('数量'),
      status: fRx(/製品状況|製品状態|納品状況/), urgent: fRx(/Status|至急|ステータス/i)
    };
  }
  const val=(r,i)=> (i==null?'':(r[i]||''));
  function parseJPDate(str){ const s=S(str); if(!s) return null; const m=s.match(/^(\d{4})\D(\d{1,2})\D(\d{1,2})/); if(m) return new Date(m[1],m[2]-1,m[3]); const d=new Date(s); return isNaN(d)?null:d }
  const z2=n=>String(n).padStart(2,'0'); const dkey=d=>`${d.getFullYear()}-${z2(d.getMonth()+1)}-${z2(d.getDate())}`; const mkey=d=>`${d.getFullYear()}-${z2(d.getMonth()+1)}`;

  /* ===== Status & state ===== */
  const STATUS=[{key:'shipok',label:'出荷済',rx:/出荷済/},{key:'prep',label:'出荷準備済',rx:/出荷準備済/},{key:'inspect',label:'検査中',rx:/検査中/},{key:'hold',label:'検査保留',rx:/検査保留/}];
  const isUrgent=v=>['至急','urgent','緊急','1','true'].includes(String(v).toLowerCase());
  const st = Object.assign({range:'ytd',metric:'qty',labels:true,interval:60000,status:null,
    custType:'barH',custTop:10,custMonTop:6,dailyOrient:'v',monthlyOrient:'v',custMonOrient:'v'
  }, get());
  let cache={header:[],rows:[],idx:null}, timer=null;

  /* ===== UI sync ===== */
  const sync=()=>{
    document.querySelectorAll('.chipbtn').forEach(b=>b.classList.toggle('active', b.dataset.range===st.range));
    document.querySelectorAll('#metricToggle button').forEach(b=>b.classList.toggle('active', b.dataset.metric===st.metric));
    $('#metricBadge').textContent='表示: '+(st.metric==='count'?'件数':'数量');
    $('#btnLabels').textContent=(st.labels?'✓ ':'✗ ')+'Labels';
    $('#intervalInfo').textContent=Math.round(st.interval/1000)+'s';
    $('#custTop').textContent='Top'+st.custTop; $('#custMonTop').textContent='Top'+st.custMonTop;
    $('#dailyOrient').textContent=st.dailyOrient==='v'?'縦':'横';
    $('#monthlyOrient').textContent=st.monthlyOrient==='v'?'縦':'横';
    $('#custMonOrient').textContent=st.custMonOrient==='v'?'縦':'横';
  };

  /* ===== Helpers ===== */
  const metricVal=(r,idx)=> st.metric==='count'?1:(+S(val(r,idx.qty))||0);
  const metricLabel=()=> st.metric==='count'?'件数':'数量';
  const byStatus=(rows,idx)=> !st.status?rows:rows.filter(r=> (STATUS.find(s=>s.key===st.status)?.rx||/.^/).test(S(val(r,idx.status))));
  const byRange=(rows,idx)=>{ const now=new Date(); if(st.range==='14d'){ const t=new Date(now);t.setDate(t.getDate()-13);t.setHours(0,0,0,0); return rows.filter(r=>{const d=parseJPDate(val(r,idx.date)); return d && d>=t})}
    if(st.range==='30d'){ const t=new Date(now);t.setDate(t.getDate()-29);t.setHours(0,0,0,0); return rows.filter(r=>{const d=parseJPDate(val(r,idx.date)); return d && d>=t})}
    if(st.range==='ytd'){ const t=new Date(now.getFullYear(),0,1); return rows.filter(r=>{const d=parseJPDate(val(r,idx.date)); return d && d>=t})}
    return rows; };

  /* ===== Build series ===== */
  const build=(rows,idx)=>{
    const daily={}, monthly={}, cust={}, custMonth={};
    rows.forEach(r=>{const d=parseJPDate(val(r,idx.date)); if(!d) return; const v=metricVal(r,idx); const D=dkey(d), M=mkey(d), C=S(val(r,idx.cust))||'—';
      daily[D]=(daily[D]||0)+v; monthly[M]=(monthly[M]||0)+v; cust[C]=(cust[C]||0)+v; (custMonth[M]||(custMonth[M]={}))[C]=(custMonth[M][C]||0)+v;});
    const dl=Object.keys(daily).sort(), dv=dl.map(k=>daily[k]);
    const ml=Object.keys(monthly).sort(), mv=ml.map(k=>monthly[k]);
    const ce=Object.entries(cust).sort((a,b)=>b[1]-a[1]).slice(0,st.custTop), cl=ce.map(x=>x[0]), cv=ce.map(x=>x[1]);
    const top=Object.entries(cust).sort((a,b)=>b[1]-a[1]).slice(0,st.custMonTop).map(x=>x[0]);
    const cmDs=top.map(cn=>({label:cn,data:ml.map(m=> (custMonth[m]&&custMonth[m][cn])?custMonth[m][cn]:0)}));
    return {dl,dv,ml,mv,cl,cv,cmDs};
  };

  /* ===== Chart helpers ===== */
  let dailyChart, monthlyChart, custChart, custMonChart;
  const opts=({h=false,max=null}={})=>({responsive:true,maintainAspectRatio:false,layout:{padding:{right:30,top:10}},
    plugins:{legend:{display:false},datalabels:{display:st.labels,clip:false,clamp:true,anchor:h?'end':'end',align:h?'end':'top',offset:4,formatter:v=>isNaN(v)?'':String(Math.round(v)),font:{weight:'700'}},tooltip:{mode:'index',intersect:false,callbacks:{label:c=>metricLabel()+': '+c.parsed.y}}},
    scales: h?{x:{grid:{color:'#eef2ff'},suggestedMax:max},y:{grid:{color:'#f1f5f9'}}}:{x:{grid:{color:'#eef2ff'}},y:{grid:{color:'#f1f5f9'},suggestedMax:max,ticks:{precision:0}}});
  const upsert=(el,cfg,name)=>{ if(window[name]){window[name].data=cfg.data;window[name].options=cfg.options;window[name].update()} else {window[name]=new Chart(el,cfg)} };
  const clearLoading=()=>document.querySelectorAll('.cwrap .loading').forEach(e=>e.remove());

  /* ===== Render ===== */
  const render=()=>{
    const idx=cache.idx;
    let rows=byRange(byStatus(cache.rows,idx),idx);

    // urgent + status chips
    const counts={}; STATUS.forEach(s=>counts[s.key]=0);
    cache.rows.forEach(r=>{const t=S(val(r,idx.status)); for(const s of STATUS){ if(s.rx.test(t)){counts[s.key]++; break;}}});
    const chips=document.getElementById('chipsBox');
    chips.innerHTML=`<button class="chipbtn ${!st.status?'active':''}" data-key="">🌐 すべて <span class="count">${cache.rows.length}</span></button>`+
      STATUS.map(s=>`<button class="chipbtn ${st.status===s.key?'active':''}" data-key="${s.key}">• ${s.label} <span class="count">${counts[s.key]||0}</span></button>`).join('');
    chips.querySelectorAll('.chipbtn').forEach(b=>b.onclick=()=>{st.status=b.dataset.key||null;set({status:st.status});render();document.getElementById('statusDropdown').classList.remove('open')});
    const urgent = idx.urgent!=null ? cache.rows.filter(r=>isUrgent(val(r,idx.urgent))).length : 0;
    const ub=document.getElementById('urgentBanner'); if(urgent>0){ub.style.display='block';ub.textContent=`⚠ 至急案件が ${urgent} 件あります！早急に確認してください。`} else {ub.style.display='none'}

    const ag=build(rows,idx);
    Chart.register(ChartDataLabels);

    const dMax=Math.max(0,...ag.dv), dH=st.dailyOrient==='h';
    upsert(document.getElementById('dailyShip'), {type:dH?'bar':'line', data:{labels:ag.dl,datasets:[{label:metricLabel(),data:ag.dv,tension:.25,fill:!dH,pointRadius:3}]}, options:Object.assign(opts({h:dH,max:Math.ceil(dMax*1.15)}), dH?{indexAxis:'y'}:{})}, 'dailyChart');

    const mMax=Math.max(0,...ag.mv), mH=st.monthlyOrient==='h';
    upsert(document.getElementById('monthlyQty'), {type:'bar', data:{labels:ag.ml,datasets:[{label:metricLabel(),data:ag.mv}]}, options:Object.assign(opts({h:mH,max:Math.ceil(mMax*1.15)}), mH?{indexAxis:'y'}:{})}, 'monthlyChart');

    let custCfg;
    if(st.custType==='pie'){
      custCfg={type:'pie',data:{labels:ag.cl,datasets:[{data:ag.cv}]},options:{responsive:true,maintainAspectRatio:false,plugins:{legend:{position:'right'},datalabels:{display:st.labels,formatter:(v,ctx)=>{const sum=ctx.chart.data.datasets[0].data.reduce((a,b)=>a+b,0)||1;const p=Math.round(v/sum*100);return `${v} (${p}%)`}}}}};
    }else if(st.custType==='pareto'){
      const total=ag.cv.reduce((a,b)=>a+b,0)||1; const cum=[]; ag.cv.reduce((acc,v,i)=>(cum[i]=Math.round((acc+v)/total*100),acc+v),0);
      custCfg={type:'bar',data:{labels:ag.cl,datasets:[{label:metricLabel(),data:ag.cv,yAxisID:'y'},{label:'累積(%)',data:cum,type:'line',yAxisID:'y1',tension:.25,pointRadius:3}]},
        options:{responsive:true,maintainAspectRatio:false,plugins:{legend:{display:true},datalabels:{display:st.labels,formatter:(v,ctx)=>ctx.dataset.type==='line'?v+'%':v}},scales:{x:{grid:{color:'#eef2ff'}},y:{beginAtZero:true,grid:{color:'#f1f5f9'}},y1:{position:'right',beginAtZero:true,max:100,grid:{drawOnChartArea:false}}}}};
    }else{
      const h=st.custType==='barH';
      custCfg={type:'bar',data:{labels:ag.cl,datasets:[{label:metricLabel(),data:ag.cv}]},options:Object.assign(opts({h,max:Math.max(...ag.cv)*1.15||undefined}), h?{indexAxis:'y'}:{})};
    }
    upsert(document.getElementById('custQty'), custCfg,'custChart');

    const sH=st.custMonOrient==='h';
    upsert(document.getElementById('custMonthly'), {type:'bar',data:{labels:ag.ml,datasets:ag.cmDs},options:Object.assign({responsive:true,maintainAspectRatio:false,plugins:{legend:{position:'bottom'},datalabels:{display:false}},scales:sH?{x:{stacked:true,grid:{color:'#eef2ff'}},y:{stacked:true,grid:{color:'#f1f5f9'}}}:{x:{stacked:true,grid:{color:'#eef2ff'}},y:{stacked:true,grid:{color:'#f1f5f9'},ticks:{precision:0}}}}, sH?{indexAxis:'y'}:{})}, 'custMonChart');

    document.getElementById('lastup').textContent='Last update: '+new Date().toLocaleString();
    clearLoading(); hideErr();
  };

  /* ===== Load & live ===== */
  async function load(){
    const btn=document.getElementById('btnRefresh'); const old=btn.textContent; btn.textContent='Loading…'; btn.disabled=true;
    try{
      const text = await getCSVRobust();
      const data = parseCSV(text);
      if(!data.length) throw new Error('CSV kosong. Cek tab dan izin.');
      const header=data[0], rows=data.slice(1); const idx=indexByName(header);
      if(idx.date==null || idx.qty==null) throw new Error('Kolom wajib tidak ditemukan (出荷日 / 数量).');
      cache={header,rows,idx}; render();
    }catch(e){ console.error(e); showErr('Gagal memuat data: '+e.message); }
    finally{ btn.textContent=old; btn.disabled=false; }
  }
  const startAuto=(ms)=>{ if(timer) clearInterval(timer); timer=setInterval(()=>{ if(document.visibilityState==='visible') load() }, ms); st.interval=ms; set({interval:ms}); document.getElementById('intervalInfo').textContent=Math.round(ms/1000)+'s'; document.getElementById('btnLive').textContent=(ms<=5000?'● Live: On':'● Live: Off') };

  /* ===== Export ===== */
  const metricLabel=()=> st.metric==='count'?'件数':'数量'; // re-declare for PDF helper scope
  async function exportPDF(){
    const { jsPDF } = window.jspdf; const doc=new jsPDF('l','pt','a4'); const charts=[dailyChart,monthlyChart,custChart,custMonChart].filter(Boolean);
    let y=40; for(const ch of charts){ const img=ch.toBase64Image(); doc.addImage(img,'PNG',30,y,760,300); y+=324; if(y>520){doc.addPage(); y=40;} } doc.save('charts_export.pdf');
  }
  function exportExcelCurrent(){
    const rows=byRange(byStatus(cache.rows,cache.idx),cache.idx); const ag=build(rows,cache.idx);
    const wb=XLSX.utils.book_new();
    XLSX.utils.book_append_sheet(wb,XLSX.utils.aoa_to_sheet([['日付',metricLabel()], ...ag.dl.map((d,i)=>[d,ag.dv[i]])]),'Daily');
    XLSX.utils.book_append_sheet(wb,XLSX.utils.aoa_to_sheet([['月',metricLabel()], ...ag.ml.map((m,i)=>[m,ag.mv[i]])]),'Monthly');
    XLSX.utils.book_append_sheet(wb,XLSX.utils.aoa_to_sheet([['顧客',metricLabel()], ...ag.cl.map((c,i)=>[c,ag.cv[i]])]),'CustomersTop');
    const header=['月',...ag.cmDs.map(d=>d.label)], rows2=ag.ml.map((m,i)=>[m,...ag.cmDs.map(ds=>ds.data[i])]);
    XLSX.utils.book_append_sheet(wb,XLSX.utils.aoa_to_sheet([header,...rows2]),'CustMonthly'); XLSX.writeFile(wb,'charts_export.xlsx');
  }

  /* ===== Wire UI ===== */
  document.querySelectorAll('.chipbtn').forEach(b=>b.onclick=()=>{document.querySelectorAll('.chipbtn').forEach(x=>x.classList.remove('active')); b.classList.add('active'); st.range=b.dataset.range; set({range:st.range}); render();});
  document.querySelectorAll('#metricToggle button').forEach(b=>b.onclick=()=>{document.querySelectorAll('#metricToggle button').forEach(x=>x.classList.remove('active')); b.classList.add('active'); st.metric=b.dataset.metric; set({metric:st.metric}); document.getElementById('metricBadge').textContent='表示: '+(st.metric==='count'?'件数':'数量'); render();});
  document.getElementById('btnLabels').onclick=()=>{st.labels=!st.labels; set({labels:st.labels}); document.getElementById('btnLabels').textContent=(st.labels?'✓ ':'✗ ')+'Labels'; render();};
  document.getElementById('btnRefresh').onclick=load;
  document.getElementById('btnLive').onclick=()=>{startAuto(st.interval<=5000?60000:5000); load();};
  document.addEventListener('visibilitychange',()=>{if(document.visibilityState==='visible') load()});
  const dd=document.getElementById('statusDropdown'); dd.querySelector('.drop-btn').onclick=()=>dd.classList.toggle('open'); document.getElementById('clearFilter').onclick=()=>{st.status=null; set({status:null}); render(); dd.classList.remove('open')};
  document.addEventListener('click',e=>{if(!dd.contains(e.target)) dd.classList.remove('open')});
  document.getElementById('custTypeBar').onclick=()=>{st.custType='bar'; set({custType:'bar'}); render()};
  document.getElementById('custTypeBarH').onclick=()=>{st.custType='barH'; set({custType:'barH'}); render()};
  document.getElementById('custTypePie').onclick=()=>{st.custType='pie'; set({custType:'pie'}); render()};
  document.getElementById('custTypePareto').onclick=()=>{st.custType='pareto'; set({custType:'pareto'}); render()};
  document.getElementById('custTop').onclick=()=>{st.custTop=st.custTop===10?20:10; set({custTop:st.custTop}); document.getElementById('custTop').textContent='Top'+st.custTop; render()};
  document.getElementById('custMonTop').onclick=()=>{st.custMonTop=st.custMonTop===6?10:6; set({custMonTop:st.custMonTop}); document.getElementById('custMonTop').textContent='Top'+st.custMonTop; render()};
  document.getElementById('dailyOrient').onclick=()=>{st.dailyOrient=st.dailyOrient==='v'?'h':'v'; set({dailyOrient:st.dailyOrient}); document.getElementById('dailyOrient').textContent=st.dailyOrient==='v'?'縦':'横'; render()};
  document.getElementById('monthlyOrient').onclick=()=>{st.monthlyOrient=st.monthlyOrient==='v'?'h':'v'; set({monthlyOrient:st.monthlyOrient}); document.getElementById('monthlyOrient').textContent=st.monthlyOrient==='v'?'縦':'横'; render()};
  document.getElementById('custMonOrient').onclick=()=>{st.custMonOrient=st.custMonOrient==='v'?'h':'v'; set({custMonOrient:st.custMonOrient}); document.getElementById('custMonOrient').textContent=st.custMonOrient==='v'?'縦':'横'; render()};
  document.getElementById('dailyExport').onclick=exportExcelCurrent;
  document.getElementById('monthlyExport').onclick=exportExcelCurrent;
  document.getElementById('custExport').onclick=exportPDF;
  document.getElementById('custMonExport').onclick=exportPDF;

  /* Boot */
  sync(); load(); startAuto(st.interval);
});
</script>
</body>
</html>
