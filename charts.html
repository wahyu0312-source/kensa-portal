<!doctype html>
<html lang="ja">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>チャート – 品質管理生産技術</title>
<style>
  :root{
    --bg:#f6f7fb; --panel:#fff; --ink:#0f172a; --muted:#64748b; --border:#e5e7eb; --ring:#c7d2fe;
    --accent:#2563eb; --danger:#dc2626; --success:#10b981; --warning:#f59e0b; --purple:#8b5cf6;
    --radius-xl:20px; --radius:12px; --shadow:0 15px 40px rgba(15,23,42,.08);
  }
  *{box-sizing:border-box}
  body{margin:0;font-family:system-ui,-apple-system,"Segoe UI",Roboto,"Noto Sans JP","Yu Gothic",sans-serif;background:var(--bg);color:var(--ink)}
  a{text-decoration:none;color:inherit}

  .app{display:grid;grid-template-rows:64px 1fr;grid-template-areas:"header" "main";min-height:100vh}
  header{grid-area:header;position:sticky;top:0;z-index:60;background:#ffffffc7;backdrop-filter:blur(12px);border-bottom:1px solid var(--border)}
  .header-wrap{height:64px;max-width:1400px;margin:0 auto;display:flex;align-items:center;justify-content:space-between;gap:10px;padding:0 14px}
  .brand{display:flex;align-items:center;gap:10px}
  .brand img{height:36px}
  .ttl{font-weight:800}
  .btn{display:inline-flex;align-items:center;gap:8px;height:34px;padding:0 12px;border-radius:10px;border:1px solid var(--border);background:#fff;cursor:pointer}
  .btn:hover{border-color:var(--ring)}
  .badge{height:28px;padding:0 10px;display:inline-flex;align-items:center;gap:8px;font-size:12px;font-weight:700;background:#f1f5f9;border:1px solid var(--border);border-radius:999px;color:#0f172a}
  .burger{display:none;align-items:center;justify-content:center;width:38px;height:38px;border:1px solid var(--border);border-radius:10px;background:#fff;cursor:pointer}
  .burger:active{transform:scale(.98)}

  main{grid-area:main;max-width:1400px;margin:0 auto;padding:22px 20px 96px}

  /* Ticker (text berjalan) */
  .ticker-wrap{overflow:hidden;border-bottom:1px solid var(--border);background:#fff}
  .ticker{display:inline-block;white-space:nowrap;animation:ticker 20s linear infinite;padding:8px 0}
  .ticker span{margin-right:40px;color:#475569}
  @keyframes ticker{0%{transform:translate3d(0,0,0)}100%{transform:translate3d(-100%,0,0)}}

  /* Hover sidebar */
  .edge-hotspot{position:fixed;left:0;top:64px;width:12px;height:calc(100vh - 64px);z-index:70}
  .hover-side{position:fixed;left:0;top:64px;height:calc(100vh - 64px);width:260px;padding:14px 12px;overflow:auto;background:var(--panel);border-right:1px solid var(--border);box-shadow:var(--shadow);transform:translateX(-100%);transition:transform .22s ease;z-index:71}
  .hover-side.open{transform:translateX(0)}
  .hover-side h3{margin:4px 8px 10px;font-size:12px;letter-spacing:.08em;color:#6b7280;text-transform:uppercase}
  .navlist{display:grid;gap:4px}
  .slink{display:flex;align-items:center;gap:10px;padding:10px 12px;border-radius:12px}
  .slink:hover{background:#f1f5ff}
  .ico{width:22px;text-align:center}

  /* Drawer mobile */
  .drawer{position:fixed;inset:0;z-index:80;display:none}
  .drawer.open{display:block}
  .drawer .backdrop{position:absolute;inset:0;background:#0006}
  .drawer .panel{position:absolute;top:0;left:0;height:100%;width:min(86%,320px);background:#fff;border-right:1px solid var(--border);box-shadow:0 30px 60px rgba(15,23,42,.10);padding:14px 12px;overflow:auto;transform:translateX(-100%);transition:transform .25s ease}
  .drawer.open .panel{transform:translateX(0)}
  .drawer .close{position:absolute;right:10px;top:10px;border:0;background:#f1f5f9;border:1px solid var(--border);border-radius:8px;padding:6px 10px;cursor:pointer}

  /* Urgent banner */
  .urgent-banner{margin:12px 0 6px;background:#fee2e2;border:1px solid #fecaca;color:#991b1b;padding:12px 14px;border-radius:12px;text-align:center;font-weight:800;animation:blink 1.8s linear infinite;display:none}
  @keyframes blink{0%,100%{opacity:1;}50%{opacity:.82}}

  /* Panels & grid */
  .panel{background:#fff;border:1px solid var(--border);border-radius:20px;box-shadow:var(--shadow);padding:14px}
  .panel + .panel{margin-top:18px}
  h2{margin:8px 0 12px}

  .grid{display:grid;grid-template-columns:1fr 1fr;gap:16px}
  @media (max-width:1000px){ .grid{grid-template-columns:1fr} }

  /* Filter bar */
  .filterbar{display:flex;gap:8px;align-items:center;flex-wrap:wrap;margin:8px 0 14px}
  .chipbtn{display:inline-flex;align-items:center;gap:8px;padding:8px 12px;border:1px solid var(--border);border-radius:999px;background:#f8fafc;cursor:pointer}
  .chipbtn.active{border-color:var(--accent);box-shadow:0 0 0 3px rgba(37,99,235,.15)}

  /* Metric toggle group */
  .toggle{display:inline-flex;border:1px solid var(--border);border-radius:999px;overflow:hidden;background:#fff}
  .toggle button{padding:8px 12px;border:0;background:transparent;cursor:pointer}
  .toggle button.active{background:#eef2ff;box-shadow:inset 0 0 0 2px #c7d2fe;font-weight:700}
</style>
<!-- Chart.js CDN -->
<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.3/dist/chart.umd.min.js"></script>
</head>
<body>
<div class="app">
  <!-- HEADER -->
  <header>
    <div class="header-wrap">
      <button id="btnBurger" class="burger" aria-label="メニュー">☰</button>
      <div class="brand">
        <img src="tsh.png" alt="TSH" onerror="this.style.display='none'">
        <div class="ttl"><strong>品質管理生産技術</strong></div>
      </div>
      <nav class="top-actions" style="display:flex;gap:8px;align-items:center;flex-wrap:wrap">
        <button id="btnRefresh" class="btn" type="button">⟳ Refresh</button>
        <button id="btnLive" class="btn" type="button" aria-pressed="false">● Live</button>
        <span id="intervalInfo" class="badge">60s</span>
        <span id="lastup" class="badge muted">—</span>
      </nav>
    </div>
    <!-- Ticker (text berjalan) -->
    <div class="ticker-wrap"><div id="ticker" class="ticker"></div></div>
  </header>

  <!-- MAIN -->
  <main>
    <div id="urgentBanner" class="urgent-banner"></div>

    <section class="panel">
      <div class="filterbar">
        <strong style="color:#475569">範囲:</strong>
        <button class="chipbtn active" data-range="all">🌐 All</button>
        <button class="chipbtn" data-range="14d">🗓️ 14日</button>
        <button class="chipbtn" data-range="30d">📅 30日</button>
        <button class="chipbtn" data-range="ytd">🗂️ 年内(YTD)</button>

        <span style="width:12px"></span>
        <strong style="color:#475569">メトリクス:</strong>
        <div class="toggle" id="metricToggle" role="tablist" aria-label="metric">
          <button type="button" role="tab" aria-selected="true" data-metric="qty" class="active">数量</button>
          <button type="button" role="tab" aria-selected="false" data-metric="count">件数</button>
        </div>
        <span id="metricBadge" class="badge">表示: 数量</span>
      </div>

      <div class="grid">
        <div class="panel"><h2 id="hDaily">出荷（⽇次・直近）</h2><div style="height:320px"><canvas id="dailyShip"></canvas></div></div>
        <div class="panel"><h2 id="hMonthly">出荷（⽉次・年内）</h2><div style="height:320px"><canvas id="monthlyQty"></canvas></div></div>
        <div class="panel"><h2 id="hCust">顧客別 出荷（Top 10）</h2><div style="height:360px"><canvas id="custQty"></canvas></div></div>
        <div class="panel"><h2 id="hDest">送り先別 出荷</h2><div style="height:360px"><canvas id="destQty"></canvas></div></div>
      </div>
    </section>
  </main>

  <!-- Hover Sidebar -->
  <div id="edgeHotspot" class="edge-hotspot" aria-hidden="true"></div>
  <aside id="hoverSide" class="hover-side" aria-label="Pages">
    <h3>Pages</h3>
    <div class="navlist">
      <a class="slink" href="./index.html"><span class="ico">🏠</span><strong>ホーム</strong><small style="color:#9ca3af;margin-left:6px">Dashboard</small></a>
      <a class="slink" href="./forms.html"><span class="ico">📄</span><strong>出荷検査成績書</strong></a>
      <a class="slink" href="./sagyoutejunsho.html"><span class="ico">📝</span><strong>作業手順書</strong></a>
      <a class="slink" href="./charts.html"><span class="ico">📈</span><strong>チャート</strong></a>
      <a class="slink" href="./quality.html"><span class="ico">🔎</span><strong>品質情報</strong></a>
      <a class="slink" href="./claim.html"><span class="ico">🧪</span><strong>Trial Page</strong></a>
    </div>
  </aside>

  <!-- Drawer mobile -->
  <div id="drawer" class="drawer" aria-hidden="true">
    <div class="backdrop" data-close></div>
    <aside class="panel">
      <button class="close" data-close>✕</button>
      <div class="navlist" style="margin-top:30px">
        <a class="slink" href="./index.html"><span class="ico">🏠</span><strong>ホーム</strong></a>
        <a class="slink" href="./forms.html"><span class="ico">📄</span><strong>出荷検査成績書</strong></a>
        <a class="slink" href="./sagyoutejunsho.html"><span class="ico">📝</span><strong>作業手順書</strong></a>
        <a class="slink" href="./charts.html"><span class="ico">📈</span><strong>チャート</strong></a>
        <a class="slink" href="./quality.html"><span class="ico">🔎</span><strong>品質情報</strong></a>
        <a class="slink" href="./claim.html"><span class="ico">🧪</span><strong>Trial Page</strong></a>
      </div>
    </aside>
  </div>
</div>

<script>
/* ===== Drawer & hover (konsisten dengan index) ===== */
const drawer = document.getElementById('drawer');
document.getElementById('btnBurger')?.addEventListener('click', ()=>{ drawer.classList.add('open'); drawer.setAttribute('aria-hidden','false');});
drawer?.addEventListener('click', e=>{ if(e.target.hasAttribute('data-close')){ drawer.classList.remove('open'); drawer.setAttribute('aria-hidden','true');}});

const hot=document.getElementById('edgeHotspot'); const fly=document.getElementById('hoverSide');
let hideTimer=null; const HIDE_DELAY=280;
function openFly(){clearTimeout(hideTimer); fly.classList.add('open')}
function scheduleClose(){clearTimeout(hideTimer); hideTimer=setTimeout(()=>fly.classList.remove('open'),HIDE_DELAY)}
hot?.addEventListener('mouseenter', openFly); hot?.addEventListener('mouseleave', scheduleClose);
fly?.addEventListener('mouseenter', ()=>clearTimeout(hideTimer)); fly?.addEventListener('mouseleave', scheduleClose);

/* ===== Data source (disamakan dengan index) ===== */
const SHEET_ID ="1lYl7oYk6atnm3KqC6VwufARX3ooRyJ2VmC_xYFb4-OE"; // same as index
const TAB_NAME ="最新情報"; // same as index
const CSV_URL = `https://docs.google.com/spreadsheets/d/${SHEET_ID}/gviz/tq?tqx=out:csv&sheet=${encodeURIComponent(TAB_NAME)}`;

/* ===== Utilities sama seperti index ===== */
const S = s => String(s ?? '').trim();
function parseCSV(t){
  const out=[], re=/\s*("(?:[^"]|"")*"|[^,]*)\s*(,|\n|$)/g; let row=[], m; t=t.replace(/\r\n?/g,"\n");
  for(let i=0;i<t.length;){ re.lastIndex=i; m=re.exec(t); if(!m) break;
    let cell=m[1]; if(cell.startsWith('"')) cell=cell.slice(1,-1).replace(/""/g,'"');
    row.push(cell); i=re.lastIndex; if(m[2]==="\n"||m[2]===""){ out.push(row); row=[]; }
  } return out.filter(r=>r.length && r.some(c=>S(c)!==""));
}
function indexByName(header){
  const map={}; header.forEach((h,i)=>map[S(h)]=i);
  const f = n => (n in map ? map[n] : null);
  const fRx = rx => { for(let i=0;i<header.length;i++){ if(rx.test(S(header[i]))) return i; } return null; };
  return {
    date: f('出荷日'), cust: f('顧客名'), draw: fRx(/図番|図面|Drawing/), machine: fRx(/機種/),
    qty: f('数量'), to: fRx(/送り先|送付先|納品先/), note: fRx(/注番|備考|注文/),
    status: fRx(/製品状況|製品状態|納品状況/), ts: f('製品状況更新日時'), user: f('更新者'),
    urgent: fRx(/Status|至急|ステータス/i)
  };
}
const valAt=(r,i)=> (i==null?'':(r[i]??''));
function parseJPDate(str){
  const s=S(str); if(!s) return null;
  const m=s.match(/^(\d{4})\D(\d{1,2})\D(\d{1,2})(?:\D(\d{1,2})\D(\d{1,2}))?/);
  if(m) return new Date(m[1],m[2]-1,m[3],m[4]||0,m[5]||0);
  const d=new Date(s); return isNaN(d)?null:d;
}
function fmtTS(d){ if(!d) return ''; const z=n=>String(n).padStart(2,'0'); return `${String(d.getFullYear()).slice(2)}/${z(d.getMonth()+1)}/${z(d.getDate())} ${z(d.getHours())}:${z(d.getMinutes())}` }
function fmtDate(d){ if(!d) return ''; const z=n=>String(n).padStart(2,'0'); return `${d.getFullYear()}-${z(d.getMonth()+1)}-${z(d.getDate())}` }
function sameYMD(a,b){return a&&b&&a.getFullYear()===b.getFullYear()&&a.getMonth()===b.getMonth()&&a.getDate()===b.getDate()}

/* ===== Status判定（index と揃える） ===== */
const STATUS_SHIPOK_RX = /出荷済/;

/* ===== State ===== */
let cache={header:[],rows:[],idx:null, shipRows:[]};
let timer=null,intervalMs=60000;
let rangeKey='all';
let metricKey='qty'; // 'qty' | 'count'

/* ===== UI ===== */
function setTicker(texts){ const t=document.getElementById('ticker'); t.innerHTML = texts.map(x=>`<span>${x}</span>`).join(''); }
function setUrgentBanner(count){ const ub=document.getElementById('urgentBanner'); if(count>0){ ub.style.display='block'; ub.textContent=`⚠ 至急案件が ${count} 件あります！早急に確認してください。`; } else { ub.style.display='none'; } }

/* ===== Charts ===== */
let dailyChart, monthlyChart, custChart, destChart;

function upsertChart(ctx, cfg, instRefName){
  if(window[instRefName]){ window[instRefName].data = cfg.data; window[instRefName].options = cfg.options; window[instRefName].update(); }
  else{ window[instRefName] = new Chart(ctx, cfg); }
}

function prepareData(rows, idx){
  // Filter 出荷済
  const ship = rows.filter(r=> STATUS_SHIPOK_RX.test(S(valAt(r,idx.status))));
  // Urgent count (optional)
  const urgentCount = idx.urgent!=null ? ship.filter(r=>['至急','urgent','緊急','1','true'].includes(S(valAt(r,idx.urgent)).toLowerCase())).length : 0;
  setUrgentBanner(urgentCount);

  // Ticker text (customer + date + qty)
  const tick = ship.slice(0,30).map(r=>{
    const d=parseJPDate(valAt(r,idx.date)); const cust=S(valAt(r,idx.cust)); const qty=S(valAt(r,idx.qty)); const draw=S(valAt(r,idx.draw));
    return `📦 ${fmtDate(d)||'—'} ｜ ${cust||'—'} ｜ ${draw||''} ×${qty||''}`;
  });
  setTicker(tick.length?tick:["データ読込中…"]);

  return ship;
}

function applyRange(ship, key){
  const now=new Date();
  if(key==='14d'){ const dt=new Date(now); dt.setDate(dt.getDate()-13); dt.setHours(0,0,0,0); return ship.filter(r=>{const d=parseJPDate(valAt(r,cache.idx.date)); return d && d>=dt;}); }
  if(key==='30d'){ const dt=new Date(now); dt.setDate(dt.getDate()-29); dt.setHours(0,0,0,0); return ship.filter(r=>{const d=parseJPDate(valAt(r,cache.idx.date)); return d && d>=dt;}); }
  if(key==='ytd'){ const dt=new Date(now.getFullYear(),0,1); return ship.filter(r=>{const d=parseJPDate(valAt(r,cache.idx.date)); return d && d>=dt;}); }
  return ship;
}

function metricValue(r, idx){
  if(metricKey==='count') return 1;
  // qty
  return (+S(valAt(r,idx.qty))||0);
}

function metricLabel(){
  return metricKey==='count' ? '件数' : '数量';
}

function renderCharts(){
  const {rows,idx}=cache;
  let ship = prepareData(rows, idx);
  ship = applyRange(ship, rangeKey);

  // Daily
  const mapDaily={}; ship.forEach(r=>{ const d=parseJPDate(valAt(r,idx.date)); if(!d) return; const k=fmtDate(d); mapDaily[k]=(mapDaily[k]||0)+ metricValue(r, idx); });
  const dailyLabels=Object.keys(mapDaily).sort();
  const dailyValues=dailyLabels.map(k=>mapDaily[k]);

  // Monthly
  const mapMonthly={}; ship.forEach(r=>{ const d=parseJPDate(valAt(r,idx.date)); if(!d) return; const k=`${d.getFullYear()}-${String(d.getMonth()+1).padStart(2,'0')}`; mapMonthly[k]=(mapMonthly[k]||0)+ metricValue(r, idx); });
  const monthlyLabels=Object.keys(mapMonthly).sort();
  const monthlyValues=monthlyLabels.map(k=>mapMonthly[k]);

  // Customer top 10
  const mapCust={}; ship.forEach(r=>{ const c=S(valAt(r,idx.cust))||'—'; mapCust[c]=(mapCust[c]||0)+ metricValue(r, idx); });
  const custEntries=Object.entries(mapCust).sort((a,b)=>b[1]-a[1]).slice(0,10);
  const custLabels=custEntries.map(x=>x[0]); const custValues=custEntries.map(x=>x[1]);

  // Destination
  const mapDest={}; ship.forEach(r=>{ const c=S(valAt(r,idx.to))||'—'; mapDest[c]=(mapDest[c]||0)+ metricValue(r, idx); });
  const destEntries=Object.entries(mapDest).sort((a,b)=>b[1]-a[1]).slice(0,12);
  const destLabels=destEntries.map(x=>x[0]); const destValues=destEntries.map(x=>x[1]);

  const commonOptions = { responsive:true, maintainAspectRatio:false, plugins:{
      legend:{display:false},
      tooltip:{mode:'index',intersect:false, callbacks:{ label:(ctx)=> `${metricLabel()}: ${ctx.parsed.y}` }},
    }, scales:{ x:{grid:{color:'#eef2ff'}}, y:{grid:{color:'#f1f5f9'}, ticks:{precision:0}} } };

  // Update headings with metric badge
  document.getElementById('hDaily').textContent = `出荷（⽇次・直近） – ${metricLabel()}`;
  document.getElementById('hMonthly').textContent = `出荷（⽉次・年内） – ${metricLabel()}`;
  document.getElementById('hCust').textContent = `顧客別 出荷（Top 10） – ${metricLabel()}`;
  document.getElementById('hDest').textContent = `送り先別 出荷 – ${metricLabel()}`;

  upsertChart(document.getElementById('dailyShip'), {
    type:'line',
    data:{ labels:dailyLabels, datasets:[{ label:metricLabel(), data:dailyValues, tension:.25, fill:true }] },
    options:{ ...commonOptions }
  }, 'dailyChart');

  upsertChart(document.getElementById('monthlyQty'), {
    type:'bar',
    data:{ labels:monthlyLabels, datasets:[{ label:metricLabel(), data:monthlyValues }] },
    options:{ ...commonOptions }
  }, 'monthlyChart');

  upsertChart(document.getElementById('custQty'), {
    type:'bar',
    data:{ labels:custLabels, datasets:[{ label:metricLabel(), data:custValues }] },
    options:{ ...commonOptions, indexAxis:'y' }
  }, 'custChart');

  upsertChart(document.getElementById('destQty'), {
    type:'bar',
    data:{ labels:destLabels, datasets:[{ label:metricLabel(), data:destValues }] },
    options:{ ...commonOptions, indexAxis:'y' }
  }, 'destChart');
}

/* ===== Fetch & live ===== */
async function load(){
  const btn=document.getElementById('btnRefresh'); const old=btn.textContent;
  try{
    btn.textContent='Loading…'; btn.disabled=true;
    const res=await fetch(CSV_URL+'&_ts='+Date.now(),{cache:'no-store'});
    const text=await res.text();
    const data=parseCSV(text);
    const header=data[0], rows=data.slice(1);
    const idx=indexByName(header);
    cache={header,rows,idx};
    renderCharts();
    document.getElementById('lastup').textContent='Last update: '+new Date().toLocaleString();
  }finally{
    btn.textContent=old; btn.disabled=false;
  }
}
function startAuto(ms){ intervalMs=ms; clearInterval(timer); timer=setInterval(()=>{ if(document.visibilityState==='visible') load(); }, intervalMs); document.getElementById('intervalInfo')?.textContent=Math.round(intervalMs/1000)+'s'; const b=document.getElementById('btnLive'); b.textContent=intervalMs<=5000?'● Live: On':'● Live: Off';}
document.getElementById('btnRefresh').addEventListener('click', load);
document.getElementById('btnLive').addEventListener('click', ()=>{ startAuto(intervalMs<=5000?60000:5000); load(); });
document.addEventListener('visibilitychange', ()=>{ if(document.visibilityState==='visible') load(); });

/* ===== Range chips ===== */
document.querySelectorAll('.chipbtn').forEach(b=>{
  b.addEventListener('click', ()=>{
    document.querySelectorAll('.chipbtn').forEach(x=>x.classList.remove('active'));
    b.classList.add('active');
    rangeKey = b.getAttribute('data-range');
    renderCharts();
  });
});

/* ===== Metric toggle ===== */
const metricToggle=document.getElementById('metricToggle');
metricToggle.querySelectorAll('button').forEach(btn=>{
  btn.addEventListener('click', ()=>{
    metricToggle.querySelectorAll('button').forEach(x=>x.classList.remove('active'));
    btn.classList.add('active');
    metricKey = btn.getAttribute('data-metric'); // 'qty' | 'count'
    document.getElementById('metricBadge').textContent = '表示: ' + (metricKey==='count' ? '件数' : '数量');
    renderCharts();
  });
});

/* boot */
load(); startAuto(60000);
</script>
</body>
</html>
