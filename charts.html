<!doctype html>
<html lang="ja">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>品質管理生産技術 – チャート</title>
<style>
  :root{
    --bg:#f6f7fb; --panel:#fff; --ink:#0f172a; --muted:#64748b; --border:#e5e7eb; --ring:#c7d2fe;
    --accent:#2563eb; --radius-xl:20px; --shadow:0 15px 40px rgba(15,23,42,.08);
  }
  *{box-sizing:border-box}
  body{margin:0;font-family:system-ui,-apple-system,"Segoe UI",Roboto,"Noto Sans JP","Yu Gothic",sans-serif;background:var(--bg);color:var(--ink)}
  a{text-decoration:none;color:inherit}

  .app{display:grid;grid-template-rows:64px 1fr;min-height:100vh}
  header{position:sticky;top:0;z-index:60;background:#ffffffc7;backdrop-filter:blur(12px);border-bottom:1px solid var(--border)}
  .header-wrap{height:64px;max-width:1400px;margin:0 auto;display:flex;align-items:center;justify-content:space-between;gap:10px;padding:0 14px}
  .brand{display:flex;align-items:center;gap:10px}
  .brand img{height:36px}
  .ttl{font-weight:800}
  .btn{display:inline-flex;align-items:center;gap:8px;height:34px;padding:0 12px;border-radius:10px;border:1px solid var(--border);background:#fff;cursor:pointer}
  .badge{height:28px;padding:0 10px;display:inline-flex;align-items:center;gap:8px;font-size:12px;font-weight:700;background:#f1f5f9;border:1px solid var(--border);border-radius:999px;color:#0f172a}
  .burger{display:none;align-items:center;justify-content:center;width:38px;height:38px;border:1px solid var(--border);border-radius:10px;background:#fff;cursor:pointer}
  main{max-width:1400px;margin:0 auto;padding:22px 20px 130px}

  /* Sidebar hover */
  .edge-hotspot{position:fixed;left:0;top:64px;width:12px;height:calc(100vh - 64px);z-index:70}
  .hover-side{position:fixed;left:0;top:64px;height:calc(100vh - 64px);width:260px;padding:14px 12px;overflow:auto;background:#fff;border-right:1px solid var(--border);box-shadow:var(--shadow);transform:translateX(-100%);transition:transform .22s ease;z-index:71}
  .hover-side.open{transform:translateX(0)}
  .navlist{display:grid;gap:4px}
  .slink{display:flex;align-items:center;gap:10px;padding:10px 12px;border-radius:12px}
  .slink:hover{background:#f1f5ff}

  /* Drawer */
  .drawer{position:fixed;inset:0;z-index:80;display:none}
  .drawer.open{display:block}
  .drawer .backdrop{position:absolute;inset:0;background:#0006}
  .drawer .panel{position:absolute;top:0;left:0;height:100%;width:min(86%,320px);background:#fff;border-right:1px solid var(--border);box-shadow:0 30px 60px rgba(15,23,42,.10);padding:14px 12px;overflow:auto;transform:translateX(-100%);transition:transform .25s ease}
  .drawer.open .panel{transform:translateX(0)}
  .drawer .close{position:absolute;right:10px;top:10px;border:0;background:#f1f5f9;border:1px solid var(--border);border-radius:8px;padding:6px 10px;cursor:pointer}

  /* Banner */
  .urgent-banner{margin:12px 0 6px;background:#fee2e2;border:1px solid #fecaca;color:#991b1b;padding:12px 14px;border-radius:12px;text-align:center;font-weight:800;display:none}

  /* Panel & grid */
  .panel{background:#fff;border:1px solid var(--border);border-radius:20px;box-shadow:var(--shadow);padding:14px}
  .grid{display:grid;grid-template-columns:1fr 1fr;gap:16px}
  @media (max-width:1000px){ .grid{grid-template-columns:1fr} }

  /* Filter bar */
  .filterbar{display:flex;gap:8px;align-items:center;flex-wrap:wrap;margin:8px 0 14px}
  .chipbtn{display:inline-flex;align-items:center;gap:8px;padding:8px 12px;border:1px solid var(--border);border-radius:999px;background:#f8fafc;cursor:pointer}
  .chipbtn.active{border-color:var(--accent);box-shadow:0 0 0 3px rgba(37,99,235,.15)}
  .toggle{display:inline-flex;border:1px solid var(--border);border-radius:999px;overflow:hidden;background:#fff}
  .toggle button{padding:8px 12px;border:0;background:transparent;cursor:pointer}
  .toggle button.active{background:#eef2ff;box-shadow:inset 0 0 0 2px #c7d2fe;font-weight:700}
  .badge.muted{opacity:.75}

  /* Canvas */
  .cwrap{height:320px}
  .cwrap.tall{height:380px}

  /* Dropdown status (header) */
  .dropdown{position:relative}
  .drop-btn{display:inline-flex;align-items:center;gap:8px;height:36px;padding:0 12px;border-radius:10px;border:1px solid var(--border);background:#fff;cursor:pointer}
  .drop-menu{position:absolute;top:42px;left:0;min-width:280px;background:#fff;border:1px solid var(--border);border-radius:12px;box-shadow:var(--shadow);padding:10px;display:none;z-index:200}
  .dropdown.open .drop-menu{display:block}
  .chips{display:flex;flex-wrap:wrap;gap:8px}

  /* Per-chart toolbar */
  .chartbar{display:flex;gap:8px;align-items:center;flex-wrap:wrap;margin:2px 0 10px}
  .chartbar .btn,.fab .btn{height:30px;padding:0 10px;border-radius:9px}

  /* Fake select (match button style) */
  .select{height:30px;border:1px solid var(--border);border-radius:9px;background:#fff;padding:0 8px}
  .hidden{display:none}

  /* Floating controls */
  .fab{position:fixed;right:16px;bottom:16px;z-index:120;display:grid;gap:8px;justify-items:end}
  .fab .card{background:#fff;border:1px solid var(--border);border-radius:14px;box-shadow:var(--shadow);padding:8px 10px;display:flex;align-items:center;gap:8px}
  .fab .hint{font-size:12px;color:#475569}

  @media (max-width:900px){
    .burger{display:inline-flex}
    .edge-hotspot,.hover-side{display:none}
  }
</style>

<script defer src="https://cdn.jsdelivr.net/npm/chart.js@4.4.3/dist/chart.umd.min.js"></script>
<script defer src="https://cdn.jsdelivr.net/npm/chartjs-plugin-datalabels@2.2.0/dist/chartjs-plugin-datalabels.min.js"></script>
<script defer src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
<script defer src="https://cdn.jsdelivr.net/npm/jspdf@2.5.1/dist/jspdf.umd.min.js"></script>
<script defer src="https://cdn.jsdelivr.net/npm/jspdf-autotable@3.8.2/dist/jspdf.plugin.autotable.min.js"></script>
</head>
<body>
<div class="app">
  <header>
    <div class="header-wrap">
      <button id="btnBurger" class="burger" aria-label="メニュー">☰</button>
      <div class="brand">
        <img src="tsh.png" alt="TSH" onerror="this.style.display='none'">
        <div class="ttl"><strong>品質管理生産技術</strong></div>
      </div>
      <nav class="top-actions" style="display:flex;gap:8px;align-items:center;flex-wrap:wrap">
        <div class="dropdown" id="statusDropdown">
          <button class="drop-btn" type="button">🔎 ステータス フィルター</button>
          <div class="drop-menu">
            <div class="chips" id="chipsBox"></div>
            <div style="margin-top:10px;text-align:right"><span class="clearlink" id="clearFilter" style="color:#2563eb;cursor:pointer">すべて表示</span></div>
          </div>
        </div>
      </nav>
    </div>
  </header>

  <main>
    <div id="urgentBanner" class="urgent-banner"></div>

    <section class="panel">
      <div class="filterbar">
        <strong style="color:#475569">範囲:</strong>
        <button class="chipbtn" data-range="all">🌐 All</button>
        <button class="chipbtn" data-range="14d">🗓️ 14日</button>
        <button class="chipbtn" data-range="30d">📅 30日</button>
        <button class="chipbtn" data-range="ytd">🗂️ 年内(YTD)</button>
        
        <span id="monthlyFilters" style="display:contents;"></span>
        
        <span style="width:12px"></span>
        <strong style="color:#475569">メトリクス:</strong>
        <div class="toggle" id="metricToggle" role="tablist" aria-label="metric">
          <button type="button" role="tab" data-metric="qty">数量</button>
          <button type="button" role="tab" data-metric="count">件数</button>
        </div>
        <span id="metricBadge" class="badge muted">表示: —</span>
      </div>

      <div class="grid">
        <div class="panel">
          <div class="chartbar">
            <strong>出荷（日次・直近）</strong>
            <button id="dailyOrient" class="btn" data-orient="v">縦</button>
            <button id="dailyExport" class="btn">Export</button>
          </div>
          <div class="cwrap"><canvas id="dailyShip"></canvas></div>
        </div>

        <div class="panel">
          <div class="chartbar">
            <strong>出荷（⽉次・年内）</strong>
            <button id="monthlyOrient" class="btn" data-orient="v">縦</button>
            <button id="monthlyExport" class="btn">Export</button>
          </div>
          <div class="cwrap"><canvas id="monthlyQty"></canvas></div>
        </div>

        <div class="panel">
          <div class="chartbar">
            <strong id="hCust">顧客別 出荷（Top 10）</strong>
            <button id="custTypeBar"  class="btn" data-type="bar">Bar</button>
            <button id="custTypeBarH" class="btn" data-type="barH">BarH</button>
            <button id="custTypePie"  class="btn" data-type="pie">Pie</button>
            <button id="custTypePareto" class="btn" data-type="pareto">Pareto</button>
            <button id="custTop" class="btn" data-top="10">Top10</button>
            <button id="custExport" class="btn">Export</button>
          </div>
          <div class="cwrap tall"><canvas id="custQty"></canvas></div>
        </div>

        <div class="panel">
          <div class="chartbar">
            <strong id="custMonTitle">顧客別 ⽉次 出荷（YTD）</strong>
            <button id="custMonMode" class="btn" data-mode="month">月</button>
            <button id="custMonTypeStacked" class="btn" data-type="stacked">Stacked</button>
            <button id="custMonTypePie" class="btn" data-type="pie">Pie</button>
            <button id="custMonTypePareto" class="btn" data-type="pareto">Pareto</button>
            <select id="custMonSelect" class="select hidden"></select>
            <button id="custMonTop" class="btn" data-top="6">Top6</button>
            <button id="custMonOrient" class="btn" data-orient="v">縦</button>
            <button id="custMonExport" class="btn">Export</button>
          </div>
          <div class="cwrap tall"><canvas id="custMonthly"></canvas></div>
        </div>
      </div>
    </section>
  </main>

  <div id="edgeHotspot" class="edge-hotspot" aria-hidden="true"></div>
  <aside id="hoverSide" class="hover-side" aria-label="Pages">
    <h3 style="margin:4px 8px 10px;font-size:12px;letter-spacing:.08em;color:#6b7280;text-transform:uppercase">Pages</h3>
    <div class="navlist">
      <a class="slink" href="./index.html"><span class="ico">🏠</span><strong>ホーム</strong><small style="color:#9ca3af;margin-left:6px">Dashboard</small></a>
      <a class="slink" href="./forms.html"><span class="ico">📄</span><strong>出荷検査成績書</strong></a>
      <a class="slink" href="./sagyoutejunsho.html"><span class="ico">📝</span><strong>作業手順書</strong></a>
      <a class="slink" href="./charts.html"><span class="ico">📈</span><strong>チャート</strong></a>
      <a class="slink" href="./quality.html"><span class="ico">🔎</span><strong>品質情報</strong></a>
      <a class="slink" href="./claim.html"><span class="ico">🧪</span><strong>Trial Page</strong></a>
    </div>
  </aside>

  <div id="drawer" class="drawer" aria-hidden="true">
    <div class="backdrop" data-close></div>
    <aside class="panel">
      <button class="close" data-close>✕</button>
      <div class="navlist" style="margin-top:30px">
        <a class="slink" href="./index.html"><span class="ico">🏠</span><strong>ホーム</strong></a>
        <a class="slink" href="./forms.html"><span class="ico">📄</span><strong>出荷検査成績書</strong></a>
        <a class="slink" href="./sagyoutejunsho.html"><span class="ico">📝</span><strong>作業手順書</strong></a>
        <a class="slink" href="./charts.html"><span class="ico">📈</span><strong>チャート</strong></a>
        <a class="slink" href="./quality.html"><span class="ico">🔎</span><strong>品質情報</strong></a>
        <a class="slink" href="./claim.html"><span class="ico">🧪</span><strong>Trial Page</strong></a>
      </div>
    </aside>
  </div>
</div>

<div class="fab" aria-live="polite">
  <div class="card">
    <button id="btnRefresh" class="btn" type="button">⟳ Refresh</button>
    <button id="btnLive" class="btn" type="button" aria-pressed="false">● Live</button>
    <button id="btnLabels" class="btn" type="button">123 Labels</button>
    <span id="intervalInfo" class="badge">—</span>
  </div>
  <div class="card hint"><span id="lastup">Last update: —</span></div>
</div>

<script>
document.addEventListener('DOMContentLoaded', function(){

  /* ====== Persist helpers ====== */
  const LSKEY='kensaCharts';
  const readLS=()=>{ try{return JSON.parse(localStorage.getItem(LSKEY)||'{}')}catch{return{}} };
  const writeLS=(p)=>localStorage.setItem(LSKEY, JSON.stringify(Object.assign(readLS(), p)));

  /* ====== Drawer & hover ====== */
  const drawer=document.getElementById('drawer');
  const btnBurger=document.getElementById('btnBurger');
  btnBurger && btnBurger.addEventListener('click', ()=>{drawer.classList.add('open');drawer.setAttribute('aria-hidden','false');});
  drawer && drawer.addEventListener('click', e=>{ if(e.target.hasAttribute('data-close')){ drawer.classList.remove('open'); drawer.setAttribute('aria-hidden','true'); }});
  const hot=document.getElementById('edgeHotspot'), fly=document.getElementById('hoverSide'); let hideTimer=null;
  function openFly(){clearTimeout(hideTimer); fly.classList.add('open')}
  function scheduleClose(){clearTimeout(hideTimer); hideTimer=setTimeout(()=>fly.classList.remove('open'), 280)}
  hot && hot.addEventListener('mouseenter', openFly); hot && hot.addEventListener('mouseleave', scheduleClose);
  fly && fly.addEventListener('mouseenter', ()=>clearTimeout(hideTimer)); fly && fly.addEventListener('mouseleave', scheduleClose);

  /* ====== Data source ====== */
  const SHEET_ID ="1lYl7oYk6atnm3KqC6VwufARX3ooRyJ2VmC_xYFb4-OE";
  const TAB_NAME ="最新情報";
  const CSV_URL = `https://docs.google.com/spreadsheets/d/${SHEET_ID}/gviz/tq?tqx=out:csv&sheet=${encodeURIComponent(TAB_NAME)}`;

  /* ====== Utils ====== */
  const S = s => String(s==null?'':s).trim();
  function parseCSV(t){
    const out=[], re=/\s*("(?:[^"]|"")*"|[^,]*)\s*(,|\n|$)/g; let row=[], m; t=t.replace(/\r\n?/g,"\n");
    for(let i=0;i<t.length;){ re.lastIndex=i; m=re.exec(t); if(!m) break;
      let cell=m[1]; if(cell.startsWith('"')) cell=cell.slice(1,-1).replace(/""/g,'"');
      row.push(cell); i=re.lastIndex; if(m[2]==="\n"||m[2]===""){ out.push(row); row=[]; }
    } return out.filter(r=>r.length && r.some(c=>S(c)!==""));
  }
  function indexByName(header){
    const map={}; header.forEach((h,i)=>map[S(h)]=i);
    const f = n => (n in map ? map[n] : null);
    const fRx = rx => { for(let i=0;i<header.length;i++){ if(rx.test(S(header[i]))) return i; } return null; };
    return {
      date: f('出荷日'), cust: f('顧客名'), draw: fRx(/図番|図面|Drawing/), machine: fRx(/機種/),
      qty: f('数量'), to: fRx(/送り先|送付先|納品先/), note: fRx(/注番|備考|注文/),
      status: fRx(/製品状況|製品状態|納品状況/), ts: f('製品状況更新日時'), user: f('更新者'),
      urgent: fRx(/Status|至急|ステータス/i)
    };
  }
  const valAt=(r,i)=> (i==null?'':(r[i]||''));
  function parseJPDate(str){
    const s=S(str); if(!s) return null;
    const m=s.match(/^(\d{4})\D(\d{1,2})\D(\d{1,2})(?:\D(\d{1,2})\D(\d{1,2}))?/);
    if(m) return new Date(m[1],m[2]-1,m[3],m[4]||0,m[5]||0);
    const d=new Date(s); return isNaN(d)?null:d;
  }
  function fmtDate(d){ if(!d) return ''; const z=n=>String(n).padStart(2,'0'); return `${d.getFullYear()}-${z(d.getMonth()+1)}-${z(d.getDate())}` }
  function fmtMonth(d){ const z=n=>String(n).padStart(2,'0'); return `${d.getFullYear()}-${z(d.getMonth()+1)}` }
  function fmtYear(d){ return String(d.getFullYear()); }

  // --- FUNGSI NORMALISASI NAMA PELANGGAN ---
  function normalizeCustomerName(name) {
    const s = S(name);
    if (s.includes('マザック')) return 'マザック';
    if (s.includes('オークマ')) return 'オークマ';
    // Tambahkan aturan lain di sini jika perlu
    return s;
  }

  /* ====== State ====== */
  const defaults = {
    range:'ytd', metric:'qty', labels:true, interval:60000, status:null,
    custType:'barH', custTop:10,
    custMonTop:6, custMonOrient:'v', custMonMode:'month', custMonType:'stacked',
    custMonPick:null, // 'YYYY-MM' | 'YYYY' | 'ALL'
    dailyOrient:'v', monthlyOrient:'v'
  };
  const state = Object.assign({}, defaults, readLS());
  let cache={header:[],rows:[],idx:null};
  let timer=null;

  /* ====== UI helpers ====== */
  // --- FUNGSI BARU UNTUK MEMBUAT TOMBOL BULAN ---
  function generateMonthFilters() {
    const container = document.getElementById('monthlyFilters');
    if (!container) return;
    
    for (let i = 0; i < 12; i++) {
      const btn = document.createElement('button');
      btn.className = 'chipbtn';
      btn.dataset.range = `month-${i}`; 
      btn.textContent = `${i + 1}月`;
      container.appendChild(btn);
    }
  }

  function syncUI(){
    document.querySelectorAll('.chipbtn').forEach(b=>{
      const r=b.getAttribute('data-range'); b.classList.toggle('active', r===state.range);
    });
    document.querySelectorAll('#metricToggle button').forEach(b=>{
      const m=b.getAttribute('data-metric'); b.classList.toggle('active', m===state.metric);
    });
    document.getElementById('metricBadge').textContent='表示: '+(state.metric==='count'?'件数':'数量');

    document.getElementById('btnLabels').textContent=(state.labels?'✓ ':'✗ ')+'Labels';
    document.getElementById('intervalInfo').textContent=Math.round(state.interval/1000)+'s';

    document.getElementById('custTop').textContent='Top'+state.custTop;

    document.getElementById('custMonTop').textContent='Top'+state.custMonTop;
    document.getElementById('custMonOrient').textContent = state.custMonOrient==='v'?'縦':'横';
    document.getElementById('custMonMode').textContent = state.custMonMode==='month'?'月':'年';
    document.getElementById('custMonTitle').textContent =
      state.custMonMode==='month' ? '顧客別 ⽉次 出荷（YTD）' : '顧客別 年次 出荷（累計）';

    document.getElementById('dailyOrient').textContent = state.dailyOrient==='v'?'縦':'横';
    document.getElementById('monthlyOrient').textContent = state.monthlyOrient==='v'?'縦':'横';

    const sel = document.getElementById('custMonSelect');
    sel.classList.toggle('hidden', state.custMonType==='stacked');
  }

  function fillPicker(ag){
    const sel=document.getElementById('custMonSelect');
    sel.innerHTML='';
    let opts=[];
    const type = state.custMonType;
    const mode = state.custMonMode;

    if(mode==='month'){ opts = ag.months; } else { opts = ag.years; }

    if(type!=='stacked'){
      const labelAll = mode==='month' ? '— 全期間（YTD）—' : '— 全期間（年）—';
      sel.appendChild(new Option(labelAll,'ALL'));
    }

    const placeholder = mode==='month' ? '月を選択' : '年を選択';
    sel.appendChild(new Option('— '+placeholder+' —',''));

    opts.forEach(v=> sel.appendChild(new Option(v, v)));

    if(!state.custMonPick) state.custMonPick = (type!=='stacked' ? 'ALL' : '');
    sel.value = state.custMonPick || '';
  }

  /* ====== Filtering / transforms ====== */
  function applyStatusFilter(rows, idx){
    if(!state.status) return rows;
    const rxMap = [/出荷済/,/出荷準備済/,/検査中/,/検査保留/,/組立中/,/組立完了/,/加工済/,/レーザ/,/板金/,/外注/];
    return rows.filter(r=> rxMap.some(()=>true)); // (chip visual only)
  }
  
  // --- FUNGSI applyRange YANG TELAH DIPERBARUI ---
  function applyRange(rows, idx){
    const now = new Date();
    
    if (state.range === '14d') {
      const dt = new Date(now); dt.setDate(dt.getDate() - 13); dt.setHours(0,0,0,0);
      return rows.filter(r => { const d = parseJPDate(valAt(r, idx.date)); return d && d >= dt; });
    }
    if (state.range === '30d') {
      const dt2 = new Date(now); dt2.setDate(dt2.getDate() - 29); dt2.setHours(0,0,0,0);
      return rows.filter(r => { const d = parseJPDate(valAt(r, idx.date)); return d && d >= dt2; });
    }
    if (state.range === 'ytd') {
      const dt3 = new Date(now.getFullYear(), 0, 1);
      return rows.filter(r => { const d = parseJPDate(valAt(r, idx.date)); return d && d >= dt3; });
    }
    
    if (state.range.startsWith('month-')) {
      const monthIndex = parseInt(state.range.split('-')[1], 10);
      const currentYear = now.getFullYear();
      return rows.filter(r => {
        const d = parseJPDate(valAt(r, idx.date));
        return d && d.getFullYear() === currentYear && d.getMonth() === monthIndex;
      });
    }
    
    return rows;
  }

  const metricValue = (r,idx)=> state.metric==='count' ? 1 : (+S(valAt(r,idx.qty))||0);
  const metricLabel = ()=> state.metric==='count' ? '件数' : '数量';

  /* ====== Chart instances ====== */
  let dailyChart, monthlyChart, custChart, custMonChart;

  /* ====== Build datasets ====== */
  function buildAggregations(rows, idx){
    const mapDaily={}, mapMonthly={}, mapYearly={};
    const mapCust={}, mapCustMonth={}, mapCustYear={};

    rows.forEach(r=>{
      const d=parseJPDate(valAt(r,idx.date)); if(!d) return;
      const v = metricValue(r, idx);
      const kDay = fmtDate(d);
      const kMon = fmtMonth(d);
      const kYear= fmtYear(d);
      const cust = normalizeCustomerName(valAt(r,idx.cust)) || '—';

      mapDaily[kDay]=(mapDaily[kDay]||0)+v;
      mapMonthly[kMon]=(mapMonthly[kMon]||0)+v;
      mapYearly[kYear]=(mapYearly[kYear]||0)+v;

      mapCust[cust]=(mapCust[cust]||0)+v;

      (mapCustMonth[kMon]||(mapCustMonth[kMon]={}))[cust]=(mapCustMonth[kMon][cust]||0)+v;
      (mapCustYear[kYear]||(mapCustYear[kYear]={}))[cust]=(mapCustYear[kYear][cust]||0)+v;
    });

    const dailyLabels=Object.keys(mapDaily).sort();
    const dailyValues=dailyLabels.map(k=>mapDaily[k]);

    const monthlyLabels=Object.keys(mapMonthly).sort();
    const monthlyValues=monthlyLabels.map(k=>mapMonthly[k]);

    const yearlyLabels=Object.keys(mapYearly).sort();
    const yearlyValues=yearlyLabels.map(k=>mapYearly[k]);

    const custEntries=Object.entries(mapCust).sort((a,b)=>b[1]-a[1]).slice(0,state.custTop);
    const custLabels=custEntries.map(x=>x[0]);
    const custValues=custEntries.map(x=>x[1]);

    const topCustN=(n)=>Object.entries(mapCust).sort((a,b)=>b[1]-a[1]).slice(0,n).map(x=>x[0]);

    const topM=topCustN(state.custMonTop);
    const months=monthlyLabels;
    const custMonthDatasets = topM.map(cn=>{
      const data = months.map(m=> (mapCustMonth[m]?.[cn]) || 0 );
      return { label: cn, data };
    });

    const topY=topCustN(state.custMonTop);
    const years=yearlyLabels;
    const custYearDatasets = topY.map(cn=>{
      const data = years.map(y=> (mapCustYear[y]?.[cn]) || 0 );
      return { label: cn, data };
    });

    const monthTotalsByCust = months.reduce((acc,m)=>{ acc[m] = {...(mapCustMonth[m]||{})}; return acc; },{});
    const yearTotalsByCust  = years.reduce((acc,y)=>{ acc[y] = {...(mapCustYear[y]||{})};  return acc; },{});

    const allMonth = {}; months.forEach(m=>{ for(const [k,v] of Object.entries(monthTotalsByCust[m]||{})){ allMonth[k]=(allMonth[k]||0)+v; }});
    const allYear  = {}; years.forEach(y=>{ for(const [k,v] of Object.entries(yearTotalsByCust[y]||{})){  allYear[k]=(allYear[k]||0)+v; }});
    monthTotalsByCust.ALL = allMonth;
    yearTotalsByCust.ALL  = allYear;
    
    // --- MEMBUAT DATA 12 BULAN UNTUK GRAFIK YTD ---
    const currentYear = new Date().getFullYear();
    const ytdMonthlyLabels = [];
    const ytdMonthlyValues = [];
    for (let i = 0; i < 12; i++) {
      ytdMonthlyLabels.push(`${i + 1}月`);
      const monthKey = `${currentYear}-${String(i + 1).padStart(2, '0')}`;
      ytdMonthlyValues.push(mapMonthly[monthKey] || 0);
    }

    return {
      dailyLabels, dailyValues,
      monthlyLabels, monthlyValues,
      yearlyLabels, yearlyValues,
      custLabels, custValues,
      months, custMonthDatasets, monthTotalsByCust,
      years, custYearDatasets,  yearTotalsByCust,
      ytdMonthlyLabels, ytdMonthlyValues // <-- Menambahkan data baru ke return
    };
  }

  /* ====== Common options ====== */
  function makeCommonOptions({horizontal=false, maxVal=null}={}){
    const headroom = maxVal? Math.ceil(maxVal*1.15) : undefined;
    const scales = horizontal
      ? { x:{ grid:{color:'#eef2ff'}, suggestedMax: headroom }, y:{ grid:{color:'#f1f5f9'} } }
      : { x:{ grid:{color:'#eef2ff'} }, y:{ grid:{color:'#f1f5f9'}, suggestedMax: headroom, ticks:{precision:0}} };
    return {
      responsive:true, maintainAspectRatio:false, layout:{padding:{right:30, top:10}},
      plugins:{
        legend:{display:false},
        datalabels:{
          display: state.labels, clip:false, clamp:true,
          anchor: horizontal?'end':'end',
          align:  horizontal?'end':'top',
          offset: 4,
          formatter:(v)=> (v==null||isNaN(v))?'':String(Math.round(v)),
          font:{weight:'700'}, padding:4
        },
        tooltip:{mode:'index',intersect:false, callbacks:{ label:(ctx)=> metricLabel()+': '+(ctx.parsed?.y ?? ctx.raw) }},
      },
      scales
    };
  }
  function upsertChart(ctx, cfg, refName){
    if(window[refName]){ window[refName].data=cfg.data; window[refName].options=cfg.options; window[refName].update(); }
    else{ window[refName]=new Chart(ctx, cfg); }
  }

  /* ====== Render ====== */
  function renderAll(){
    const idx=cache.idx;
    let rows = cache.rows.slice();

    const ub=document.getElementById('urgentBanner');
    const urgentCount = idx.urgent!=null ? rows.filter(r=> {
      const v=S(valAt(r,idx.urgent)).toLowerCase(); return v==='至急'||v==='urgent'||v==='緊急'||v==='1'||v==='true';
    }).length : 0;
    if(urgentCount>0){ ub.style.display='block'; ub.textContent=`⚠ 至急案件が ${urgentCount} 件あります！早急に確認してください。`; }
    else{ ub.style.display='none'; ub.textContent=''; }

    rows = applyRange(rows, idx);

    const ag = buildAggregations(rows, idx);
    Chart.register(ChartDataLabels);

    /* Daily */
    const dMax=Math.max(0,...ag.dailyValues);
    const dailyType = state.dailyOrient==='h'?'bar':'line';
    const dailyHorizontal = state.dailyOrient==='h';
    upsertChart(document.getElementById('dailyShip'), {
      type: dailyType,
      data:{ labels:ag.dailyLabels, datasets:[{ label:metricLabel(), data:ag.dailyValues, tension:.25, fill:!dailyHorizontal, pointRadius:3 }] },
      options: makeCommonOptions({horizontal: dailyHorizontal, maxVal:dMax})
    }, 'dailyChart');

    /* Monthly totals */
    // --- MENGGUNAKAN DATA 12 BULAN YANG BARU ---
    const mMax = Math.max(0, ...ag.ytdMonthlyValues);
    const monHorizontal = state.monthlyOrient === 'h';
    upsertChart(document.getElementById('monthlyQty'), {
      type: 'bar',
      data: { 
        labels: ag.ytdMonthlyLabels,
        datasets: [{ label: metricLabel(), data: ag.ytdMonthlyValues }]
      },
      options: Object.assign(makeCommonOptions({ horizontal: monHorizontal, maxVal: mMax }), monHorizontal ? { indexAxis: 'y' } : {})
    }, 'monthlyChart');

    /* Customer Top */
    const cMax=Math.max(0,...ag.custValues);
    let custConfig;
    if(state.custType==='pie'){
      custConfig = {
        type:'pie',
        data:{ labels:ag.custLabels, datasets:[{ label:metricLabel(), data:ag.custValues }] },
        options:{ responsive:true, maintainAspectRatio:false,
          plugins:{ legend:{position:'right'},
            datalabels:{ display: state.labels, formatter:(v,ctx)=>{ const sum=ctx.chart.data.datasets[0].data.reduce((a,b)=>a+b,0)||1; const p=Math.round(v/sum*100); return `${v} (${p}%)`; } } }
        }
      };
    } else if(state.custType==='pareto'){
      const total = ag.custValues.reduce((a,b)=>a+b,0)||1;
      const cum = []; ag.custValues.reduce((acc,v,i)=> (cum[i]=Math.round((acc+v)/total*100), acc+v),0);
      custConfig = {
        type:'bar',
        data:{ labels:ag.custLabels, datasets:[
          { label:metricLabel(), data:ag.custValues, yAxisID:'y' },
          { label:'累積(%)', data:cum, type:'line', yAxisID:'y1', tension:.25, pointRadius:3 }
        ]},
        options:{ responsive:true, maintainAspectRatio:false, layout:{padding:{right:30}},
          plugins:{ legend:{display:true}, datalabels:{ display: state.labels, anchor:'end', align:'top', formatter:(v,ctx)=> ctx.dataset.type==='line'? v+'%': v } },
          scales:{ x:{grid:{color:'#eef2ff'}}, y:{grid:{color:'#f1f5f9'}, beginAtZero:true}, y1:{position:'right', beginAtZero:true, max:100, grid:{drawOnChartArea:false}} }
        }
      };
    } else {
      const horiz = state.custType==='barH';
      custConfig = {
        type:'bar',
        data:{ labels:ag.custLabels, datasets:[{ label:metricLabel(), data:ag.custValues }] },
        options: Object.assign(makeCommonOptions({horizontal:horiz, maxVal:cMax}), horiz?{indexAxis:'y'}:{})
      };
    }
    upsertChart(document.getElementById('custQty'), custConfig, 'custChart');

    /* Picker (month/year list + ALL) */
    fillPicker(ag);

    /* Customer Monthly/Yearly (Stacked | Pie | Pareto) */
    const mode = state.custMonMode;
    const type = state.custMonType;
    const picker = document.getElementById('custMonSelect');
    picker.classList.toggle('hidden', type==='stacked');

    if(type==='stacked'){
      const labels = mode==='month' ? ag.months : ag.years;
      const datasets = (mode==='month' ? ag.custMonthDatasets : ag.custYearDatasets);
      const horiz = state.custMonOrient==='h';
      upsertChart(document.getElementById('custMonthly'), {
        type:'bar',
        data:{ labels, datasets },
        options:Object.assign({
          responsive:true, maintainAspectRatio:false,
          plugins:{ legend:{position:'bottom'}, datalabels:{ display:false } },
          scales: horiz
            ? { x:{ stacked:true, grid:{color:'#eef2ff'}}, y:{ stacked:true, grid:{color:'#f1f5f9'} } }
            : { x:{ stacked:true, grid:{color:'#eef2ff'}}, y:{ stacked:true, grid:{color:'#f1f5f9'}, ticks:{precision:0}} }
        }, horiz?{indexAxis:'y'}:{})
      }, 'custMonChart');
    } else {
      let labels=[], values=[], key = state.custMonPick;

      if(mode==='month'){
        if(!key) key = 'ALL';
        const map = ag.monthTotalsByCust[key] || {};
        const entries = Object.entries(map).sort((a,b)=>b[1]-a[1]).slice(0,state.custMonTop);
        labels=entries.map(e=>e[0]); values=entries.map(e=>e[1]);
      }else{
        if(!key) key = 'ALL';
        const map = ag.yearTotalsByCust[key] || {};
        const entries = Object.entries(map).sort((a,b)=>b[1]-a[1]).slice(0,state.custMonTop);
        labels=entries.map(e=>e[0]); values=entries.map(e=>e[1]);
      }
      if(state.custMonPick!==key){ state.custMonPick=key; writeLS({custMonPick:key}); picker.value=key; }

      if(type==='pie'){
        upsertChart(document.getElementById('custMonthly'), {
          type:'pie',
          data:{ labels, datasets:[{ label:metricLabel(), data:values }] },
          options:{ responsive:true, maintainAspectRatio:false, plugins:{
            legend:{position:'right'},
            datalabels:{ display: state.labels, formatter:(v,ctx)=>{ const sum=ctx.chart.data.datasets[0].data.reduce((a,b)=>a+b,0)||1; const p=Math.round(v/sum*100); return `${v} (${p}%)`; } }
          }}
        }, 'custMonChart');
      } else {
        const total = values.reduce((a,b)=>a+b,0)||1;
        const cum=[]; values.reduce((acc,v,i)=> (cum[i]=Math.round((acc+v)/total*100),acc+v),0);
        upsertChart(document.getElementById('custMonthly'), {
          type:'bar',
          data:{ labels, datasets:[
            { label:metricLabel(), data:values, yAxisID:'y' },
            { label:'累積(%)', data:cum, type:'line', yAxisID:'y1', tension:.25, pointRadius:3 }
          ]},
          options:{ responsive:true, maintainAspectRatio:false,
            plugins:{ legend:{display:true}, datalabels:{ display: state.labels, anchor:'end', align:'top', formatter:(v,ctx)=> ctx.dataset.type==='line'?v+'%':v } },
            scales:{ x:{grid:{color:'#eef2ff'}}, y:{grid:{color:'#f1f5f9'}, beginAtZero:true}, y1:{position:'right', beginAtZero:true, max:100, grid:{drawOnChartArea:false}} }
          }
        }, 'custMonChart');
      }
    }

    document.getElementById('lastup').textContent = 'Last update: '+new Date().toLocaleString();
  }

  /* ====== Export helpers ====== */
  function exportExcel(ag){
    const wb = XLSX.utils.book_new();
    XLSX.utils.book_append_sheet(wb, XLSX.utils.aoa_to_sheet([['日付', metricLabel()], ...ag.dailyLabels.map((d,i)=>[d, ag.dailyValues[i]])]), 'Daily');
    XLSX.utils.book_append_sheet(wb, XLSX.utils.aoa_to_sheet([['月', metricLabel()], ...ag.ytdMonthlyLabels.map((m,i)=>[m, ag.ytdMonthlyValues[i]])]), 'MonthlyYTD');
    XLSX.utils.book_append_sheet(wb, XLSX.utils.aoa_to_sheet([['年', metricLabel()], ...ag.yearlyLabels.map((y,i)=>[y, ag.yearlyValues[i]])]), 'Yearly');
    XLSX.utils.book_append_sheet(wb, XLSX.utils.aoa_to_sheet([['顧客', metricLabel()], ...ag.custLabels.map((c,i)=>[c, ag.custValues[i]])]), 'CustomersTop');
    const headerM=['月', ...ag.custMonthDatasets.map(d=>d.label)];
    const rowsM=ag.months.map((m,i)=> [m, ...ag.custMonthDatasets.map(ds=> ds.data[i]) ]);
    XLSX.utils.book_append_sheet(wb, XLSX.utils.aoa_to_sheet([headerM, ...rowsM]), 'CustMonthly');
    const headerY=['年', ...ag.custYearDatasets.map(d=>d.label)];
    const rowsY=ag.years.map((y,i)=> [y, ...ag.custYearDatasets.map(ds=> ds.data[i]) ]);
    XLSX.utils.book_append_sheet(wb, XLSX.utils.aoa_to_sheet([headerY, ...rowsY]), 'CustYearly');
    XLSX.writeFile(wb, 'charts_export.xlsx');
  }
  async function exportPDF(){
    const { jsPDF } = window.jspdf;
    const doc = new jsPDF('l','pt','a4');
    const charts = [dailyChart, monthlyChart, custChart, custMonChart].filter(Boolean);
    let y=40;
    for(const ch of charts){
      const img = ch.toBase64Image();
      const w=760, h=300;
      doc.addImage(img, 'PNG', 30, y, w, h);
      y += h+24;
      if(y>520){ doc.addPage(); y=40; }
    }
    doc.save('charts_export.pdf');
  }
  function exportAllExcelCurrent(){
    const ag = buildAggregations(applyRange(cache.rows, cache.idx), cache.idx);
    exportExcel(ag);
  }

  /* ====== Wire controls ====== */
  // --- MENGGUNAKAN EVENT DELEGATION UNTUK FILTER RANGE ---
  document.querySelector('.filterbar').addEventListener('click', (e) => {
    const btn = e.target.closest('.chipbtn[data-range]');
    if (!btn) return;
    
    document.querySelectorAll('.chipbtn[data-range]').forEach(x => x.classList.remove('active'));
    btn.classList.add('active');
    
    state.range = btn.getAttribute('data-range');
    writeLS({range:state.range});
    renderAll();
  });

  document.querySelectorAll('#metricToggle button').forEach(b=>{
    b.addEventListener('click', ()=>{
      document.querySelectorAll('#metricToggle button').forEach(x=>x.classList.remove('active'));
      b.classList.add('active');
      state.metric = b.getAttribute('data-metric');
      writeLS({metric:state.metric});
      document.getElementById('metricBadge').textContent='表示: '+(state.metric==='count'?'件数':'数量');
      renderAll();
    });
  });
  
  document.getElementById('btnLabels').addEventListener('click', ()=>{
    state.labels = !state.labels; writeLS({labels:state.labels});
    document.getElementById('btnLabels').textContent=(state.labels?'✓ ':'✗ ')+'Labels';
    renderAll();
  });
  document.getElementById('btnRefresh').addEventListener('click', load);
  document.getElementById('btnLive').addEventListener('click', ()=>{ startAuto(state.interval<=5000?60000:5000); load(); });
  document.addEventListener('visibilitychange', ()=>{ if(document.visibilityState==='visible') load(); });

  const dropdown=document.getElementById('statusDropdown');
  dropdown.querySelector('.drop-btn').addEventListener('click', ()=> dropdown.classList.toggle('open'));
  document.getElementById('clearFilter').addEventListener('click', ()=>{ state.status=null; writeLS({status:null}); renderAll(); dropdown.classList.remove('open'); });
  document.addEventListener('click', (e)=>{ if(!dropdown.contains(e.target)) dropdown.classList.remove('open'); });

  document.getElementById('custTypeBar').addEventListener('click', ()=>{ state.custType='bar'; writeLS({custType:'bar'}); renderAll(); });
  document.getElementById('custTypeBarH').addEventListener('click', ()=>{ state.custType='barH'; writeLS({custType:'barH'}); renderAll(); });
  document.getElementById('custTypePie').addEventListener('click', ()=>{ state.custType='pie'; writeLS({custType:'pie'}); renderAll(); });
  document.getElementById('custTypePareto').addEventListener('click', ()=>{ state.custType='pareto'; writeLS({custType:'pareto'}); renderAll(); });
  document.getElementById('custTop').addEventListener('click', ()=>{
    state.custTop = (state.custTop===10)?20:10; writeLS({custTop:state.custTop});
    document.getElementById('custTop').textContent='Top'+state.custTop;
    renderAll();
  });

  document.getElementById('custMonTop').addEventListener('click', ()=>{
    state.custMonTop = (state.custMonTop===6)?10:6; writeLS({custMonTop:state.custMonTop});
    document.getElementById('custMonTop').textContent='Top'+state.custMonTop;
    renderAll();
  });
  document.getElementById('custMonOrient').addEventListener('click', ()=>{
    state.custMonOrient = state.custMonOrient==='v'?'h':'v'; writeLS({custMonOrient:state.custMonOrient});
    document.getElementById('custMonOrient').textContent= state.custMonOrient==='v'?'縦':'横';
    renderAll();
  });
  document.getElementById('custMonMode').addEventListener('click', ()=>{
    state.custMonMode = state.custMonMode==='month'?'year':'month';
    state.custMonPick=null;
    writeLS({custMonMode:state.custMonMode,custMonPick:null});
    syncUI(); renderAll();
  });
  document.getElementById('custMonTypeStacked').addEventListener('click', ()=>{
    state.custMonType='stacked'; writeLS({custMonType:'stacked'}); syncUI(); renderAll();
  });
  document.getElementById('custMonTypePie').addEventListener('click', ()=>{
    state.custMonType='pie'; writeLS({custMonType:'pie'}); syncUI(); renderAll();
  });
  document.getElementById('custMonTypePareto').addEventListener('click', ()=>{
    state.custMonType='pareto'; writeLS({custMonType:'pareto'}); syncUI(); renderAll();
  });
  document.getElementById('custMonSelect').addEventListener('change', (e)=>{
    state.custMonPick = e.target.value || null; writeLS({custMonPick:state.custMonPick}); renderAll();
  });

  document.getElementById('dailyExport').addEventListener('click', exportAllExcelCurrent);
  document.getElementById('monthlyExport').addEventListener('click', exportAllExcelCurrent);
  document.getElementById('custExport').addEventListener('click', async ()=>{ await exportPDF(); });
  document.getElementById('custMonExport').addEventListener('click', async ()=>{ await exportPDF(); });

  /* ====== Boot ====== */
  function startAuto(ms){
    if(timer) clearInterval(timer);
    timer=setInterval(()=>{ if(document.visibilityState==='visible') load(); }, ms);
    state.interval=ms; writeLS({interval:ms});
    document.getElementById('intervalInfo').textContent=Math.round(ms/1000)+'s';
    document.getElementById('btnLive').textContent = (ms<=5000?'● Live: On':'● Live: Off');
  }
  async function load(){
    const btn=document.getElementById('btnRefresh'); const old=btn.textContent;
    try{
      btn.textContent='Loading…'; btn.disabled=true;
      const res=await fetch(CSV_URL+'&_ts='+Date.now(),{cache:'no-store'});
      const text=await res.text();
      const data=parseCSV(text);
      const header=data[0], rows=data.slice(1);
      const idx=indexByName(header);
      cache={header,rows,idx};
      syncUI(); renderAll();
    }finally{
      btn.textContent=old; btn.disabled=false;
    }
  }

  generateMonthFilters();
  syncUI();
  load();
  startAuto(state.interval);
});
</script>
</body>
</html>
