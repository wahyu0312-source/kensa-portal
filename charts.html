<!doctype html>
<html lang="ja">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>品質管理生産技術 – チャート</title>
<style>
  :root{
    --bg:#f6f7fb; --panel:#fff; --ink:#0f172a; --muted:#64748b; --border:#e5e7eb; --ring:#c7d2fe;
    --accent:#2563eb; --radius-xl:20px; --shadow:0 15px 40px rgba(15,23,42,.08);
  }
  *{box-sizing:border-box}
  body{margin:0;font-family:system-ui,-apple-system,"Segoe UI",Roboto,"Noto Sans JP","Yu Gothic",sans-serif;background:var(--bg);color:var(--ink)}
  a{text-decoration:none;color:inherit}

  .app{display:grid;grid-template-rows:64px 1fr;min-height:100vh}
  header{position:sticky;top:0;z-index:60;background:#ffffffc7;backdrop-filter:blur(12px);border-bottom:1px solid var(--border)}
  .header-wrap{height:64px;max-width:1400px;margin:0 auto;display:flex;align-items:center;justify-content:space-between;gap:10px;padding:0 14px}
  .brand{display:flex;align-items:center;gap:10px}
  .brand img{height:36px}
  .ttl{font-weight:800}
  .btn{display:inline-flex;align-items:center;gap:8px;height:34px;padding:0 12px;border-radius:10px;border:1px solid var(--border);background:#fff;cursor:pointer}
  .badge{height:28px;padding:0 10px;display:inline-flex;align-items:center;gap:8px;font-size:12px;font-weight:700;background:#f1f5f9;border:1px solid var(--border);border-radius:999px;color:#0f172a}
  .burger{display:none;align-items:center;justify-content:center;width:38px;height:38px;border:1px solid var(--border);border-radius:10px;background:#fff;cursor:pointer}
  main{max-width:1400px;margin:0 auto;padding:22px 20px 130px}

  /* Hover sidebar (kiri) */
  .edge-hotspot{position:fixed;left:0;top:64px;width:12px;height:calc(100vh - 64px);z-index:70}
  .hover-side{position:fixed;left:0;top:64px;height:calc(100vh - 64px);width:260px;padding:14px 12px;overflow:auto;background:#fff;border-right:1px solid var(--border);box-shadow:var(--shadow);transform:translateX(-100%);transition:transform .22s ease;z-index:71}
  .hover-side.open{transform:translateX(0)}
  .navlist{display:grid;gap:4px}
  .slink{display:flex;align-items:center;gap:10px;padding:10px 12px;border-radius:12px}
  .slink:hover{background:#f1f5ff}

  /* Drawer mobile */
  .drawer{position:fixed;inset:0;z-index:80;display:none}
  .drawer.open{display:block}
  .drawer .backdrop{position:absolute;inset:0;background:#0006}
  .drawer .panel{position:absolute;top:0;left:0;height:100%;width:min(86%,320px);background:#fff;border-right:1px solid var(--border);box-shadow:0 30px 60px rgba(15,23,42,.10);padding:14px 12px;overflow:auto;transform:translateX(-100%);transition:transform .25s ease}
  .drawer.open .panel{transform:translateX(0)}
  .drawer .close{position:absolute;right:10px;top:10px;border:0;background:#f1f5f9;border:1px solid var(--border);border-radius:8px;padding:6px 10px;cursor:pointer}

  /* Banner */
  .urgent-banner{margin:12px 0 6px;background:#fee2e2;border:1px solid #fecaca;color:#991b1b;padding:12px 14px;border-radius:12px;text-align:center;font-weight:800;display:none}
  .error-banner{margin:10px 0;padding:10px 12px;border-radius:12px;background:#fff7ed;border:1px solid #fed7aa;color:#9a3412;display:none}

  /* Panel & grid */
  .panel{background:#fff;border:1px solid var(--border);border-radius:20px;box-shadow:var(--shadow);padding:14px}
  .grid{display:grid;grid-template-columns:1fr 1fr;gap:16px}
  @media (max-width:1000px){ .grid{grid-template-columns:1fr} }

  /* Filter bar */
  .filterbar{display:flex;gap:8px;align-items:center;flex-wrap:wrap;margin:8px 0 14px}
  .chipbtn{display:inline-flex;align-items:center;gap:8px;padding:8px 12px;border:1px solid var(--border);border-radius:999px;background:#f8fafc;cursor:pointer}
  .chipbtn.active{border-color:var(--accent);box-shadow:0 0 0 3px rgba(37,99,235,.15)}
  .toggle{display:inline-flex;border:1px solid var(--border);border-radius:999px;overflow:hidden;background:#fff}
  .toggle button{padding:8px 12px;border:0;background:transparent;cursor:pointer}
  .toggle button.active{background:#eef2ff;box-shadow:inset 0 0 0 2px #c7d2fe;font-weight:700}
  .badge.muted{opacity:.75}

  /* Canvas area */
  .cwrap{height:320px;position:relative}
  .cwrap.tall{height:380px}
  .loading{position:absolute;inset:0;display:grid;place-items:center;color:#64748b;font-weight:700}

  /* Dropdown status */
  .dropdown{position:relative}
  .drop-btn{display:inline-flex;align-items:center;gap:8px;height:36px;padding:0 12px;border-radius:10px;border:1px solid var(--border);background:#fff;cursor:pointer}
  .drop-menu{position:absolute;top:42px;left:0;min-width:280px;background:#fff;border:1px solid var(--border);border-radius:12px;box-shadow:var(--shadow);padding:10px;display:none;z-index:200}
  .dropdown.open .drop-menu{display:block}
  .chips{display:flex;flex-wrap:wrap;gap:8px}

  /* Per-chart toolbar */
  .chartbar{display:flex;gap:8px;align-items:center;flex-wrap:wrap;margin:2px 0 10px}
  .chartbar .btn,.fab .btn{height:30px;padding:0 10px;border-radius:9px}
  .chartbar select{height:30px;border:1px solid var(--border);border-radius:9px;padding:0 8px;background:#fff}

  /* Floating controls */
  .fab{position:fixed;right:16px;bottom:16px;z-index:120;display:grid;gap:8px;justify-items:end}
  .fab .card{background:#fff;border:1px solid var(--border);border-radius:14px;box-shadow:var(--shadow);padding:8px 10px;display:flex;align-items:center;gap:8px}
  .fab .hint{font-size:12px;color:#475569}

  @media (max-width:900px){
    .burger{display:inline-flex}
    .edge-hotspot,.hover-side{display:none}
  }
</style>
</head>
<body>
<div class="app">
  <!-- HEADER -->
  <header>
    <div class="header-wrap">
      <button id="btnBurger" class="burger" aria-label="メニュー">☰</button>
      <div class="brand">
        <img src="tsh.png" alt="TSH" onerror="this.style.display='none'">
        <div class="ttl"><strong>品質管理生産技術</strong></div>
      </div>
      <nav class="top-actions" style="display:flex;gap:8px;align-items:center;flex-wrap:wrap">
        <div class="dropdown" id="statusDropdown">
          <button class="drop-btn" type="button">🔎 ステータス フィルター</button>
          <div class="drop-menu">
            <div class="chips" id="chipsBox"></div>
            <div style="margin-top:10px;text-align:right"><span class="clearlink" id="clearFilter" style="color:#2563eb;cursor:pointer">すべて表示</span></div>
          </div>
        </div>
      </nav>
    </div>
  </header>

  <!-- MAIN -->
  <main>
    <div id="urgentBanner" class="urgent-banner"></div>
    <div id="errorBanner" class="error-banner"></div>

    <section class="panel">
      <div class="filterbar">
        <strong style="color:#475569">範囲:</strong>
        <button class="chipbtn" data-range="all">🌐 All</button>
        <button class="chipbtn" data-range="14d">🗓️ 14日</button>
        <button class="chipbtn" data-range="30d">📅 30日</button>
        <button class="chipbtn" data-range="ytd">🗂️ 年内(YTD)</button>

        <span style="width:12px"></span>
        <strong style="color:#475569">メトリクス:</strong>
        <div class="toggle" id="metricToggle" role="tablist" aria-label="metric">
          <button type="button" role="tab" data-metric="qty">数量</button>
          <button type="button" role="tab" data-metric="count">件数</button>
        </div>
        <span id="metricBadge" class="badge muted">表示: —</span>
      </div>

      <div class="grid">
        <!-- Daily -->
        <div class="panel">
          <div class="chartbar">
            <strong>出荷（日次・直近）</strong>
            <button id="dailyOrient" class="btn" data-orient="v">縦</button>
            <button id="dailyExport" class="btn">Export</button>
          </div>
          <div class="cwrap"><div class="loading">Loading…</div><canvas id="dailyShip"></canvas></div>
        </div>

        <!-- Monthly overall -->
        <div class="panel">
          <div class="chartbar">
            <strong>出荷（⽉次・年内）</strong>
            <button id="monthlyOrient" class="btn" data-orient="v">縦</button>
            <button id="monthlyExport" class="btn">Export</button>
          </div>
          <div class="cwrap"><div class="loading">Loading…</div><canvas id="monthlyQty"></canvas></div>
        </div>

        <!-- Customer Top-N -->
        <div class="panel">
          <div class="chartbar">
            <strong id="hCust">顧客別 出荷（Top 10）</strong>
            <button id="custTypeBar"  class="btn" data-type="bar">Bar</button>
            <button id="custTypeBarH" class="btn" data-type="barH">BarH</button>
            <button id="custTypePie"  class="btn" data-type="pie">Pie</button>
            <button id="custTypePareto" class="btn" data-type="pareto">Pareto</button>
            <button id="custTop" class="btn" data-top="10">Top10</button>
            <button id="custExport" class="btn">Export</button>
          </div>
          <div class="cwrap tall"><div class="loading">Loading…</div><canvas id="custQty"></canvas></div>
        </div>

        <!-- Customer Monthly: Stacked / Pie / Pareto -->
        <div class="panel">
          <div class="chartbar">
            <strong>顧客別 ⽉次 出荷（YTD）</strong>
            <select id="custMonMonth"></select>
            <button id="custMonModeStack"  class="btn" data-mode="stacked">Stacked</button>
            <button id="custMonModePie"    class="btn" data-mode="pie">Pie</button>
            <button id="custMonModePareto" class="btn" data-mode="pareto">Pareto</button>
            <button id="custMonTop" class="btn" data-top="6">Top6</button>
            <button id="custMonOrient" class="btn" data-orient="v">縦</button>
            <button id="custMonExport" class="btn">Export</button>
          </div>
          <div class="cwrap tall"><div class="loading">Loading…</div><canvas id="custMonthly"></canvas></div>
        </div>
      </div>
    </section>
  </main>

  <!-- Sidebar hover kiri -->
  <div id="edgeHotspot" class="edge-hotspot" aria-hidden="true"></div>
  <aside id="hoverSide" class="hover-side" aria-label="Pages">
    <h3 style="margin:4px 8px 10px;font-size:12px;letter-spacing:.08em;color:#6b7280;text-transform:uppercase">Pages</h3>
    <div class="navlist">
      <a class="slink" href="./index.html"><span class="ico">🏠</span><strong>ホーム</strong><small style="color:#9ca3af;margin-left:6px">Dashboard</small></a>
      <a class="slink" href="./forms.html"><span class="ico">📄</span><strong>出荷検査成績書</strong></a>
      <a class="slink" href="./sagyoutejunsho.html"><span class="ico">📝</span><strong>作業手順書</strong></a>
      <a class="slink" href="./charts.html"><span class="ico">📈</span><strong>チャート</strong></a>
      <a class="slink" href="./quality.html"><span class="ico">🔎</span><strong>品質情報</strong></a>
      <a class="slink" href="./claim.html"><span class="ico">🧪</span><strong>Trial Page</strong></a>
    </div>
  </aside>

  <!-- Drawer mobile -->
  <div id="drawer" class="drawer" aria-hidden="true">
    <div class="backdrop" data-close></div>
    <aside class="panel">
      <button class="close" data-close>✕</button>
      <div class="navlist" style="margin-top:30px">
        <a class="slink" href="./index.html"><span class="ico">🏠</span><strong>ホーム</strong></a>
        <a class="slink" href="./forms.html"><span class="ico">📄</span><strong>出荷検査成績書</strong></a>
        <a class="slink" href="./sagyoutejunsho.html"><span class="ico">📝</span><strong>作業手順書</strong></a>
        <a class="slink" href="./charts.html"><span class="ico">📈</span><strong>チャート</strong></a>
        <a class="slink" href="./quality.html"><span class="ico">🔎</span><strong>品質情報</strong></a>
        <a class="slink" href="./claim.html"><span class="ico">🧪</span><strong>Trial Page</strong></a>
      </div>
    </aside>
  </div>
</div>

<!-- Libs (tanpa defer agar pasti siap) -->
<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.3/dist/chart.umd.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-datalabels@2.2.0/dist/chartjs-plugin-datalabels.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/jspdf@2.5.1/dist/jspdf.umd.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/jspdf-autotable@3.8.2/dist/jspdf.plugin.autotable.min.js"></script>

<script>
/* ========= Semua logic dijalankan setelah WINDOW LOAD supaya lib sudah siap ========= */
window.addEventListener('load', function(){

  /* ===== Persist ===== */
  const LSKEY='kensaCharts';
  const getLS=()=>{ try{return JSON.parse(localStorage.getItem(LSKEY)||'{}')}catch{return{}} };
  const setLS=(p)=>localStorage.setItem(LSKEY, JSON.stringify(Object.assign(getLS(), p)));

  /* ===== Drawer & hover ===== */
  const drawer=document.getElementById('drawer');
  const btnBurger=document.getElementById('btnBurger');
  btnBurger && btnBurger.addEventListener('click', ()=>{drawer.classList.add('open');drawer.setAttribute('aria-hidden','false');});
  drawer && drawer.addEventListener('click', e=>{ if(e.target.hasAttribute('data-close')){ drawer.classList.remove('open'); drawer.setAttribute('aria-hidden','true'); }});
  const hot=document.getElementById('edgeHotspot'), fly=document.getElementById('hoverSide'); let hideTimer=null;
  function openFly(){clearTimeout(hideTimer); fly.classList.add('open')}
  function scheduleClose(){clearTimeout(hideTimer); hideTimer=setTimeout(()=>fly.classList.remove('open'), 280)}
  hot && hot.addEventListener('mouseenter', openFly); hot && hot.addEventListener('mouseleave', scheduleClose);
  fly && fly.addEventListener('mouseenter', ()=>clearTimeout(hideTimer)); fly && fly.addEventListener('mouseleave', scheduleClose);

  /* ===== Data source =====
     NOTE: Pastikan ID & nama sheet ini sama dengan file kamu.
     Kalau tab di Sheet diganti, ubah konstanta TAB_NAME di sini. */
  const SHEET_ID ="1lYl7oYk6atnm3KqC6VwufARX3ooRyJ2VmC_xYFb4-OE";
  const TAB_NAME ="最新情報";
  const CSV_URL = `https://docs.google.com/spreadsheets/d/${SHEET_ID}/gviz/tq?tqx=out:csv&sheet=${encodeURIComponent(TAB_NAME)}`;

  /* ===== Utils ===== */
  const $ = sel => document.querySelector(sel);
  const S = s => String(s==null?'':s).trim();
  const showErr = (msg)=>{ const b=$('#errorBanner'); b.style.display='block'; b.textContent=msg; };
  function parseCSV(t){
    const out=[], re=/\s*("(?:[^"]|"")*"|[^,]*)\s*(,|\n|$)/g; let row=[], m; t=t.replace(/\r\n?/g,"\n");
    for(let i=0;i<t.length;){ re.lastIndex=i; m=re.exec(t); if(!m) break;
      let cell=m[1]; if(cell.startsWith('"')) cell=cell.slice(1,-1).replace(/""/g,'"');
      row.push(cell); i=re.lastIndex; if(m[2]==="\n"||m[2]===""){ out.push(row); row=[]; }
    } return out.filter(r=>r.length && r.some(c=>S(c)!==""));
  }
  function indexByName(header){
    const map={}; header.forEach((h,i)=>map[S(h)]=i);
    const f = n => (n in map ? map[n] : null);
    const fRx = rx => { for(let i=0;i<header.length;i++){ if(rx.test(S(header[i]))) return i; } return null; };
    return {
      date: f('出荷日'), cust: f('顧客名'), draw: fRx(/図番|図面|Drawing/), machine: fRx(/機種/),
      qty: f('数量'), to: fRx(/送り先|送付先|納品先/), note: fRx(/注番|備考|注文/),
      status: fRx(/製品状況|製品状態|納品状況/), ts: f('製品状況更新日時'), user: f('更新者'),
      urgent: fRx(/Status|至急|ステータス/i)
    };
  }
  const valAt=(r,i)=> (i==null?'':(r[i]||''));
  function parseJPDate(str){
    const s=S(str); if(!s) return null;
    const m=s.match(/^(\d{4})\D(\d{1,2})\D(\d{1,2})(?:\D(\d{1,2})\D(\d{1,2}))?/);
    if(m) return new Date(m[1],m[2]-1,m[3],m[4]||0,m[5]||0);
    const d=new Date(s); return isNaN(d)?null:d;
  }
  const z2=n=>String(n).padStart(2,'0');
  function fmtDate(d){ if(!d) return ''; return `${d.getFullYear()}-${z2(d.getMonth()+1)}-${z2(d.getDate())}` }
  function fmtMonth(d){ return `${d.getFullYear()}-${z2(d.getMonth()+1)}` }

  /* ===== Status ===== */
  const STATUS = [
    {key:'shipok',   label:'出荷済',     icon:'📦', cls:'shipok',  rx:/出荷済/},
    {key:'prep',     label:'出荷準備済', icon:'🚚', cls:'prep',    rx:/出荷準備済/},
    {key:'inspect',  label:'検査中',     icon:'🔬', cls:'inspect', rx:/検査中/},
    {key:'hold',     label:'検査保留',   icon:'⛔', cls:'hold',    rx:/検査保留/},
    {key:'assem',    label:'組立中',     icon:'🧰', cls:'assem',   rx:/組立中/},
    {key:'assemok',  label:'組立完了',   icon:'✅', cls:'assemok', rx:/組立完了/},
    {key:'proc',     label:'加工済',     icon:'🔧', cls:'proc',    rx:/加工済/},
    {key:'laser',    label:'レーザ加工', icon:'🪚', cls:'laser',   rx:/レーザ/},
    {key:'sheet',    label:'板金加工',   icon:'🔩', cls:'sheet',   rx:/板金/},
    {key:'out',      label:'外注',       icon:'🏭', cls:'out',     rx:/外注/},
  ];
  const isUrgent=v=>['至急','urgent','緊急','1','true'].includes(S(v).toLowerCase());

  /* ===== State (persist) ===== */
  const defaults = {
    range:'ytd', metric:'qty', labels:true, interval:60000, status:null,
    custType:'barH', custTop:10,
    dailyOrient:'v', monthlyOrient:'v',
    custMonMode:'stacked', custMonTop:6, custMonOrient:'v', custMonMonth:'ALL'
  };
  const state = Object.assign({}, defaults, getLS());
  let cache={header:[],rows:[],idx:null};
  let timer=null;

  /* ===== UI sync ===== */
  function syncUI(){
    document.querySelectorAll('.chipbtn').forEach(b=> b.classList.toggle('active', b.getAttribute('data-range')===state.range));
    document.querySelectorAll('#metricToggle button').forEach(b=> b.classList.toggle('active', b.getAttribute('data-metric')===state.metric));
    document.getElementById('metricBadge').textContent='表示: '+(state.metric==='count'?'件数':'数量');
    document.getElementById('btnLabels').textContent=(state.labels?'✓ ':'✗ ')+'Labels';
    document.getElementById('intervalInfo').textContent=Math.round(state.interval/1000)+'s';
    document.getElementById('custTop').textContent='Top'+state.custTop;
    document.getElementById('custMonTop').textContent='Top'+state.custMonTop;
    document.getElementById('dailyOrient').textContent  = state.dailyOrient==='v'?'縦':'横';
    document.getElementById('monthlyOrient').textContent= state.monthlyOrient==='v'?'縦':'横';
    document.getElementById('custMonOrient').textContent= state.custMonOrient==='v'?'縦':'横';
  }

  /* ===== Filters ===== */
  function applyStatusFilter(rows, idx){
    if(!state.status) return rows;
    const d = STATUS.find(s=>s.key===state.status);
    if(!d) return rows;
    return rows.filter(r=> d.rx.test(S(valAt(r,idx.status))));
  }
  function applyRange(rows, idx){
    const now=new Date();
    if(state.range==='14d'){ const dt=new Date(now); dt.setDate(dt.getDate()-13); dt.setHours(0,0,0,0); return rows.filter(r=>{ const d=parseJPDate(valAt(r,idx.date)); return d && d>=dt;}); }
    if(state.range==='30d'){ const dt2=new Date(now); dt2.setDate(dt2.getDate()-29); dt2.setHours(0,0,0,0); return rows.filter(r=>{ const d=parseJPDate(valAt(r,idx.date)); return d && d>=dt2;}); }
    if(state.range==='ytd'){ const dt3=new Date(now.getFullYear(),0,1); return rows.filter(r=>{ const d=parseJPDate(valAt(r,idx.date)); return d && d>=dt3;}); }
    return rows;
  }
  const metricValue=(r,idx)=> state.metric==='count' ? 1 : (+S(valAt(r,idx.qty))||0);
  const metricLabel=()=> state.metric==='count' ? '件数' : '数量';

  /* ===== Aggregations ===== */
  function buildAggregations(rows, idx){
    const mapDaily={}, mapMonthly={}, mapCust={}, mapCustMonth={};
    rows.forEach(r=>{
      const d=parseJPDate(valAt(r,idx.date)); if(!d) return;
      const v=metricValue(r,idx);
      const day=fmtDate(d), mon=fmtMonth(d), cust=S(valAt(r,idx.cust))||'—';
      mapDaily[day]=(mapDaily[day]||0)+v;
      mapMonthly[mon]=(mapMonthly[mon]||0)+v;
      mapCust[cust]=(mapCust[cust]||0)+v;
      (mapCustMonth[mon]||(mapCustMonth[mon]={}))[cust]=(mapCustMonth[mon][cust]||0)+v;
    });

    const dailyLabels=Object.keys(mapDaily).sort();
    const dailyValues=dailyLabels.map(k=>mapDaily[k]);
    const monthlyLabels=Object.keys(mapMonthly).sort();
    const monthlyValues=monthlyLabels.map(k=>mapMonthly[k]);
    const custEntries=Object.entries(mapCust).sort((a,b)=>b[1]-a[1]).slice(0,state.custTop);
    const custLabels=custEntries.map(x=>x[0]), custValues=custEntries.map(x=>x[1]);

    // YTD monthly customers
    const months=monthlyLabels;
    const ytdCustTotals = {};
    months.forEach(m=>{
      const o=mapCustMonth[m]||{};
      Object.keys(o).forEach(c=> ytdCustTotals[c]=(ytdCustTotals[c]||0)+o[c]);
    });
    const topForStack = Object.entries(ytdCustTotals).sort((a,b)=>b[1]-a[1]).slice(0,state.custMonTop).map(x=>x[0]);
    const custMonthDatasets = topForStack.map(cn=>({
      label:cn,
      data: months.map(m=> (mapCustMonth[m] && mapCustMonth[m][cn]) ? mapCustMonth[m][cn] : 0 )
    }));

    return { dailyLabels, dailyValues, monthlyLabels, monthlyValues, custLabels, custValues, months, mapCustMonth, ytdCustTotals, custMonthDatasets };
  }

  /* ===== Charts ===== */
  let dailyChart, monthlyChart, custChart, custMonChart;

  function makeCommonOptions({horizontal=false, maxVal=null}={}){
    const headroom = maxVal? Math.ceil(maxVal*1.15) : undefined;
    const scales = horizontal
      ? { x:{ grid:{color:'#eef2ff'}, suggestedMax: headroom }, y:{ grid:{color:'#f1f5f9'} } }
      : { x:{ grid:{color:'#eef2ff'} }, y:{ grid:{color:'#f1f5f9'}, suggestedMax: headroom, ticks:{precision:0}} };
    return {
      responsive:true, maintainAspectRatio:false, layout:{padding:{right:30, top:10}},
      plugins:{
        legend:{display:false},
        datalabels:{
          display: state.labels, clip:false, clamp:true,
          anchor: horizontal?'end':'end', align: horizontal?'end':'top', offset:4,
          formatter:v=> (v==null||isNaN(v))?'':String(Math.round(v)), font:{weight:'700'}
        },
        tooltip:{mode:'index',intersect:false, callbacks:{ label:ctx=> metricLabel()+': '+ctx.parsed.y }},
      },
      scales
    };
  }
  function upsertChart(ctx, cfg, ref){ if(window[ref]){ window[ref].data=cfg.data; window[ref].options=cfg.options; window[ref].update(); } else { window[ref]=new Chart(ctx, cfg); } }
  function clearLoading(){ document.querySelectorAll('.cwrap .loading').forEach(e=>e.remove()); }

  function renderChips(counts){
    const box=document.getElementById('chipsBox');
    const chip=(key,label,icon,cnt)=>`<button class="chipbtn ${state.status===key?'active':''}" data-key="${key}">${icon} ${label} <span class="count">${cnt}</span></button>`;
    let html=`<button class="chipbtn ${!state.status?'active':''}" data-key="">🌐 すべて <span class="count">${cache.rows.length}</span></button>`;
    STATUS.forEach(s=> html+=chip(s.key,s.label,s.icon, counts[s.key]||0));
    box.innerHTML=html;
    box.querySelectorAll('.chipbtn').forEach(b=>{
      b.addEventListener('click', ()=>{ state.status=b.getAttribute('data-key')||null; setLS({status:state.status}); renderAll(); dropdown.classList.remove('open'); });
    });
  }

  function buildMonthSelect(months){
    const sel=document.getElementById('custMonMonth');
    const cur=state.custMonMonth;
    sel.innerHTML = `<option value="ALL">All (YTD)</option>` + months.map(m=>`<option value="${m}">${m}</option>`).join('');
    sel.value = cur && (cur==='ALL' || months.includes(cur)) ? cur : 'ALL';
    sel.onchange = ()=>{ state.custMonMonth = sel.value; setLS({custMonMonth:state.custMonMonth}); renderAll(); };
  }

  function renderAll(){
    const idx=cache.idx;
    let rows = cache.rows.slice();

    // status counters + urgent
    const counts={}; STATUS.forEach(s=>counts[s.key]=0);
    rows.forEach(r=>{ const t=S(valAt(r,idx.status)); for(const s of STATUS){ if(s.rx.test(t)){ counts[s.key]++; break; } }});
    renderChips(counts);

    const urgentCount = idx.urgent!=null ? rows.filter(r=>isUrgent(valAt(r,idx.urgent))).length : 0;
    const ub=document.getElementById('urgentBanner');
    if(urgentCount>0){ ub.style.display='block'; ub.textContent=`⚠ 至急案件が ${urgentCount} 件あります！早急に確認してください。`; }
    else{ ub.style.display='none'; ub.textContent=''; }

    rows = applyStatusFilter(rows, idx);
    rows = applyRange(rows, idx);

    const ag = buildAggregations(rows, idx);
    Chart.register(ChartDataLabels);

    /* Daily */
    const dMax=Math.max(0,...ag.dailyValues);
    const dHoriz = state.dailyOrient==='h';
    upsertChart(document.getElementById('dailyShip'), {
      type: dHoriz?'bar':'line',
      data:{ labels:ag.dailyLabels, datasets:[{ label:metricLabel(), data:ag.dailyValues, tension:.25, fill:!dHoriz, pointRadius:3 }] },
      options: Object.assign(makeCommonOptions({horizontal:dHoriz, maxVal:dMax}), dHoriz?{indexAxis:'y'}:{})
    }, 'dailyChart');

    /* Monthly overall */
    const mMax=Math.max(0,...ag.monthlyValues);
    const mHoriz = state.monthlyOrient==='h';
    upsertChart(document.getElementById('monthlyQty'), {
      type:'bar',
      data:{ labels:ag.monthlyLabels, datasets:[{ label:metricLabel(), data:ag.monthlyValues }] },
      options: Object.assign(makeCommonOptions({horizontal:mHoriz, maxVal:mMax}), mHoriz?{indexAxis:'y'}:{})
    }, 'monthlyChart');

    /* Customer Top-N (bar/barH/pie/pareto) */
    const cMax=Math.max(0,...ag.custValues);
    let custCfg;
    if(state.custType==='pie'){
      custCfg={ type:'pie', data:{labels:ag.custLabels, datasets:[{data:ag.custValues}]},
        options:{responsive:true, maintainAspectRatio:false, plugins:{legend:{position:'right'},
          datalabels:{display:state.labels, formatter:(v,ctx)=>{const sum=ctx.chart.data.datasets[0].data.reduce((a,b)=>a+b,0)||1; const p=Math.round(v/sum*100); return `${v} (${p}%)`;}}}} };
    } else if(state.custType==='pareto'){
      const total=ag.custValues.reduce((a,b)=>a+b,0)||1;
      const cum=[]; ag.custValues.reduce((acc,v,i)=> (cum[i]=Math.round((acc+v)/total*100), acc+v),0);
      custCfg={ type:'bar', data:{labels:ag.custLabels, datasets:[
        {label:metricLabel(), data:ag.custValues, yAxisID:'y'},
        {label:'累積(%)', data:cum, type:'line', yAxisID:'y1', tension:.25, pointRadius:3 }
      ]}, options:{responsive:true, maintainAspectRatio:false, plugins:{legend:{display:true},
        datalabels:{display:state.labels, formatter:(v,ctx)=> ctx.dataset.type==='line'? v+'%': v}},
        scales:{ x:{grid:{color:'#eef2ff'}}, y:{beginAtZero:true, grid:{color:'#f1f5f9'}}, y1:{position:'right', beginAtZero:true, max:100, grid:{drawOnChartArea:false}} } };
    } else {
      const horiz = state.custType==='barH';
      custCfg={ type:'bar', data:{labels:ag.custLabels, datasets:[{data:ag.custValues, label:metricLabel()}]},
        options:Object.assign(makeCommonOptions({horizontal:horiz, maxVal:cMax}), horiz?{indexAxis:'y'}:{}) };
    }
    upsertChart(document.getElementById('custQty'), custCfg, 'custChart');

    /* Customer Monthly panel: stacked | pie | pareto  */
    buildMonthSelect(ag.months);
    let cmCfg;
    if(state.custMonMode==='stacked'){
      const horiz = state.custMonOrient==='h';
      cmCfg = { type:'bar', data:{ labels:ag.months, datasets: ag.custMonthDatasets },
        options:Object.assign({responsive:true, maintainAspectRatio:false,
          plugins:{legend:{position:'bottom'}, datalabels:{display:false}},
          scales: horiz
            ? { x:{ stacked:true, grid:{color:'#eef2ff'}}, y:{ stacked:true, grid:{color:'#f1f5f9'} } }
            : { x:{ stacked:true, grid:{color:'#eef2ff'}}, y:{ stacked:true, grid:{color:'#f1f5f9'}, ticks:{precision:0}} }
        }, horiz?{indexAxis:'y'}:{}) };
    } else {
      // Build dataset for selected month or YTD (ALL)
      let dict={};
      if(state.custMonMonth==='ALL'){
        dict = ag.ytdCustTotals;
      } else {
        dict = ag.mapCustMonth[state.custMonMonth] || {};
      }
      const entries = Object.entries(dict).sort((a,b)=>b[1]-a[1]).slice(0,state.custMonTop);
      const labels = entries.map(x=>x[0]), values = entries.map(x=>x[1]);

      if(state.custMonMode==='pie'){
        cmCfg = { type:'pie', data:{ labels, datasets:[{ data:values }] },
          options:{ responsive:true, maintainAspectRatio:false,
            plugins:{ legend:{position:'right'}, datalabels:{ display:state.labels, formatter:(v,ctx)=>{ const sum=ctx.chart.data.datasets[0].data.reduce((a,b)=>a+b,0)||1; const p=Math.round(v/sum*100); return `${v} (${p}%)`; } } }
          } };
      } else { // pareto
        const total = values.reduce((a,b)=>a+b,0)||1;
        const cum=[]; values.reduce((acc,v,i)=> (cum[i]=Math.round((acc+v)/total*100), acc+v),0);
        cmCfg = { type:'bar', data:{ labels, datasets:[
          { label:metricLabel(), data:values, yAxisID:'y' },
          { label:'累積(%)', data:cum, type:'line', yAxisID:'y1', tension:.25, pointRadius:3 }
        ]}, options:{ responsive:true, maintainAspectRatio:false,
          plugins:{ legend:{display:true}, datalabels:{ display:state.labels, formatter:(v,ctx)=> ctx.dataset.type==='line'? v+'%': v } },
          scales:{ x:{grid:{color:'#eef2ff'}}, y:{beginAtZero:true, grid:{color:'#f1f5f9'}}, y1:{position:'right', beginAtZero:true, max:100, grid:{drawOnChartArea:false}} }
        } };
      }
    }
    upsertChart(document.getElementById('custMonthly'), cmCfg, 'custMonChart');

    document.getElementById('lastup').textContent = 'Last update: '+new Date().toLocaleString();
    clearLoading();
  }

  /* ===== Fetch & live ===== */
  async function load(){
    const btn=document.getElementById('btnRefresh'); const old=btn.textContent;
    try{
      btn.textContent='Loading…'; btn.disabled=true;
      const res=await fetch(CSV_URL+'&_ts='+Date.now(),{cache:'no-store'});
      if(!res.ok){ throw new Error('HTTP '+res.status+' – periksa permission Sheet/tab name'); }
      const text=await res.text();
      const data=parseCSV(text);
      if(!data.length){ throw new Error('CSV kosong – pastikan tab "'+TAB_NAME+'" berisi data'); }
      const header=data[0], rows=data.slice(1);
      const idx=indexByName(header);
      if(idx.date==null || idx.qty==null){ throw new Error('Kolom wajib (出荷日/数量) tidak ditemukan. Cek header sheet.'); }
      cache={header,rows,idx};
      $('#errorBanner').style.display='none';
      renderAll();
    }catch(e){
      showErr('Gagal memuat data: '+e.message);
      console.error(e);
    }finally{
      btn.textContent=old; btn.disabled=false;
    }
  }
  function startAuto(ms){
    if(timer) clearInterval(timer);
    timer=setInterval(()=>{ if(document.visibilityState==='visible') load(); }, ms);
    state.interval=ms; setLS({interval:ms});
    document.getElementById('intervalInfo').textContent=Math.round(ms/1000)+'s';
    document.getElementById('btnLive').textContent=(ms<=5000?'● Live: On':'● Live: Off');
  }

  /* ===== Export ===== */
  function exportExcelCurrent(){
    const idx=cache.idx; const rows=applyRange(applyStatusFilter(cache.rows, idx), idx);
    const ag=buildAggregations(rows, idx);
    const wb = XLSX.utils.book_new();
    XLSX.utils.book_append_sheet(wb, XLSX.utils.aoa_to_sheet([['日付', metricLabel()], ...ag.dailyLabels.map((d,i)=>[d, ag.dailyValues[i]])]), 'Daily');
    XLSX.utils.book_append_sheet(wb, XLSX.utils.aoa_to_sheet([['月', metricLabel()], ...ag.monthlyLabels.map((m,i)=>[m, ag.monthlyValues[i]])]), 'Monthly');
    XLSX.utils.book_append_sheet(wb, XLSX.utils.aoa_to_sheet([['顧客', metricLabel()], ...ag.custLabels.map((c,i)=>[c, ag.custValues[i]])]), 'CustomersTop');
    const header=['月', ...ag.custMonthDatasets.map(d=>d.label)];
    const rows2=ag.months.map((m,i)=> [m, ...ag.custMonthDatasets.map(ds=> ds.data[i]) ]);
    XLSX.utils.book_append_sheet(wb, XLSX.utils.aoa_to_sheet([header, ...rows2]), 'CustMonthly');
    XLSX.writeFile(wb, 'charts_export.xlsx');
  }
  async function exportPDF(){
    const { jsPDF } = window.jspdf;
    const doc = new jsPDF('l','pt','a4');
    const charts = [dailyChart, monthlyChart, custChart, custMonChart].filter(Boolean);
    let y=40;
    for(const ch of charts){
      const img = ch.toBase64Image();
      const w=760, h=300;
      doc.addImage(img, 'PNG', 30, y, w, h);
      y += h+24;
      if(y>520){ doc.addPage(); y=40; }
    }
    doc.save('charts_export.pdf');
  }

  /* ===== Wire controls ===== */
  // Range
  document.querySelectorAll('.chipbtn').forEach(b=>{
    b.addEventListener('click', ()=>{ document.querySelectorAll('.chipbtn').forEach(x=>x.classList.remove('active')); b.classList.add('active');
      state.range=b.getAttribute('data-range'); setLS({range:state.range}); renderAll(); });
  });
  // Metric
  document.querySelectorAll('#metricToggle button').forEach(b=>{
    b.addEventListener('click', ()=>{ document.querySelectorAll('#metricToggle button').forEach(x=>x.classList.remove('active')); b.classList.add('active');
      state.metric=b.getAttribute('data-metric'); setLS({metric:state.metric});
      document.getElementById('metricBadge').textContent='表示: '+(state.metric==='count'?'件数':'数量'); renderAll(); });
  });
  // Labels (FAB)
  const btnLabels=document.createElement('div');
  document.getElementById('btnLabels').addEventListener('click', ()=>{ state.labels=!state.labels; setLS({labels:state.labels}); document.getElementById('btnLabels').textContent=(state.labels?'✓ ':'✗ ')+'Labels'; renderAll(); });
  // Refresh / Live
  document.getElementById('btnRefresh').addEventListener('click', load);
  document.getElementById('btnLive').addEventListener('click', ()=>{ startAuto(state.interval<=5000?60000:5000); load(); });
  document.addEventListener('visibilitychange', ()=>{ if(document.visibilityState==='visible') load(); });
  // Status dropdown
  const dropdown=document.getElementById('statusDropdown');
  dropdown.querySelector('.drop-btn').addEventListener('click', ()=> dropdown.classList.toggle('open'));
  document.getElementById('clearFilter').addEventListener('click', ()=>{ state.status=null; setLS({status:null}); renderAll(); dropdown.classList.remove('open'); });
  document.addEventListener('click', (e)=>{ if(!dropdown.contains(e.target)) dropdown.classList.remove('open'); });

  // Top customers panel
  document.getElementById('custTypeBar').addEventListener('click', ()=>{ state.custType='bar'; setLS({custType:'bar'}); renderAll(); });
  document.getElementById('custTypeBarH').addEventListener('click', ()=>{ state.custType='barH'; setLS({custType:'barH'}); renderAll(); });
  document.getElementById('custTypePie').addEventListener('click', ()=>{ state.custType='pie'; setLS({custType:'pie'}); renderAll(); });
  document.getElementById('custTypePareto').addEventListener('click', ()=>{ state.custType='pareto'; setLS({custType:'pareto'}); renderAll(); });
  document.getElementById('custTop').addEventListener('click', ()=>{ state.custTop = (state.custTop===10?20:10); setLS({custTop:state.custTop}); document.getElementById('custTop').textContent='Top'+state.custTop; renderAll(); });

  // Customer Monthly panel
  document.getElementById('custMonModeStack').addEventListener('click', ()=>{ state.custMonMode='stacked'; setLS({custMonMode:'stacked'}); renderAll(); });
  document.getElementById('custMonModePie').addEventListener('click',   ()=>{ state.custMonMode='pie'; setLS({custMonMode:'pie'}); renderAll(); });
  document.getElementById('custMonModePareto').addEventListener('click',()=>{ state.custMonMode='pareto'; setLS({custMonMode:'pareto'}); renderAll(); });
  document.getElementById('custMonTop').addEventListener('click', ()=>{ state.custMonTop=(state.custMonTop===6?10:6); setLS({custMonTop:state.custMonTop}); document.getElementById('custMonTop').textContent='Top'+state.custMonTop; renderAll(); });
  document.getElementById('custMonOrient').addEventListener('click', ()=>{ state.custMonOrient=state.custMonOrient==='v'?'h':'v'; setLS({custMonOrient:state.custMonOrient}); document.getElementById('custMonOrient').textContent=state.custMonOrient==='v'?'縦':'横'; renderAll(); });

  // Exports
  document.getElementById('dailyExport').addEventListener('click', exportExcelCurrent);
  document.getElementById('monthlyExport').addEventListener('click', exportExcelCurrent);
  document.getElementById('custExport').addEventListener('click', exportPDF);
  document.getElementById('custMonExport').addEventListener('click', exportPDF);

  /* Boot */
  syncUI();
  load();
  startAuto(state.interval);
});
</script>
</body>
</html>
