<!doctype html> 
<html lang="ja" data-theme="light">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>出荷検査（グラフ）</title>
<style>
  :root{
    --bg1:#eef2ff; --bg2:#f8fafc;
    --card:#fff; --ink:#0f172a; --muted:#64748b; --border:#e5e7eb;
    --accent:#2563eb; --shadow:0 30px 60px rgba(15,23,42,.08); --radius:20px;
    --grid:#e5e7eb;
  }
  [data-theme="dark"]{
    --bg1:#0b1220; --bg2:#0b1220;
    --card:#0f172a; --ink:#e5e7eb; --muted:#94a3b8; --border:#1f2937;
    --accent:#60a5fa; --shadow:none; --grid:#223044;
  }

  *{box-sizing:border-box}
  html,body{height:100%}
  body{
    margin:0;color:var(--ink);
    font-family:system-ui,-apple-system,Segoe UI,Roboto,"Noto Sans JP","Yu Gothic",sans-serif;
    background:
      radial-gradient(1200px 600px at -10% -10%, #c7d2fe33 0%, transparent 60%),
      radial-gradient(900px 500px at 110% 0%, #bae6fd33 0%, transparent 55%),
      linear-gradient(120deg,var(--bg1),var(--bg2));
    padding-bottom:64px;
  }

  /* Header */
  header{position:sticky;top:0;z-index:10;background:#ffffffcc;backdrop-filter:blur(10px);border-bottom:1px solid var(--border)}
  [data-theme="dark"] header{background:#0f172acc}
  .wrap{max-width:1200px;margin:0 auto;padding:12px 20px}
  .row{display:flex;justify-content:space-between;align-items:center;gap:16px}
  nav a{margin-left:18px;color:var(--accent);font-weight:700;text-decoration:none}
  nav a:hover{text-decoration:underline}
  .controls{display:flex;gap:8px;align-items:center}
  .btn{padding:8px 12px;border:1px solid var(--border);border-radius:10px;background:var(--card);color:var(--ink);cursor:pointer}
  .btn[disabled]{opacity:.6;cursor:not-allowed}
  .btn.active{border-color:#93c5fd;background:#f0f9ff}
  [data-theme="dark"] .btn.active{background:#0b3b6f66}
  .small{font-size:12px;color:var(--muted)}

  /* Main & cards */
  main{max-width:1200px;margin:26px auto;padding:0 20px}
  .card{background:var(--card);border:1px solid var(--border);border-radius:var(--radius);box-shadow:var(--shadow);padding:18px}
  .card-title{display:flex;align-items:center;justify-content:space-between;gap:16px;margin:0 0 10px}
  .title-nowrap{white-space:nowrap}
  @media (max-width:640px){ .title-nowrap{white-space:normal} }

  .filterbar{display:flex;gap:8px;align-items:center;flex-wrap:wrap}
  select.btn{appearance:none;padding-right:26px;background-image:
    linear-gradient(45deg,transparent 50%,#64748b 50%),
    linear-gradient(135deg,#64748b 50%,transparent 50%);
    background-position:calc(100% - 18px) calc(1em - 2px),calc(100% - 13px) calc(1em - 2px);
    background-size:5px 5px;background-repeat:no-repeat
  }

  .toolbar{display:flex;gap:8px;align-items:center;flex-wrap:wrap}
  .toolbar .spacer{flex:1 1 auto}

  /* Charts grid */
  .chart-grid{display:grid;grid-template-columns:1fr 1fr;gap:16px}
  .chart-box{background:var(--card);border:1px solid var(--border);border-radius:16px;padding:12px;min-height:380px;display:flex;align-items:center;justify-content:center}
  .chart-box.wide{grid-column:1/-1}
  .chart-box canvas{width:100%!important;height:330px!important}
  @media (max-width:900px){.chart-grid{grid-template-columns:1fr}}
  @media (max-width:768px){.row{flex-direction:column;align-items:flex-start}}

  /* Info & footer */
  .marquee{position:fixed;left:0;right:0;bottom:20px;background:var(--accent);color:#fff;font-weight:bold;padding:6px 0;white-space:nowrap;overflow:hidden;z-index:20}
  .marquee span{display:inline-block;padding-left:100%;animation:marquee 25s linear infinite}
  @keyframes marquee{0%{transform:translateX(0)}100%{transform:translateX(-100%)}}
  .footer{position:fixed;bottom:0;left:0;right:0;text-align:center;font-size:12px;color:var(--muted);background:#f1f5f9;padding:4px 0;z-index:21}
  [data-theme="dark"] .footer{background:#0b1220}

  /* Loading overlay */
  #loading{
    position:fixed;inset:64px 0 64px 0;display:none;place-items:center;pointer-events:none;
    background:linear-gradient(0deg,transparent,transparent 60%,#00000005 60%,#00000005 100%);
  }
  #loading .pulse{
    width:120px;height:8px;border-radius:999px;background:var(--border);
    overflow:hidden;position:relative
  }
  #loading .pulse::after{
    content:"";position:absolute;inset:0;background:var(--accent);transform:translateX(-100%);
    animation:pulse 1.3s infinite
  }
  @keyframes pulse{50%{transform:translateX(0)} 100%{transform:translateX(100%)}}
</style>
</head>
<body>
<header>
  <div class="wrap row">
    <div style="display:flex;align-items:center;gap:10px">
      <img src="tsh.png" alt="TSH" style="height:36px">
      <strong>品質管理生産技術</strong>
    </div>
    <nav>
      <a href="./index.html">ホーム</a>
      <a href="./forms.html">出荷検査成績書</a>
      <a href="./sagyoutejunsho.html">出荷検査作業手順書</a>
      <a href="./charts.html"><strong>出荷検査（グラフ）</strong></a>
    </nav>
    <div class="controls">
      <button id="btnRefresh" class="btn" type="button">Refresh now</button>
      <button id="btnLive" class="btn" type="button">Live: Off</button>
      <label class="small" style="display:flex;align-items:center;gap:6px">
        <input id="chkDark" type="checkbox"> Dark
      </label>
      <span id="intervalInfo" class="small">Interval: 60s</span>
    </div>
  </div>
</header>

<main>
  <section class="card" style="margin-bottom:16px">
    <div class="card-title">
      <h2 class="title-nowrap" style="margin:0">出荷検査 — グラフ</h2>
      <div class="toolbar">
        <div class="spacer"></div>
        <button class="btn" id="btnExcelCharts">Export Excel</button>
        <button class="btn" id="btnPDF">Export PDF</button>
      </div>
    </div>

    <div class="filterbar" aria-label="フィルター">
      <label class="small">Top 顧客:</label>
      <select id="selTop" class="btn">
        <option value="5">5</option>
        <option value="10" selected>10</option>
        <option value="15">15</option>
        <option value="30">30</option>
      </select>

      <label class="small">対象 年:</label>
      <select id="selYear" class="btn"></select>

      <label class="small">Quarter:</label>
      <select id="selQuarter" class="btn">
        <option value="ALL" selected>All</option>
        <option value="Q1">Q1</option>
        <option value="Q2">Q2</option>
        <option value="Q3">Q3</option>
        <option value="Q4">Q4</option>
      </select>

      <label class="small">月:</label>
      <select id="selMonth" class="btn" title="Quarter dipilih → opsi bulan nonaktif">
        <option value="ALL" selected>All</option>
        <option value="01">1</option><option value="02">2</option><option value="03">3</option>
        <option value="04">4</option><option value="05">5</option><option value="06">6</option>
        <option value="07">7</option><option value="08">8</option><option value="09">9</option>
        <option value="10">10</option><option value="11">11</option><option value="12">12</option>
      </select>

      <label class="small">顧客:</label>
      <select id="selCust" class="btn"></select>

      <label class="small" style="display:flex;align-items:center;gap:6px">
        <input id="chkPareto" type="checkbox"> Pareto
      </label>

      <!-- NEW: rotate controls -->
      <label class="small" style="display:flex;align-items:center;gap:6px">
        <input id="chkRotateAuto" type="checkbox" checked> Auto-rotate
      </label>
      <label class="small" style="display:flex;align-items:center;gap:6px">
        <input id="chkRotate" type="checkbox"> Rotate −90°
      </label>

      <button class="btn" id="btnReset" type="button" title="Reset ke default">Reset</button>
    </div>

    <div class="small" id="chartNote" style="margin-top:6px">顧客別（年／月／Quarter）・月別（顧客）の数量合計）</div>
  </section>

  <section class="card" id="chartsSection" aria-label="チャート">
    <div class="chart-grid">
      <div class="chart-box"><canvas id="chartTopCust" aria-label="出荷検査 顧客別（期間｜済）"></canvas></div>
      <div class="chart-box"><canvas id="chartByMonth" aria-label="出荷検査 月別（済）"></canvas></div>
      <div class="chart-box wide"><canvas id="chartTopCustYear" aria-label="出荷検査 顧客別（年｜済）"></canvas></div>
    </div>
  </section>
</main>

<div id="loading"><div class="pulse" aria-hidden="true"></div></div>
<div class="marquee"><span>出荷検査（グラフ） - 最新データで自動更新</span></div>
<div class="footer">Design by Wahyu</div>

<!-- Libraries -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-datalabels@2"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>

<script>
  // ===== Config & helpers =====
  const SHEET_ID ="1lYl7oYk6atnm3KqC6VwufARX3ooRyJ2VmC_xYFb4-OE";
  const TAB_NAME ="最新情報";
  const CSV_URL  =`https://docs.google.com/spreadsheets/d/${SHEET_ID}/gviz/tq?tqx=out:csv&sheet=${encodeURIComponent(TAB_NAME)}`;
  const S = s => String(s ?? '').trim();
  const QUARTERS = {Q1:[1,2,3], Q2:[4,5,6], Q3:[7,8,9], Q4:[10,11,12]};
  Chart.register(ChartDataLabels);

  function parseCSV(t){
    const rows=[], re=/\s*("(?:[^"]|"")*"|[^,]*)\s*(,|\n|$)/g;
    let m, row=[]; t=t.replace(/\r\n?/g,"\n");
    for(let i=0;i<t.length;){
      re.lastIndex=i; m=re.exec(t); if(!m) break;
      let cell=m[1]; if(cell.startsWith('"')) cell=cell.slice(1,-1).replace(/""/g,'"');
      row.push(cell); i=re.lastIndex;
      if(m[2]==="\n"||m[2]===""){ rows.push(row); row=[]; }
    }
    return rows.filter(r=>r.length && r.some(c=>S(c)!==""));
  }

  function indexByName(header){
    const map={}; header.forEach((h,i)=>map[S(h)]=i);
    const find=(names)=>{ for(const n of names){ if(n in map) return map[n]; } return null; };
    const findFuzzy=(re)=>{ for(let i=0;i<header.length;i++){ if(re.test(S(header[i]))) return i; } return null; };
    return {
      date:find(["出荷日","日付","Date"]),
      cust:find(["顧客名","客先","Customer"]),
      qty: find(["数量","Qty","数量(個)","数量pcs"]) ?? findFuzzy(/数量|qty|個数|pcs/i),
      status_done:find(["製品状況","製品状態","納品状況"]) ?? findFuzzy(/(製品|納品).*(状況|状態)/),
      qc_check:  find(["検査チェックシート","検査ﾁｪｯｸｼｰﾄ","CheckSheet"]) ?? findFuzzy(/(検査|ﾁｪｯｸ|チェック).*シート|check/i),
      qc_label:  find(["テプラ","ﾃﾌﾟﾗ","ラベル","Label"])            ?? findFuzzy(/(ﾃﾌﾟﾗ|テプラ|ﾗﾍﾞﾙ|ラベル|label)/i),
      qc_result: find(["検査成績表","成績表","InspectionReport"])   ?? findFuzzy(/(検査|inspection).*(成績|report)/i),
      qc_pack:   find(["梱包","Packing","包装"])                    ?? findFuzzy(/(梱包|packing|包装)/i),
    };
  }
  const valAt = (row, idx) => (idx==null ? "" : (row[idx] ?? ""));
  const parseQty = (v)=>{ const t=S(v).replace(/,/g,''); const n=parseFloat(t); return isNaN(n)?0:n; };
  function isDoneValue(v){ const t=S(v).toLowerCase(); return !!t && (/(済|完了|ok|done)/.test(t)); }
  function isRowDoneByQC(row, idx){
    const vals=[];
    if(idx.qc_check!=null)  vals.push(valAt(row, idx.qc_check));
    if(idx.qc_label!=null)  vals.push(valAt(row, idx.qc_label));
    if(idx.qc_result!=null) vals.push(valAt(row, idx.qc_result));
    if(idx.qc_pack!=null)   vals.push(valAt(row, idx.qc_pack));
    return vals.length? vals.every(isDoneValue) : false;
  }
  function isDoneRow(r, idx){
    if(idx.status_done!=null) return isDoneValue(valAt(r, idx.status_done));
    return isRowDoneByQC(r, idx);
  }

  function parseJPDate(str){
    const s=String(str??"").trim();
    const m=s.match(/^(\d{4})\D(\d{1,2})\D(\d{1,2})/);
    if(m) return new Date(m[1], m[2]-1, m[3]);
    const parts=s.replaceAll('-','/').split('/');
    if(parts.length===3) return new Date(parts[0], parts[1]-1, parts[2]);
    const d=new Date(s);
    return isNaN(d)?null:d;
  }
  const ymKey=(d)=>`${d.getFullYear()}-${String(d.getMonth()+1).padStart(2,'0')}`;
  const intTick=(v)=>Number.isInteger(v)?v:'';

  // ===== Theme utilities (SOFT COLORS) =====
  const isDark = () => document.documentElement.getAttribute('data-theme') === 'dark';

  const PALETTE_LIGHT = ['#93c5fd','#a5b4fc','#fda4af','#fdba74','#86efac','#67e8f9','#f5d0fe','#c4b5fd','#fecaca','#fde68a','#bbf7d0','#bae6fd'];
  const PALETTE_DARK  = ['#60a5fa','#818cf8','#fca5a5','#fbbf24','#4ade80','#22d3ee','#f0abfc','#a78bfa','#f87171','#fde047','#86efac','#93c5fd'];

  function hexToRgba(hex, a=0.8){
    const h=hex.replace('#',''); const b=parseInt(h,16);
    const r=(b>>16)&255, g=(b>>8
